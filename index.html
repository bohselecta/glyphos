<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GlyphOS</title>
  
  <!-- CRITICAL: Frame-busting protection - must be FIRST -->
  <script>
    // Prevent loading in iframe (anti-recursion) - MUST be first script
    if (window.self !== window.top) {
      // We're in an iframe — don't boot the OS here.
      // Fail-safe: replace contents with blank doc.
      document.open(); 
      document.write(''); 
      document.close();
      
      // Optionally post a message so the parent knows
      try { 
        parent.postMessage({ type: "glyph:prevented-os-embed" }, "*"); 
      } catch {}
      
      // Don't throw error - just silently prevent execution
      console.warn('Prevented recursive OS loading in iframe');
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* Desktop Background - responsive */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('/livingos_comet_desktop_4k_32c.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -1;
      opacity: 1;
    }

    /* Mobile Background - for smaller screens */
    @media (max-width: 768px) {
      body::before {
        background-image: url('/livingos_comet_mobile_1440x3120_32c.png');
      }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #333;
      border-top: 4px solid #007acc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Top Bar - Clean & Minimal */
    .top-bar {
      height: 48px;
      background: rgba(15, 23, 42, 0.95);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    /* OS Brand */
    .os-brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: white;
    }

    .glyph-logo {
      font-size: 1.5rem;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .os-name {
      font-size: 1rem;
      letter-spacing: 0.02em;
    }

    /* Active App Title */
    .active-app-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.875rem;
      font-weight: 500;
    }

    /* System Controls */
    .system-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-btn {
      position: relative;
      width: 36px;
      height: 36px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .status-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .status-btn .icon {
      font-size: 1.25rem;
    }

    /* Status Dot (for realtime indicator) */
    .status-dot {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      border: 2px solid rgba(15, 23, 42, 0.95);
      display: none;
    }

    .status-btn.active .status-dot {
      display: block;
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
    }

    /* User Button */
    .user-btn {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .user-btn:hover {
      transform: scale(1.05);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .user-avatar {
      font-size: 1.25rem;
    }

    /* Desktop */
    .desktop {
      position: fixed;
      top: 48px;
      left: 0;
      right: 0;
      bottom: 80px;
      overflow: hidden;
      display: none;
    }

    .desktop.loaded {
      display: block;
    }

    /* Dock */
    .dock {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(20px);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 0.75rem 1rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      z-index: 1000;
    }

    .dock-btn {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 1.5rem;
    }

    .dock-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .dock-btn.active {
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .dock-divider {
      width: 1px;
      height: 32px;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 0.5rem;
    }

    /* SKWAREs (App Containers) */
    .window, .skware {
      position: absolute;
      background: rgba(255, 255, 255, 0.98);
      -webkit-backdrop-filter: blur(40px);
      backdrop-filter: blur(40px);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      overflow: hidden;
      z-index: 100;
    }

    .window-header {
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1rem;
      cursor: move;
    }

    .window-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e293b;
    }

    .window-controls {
      display: flex;
      gap: 0.5rem;
    }

    .window-btn {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .window-btn.close {
      background: #ef4444;
      color: white;
    }

    .window-btn.close:hover {
      background: #dc2626;
    }

    .window-btn.minimize {
      background: #f59e0b;
      color: white;
    }

    .window-btn.minimize:hover {
      background: #d97706;
    }

    .window-btn.maximize {
      background: #10b981;
      color: white;
    }

    .window-btn.maximize:hover {
      background: #059669;
    }

    .window-body {
      height: calc(100% - 40px);
      overflow: hidden;
    }

    .window-body iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Legacy App Launcher (will be removed) */
    .app-launcher {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .app-launcher.active {
      display: flex;
    }

    .app-grid {
      background: rgba(26, 26, 26, 0.95);
      border-radius: 20px;
      padding: 2rem;
      max-width: 800px;
      max-height: 600px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.5rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .app-icon {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .app-icon:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    .app-icon:active {
      transform: scale(0.95);
    }

    .app-icon-image {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(255, 255, 255, 0.1);
    }

    .app-icon-name {
      font-size: 12px;
      text-align: center;
      color: #e2e8f0;
      font-weight: 500;
    }

    .launcher-header {
      text-align: center;
      margin-bottom: 2rem;
      color: #e2e8f0;
    }

    .launcher-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .launcher-subtitle {
      font-size: 14px;
      color: #94a3b8;
    }


    /* Panel System */
    .panel {
      position: fixed;
      top: 48px; /* Below top bar */
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      width: 90%;
      max-width: 800px;
      height: calc(100vh - 148px); /* Top bar + dock space */
      background: rgba(255, 255, 255, 0.98);
      -webkit-backdrop-filter: blur(40px);
      backdrop-filter: blur(40px);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: none;
      flex-direction: column;
      opacity: 0;
      z-index: 900;
      overflow: hidden;
    }

    .panel.active {
      display: flex;
      animation: panelSlideIn 0.3s ease forwards;
    }

    @keyframes panelSlideIn {
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .panel-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .search-input {
      flex: 1;
      padding: 0.75rem 1rem;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      font-size: 1rem;
      outline: none;
    }

    .search-input:focus {
      background: white;
      border-color: #a855f7;
    }

    /* App Grid in Panel */
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 1.5rem;
      padding: 1rem 0;
    }

    .app-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 1rem;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .app-item:hover {
      background: rgba(168, 85, 247, 0.1);
    }

    .app-item-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .app-item-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e293b;
      text-align: center;
    }

    /* App Categories */
    .app-categories {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    .category-chip {
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-chip:hover {
      background: rgba(168, 85, 247, 0.1);
      border-color: #a855f7;
    }

    .category-chip.active {
      background: #a855f7;
      color: white;
      border-color: #a855f7;
    }

    /* Folder Grid */
    .folder-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 1.5rem;
      padding: 1rem 0;
    }

    .folder-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 1rem;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .folder-item:hover {
      background: rgba(168, 85, 247, 0.1);
    }

    .folder-icon {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .folder-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e293b;
      text-align: center;
    }

    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .breadcrumb-item {
      padding: 0.5rem 1rem;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .breadcrumb-item:hover {
      background: rgba(168, 85, 247, 0.1);
      border-color: #a855f7;
    }

    /* Market Section */
    .market-section {
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 1rem;
    }

    .featured-apps {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .market-app {
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .market-app:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .market-app-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .market-app-name {
      font-size: 0.875rem;
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 0.25rem;
    }

    .market-app-desc {
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 0.75rem;
    }

    .market-app-install {
      width: 100%;
      padding: 0.5rem;
      background: #a855f7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .market-app-install:hover {
      background: #9333ea;
    }

    /* Button Primary */
    .btn-primary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: #a855f7;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: #9333ea;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>Initializing GlyphOS...</div>
    </div>

    <!-- Top Status Bar -->
    <div class="top-bar">
      <!-- Left: OS Identity -->
      <div class="os-brand">
        <span class="glyph-logo">◬</span>
        <span class="os-name">GlyphOS</span>
      </div>
      
      <!-- Center: Active App Title (when window open) -->
      <div class="active-app-title" id="activeAppTitle"></div>
      
      <!-- Right: System Features -->
      <div class="system-controls">
        <!-- Realtime Status (shows if connected to any rooms) -->
        <button class="status-btn" id="realtimeStatus" title="Realtime">
          <span class="status-dot"></span>
          <span class="icon">⚡</span>
        </button>
        
        <!-- AI Availability -->
        <button class="status-btn" id="aiStatus" title="AI Ready">
          <span class="icon">🤖</span>
        </button>
        
        <!-- System Performance/Health -->
        <button class="status-btn" id="systemStatus" title="System">
          <span class="icon">📊</span>
        </button>
        
        <!-- User Account/Auth -->
        <button class="user-btn" id="userBtn" title="Account">
          <span class="user-avatar">👤</span>
        </button>
      </div>
    </div>

    <div class="desktop" id="desktop">
      <!-- SKWAREs Container (App Windows) -->
      <div id="windows-container"></div>
      <div id="skwares-container"></div>
    </div>

    <!-- Bottom Dock -->
    <div class="dock">
      <!-- App Launcher -->
      <button class="dock-btn" id="appsBtn" title="Apps">
        <span class="dock-icon">⊞</span>
      </button>
      
      <!-- File Manager -->
      <button class="dock-btn" id="filesBtn" title="Files">
        <span class="dock-icon">📁</span>
      </button>
      
      <!-- App Marketplace -->
      <button class="dock-btn" id="marketBtn" title="Market">
        <span class="dock-icon">🏪</span>
      </button>
      
      <!-- Running Apps (dynamically added) -->
      <div class="dock-divider"></div>
      <div id="runningApps"></div>
    </div>

    <!-- The Three Panel Views - Enhanced -->
    
    <!-- 1. App Launcher Panel -->
    <div class="panel" id="appsPanel">
      <div class="panel-header">
        <input type="text" class="search-input" placeholder="Search apps..." id="appSearch">
      </div>
      
      <div class="panel-content">
        <!-- Categories -->
        <div class="app-categories">
          <button class="category-chip active" data-category="all">All</button>
          <button class="category-chip" data-category="productivity">Productivity</button>
          <button class="category-chip" data-category="creative">Creative</button>
          <button class="category-chip" data-category="ai">AI</button>
          <button class="category-chip" data-category="tools">Tools</button>
        </div>
        
        <!-- App Grid -->
        <div class="app-grid" id="appGrid">
          <!-- Apps inserted here -->
        </div>
      </div>
    </div>

    <!-- 2. File Manager Panel -->
    <div class="panel" id="filesPanel">
      <div class="panel-header">
        <div class="breadcrumb" id="breadcrumb">
          <button class="breadcrumb-item">🏠 Home</button>
        </div>
      </div>
      
      <div class="panel-content">
        <!-- Quick Access Folders -->
        <div class="folder-grid" id="folderGrid">
          <div class="folder-item" data-path="desktop">
            <div class="folder-icon">🖥️</div>
            <div class="folder-name">Desktop</div>
          </div>
          <div class="folder-item" data-path="documents">
            <div class="folder-icon">📄</div>
            <div class="folder-name">Documents</div>
          </div>
          <div class="folder-item" data-path="pictures">
            <div class="folder-icon">🖼️</div>
            <div class="folder-name">Pictures</div>
          </div>
          <div class="folder-item" data-path="downloads">
            <div class="folder-icon">⬇️</div>
            <div class="folder-name">Downloads</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. App Marketplace Panel -->
    <div class="panel" id="marketPanel">
      <div class="panel-header">
        <input type="text" class="search-input" placeholder="Search marketplace..." id="marketSearch">
        <button class="btn-primary" id="publishBtn">
          <span>📤</span>
          <span>Publish App</span>
        </button>
      </div>
      
      <div class="panel-content">
        <!-- Featured Section -->
        <div class="market-section">
          <h3 class="section-title">Featured</h3>
          <div class="featured-apps" id="featuredApps">
            <!-- Featured app cards -->
          </div>
        </div>
        
        <!-- Browse All -->
        <div class="market-section">
          <h3 class="section-title">Browse All Apps</h3>
          <div class="market-grid" id="marketGrid">
            <!-- Market app cards -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SDK - Must load before apps -->
  <script type="module" src="/sdk/index.ts"></script>
  
  <!-- Test Scripts (loaded dynamically to avoid build errors) -->
  <script type="module">
    // Load test scripts only in development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      const scripts = ['quick-test.js', 'test-apps.js', 'comprehensive-test.js'];
      scripts.forEach(src => {
        const script = document.createElement('script');
        script.src = `/${src}`;
        script.onerror = () => console.log(`Test script ${src} not found (OK in production)`);
        document.body.appendChild(script);
      });
    }
  </script>
  
  <!-- Main Application -->
  <script type="module" src="/src/index.ts"></script>
  <script type="module">

    // Show desktop when loaded
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none'
        document.getElementById('desktop').classList.add('loaded')
      }, 2000)
    })

    // Command palette removed - using new panel system

    // Window controls are handled directly in renderWindows() - no duplicate handlers
    
    // THE CLOSE METHOD - Updated for deterministic lifecycle
    function closeWindow(windowId) {
      try {
        console.log('Closing window:', windowId)
        
        // Check if GlyphOS is available
        if (!window.GlyphOS || !window.GlyphOS.getWindowManager) {
          console.error('GlyphOS not available yet')
          return false
        }
        
        const windowManager = window.GlyphOS.getWindowManager()
        
        // Get the window element and iframe
        const windowElement = document.querySelector(`[data-window-id="${windowId}"]`)?.closest('.window')
        const iframe = windowElement?.querySelector('iframe')
        
        if (iframe) {
          // 1) Request app to shutdown gracefully
          try {
            iframe.contentWindow?.postMessage({ 
              type: "app:beforeClose",
              windowId: windowId 
            }, "*")
          } catch (error) {
            // Cross-origin error is expected
            console.log("Cross-origin close message (expected)")
          }
          
          // 2) Start closing animation
          if (windowElement) {
            windowElement.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out'
            windowElement.style.opacity = '0'
            windowElement.style.transform = 'scale(0.95)'
          }
          
          // 3) Hard kill after transition
          setTimeout(() => {
            console.log(`Hard killing window ${windowId}`)
            
            // Blank and remove iframe
            iframe.src = "about:blank"
            iframe.remove()
            
            // Remove window element
            if (windowElement) {
              windowElement.remove()
              console.log('Window element removed from DOM')
            }
            
            // Remove from window manager
            windowManager.closeWindow(windowId)
            console.log(`Window ${windowId} completely removed`)
          }, 220)
        } else {
          // Fallback: immediate removal
          if (windowElement) {
            windowElement.remove()
          }
          windowManager.closeWindow(windowId)
        }
        
        return true
      } catch (error) {
        console.error('Error closing window:', error)
        return false
      }
    }
    
    function minimizeWindow(windowId) {
      console.log('Minimizing window:', windowId)
      
      if (!window.GlyphOS || !window.GlyphOS.getWindowManager) {
        console.error('GlyphOS not available yet')
        return false
      }
      
      const windowManager = window.GlyphOS.getWindowManager()
      windowManager.minimizeWindow(windowId)
      renderWindows()
      return true
    }
    
    function toggleMaximize(windowId) {
      console.log('Maximizing window:', windowId)
      
      if (!window.GlyphOS || !window.GlyphOS.getWindowManager) {
        console.error('GlyphOS not available yet')
        return false
      }
      
      const windowManager = window.GlyphOS.getWindowManager()
      windowManager.maximizeWindow(windowId)
      renderWindows()
      return true
    }

    // Window rendering functions
    function renderWindows() {
      const container = document.getElementById('windows-container')
      
      // Check if GlyphOS is available
      if (!window.GlyphOS || !window.GlyphOS.getWindowManager) {
        console.log('GlyphOS not available yet, skipping window render')
        return
      }
      
      const windowManager = window.GlyphOS.getWindowManager()
      const windows = windowManager.getWindows()
      
      console.log('Rendering windows:', windows.length, 'windows')
      console.log('Window IDs:', windows.map(w => w.id))
      console.log('Window URLs:', windows.map(w => ({ id: w.id, url: w.url })))
      
      // CRITICAL FIX: Don't destroy all iframes - only remove windows that no longer exist
      const existingIds = new Set(windows.map(w => w.id))
      Array.from(container.children).forEach(el => {
        if (!existingIds.has(el.id)) {
          console.log('Removing stale window:', el.id)
          el.remove()
        }
      })
      
      windows.forEach(skware => {
        // Skip if already rendered
        if (document.getElementById(skware.id)) {
          console.log('SKWARE already rendered:', skware.id)
          return
        }
        
        console.log('Rendering NEW SKWARE:', skware.id, skware.title, 'URL:', skware.url)
        
        // Validate URL before rendering
        if (!skware.url || skware.url === '' || skware.url === window.location.href) {
          console.error('INVALID URL for SKWARE:', skware.id, 'URL:', skware.url)
          return
        }
        
        const windowEl = document.createElement('div')
        windowEl.className = `window ${skware.focused ? 'focused' : ''}`
        windowEl.id = skware.id // Set the ID
        windowEl.style.left = `${skware.bounds.x}px`
        windowEl.style.top = `${skware.bounds.y}px`
        windowEl.style.width = `${skware.bounds.width}px`
        windowEl.style.height = `${skware.bounds.height}px`
        windowEl.style.zIndex = skware.zIndex
        
        windowEl.innerHTML = `
          <div class="window-header" data-window-id="${skware.id}">
            <div class="window-title">${skware.title}</div>
            <div class="window-controls">
              <button class="window-btn minimize" data-action="minimize">−</button>
              <button class="window-btn maximize" data-action="maximize">□</button>
              <button class="window-btn close" data-action="close">×</button>
            </div>
          </div>
          <div class="window-body">
            <iframe class="window-content" src="${skware.url}" sandbox="allow-scripts allow-downloads allow-forms allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-modals" data-window-id="${skware.id}"></iframe>
          </div>
        `
        
        // Add to DOM
        container.appendChild(windowEl)
        console.log('SKWARE added to DOM:', skware.id)
        
        // Attach window control event listeners directly
        const closeBtn = windowEl.querySelector('.window-btn.close')
        const minimizeBtn = windowEl.querySelector('.window-btn.minimize')
        const maximizeBtn = windowEl.querySelector('.window-btn.maximize')
        
        console.log('Attaching controls to SKWARE:', skware.id)
        console.log('Found buttons:', { close: !!closeBtn, minimize: !!minimizeBtn, maximize: !!maximizeBtn })
        
        if (closeBtn) {
          closeBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            e.preventDefault()
            console.log('Close button clicked for SKWARE:', skware.id)
            closeWindow(skware.id)
          })
        }
        
        if (minimizeBtn) {
          minimizeBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            e.preventDefault()
            console.log('Minimize button clicked for SKWARE:', skware.id)
            minimizeWindow(skware.id)
          })
        }
        
        if (maximizeBtn) {
          maximizeBtn.addEventListener('click', (e) => {
            e.stopPropagation()
            e.preventDefault()
            console.log('Maximize button clicked for SKWARE:', skware.id)
            toggleMaximize(skware.id)
          })
        }
        
        // Add focus handling
        windowEl.addEventListener('mousedown', () => {
          windowManager.focusWindow(skware.id)
          renderWindows()
        })
      })
    }

    // Panel management
    const panels = {
      apps: document.getElementById('appsPanel'),
      files: document.getElementById('filesPanel'),
      market: document.getElementById('marketPanel')
    }

    function openPanel(panelName) {
      // Close all panels
      Object.values(panels).forEach(p => p?.classList.remove('active'))
      
      // Open requested panel
      panels[panelName]?.classList.add('active')
      
      // Update dock button states
      document.querySelectorAll('.dock-btn').forEach(btn => btn.classList.remove('active'))
      document.getElementById(`${panelName}Btn`)?.classList.add('active')
    }

    function closeAllPanels() {
      Object.values(panels).forEach(p => p?.classList.remove('active'))
      document.querySelectorAll('.dock-btn').forEach(btn => btn.classList.remove('active'))
    }

    // Dock button handlers
    document.getElementById('appsBtn').addEventListener('click', () => openPanel('apps'))
    document.getElementById('filesBtn').addEventListener('click', () => openPanel('files'))
    document.getElementById('marketBtn').addEventListener('click', () => openPanel('market'))

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAllPanels()
    })

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.panel') && !e.target.closest('.dock-btn')) {
        closeAllPanels()
      }
    })

    // Populate app grid in apps panel
    function populateAppsPanel() {
      const appGrid = document.getElementById('appGrid')
      
      // Define all installed apps
      const apps = [
        {
          id: 'com.glyphd.notes',
          name: 'Notes',
          icon: '📝',
          url: '/apps/notes/index.html',
          description: 'Note-taking app',
          category: 'productivity'
        },
        {
          id: 'com.glyphd.canvas',
          name: 'Glyph Canvas',
          icon: '🎨',
          url: '/apps/canvas/index.html',
          description: 'Creative drawing app',
          category: 'creative'
        },
        {
          id: 'com.glyphd.collab',
          name: 'Live Collab',
          icon: '🤝',
          url: '/apps/collab/index.html',
          description: 'Real-time collaboration',
          category: 'productivity'
        },
        {
          id: 'com.glyphd.aichat',
          name: 'AI Chat',
          icon: '🤖',
          url: '/apps/aichat/index.html',
          description: 'Chat with AI',
          category: 'ai'
        },
        {
          id: 'com.glyphd.monitor',
          name: 'System Monitor',
          icon: '📊',
          url: '/apps/monitor/index.html',
          description: 'System performance monitor',
          category: 'tools'
        },
        {
          id: 'com.glyphd.command',
          name: 'Command Center',
          icon: '⚡',
          url: '/apps/command/index.html',
          description: 'App launcher and workflows',
          category: 'tools'
        },
        {
          id: 'com.glyphd.memory',
          name: 'Memory Graph',
          icon: '🧠',
          url: '/apps/memory/index.html',
          description: 'Knowledge graph visualization',
          category: 'ai'
        },
        {
          id: 'com.glyphd.studio',
          name: 'Studio Player',
          icon: '🎬',
          url: '/apps/studio/index.html',
          description: 'Media player and visualizer',
          category: 'creative'
        },
        {
          id: 'com.glyphd.focus',
          name: 'Focus',
          icon: '🎯',
          url: '/apps/focus/index.html',
          description: 'Pomodoro timer and focus tool',
          category: 'productivity'
        },
        {
          id: 'com.glyphd.market',
          name: 'Market',
          icon: '🏪',
          url: '/apps/market/index.html',
          description: 'App store and discovery',
          category: 'tools'
        }
      ]

      appGrid.innerHTML = ''

      // Add app icons
      apps.forEach(app => {
        const appItem = document.createElement('div')
        appItem.className = 'app-item'
        appItem.dataset.category = app.category
        appItem.title = app.description
        
        appItem.innerHTML = `
          <div class="app-item-icon">${app.icon}</div>
          <div class="app-item-name">${app.name}</div>
        `
        
        appItem.addEventListener('click', () => {
          launchApp(app)
          closeAllPanels()
        })
        
        appGrid.appendChild(appItem)
      })
    }

    // Category filtering
    document.querySelectorAll('.category-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'))
        chip.classList.add('active')
        
        const category = chip.dataset.category
        const appItems = document.querySelectorAll('.app-item')
        
        appItems.forEach(item => {
          if (category === 'all' || item.dataset.category === category) {
            item.style.display = 'flex'
          } else {
            item.style.display = 'none'
          }
        })
      })
    })

    // App search
    document.getElementById('appSearch').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase()
      const appItems = document.querySelectorAll('.app-item')
      
      appItems.forEach(item => {
        const name = item.querySelector('.app-item-name').textContent.toLowerCase()
        if (name.includes(query)) {
          item.style.display = 'flex'
        } else {
          item.style.display = 'none'
        }
      })
    })

    // Populate market panel
    function populateMarketPanel() {
      const featuredApps = document.getElementById('featuredApps')
      const marketGrid = document.getElementById('marketGrid')
      
      // Featured apps
      const featured = [
        { name: 'AI Assistant', icon: '🤖', desc: 'Advanced AI helper' },
        { name: 'Code Editor', icon: '💻', desc: 'Full-featured code editor' },
        { name: 'Design Tool', icon: '🎨', desc: 'Professional design suite' }
      ]
      
      featuredApps.innerHTML = featured.map(app => `
        <div class="market-app">
          <div class="market-app-icon">${app.icon}</div>
          <div class="market-app-name">${app.name}</div>
          <div class="market-app-desc">${app.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join('')
      
      // All apps
      const allApps = [
        { name: 'Calculator', icon: '🧮', desc: 'Scientific calculator' },
        { name: 'Calendar', icon: '📅', desc: 'Event management' },
        { name: 'Weather', icon: '🌤️', desc: 'Weather forecast' },
        { name: 'Music Player', icon: '🎵', desc: 'Audio player' },
        { name: 'Photo Editor', icon: '📸', desc: 'Image editing' },
        { name: 'Task Manager', icon: '✅', desc: 'Task organization' }
      ]
      
      marketGrid.innerHTML = allApps.map(app => `
        <div class="market-app">
          <div class="market-app-icon">${app.icon}</div>
          <div class="market-app-name">${app.name}</div>
          <div class="market-app-desc">${app.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join('')
    }

    function launchApp(app) {
      try {
        console.log('Launching app:', app.name)
        
        // Check if GlyphOS is available
        if (!window.GlyphOS || !window.GlyphOS.getWindowManager) {
          console.error('GlyphOS not available yet, cannot launch app')
          return false
        }
        
        // Check if app registry is available
        if (!window.__APP_REGISTRY__ || !window.__APP_REGISTRY__[app.id]) {
          console.error(`App ${app.id} not found in registry`)
          return false
        }
        
        const windowManager = window.GlyphOS.getWindowManager()
        const appManifest = window.__APP_REGISTRY__[app.id]
        
        // Resolve the entry URL properly
        let entryUrl = appManifest.entry?.html || app.url
        if (!entryUrl.startsWith('http')) {
          entryUrl = `${window.location.origin}${entryUrl.startsWith('/') ? '' : '/'}${entryUrl}`
        }
        
        // Validate URL doesn't point to OS root
        if (entryUrl === window.location.href || 
            entryUrl === window.location.origin + '/index.html' ||
            entryUrl === window.location.origin + '/' ||
            entryUrl.endsWith('/index.html') && !entryUrl.includes('/apps/')) {
          console.error(`App ${app.id} entry URL points to OS root: ${entryUrl}`)
          return false
        }
        
        console.log(`✅ Launching ${app.name} from: ${entryUrl}`)
        console.log(`   App ID: ${app.id}`)
        console.log(`   Entry URL validated: ${entryUrl}`)
        
        const windowId = windowManager.createWindow({
          appId: app.id,
          title: app.name,
          url: entryUrl,
          width: 800,
          height: 600,
          x: Math.random() * 200 + 100, // Random position
          y: Math.random() * 200 + 100
        })
        
        console.log(`✅ ${app.name} launched with window ID:`, windowId)
        console.log(`   Now calling renderWindows()`)
        renderWindows()
        return true
      } catch (error) {
        console.error(`Failed to launch ${app.name}:`, error)
        return false
      }
    }

    // Initialize app registry
    function initializeAppRegistry() {
      window.__APP_REGISTRY__ = {
        'com.glyphd.notes': {
          id: 'com.glyphd.notes',
          manifest: {
            name: 'Notes',
            shortName: 'Notes',
            description: 'Simple, fast note-taking with automatic saving',
            categories: ['productivity', 'utility'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#3b82f6',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/notes/index.html'
          }
        },
        'com.glyphd.canvas': {
          id: 'com.glyphd.canvas',
          manifest: {
            name: 'Glyph Canvas',
            shortName: 'Canvas',
            description: 'Creative drawing app',
            categories: ['creative'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#8b5cf6',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/canvas/index.html'
          }
        },
        'com.glyphd.collab': {
          id: 'com.glyphd.collab',
          manifest: {
            name: 'Live Collab',
            shortName: 'Collab',
            description: 'Real-time collaboration',
            categories: ['productivity'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#10b981',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/collab/index.html'
          }
        },
        'com.glyphd.aichat': {
          id: 'com.glyphd.aichat',
          manifest: {
            name: 'AI Chat',
            shortName: 'AI Chat',
            description: 'Chat with AI',
            categories: ['ai'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#f59e0b',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/aichat/index.html'
          }
        },
        'com.glyphd.monitor': {
          id: 'com.glyphd.monitor',
          manifest: {
            name: 'System Monitor',
            shortName: 'Monitor',
            description: 'System performance monitor',
            categories: ['tools'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#ef4444',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/monitor/index.html'
          }
        },
        'com.glyphd.command': {
          id: 'com.glyphd.command',
          manifest: {
            name: 'Command Center',
            shortName: 'Command',
            description: 'App launcher and workflows',
            categories: ['tools'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#06b6d4',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/command/index.html'
          }
        },
        'com.glyphd.memory': {
          id: 'com.glyphd.memory',
          manifest: {
            name: 'Memory Graph',
            shortName: 'Memory',
            description: 'Knowledge graph visualization',
            categories: ['ai'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#84cc16',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/memory/index.html'
          }
        },
        'com.glyphd.focus': {
          id: 'com.glyphd.focus',
          manifest: {
            name: 'Focus',
            shortName: 'Focus',
            description: 'Temporal flow management with productivity rituals',
            categories: ['productivity'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'minimal-ui',
            themeColor: '#10b981',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/focus/index.html'
          }
        },
        'com.glyphd.market': {
          id: 'com.glyphd.market',
          manifest: {
            name: 'App Market',
            shortName: 'Market',
            description: 'Discover and install apps',
            categories: ['tools'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#f97316',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/market/index.html'
          }
        },
        'com.glyphd.studio': {
          id: 'com.glyphd.studio',
          manifest: {
            name: 'Glyph Studio',
            shortName: 'Studio',
            description: 'Creative workspace',
            categories: ['creative'],
            icons: [{ src: 'icon.svg', sizes: 'any', type: 'image/svg+xml' }],
            display: 'standalone',
            themeColor: '#ec4899',
            backgroundColor: '#0f172a'
          },
          entry: {
            html: '/apps/studio/index.html'
          }
        }
      };
      
      console.log('✅ App registry initialized with', Object.keys(window.__APP_REGISTRY__).length, 'apps');
    }

    // Initialize panels when desktop loads
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none'
        document.getElementById('desktop').classList.add('loaded')
        
        // Initialize app registry first
        initializeAppRegistry()
        
        // Populate panels
        populateAppsPanel()
        populateMarketPanel()
      }, 2000)
    })

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + Space opens apps panel
      if ((e.metaKey || e.ctrlKey) && e.key === ' ') {
        e.preventDefault()
        openPanel('apps')
      }
    })
  </script>
</body>
</html>
