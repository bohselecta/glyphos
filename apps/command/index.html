<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Command Center</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      padding: 2rem;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      text-align: center;
    }
    
    .title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .search-container {
      padding: 1.5rem;
      background: #1e293b;
      border-bottom: 1px solid #334155;
    }
    
    .search-box {
      width: 100%;
      padding: 1rem;
      background: #0f172a;
      border: 2px solid #334155;
      border-radius: 0.5rem;
      color: #e2e8f0;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .search-box:focus {
      border-color: #a855f7;
    }
    
    .search-box::placeholder {
      color: #64748b;
    }
    
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #334155;
      padding-bottom: 1rem;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      color: #64748b;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #e2e8f0;
    }
    
    .tab.active {
      color: #a855f7;
      border-bottom-color: #a855f7;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }
    
    .app-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .app-card:hover {
      border-color: #a855f7;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(168, 85, 247, 0.2);
    }
    
    .app-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .app-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .app-description {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 1rem;
    }
    
    .app-methods {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    
    .method-badge {
      padding: 0.25rem 0.5rem;
      background: #334155;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      color: #94a3b8;
      font-family: 'Monaco', monospace;
    }
    
    .workflow-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .workflow-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 1.5rem;
    }
    
    .workflow-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    
    .workflow-title {
      font-weight: 600;
      font-size: 1.125rem;
    }
    
    .workflow-description {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .workflow-steps {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .workflow-step {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #0f172a;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    
    .step-number {
      width: 24px;
      height: 24px;
      background: #a855f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    
    .step-arrow {
      color: #64748b;
      margin: 0.5rem 0 0.5rem 12px;
    }
    
    .run-btn {
      padding: 0.75rem 1.5rem;
      background: #a855f7;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    .run-btn:hover {
      background: #9333ea;
    }
    
    .run-btn:disabled {
      background: #475569;
      cursor: not-allowed;
    }
    
    .output-panel {
      margin-top: 1rem;
      padding: 1rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.375rem;
      font-family: 'Monaco', monospace;
      font-size: 0.875rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .output-line {
      margin-bottom: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }
    
    .output-time {
      color: #64748b;
    }
    
    .output-success {
      color: #10b981;
    }
    
    .output-error {
      color: #ef4444;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: #1e293b;
      border-radius: 0.5rem;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1.5rem;
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      color: #e2e8f0;
    }
    
    .method-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .form-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: #94a3b8;
    }
    
    .form-input {
      padding: 0.75rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.375rem;
      color: #e2e8f0;
      font-size: 1rem;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #a855f7;
    }
    
    .form-textarea {
      min-height: 100px;
      font-family: inherit;
      resize: vertical;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #64748b;
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">⚡ Command Center</div>
    <div class="subtitle">Launch apps, run workflows, and automate tasks</div>
  </div>
  
  <div class="search-container">
    <input 
      type="text" 
      class="search-box" 
      id="searchBox"
      placeholder="Search apps and workflows... (⌘K)"
    />
  </div>
  
  <div class="content">
    <div class="tabs">
      <button class="tab active" data-tab="apps">Apps</button>
      <button class="tab" data-tab="workflows">Workflows</button>
      <button class="tab" data-tab="recent">Recent</button>
    </div>
    
    <div class="tab-content active" id="apps-tab">
      <div class="app-grid" id="appGrid"></div>
    </div>
    
    <div class="tab-content" id="workflows-tab">
      <div class="workflow-list" id="workflowList"></div>
    </div>
    
    <div class="tab-content" id="recent-tab">
      <div id="recentList"></div>
    </div>
  </div>
  
  <!-- Method Call Modal -->
  <div class="modal" id="methodModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Call Method</div>
        <button class="close-btn" id="closeModal">×</button>
      </div>
      
      <form class="method-form" id="methodForm">
        <div id="methodParams"></div>
        
        <button type="submit" class="run-btn">Execute</button>
      </form>
      
      <div class="output-panel" id="methodOutput" style="display: none;"></div>
    </div>
  </div>

  <script type="module">
    // Command Center - GlyphOS
    
    let apps = []
    let workflows = []
    let recentCalls = []
    
    // Discover apps with IPC methods
    async function discoverApps() {
      try {
        const serviceRegistry = OS.ipc.discover()
        apps = []
        
        for (const [appId, services] of Object.entries(serviceRegistry)) {
          const manifest = await getAppManifest(appId)
          
          apps.push({
            id: appId,
            name: manifest?.name || appId,
            description: manifest?.description || '',
            icon: manifest?.icon || '📦',
            methods: services.methods || [],
            channels: services.channels || []
          })
        }
        
        renderApps()
      } catch (error) {
        console.error('Failed to discover apps:', error)
      }
    }
    
    // Get app manifest (simplified - would use real OS API)
    async function getAppManifest(appId) {
      // In real implementation, this would fetch from registry
      const mockManifests = {
        'com.glyphd.notes': {
          name: 'Notes',
          description: 'Note-taking app',
          icon: '📝'
        },
        'com.glyphd.canvas': {
          name: 'Glyph Canvas',
          description: 'Creative drawing app',
          icon: '🎨'
        },
        'com.glyphd.aichat': {
          name: 'AI Chat',
          description: 'Chat with AI',
          icon: '🤖'
        }
      }
      
      return mockManifests[appId]
    }
    
    // Render app grid
    function renderApps(filter = '') {
      const grid = document.getElementById('appGrid')
      const filtered = apps.filter(app => 
        app.name.toLowerCase().includes(filter.toLowerCase()) ||
        app.description.toLowerCase().includes(filter.toLowerCase())
      )
      
      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">🔍</div>
            <div>No apps found with IPC methods</div>
          </div>
        `
        return
      }
      
      grid.innerHTML = filtered.map(app => `
        <div class="app-card" data-app-id="${app.id}">
          <div class="app-icon">${app.icon}</div>
          <div class="app-name">${app.name}</div>
          <div class="app-description">${app.description}</div>
          ${app.methods.length > 0 ? `
            <div class="app-methods">
              ${app.methods.map(m => `
                <span class="method-badge" data-method="${m.name}">${m.name}</span>
              `).join('')}
            </div>
          ` : '<div style="color: #64748b; font-size: 0.875rem;">No exposed methods</div>'}
        </div>
      `).join('')
      
      // Add click handlers
      grid.querySelectorAll('.method-badge').forEach(badge => {
        badge.addEventListener('click', (e) => {
          e.stopPropagation()
          const appId = badge.closest('.app-card').dataset.appId
          const methodName = badge.dataset.method
          openMethodModal(appId, methodName)
        })
      })
      
      grid.querySelectorAll('.app-card').forEach(card => {
        card.addEventListener('click', () => {
          const appId = card.dataset.appId
          OS.process.launch(appId)
        })
      })
    }
    
    // Open method call modal
    function openMethodModal(appId, methodName) {
      const app = apps.find(a => a.id === appId)
      const method = app.methods.find(m => m.name === methodName)
      
      document.getElementById('modalTitle').textContent = 
        `${app.name} → ${methodName}()`
      
      const paramsEl = document.getElementById('methodParams')
      paramsEl.innerHTML = method.params.map((param, i) => `
        <div class="form-group">
          <label class="form-label">
            ${param.name} 
            <span style="color: #64748b;">(${param.type})</span>
            ${param.optional ? ' - optional' : ''}
          </label>
          ${param.description ? `<div style="font-size: 0.75rem; color: #64748b; margin-top: -0.25rem;">${param.description}</div>` : ''}
          <input 
            type="text" 
            class="form-input" 
            id="param-${i}"
            placeholder="${param.type === 'object' ? 'Enter JSON object' : `Enter ${param.type}`}"
            ${!param.optional ? 'required' : ''}
          />
        </div>
      `).join('')
      
      const form = document.getElementById('methodForm')
      form.onsubmit = (e) => {
        e.preventDefault()
        executeMethod(appId, methodName, method.params)
      }
      
      document.getElementById('methodOutput').style.display = 'none'
      document.getElementById('methodOutput').innerHTML = ''
      
      document.getElementById('methodModal').classList.add('active')
    }
    
    // Execute IPC method call
    async function executeMethod(appId, methodName, params) {
      const outputEl = document.getElementById('methodOutput')
      outputEl.style.display = 'block'
      outputEl.innerHTML = ''
      
      function log(message, type = 'info') {
        const line = document.createElement('div')
        line.className = 'output-line'
        line.innerHTML = `
          <span class="output-time">${new Date().toLocaleTimeString()}</span>
          <span class="output-${type}">${escapeHtml(message)}</span>
        `
        outputEl.appendChild(line)
        outputEl.scrollTop = outputEl.scrollHeight
      }
      
      try {
        log(`Calling ${appId}.${methodName}()...`)
        
        // Collect parameters
        const args = params.map((param, i) => {
          const input = document.getElementById(`param-${i}`)
          const value = input.value
          
          if (!value && !param.optional) {
            throw new Error(`Parameter '${param.name}' is required`)
          }
          
          // Try to parse as JSON for objects/arrays
          if (param.type === 'object' || param.type === 'array') {
            try {
              return JSON.parse(value)
            } catch {
              throw new Error(`Parameter '${param.name}' must be valid JSON`)
            }
          }
          
          // Type conversion
          if (param.type === 'number') return Number(value)
          if (param.type === 'boolean') return value === 'true'
          
          return value
        })
        
        log(`Arguments: ${JSON.stringify(args)}`)
        
        // Call method
        const result = await OS.ipc.call(appId, methodName, ...args)
        
        log('✓ Success', 'success')
        log(`Result: ${JSON.stringify(result, null, 2)}`, 'success')
        
        // Save to recent
        recentCalls.unshift({
          appId,
          methodName,
          args,
          result,
          timestamp: Date.now()
        })
        recentCalls = recentCalls.slice(0, 20)
        await OS.storage.kv.set('recent-calls', recentCalls)
        
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error')
      }
    }
    
    // Default workflows
    workflows = [
      {
        id: 'image-to-fractal',
        name: 'Image to Fractal',
        description: 'Convert an image to fractal encoding',
        steps: [
          { app: 'com.glyphd.canvas', method: 'getCurrentImage', description: 'Get current canvas image' },
          { app: 'com.glyphd.fractal', method: 'encode', description: 'Encode as fractal' },
          { app: 'com.glyphd.notes', method: 'createNote', description: 'Save to notes' }
        ]
      },
      {
        id: 'ai-summarize-notes',
        name: 'AI Summarize Notes',
        description: 'Summarize all notes using AI',
        steps: [
          { app: 'com.glyphd.notes', method: 'getAllNotes', description: 'Fetch all notes' },
          { app: 'com.glyphd.aichat', method: 'summarize', description: 'Generate AI summary' },
          { app: 'com.glyphd.notes', method: 'createNote', description: 'Save summary' }
        ]
      },
      {
        id: 'batch-process',
        name: 'Batch Process Files',
        description: 'Process multiple files through custom pipeline',
        steps: [
          { app: 'com.glyphd.files', method: 'selectMultiple', description: 'Select files' },
          { app: 'com.glyphd.processor', method: 'batchProcess', description: 'Process files' },
          { app: 'com.glyphd.storage', method: 'saveResults', description: 'Save results' }
        ]
      }
    ]
    
    // Render workflows
    function renderWorkflows() {
      const list = document.getElementById('workflowList')
      
      list.innerHTML = workflows.map(workflow => `
        <div class="workflow-card">
          <div class="workflow-header">
            <div>
              <div class="workflow-title">${workflow.name}</div>
              <div class="workflow-description">${workflow.description}</div>
            </div>
            <button class="run-btn" data-workflow-id="${workflow.id}">
              Run Workflow
            </button>
          </div>
          
          <div class="workflow-steps">
            ${workflow.steps.map((step, i) => `
              <div class="workflow-step">
                <div class="step-number">${i + 1}</div>
                <div style="flex: 1;">
                  <div style="font-weight: 500; margin-bottom: 0.25rem;">
                    ${step.app.split('.').pop()}.<span style="color: #a855f7;">${step.method}()</span>
                  </div>
                  <div style="color: #64748b; font-size: 0.75rem;">${step.description}</div>
                </div>
              </div>
              ${i < workflow.steps.length - 1 ? '<div class="step-arrow">↓</div>' : ''}
            `).join('')}
          </div>
          
          <div class="output-panel" id="workflow-output-${workflow.id}" style="display: none;"></div>
        </div>
      `).join('')
      
      // Add click handlers
      list.querySelectorAll('.run-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const workflowId = btn.dataset.workflowId
          runWorkflow(workflowId)
        })
      })
    }
    
    // Run workflow
    async function runWorkflow(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId)
      const outputEl = document.getElementById(`workflow-output-${workflowId}`)
      const btn = document.querySelector(`[data-workflow-id="${workflowId}"]`)
      
      outputEl.style.display = 'block'
      outputEl.innerHTML = ''
      btn.disabled = true
      btn.textContent = 'Running...'
      
      function log(message, type = 'info') {
        const line = document.createElement('div')
        line.className = 'output-line'
        line.innerHTML = `
          <span class="output-time">${new Date().toLocaleTimeString()}</span>
          <span class="output-${type}">${escapeHtml(message)}</span>
        `
        outputEl.appendChild(line)
        outputEl.scrollTop = outputEl.scrollHeight
      }
      
      let previousResult = null
      
      try {
        log(`Starting workflow: ${workflow.name}`)
        
        for (let i = 0; i < workflow.steps.length; i++) {
          const step = workflow.steps[i]
          log(`Step ${i + 1}: ${step.app}.${step.method}()`)
          
          // In real implementation, would pass previous result as argument
          const result = await OS.ipc.call(
            step.app, 
            step.method,
            previousResult
          )
          
          log(`✓ Complete`, 'success')
          previousResult = result
        }
        
        log('✓ Workflow complete!', 'success')
        log(`Final result: ${JSON.stringify(previousResult, null, 2)}`, 'success')
        
      } catch (error) {
        log(`✗ Workflow failed: ${error.message}`, 'error')
      }
      
      btn.disabled = false
      btn.textContent = 'Run Workflow'
    }
    
    // Render recent calls
    function renderRecent() {
      const list = document.getElementById('recentList')
      
      if (recentCalls.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📋</div>
            <div>No recent method calls</div>
          </div>
        `
        return
      }
      
      list.innerHTML = recentCalls.map(call => `
        <div class="workflow-card">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
              <div style="font-weight: 600; margin-bottom: 0.25rem;">
                ${call.appId}.<span style="color: #a855f7;">${call.methodName}()</span>
              </div>
              <div style="font-size: 0.75rem; color: #64748b;">
                ${new Date(call.timestamp).toLocaleString()}
              </div>
            </div>
          </div>
          
          <div style="font-size: 0.875rem; margin-top: 1rem;">
            <div style="color: #94a3b8; margin-bottom: 0.5rem;">Arguments:</div>
            <div style="background: #0f172a; padding: 0.75rem; border-radius: 0.375rem; font-family: Monaco, monospace; font-size: 0.75rem;">
              ${escapeHtml(JSON.stringify(call.args, null, 2))}
            </div>
          </div>
          
          <div style="font-size: 0.875rem; margin-top: 1rem;">
            <div style="color: #94a3b8; margin-bottom: 0.5rem;">Result:</div>
            <div style="background: #0f172a; padding: 0.75rem; border-radius: 0.375rem; font-family: Monaco, monospace; font-size: 0.75rem; color: #10b981;">
              ${escapeHtml(JSON.stringify(call.result, null, 2))}
            </div>
          </div>
        </div>
      `).join('')
    }
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
        tab.classList.add('active')
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active')
        
        // Render content
        if (tab.dataset.tab === 'workflows') {
          renderWorkflows()
        } else if (tab.dataset.tab === 'recent') {
          renderRecent()
        }
      })
    })
    
    // Search
    document.getElementById('searchBox').addEventListener('input', (e) => {
      const query = e.target.value
      const activeTab = document.querySelector('.tab.active').dataset.tab
      
      if (activeTab === 'apps') {
        renderApps(query)
      }
    })
    
    // Modal close
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('methodModal').classList.remove('active')
    })
    
    // Click outside modal to close
    document.getElementById('methodModal').addEventListener('click', (e) => {
      if (e.target.id === 'methodModal') {
        document.getElementById('methodModal').classList.remove('active')
      }
    })
    
    // Keyboard shortcut (Cmd+K)
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        document.getElementById('searchBox').focus()
      }
      
      if (e.key === 'Escape') {
        document.getElementById('methodModal').classList.remove('active')
      }
    })
    
    // Utility
    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = String(text)
      return div.innerHTML
    }
    
    // Initialize
    async function init() {
      await discoverApps()
      
      // Load recent calls
      const recent = await OS.storage.kv.get('recent-calls')
      if (recent) {
        recentCalls = recent
      }
      
      renderWorkflows()
    }
    
    init()
  </script>
</body>
</html>
