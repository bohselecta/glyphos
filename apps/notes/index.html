<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes</title>
  <base href="/apps/notes/">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      padding: 1rem;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .header button {
      padding: 0.5rem 1rem;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.375rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    .header button:hover {
      background: #2563eb;
    }
    
    .header button.secondary {
      background: #475569;
    }
    
    .header button.secondary:hover {
      background: #64748b;
    }
    
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .sidebar {
      width: 250px;
      background: #1e293b;
      border-right: 1px solid #334155;
      overflow-y: auto;
    }
    
    .note-list {
      list-style: none;
    }
    
    .note-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #334155;
      transition: background 0.2s;
    }
    
    .note-item:hover {
      background: #334155;
    }
    
    .note-item.active {
      background: #3b82f6;
    }
    
    .note-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    .note-preview {
      font-size: 0.875rem;
      color: #94a3b8;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem;
    }
    
    .editor-title {
      width: 100%;
      font-size: 2rem;
      font-weight: 700;
      background: transparent;
      border: none;
      color: #e2e8f0;
      margin-bottom: 1rem;
      outline: none;
    }
    
    .editor-title::placeholder {
      color: #475569;
    }
    
    .editor-content {
      flex: 1;
      width: 100%;
      font-size: 1rem;
      line-height: 1.5;
      background: transparent;
      border: none;
      color: #e2e8f0;
      resize: none;
      outline: none;
      font-family: inherit;
    }
    
    .editor-content::placeholder {
      color: #475569;
    }
    
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #475569;
      font-size: 1.125rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <button id="newNote">New Note</button>
    <button id="deleteNote" class="secondary">Delete</button>
    <button id="exportAll" class="secondary">Export All</button>
  </div>
  
  <div class="container">
    <div class="sidebar">
      <ul class="note-list" id="noteList"></ul>
    </div>
    
    <div class="editor" id="editor" style="display: none;">
      <input 
        type="text" 
        class="editor-title" 
        id="noteTitle" 
        placeholder="Untitled Note"
      />
      <textarea 
        class="editor-content" 
        id="noteContent" 
        placeholder="Start writing..."
      ></textarea>
    </div>
    
    <div class="empty-state" id="emptyState">
      Create a note to get started
    </div>
  </div>

  <script type="module">
    // Notes App - GlyphOS
    
    // Handshake with parent OS
    function handshakeWithOS() {
      console.log('Notes app: Sending handshake to OS');
      try {
        window.parent.postMessage({ type: 'glyph:hello' }, '*');
      } catch (error) {
        console.log('Notes app: Cross-origin handshake (expected)');
      }
    }
    
    // Listen for OS messages
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'glyph:hello:ack') {
        console.log('Notes app: Handshake acknowledged by OS', event.data);
      }
      
      if (event.data?.type === 'app:beforeClose') {
        console.log('Notes app: OS requested close');
        // Save any pending changes before closing
        if (window.saveNote) {
          window.saveNote();
        }
      }
    });
    
    // Send handshake when app loads
    setTimeout(handshakeWithOS, 100);
    
    // Mock OS API for now - will be injected by GlyphOS later
    const OS = {
      storage: {
        kv: {
          get: async (key) => {
            return localStorage.getItem(key)
          },
          set: async (key, value) => {
            localStorage.setItem(key, JSON.stringify(value))
          }
        },
        db: {
          insert: async (collection, doc) => {
            console.log('Mock DB insert:', collection, doc)
            const id = Date.now()
            // Store in localStorage for persistence
            const key = `notes_${id}`
            localStorage.setItem(key, JSON.stringify({ ...doc, id }))
            return { id }
          },
          find: async (collection, query) => {
            console.log('Mock DB find:', collection, query)
            // Return all stored notes
            const notes = []
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i)
              if (key && key.startsWith('notes_')) {
                const note = JSON.parse(localStorage.getItem(key))
                notes.push(note)
              }
            }
            return notes
          }
        }
      }
    }
    
    const db = OS.storage.db
    const kv = OS.storage.kv
    
    let currentNoteId = null
    let notes = []
    let saveTimeout = null
    
    // Initialize
    async function init() {
      // Create notes collection
      try {
        await db.createCollection('notes', {
          properties: {
            title: { type: 'string', default: 'Untitled' },
            content: { type: 'string', default: '' },
            createdAt: { type: 'date', required: true },
            updatedAt: { type: 'date', required: true }
          },
          indexes: [
            { fields: ['updatedAt'] }
          ]
        })
      } catch (e) {
        // Collection already exists
      }
      
      await loadNotes()
      
      // Auto-select first note or show empty state
      if (notes.length > 0) {
        selectNote(notes[0]._id)
      }
    }
    
    // Load all notes
    async function loadNotes() {
      notes = await db.find('notes', {})
      notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      renderNoteList()
    }
    
    // Render note list
    function renderNoteList() {
      const list = document.getElementById('noteList')
      list.innerHTML = ''
      
      notes.forEach(note => {
        const item = document.createElement('li')
        item.className = 'note-item'
        if (currentNoteId === note._id) {
          item.classList.add('active')
        }
        
        item.innerHTML = `
          <div class="note-title">${escapeHtml(note.title || 'Untitled')}</div>
          <div class="note-preview">${escapeHtml(note.content.slice(0, 50))}</div>
        `
        
        item.addEventListener('click', () => selectNote(note._id))
        list.appendChild(item)
      })
    }
    
    // Select note
    function selectNote(id) {
      currentNoteId = id
      const note = notes.find(n => n._id === id)
      
      if (note) {
        document.getElementById('noteTitle').value = note.title
        document.getElementById('noteContent').value = note.content
        document.getElementById('editor').style.display = 'flex'
        document.getElementById('emptyState').style.display = 'none'
        renderNoteList()
      }
    }
    
    // Create new note
    async function createNote() {
      const result = await db.insert('notes', {
        title: 'Untitled',
        content: '',
        createdAt: new Date(),
        updatedAt: new Date()
      })
      
      await loadNotes()
      selectNote(result.id) // Use result.id instead of result.insertedIds[0]
    }
    
    // Save current note (debounced)
    function saveNote() {
      if (!currentNoteId) return
      
      clearTimeout(saveTimeout)
      saveTimeout = setTimeout(async () => {
        const title = document.getElementById('noteTitle').value
        const content = document.getElementById('noteContent').value
        
        await db.update('notes',
          { _id: currentNoteId },
          { 
            $set: { 
              title, 
              content,
              updatedAt: new Date()
            } 
          }
        )
        
        await loadNotes()
      }, 500)
    }
    
    // Expose saveNote globally for OS to call
    window.saveNote = saveNote;
    
    // Delete current note
    async function deleteNote() {
      if (!currentNoteId) return
      
      if (confirm('Delete this note?')) {
        await db.delete('notes', { _id: currentNoteId })
        currentNoteId = null
        await loadNotes()
        
        if (notes.length > 0) {
          selectNote(notes[0]._id)
        } else {
          document.getElementById('editor').style.display = 'none'
          document.getElementById('emptyState').style.display = 'flex'
        }
      }
    }
    
    // Export all notes
    async function exportNotes() {
      const data = JSON.stringify(notes, null, 2)
      const blob = new Blob([data], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      
      const a = document.createElement('a')
      a.href = url
      a.download = `notes-${Date.now()}.json`
      a.click()
      
      URL.revokeObjectURL(url)
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div')
      div.textContent = text
      return div.innerHTML
    }
    
    // Event listeners
    document.getElementById('newNote').addEventListener('click', createNote)
    document.getElementById('deleteNote').addEventListener('click', deleteNote)
    document.getElementById('exportAll').addEventListener('click', exportNotes)
    document.getElementById('noteTitle').addEventListener('input', saveNote)
    document.getElementById('noteContent').addEventListener('input', saveNote)
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
        e.preventDefault()
        createNote()
      }
    })
    
    // Initialize app
    init()
  </script>
</body>
</html>
