(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class KernelEventBus{constructor(){this.listeners=new Map,this.onceListeners=new Map}emit(e,t){const s=this.listeners.get(e);if(s)for(const n of s)try{n(t)}catch(r){console.error(`Error in event handler for ${e}:`,r)}const i=this.onceListeners.get(e);if(i){for(const n of i)try{n(t)}catch(r){console.error(`Error in once event handler for ${e}:`,r)}this.onceListeners.delete(e)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){const s=this.listeners.get(e);s&&(s.delete(t),s.size===0&&this.listeners.delete(e));const i=this.onceListeners.get(e);i&&(i.delete(t),i.size===0&&this.onceListeners.delete(e))}removeAllListeners(e){e?(this.listeners.delete(e),this.onceListeners.delete(e)):(this.listeners.clear(),this.onceListeners.clear())}listenerCount(e){var i,n;const t=((i=this.listeners.get(e))==null?void 0:i.size)||0,s=((n=this.onceListeners.get(e))==null?void 0:n.size)||0;return t+s}eventNames(){const e=new Set;for(const t of this.listeners.keys())e.add(t);for(const t of this.onceListeners.keys())e.add(t);return Array.from(e)}}class KernelCapabilityManager{constructor(){this.grantedCapabilities=new Map,this.capabilityConstraints=new Map,this.initializeDefaultConstraints()}async request(e,t){const s=this.getCapabilityToken(e,t);if(s)return s;if(!this.validateCapabilityFormat(t))throw new Error(`Invalid capability format: ${JSON.stringify(t)}`);const i=this.capabilityConstraints.get(this.getCapabilityKey(t));if(i&&!this.satisfiesConstraints(t,i))throw new Error(`Capability constraints not satisfied: ${JSON.stringify(t)}`);const n={capability:t,grantedAt:Date.now(),expiresAt:i==null?void 0:i.expiresAt};return this.grantedCapabilities.has(e)||this.grantedCapabilities.set(e,new Map),this.grantedCapabilities.get(e).set(this.getCapabilityKey(t),n),n}has(e,t){const s=this.getCapabilityToken(e,t);return s?s.expiresAt&&Date.now()>s.expiresAt?(this.revoke(e,t),!1):!0:!1}revoke(e,t){const s=this.grantedCapabilities.get(e);s&&(s.delete(this.getCapabilityKey(t)),s.size===0&&this.grantedCapabilities.delete(e))}list(e){const t=this.grantedCapabilities.get(e);if(!t)return[];const s=[];for(const i of t.values())(!i.expiresAt||Date.now()<=i.expiresAt)&&s.push(i.capability);return s}validate(e){const t=[],s=[];if(e.capabilities.storage){const i=e.capabilities.storage;if(i.quota&&this.parseByteSize(i.quota)>1024*1024*1024&&s.push(`Storage quota ${i.quota} is very large`),i.scopes)for(const n of i.scopes)/^[a-zA-Z0-9_-]+$/.test(n)||t.push(`Invalid storage scope: ${n}`)}if(e.capabilities.network){const i=e.capabilities.network;if(i.fetch)for(const n of i.fetch)this.isValidURLPattern(n)||t.push(`Invalid fetch URL pattern: ${n}`);if(i.websocket)for(const n of i.websocket)this.isValidURLPattern(n)||t.push(`Invalid WebSocket URL pattern: ${n}`)}if(e.capabilities.ai){const i=e.capabilities.ai;if(i.maxTokens&&i.maxTokens>1e5&&s.push(`AI max tokens ${i.maxTokens} is very high`),i.providers){const n=["openai","anthropic","xai","ollama"];for(const r of i.providers)!n.includes(r)&&!r.startsWith("custom:")&&s.push(`Unknown AI provider: ${r}`)}}if(e.capabilities.ipc){const i=e.capabilities.ipc;if(i.expose)for(const n of i.expose)/^[a-zA-Z][a-zA-Z0-9_]*$/.test(n.name)||t.push(`Invalid IPC method name: ${n.name}`);if(i.consume)for(const n of i.consume)this.isValidServicePattern(n)||t.push(`Invalid IPC service pattern: ${n}`)}return{valid:t.length===0,errors:t.length>0?t:void 0,warnings:s.length>0?s:void 0}}getCapabilityToken(e,t){const s=this.grantedCapabilities.get(e);return s&&s.get(this.getCapabilityKey(t))||null}getCapabilityKey(e){return JSON.stringify(e)}validateCapabilityFormat(e){if(!e.type)return!1;switch(e.type){case"storage":return typeof e.scope=="string";case"network":return typeof e.origin=="string";case"ai":return typeof e.provider=="string";case"ipc":return typeof e.target=="string";case"media":return["camera","microphone","screen"].includes(e.device);case"notifications":return!0;case"clipboard":return["read","write"].includes(e.mode);case"geolocation":return!0;default:return!1}}satisfiesConstraints(e,t){return!0}initializeDefaultConstraints(){this.capabilityConstraints.set("storage",{maxQuota:1024*1024*1024,allowedScopes:["documents","cache","temp","user"]}),this.capabilityConstraints.set("network",{maxRequestsPerMinute:100,allowedOrigins:["*"]}),this.capabilityConstraints.set("ai",{maxTokensPerRequest:1e5,maxRequestsPerHour:1e3})}parseByteSize(e){const t={B:1,KB:1024,MB:1048576,GB:1073741824},s=e.match(/^(\d+(?:\.\d+)?)\s*(B|KB|MB|GB)$/i);if(!s)return 0;const i=parseFloat(s[1]),n=s[2].toUpperCase();return i*t[n]}isValidURLPattern(e){if(e==="*")return!0;try{return new URL(e),!0}catch{return/^https?:\/\/[^*]+\*$/.test(e)}}isValidServicePattern(e){return/^[a-zA-Z][a-zA-Z0-9_.]*$/.test(e)}}class KernelIPCRouter{constructor(){this.exposedMethods=new Map,this.broadcastSubscribers=new Map,this.pendingRequests=new Map,this.messageCounter=0,this.setupMessageHandling()}expose(e,t){this.exposedMethods.has(e)&&console.warn(`Method ${e} is already exposed, replacing handler`),this.exposedMethods.set(e,t)}unexpose(e){this.exposedMethods.delete(e)}async call(e,t,s){const i=this.generateMessageId(),n={id:i,type:"request",from:"kernel",to:e,method:t,payload:s,timestamp:Date.now()};return new Promise((r,o)=>{const c=setTimeout(()=>{this.pendingRequests.delete(i),o(new Error(`IPC call timeout: ${t}`))},3e4);this.pendingRequests.set(i,{resolve:r,reject:o,timeout:c}),this.sendMessage(n)})}broadcast(e,t){const s={id:this.generateMessageId(),type:"broadcast",from:"kernel",to:null,method:e,payload:t,timestamp:Date.now()};this.sendMessage(s)}subscribe(e,t){this.broadcastSubscribers.has(e)||this.broadcastSubscribers.set(e,new Set),this.broadcastSubscribers.get(e).add(t)}unsubscribe(e,t){const s=this.broadcastSubscribers.get(e);s&&(s.delete(t),s.size===0&&this.broadcastSubscribers.delete(e))}discover(){const e={},t=Array.from(this.exposedMethods.keys());return e.kernel={methods:t.map(s=>({name:s,params:[],returns:"any"})),channels:Array.from(this.broadcastSubscribers.keys())},e}handleMessage(e){switch(e.type){case"request":this.handleRequest(e);break;case"response":this.handleResponse(e);break;case"broadcast":this.handleBroadcast(e);break;case"error":this.handleError(e);break}}async handleRequest(e){const t=this.exposedMethods.get(e.method);if(!t){this.sendErrorResponse(e.id,"METHOD_NOT_FOUND",`Method ${e.method} not found`);return}try{const s=await t(...e.payload);this.sendResponse(e.id,s)}catch(s){this.sendErrorResponse(e.id,"HANDLER_ERROR",s instanceof Error?s.message:String(s))}}handleResponse(e){const t=this.pendingRequests.get(e.id);t&&(clearTimeout(t.timeout),this.pendingRequests.delete(e.id),t.resolve(e.payload))}handleBroadcast(e){const t=this.broadcastSubscribers.get(e.method);if(t)for(const s of t)try{s(e.payload,e.from)}catch(i){console.error(`Error in broadcast handler for ${e.method}:`,i)}}handleError(e){var s;const t=this.pendingRequests.get(e.id);if(t){clearTimeout(t.timeout),this.pendingRequests.delete(e.id);const i=new Error(((s=e.error)==null?void 0:s.message)||"Unknown IPC error");t.reject(i)}}sendResponse(e,t){const s={id:this.generateMessageId(),type:"response",from:"kernel",to:null,method:"",payload:t,timestamp:Date.now(),replyTo:e};this.sendMessage(s)}sendErrorResponse(e,t,s){const i={id:this.generateMessageId(),type:"error",from:"kernel",to:null,method:"",payload:null,timestamp:Date.now(),replyTo:e,error:{code:t,message:s}};this.sendMessage(i)}sendMessage(e){console.log("Sending IPC message:",e)}setupMessageHandling(){this.handleMessage=this.handleMessage.bind(this)}generateMessageId(){return`msg_${++this.messageCounter}_${Date.now()}`}}class KernelProcessManager{constructor(){this.processes=new Map,this.appToProcess=new Map,this.eventHandlers=new Map,this.maxConcurrentApps=10,this.resourceMonitor=new ResourceMonitor,this.startResourceMonitoring()}async spawn(e,t){const s=this.appToProcess.get(e.id);if(s){const r=this.processes.get(s);if(r&&r.state==="running")throw new Error(`App ${e.id} is already running`)}this.processes.size>=this.maxConcurrentApps&&await this.suspendLeastRecentlyUsed();const i=this.generateProcessId(),n={pid:i,appId:e.id,manifest:e,state:"spawning",spawnedAt:Date.now(),resourceUsage:{cpu:0,memory:0,storage:0,network:{sent:0,received:0,requests:0}}};return this.processes.set(i,n),this.appToProcess.set(e.id,i),this.emitEvent("spawn",n),n.state="running",new ProcessHandleImpl(i,this)}async kill(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);this.processes.delete(e),this.appToProcess.delete(t.appId),this.emitEvent("exit",t)}async suspend(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);if(t.state!=="running")throw new Error(`Process ${e} is not running`);t.state="suspended",this.emitEvent("suspend",t)}async resume(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);if(t.state!=="suspended")throw new Error(`Process ${e} is not suspended`);t.state="running",this.emitEvent("resume",t)}getProcess(e){return this.processes.get(e)||null}listProcesses(){return Array.from(this.processes.values())}isRunning(e){const t=this.appToProcess.get(e);if(!t)return!1;const s=this.processes.get(t);return s?s.state==="running":!1}getPID(e){return this.appToProcess.get(e)||null}getResourceUsage(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);return t.resourceUsage}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(t)}off(e,t){const s=this.eventHandlers.get(e);s&&(s.delete(t),s.size===0&&this.eventHandlers.delete(e))}async suspendLeastRecentlyUsed(){const e=Array.from(this.processes.values()).filter(t=>t.state==="running").sort((t,s)=>t.spawnedAt-s.spawnedAt);e.length>0&&await this.suspend(e[0].pid)}generateProcessId(){return`proc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}emitEvent(e,t){const s=this.eventHandlers.get(e);if(s)for(const i of s)try{i(t)}catch(n){console.error(`Error in process event handler for ${e}:`,n)}}startResourceMonitoring(){this.resourceMonitor.start(),setInterval(()=>{this.updateResourceUsage()},1e3)}updateResourceUsage(){for(const e of this.processes.values())e.resourceUsage.cpu=Math.random()*10,e.resourceUsage.memory=Math.random()*50*1024*1024}}class ProcessHandleImpl{constructor(e,t){this.pid=e,this.manager=t}async kill(){await this.manager.kill(this.pid)}async suspend(){await this.manager.suspend(this.pid)}async resume(){await this.manager.resume(this.pid)}getInfo(){const e=this.manager.getProcess(this.pid);if(!e)throw new Error(`Process ${this.pid} not found`);return e}}class ResourceMonitor{constructor(){this.monitoring=!1}start(){this.monitoring=!0}stop(){this.monitoring=!1}isMonitoring(){return this.monitoring}}class Kernel{constructor(){this.initialized=!1,this.startTime=Date.now(),this.events=new KernelEventBus,this.capabilities=new KernelCapabilityManager,this.ipc=new KernelIPCRouter,this.processes=new KernelProcessManager,this.setupEventHandlers()}async initialize(){if(this.initialized)throw new Error("Kernel is already initialized");console.log("Initializing GlyphOS Kernel..."),this.initialized=!0,console.log("GlyphOS Kernel initialized successfully")}async shutdown(){if(!this.initialized)return;console.log("Shutting down GlyphOS Kernel...");const e=this.processes.listProcesses();for(const t of e)try{await this.processes.kill(t.pid)}catch(s){console.error(`Error killing process ${t.pid}:`,s)}this.initialized=!1,console.log("GlyphOS Kernel shutdown complete")}isInitialized(){return this.initialized}getStatus(){return{initialized:this.initialized,processCount:this.processes.listProcesses().length,runningProcesses:this.processes.listProcesses().filter(e=>e.state==="running").length,exposedMethods:Object.keys(this.ipc.discover()).length,uptime:Date.now()-this.startTime}}setupEventHandlers(){this.processes.on("spawn",e=>{this.events.emit("process:spawn",e)}),this.processes.on("exit",e=>{this.events.emit("process:exit",e)}),this.processes.on("crash",e=>{this.events.emit("process:crash",e),console.error(`Process ${e.pid} crashed`)}),this.events.on("app:install",e=>{console.log("App installed:",e)}),this.events.on("app:uninstall",e=>{console.log("App uninstalled:",e)}),this.events.on("network:online",()=>{console.log("Network is online")}),this.events.on("network:offline",()=>{console.log("Network is offline")})}}let kernelInstance=null;function getKernel$1(){return kernelInstance||(kernelInstance=new Kernel),kernelInstance}async function initializeKernel(){const a=getKernel$1();return await a.initialize(),a}class IndexedDBKVStore{constructor(){this.db=null,this.dbName="glyphos-kv",this.storeName="kv-store",this.version=1}async initialize(){return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${s.error}`))},s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=i=>{const n=i.target.result;n.objectStoreNames.contains(this.storeName)||n.createObjectStore(this.storeName)}})}async get(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,s)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);r.onerror=()=>{s(new Error(`Failed to get key ${e}: ${r.error}`))},r.onsuccess=()=>{t(r.result||null)}})}async set(e,t){if(!this.db)throw new Error("Store not initialized");return new Promise((s,i)=>{const o=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(t,e);o.onerror=()=>{i(new Error(`Failed to set key ${e}: ${o.error}`))},o.onsuccess=()=>{s()}})}async delete(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,s)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);r.onerror=()=>{s(new Error(`Failed to delete key ${e}: ${r.error}`))},r.onsuccess=()=>{t()}})}async has(e){return await this.get(e)!==null}async keys(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAllKeys();n.onerror=()=>{t(new Error(`Failed to get keys: ${n.error}`))},n.onsuccess=()=>{e(n.result)}})}async clear(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();n.onerror=()=>{t(new Error(`Failed to clear store: ${n.error}`))},n.onsuccess=()=>{e()}})}async getMany(e){const t=e.map(s=>this.get(s));return Promise.all(t)}async setMany(e){const t=Object.entries(e).map(([s,i])=>this.set(s,i));await Promise.all(t)}async deleteMany(e){const t=e.map(s=>this.delete(s));await Promise.all(t)}}class OPFSFileSystem{constructor(){this.rootHandle=null,this.watchers=new Map}async initialize(){try{this.rootHandle=await navigator.storage.getDirectory(),console.log("OPFS initialized successfully")}catch(e){throw console.error("Failed to initialize OPFS:",e),new Error("OPFS not available")}}async read(e,t){const i=await(await this.getFileHandle(e)).getFile();if((t==null?void 0:t.encoding)==="utf8")return await i.text();{const n=await i.arrayBuffer();return new Uint8Array(n)}}async write(e,t){const s=this.getDirPath(e),i=this.getFileName(e);await this.ensureDirectory(s);const o=await(await(await this.getDirectoryHandle(s)).getFileHandle(i,{create:!0})).createWritable();if(typeof t=="string")await o.write(t);else{const c=new ArrayBuffer(t.length);new Uint8Array(c).set(t),await o.write(c)}await o.close(),this.notifyWatchers(e,"modify")}async delete(e,t){const s=this.getDirPath(e),i=this.getFileName(e),n=await this.getDirectoryHandle(s);try{t!=null&&t.recursive?await n.removeEntry(i,{recursive:!0}):await n.removeEntry(i),this.notifyWatchers(e,"delete")}catch(r){if(r instanceof Error&&r.name==="NotFoundError")return;throw r}}async list(e){await this.getDirectoryHandle(e);const t=[];return console.warn("Directory listing not fully implemented yet"),t}async mkdir(e){await this.ensureDirectory(e)}async exists(e){try{return await this.getHandle(e),!0}catch{return!1}}async stat(e){const t=await this.getHandle(e);if(t.kind==="directory")return{size:0,created:Date.now(),modified:Date.now(),accessed:Date.now(),isDirectory:!0,isFile:!1};{const s=await t.getFile();return{size:s.size,created:s.lastModified,modified:s.lastModified,accessed:s.lastModified,isDirectory:!1,isFile:!0}}}async copy(e,t){const s=await this.read(e);await this.write(t,s)}async move(e,t){await this.copy(e,t),await this.delete(e)}watch(e,t){const s=new WatchHandleImpl(e,t,this);return this.watchers.set(e,s),s}async clear(){if(!this.rootHandle)throw new Error("OPFS not initialized");console.warn("OPFS clearing not fully implemented yet")}async getFileHandle(e){const t=await this.getHandle(e);if(t.kind!=="file")throw new Error(`Path ${e} is not a file`);return t}async getDirectoryHandle(e){const t=await this.getHandle(e);if(t.kind!=="directory")throw new Error(`Path ${e} is not a directory`);return t}async getHandle(e){if(!this.rootHandle)throw new Error("OPFS not initialized");const t=this.normalizePath(e).split("/").filter(Boolean);let s=this.rootHandle;for(const i of t)try{s=await s.getDirectoryHandle(i)}catch{return await s.getFileHandle(i)}return s}async ensureDirectory(e){if(!this.rootHandle)throw new Error("OPFS not initialized");const t=this.normalizePath(e).split("/").filter(Boolean);let s=this.rootHandle;for(const i of t)try{s=await s.getDirectoryHandle(i)}catch{s=await s.getDirectoryHandle(i,{create:!0})}}getDirPath(e){const t=this.normalizePath(e),s=t.lastIndexOf("/");return s===0?"/":t.substring(0,s)}getFileName(e){const t=this.normalizePath(e),s=t.lastIndexOf("/");return t.substring(s+1)}normalizePath(e){return e.replace(/\/+/g,"/").replace(/\/$/,"")||"/"}notifyWatchers(e,t){for(const[s,i]of this.watchers)e.startsWith(s)&&i.notify({type:t,path:e})}}class WatchHandleImpl{constructor(e,t,s){this._path=e,this.handler=t,this._fs=s}close(){console.log(`Closing watch handle for ${this._path}`),console.log(`File system: ${this._fs?"available":"unavailable"}`)}notify(e){try{this.handler(e)}catch(t){console.error("Error in watch handler:",t)}}}class IndexedDBBlobStore{constructor(){this.db=null,this.dbName="glyphos-blobs",this.storeName="blob-store",this.version=1}async initialize(){return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${s.error}`))},s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=i=>{const n=i.target.result;if(!n.objectStoreNames.contains(this.storeName)){const r=n.createObjectStore(this.storeName,{keyPath:"key"});r.createIndex("created","created",{unique:!1}),r.createIndex("size","size",{unique:!1})}}})}async put(e,t){if(!this.db)throw new Error("Store not initialized");const s=t instanceof Blob?t:new Blob([t]),i=s.size,n=s.type,r=Date.now();return new Promise((o,c)=>{const d=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),h={key:e,data:s,size:i,type:n,created:r},u=d.put(h);u.onerror=()=>{c(new Error(`Failed to store blob ${e}: ${u.error}`))},u.onsuccess=()=>{const m=URL.createObjectURL(s);o({key:e,size:i,type:n,url:m})}})}async get(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,s)=>{const r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);r.onerror=()=>{s(new Error(`Failed to get blob ${e}: ${r.error}`))},r.onsuccess=()=>{const o=r.result;t(o?o.data:null)}})}async delete(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,s)=>{const r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);r.onerror=()=>{s(new Error(`Failed to delete blob ${e}: ${r.error}`))},r.onsuccess=()=>{t()}})}async getURL(e){const t=await this.get(e);return t?URL.createObjectURL(t):null}async list(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const n=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();n.onerror=()=>{t(new Error(`Failed to list blobs: ${n.error}`))},n.onsuccess=()=>{const r=n.result.map(o=>({key:o.key,size:o.size,type:o.type,created:o.created}));e(r)}})}async clear(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const n=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();n.onerror=()=>{t(new Error(`Failed to clear blobs: ${n.error}`))},n.onsuccess=()=>{e()}})}async getTotalSize(){return(await this.list()).reduce((t,s)=>t+s.size,0)}async getCount(){return(await this.list()).length}}class IndexedDBDatabase{constructor(){this.db=null,this.dbName="glyphos-database",this.version=1}async initialize(){return new Promise((e,t)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${s.error}`))},s.onsuccess=()=>{this.db=s.result,e()},s.onupgradeneeded=i=>{}})}async createTable(e,t){if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(e))return new Promise((s,i)=>{const n=this.db.transaction([],"versionchange"),r=n.objectStore(e)||this.db.createObjectStore(e,{keyPath:"id",autoIncrement:!0});if(t.indexes)for(const o of t.indexes){const c=o.columns.join("_"),l=o.unique||!1;r.createIndex(c,o.columns,{unique:l})}n.oncomplete=()=>s(),n.onerror=()=>i(new Error(`Failed to create table ${e}: ${n.error}`))})}async insert(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((s,i)=>{const r=this.db.transaction([e],"readwrite").objectStore(e);let o=0;const c=t.length;if(c===0){s();return}for(const l of t){const d=r.add(l);d.onsuccess=()=>{o++,o===c&&s()},d.onerror=()=>{i(new Error(`Failed to insert record: ${d.error}`))}}})}async query(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((s,i)=>{const o=this.db.transaction([e],"readonly").objectStore(e).getAll();o.onerror=()=>{i(new Error(`Failed to query table ${e}: ${o.error}`))},o.onsuccess=()=>{let c=o.result;t.where&&(c=this.applyWhereClause(c,t.where)),t.orderBy&&(c=this.applyOrderBy(c,t.orderBy)),t.offset&&(c=c.slice(t.offset)),t.limit&&(c=c.slice(0,t.limit)),s(c)}})}async update(e,t,s){if(!this.db)throw new Error("Database not initialized");const i=await this.query(e,t);return i.length===0?0:new Promise((n,r)=>{const c=this.db.transaction([e],"readwrite").objectStore(e);let l=0;const d=i.length;for(const h of i){const u={...h,...s},m=c.put(u);m.onsuccess=()=>{l++,l===d&&n(d)},m.onerror=()=>{r(new Error(`Failed to update record: ${m.error}`))}}})}async delete(e,t){if(!this.db)throw new Error("Database not initialized");const s=await this.query(e,t);return s.length===0?0:new Promise((i,n)=>{const o=this.db.transaction([e],"readwrite").objectStore(e);let c=0;const l=s.length;for(const d of s){const h=o.delete(d.id);h.onsuccess=()=>{c++,c===l&&i(l)},h.onerror=()=>{n(new Error(`Failed to delete record: ${h.error}`))}}})}async count(e,t){if(!this.db)throw new Error("Database not initialized");return t?(await this.query(e,t)).length:new Promise((i,n)=>{const c=this.db.transaction([e],"readonly").objectStore(e).count();c.onerror=()=>{n(new Error(`Failed to count table ${e}: ${c.error}`))},c.onsuccess=()=>{i(c.result)}})}async clear(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,s)=>{const r=this.db.transaction([e],"readwrite").objectStore(e).clear();r.onerror=()=>{s(new Error(`Failed to clear table ${e}: ${r.error}`))},r.onsuccess=()=>{t()}})}applyWhereClause(e,t){return e.filter(s=>this.evaluateWhereClause(s,t))}evaluateWhereClause(e,t){if("field"in t){const s=e[t.field];switch(t.op){case"=":return s===t.value;case"!=":return s!==t.value;case">":return s>t.value;case">=":return s>=t.value;case"<":return s<t.value;case"<=":return s<=t.value;case"in":return Array.isArray(t.value)&&t.value.includes(s);case"contains":return typeof s=="string"&&s.includes(t.value);default:return!1}}else{if("and"in t)return t.and.every(s=>this.evaluateWhereClause(e,s));if("or"in t)return t.or.some(s=>this.evaluateWhereClause(e,s))}return!1}applyOrderBy(e,t){return e.sort((s,i)=>{for(const n of t){const r=s[n.field],o=i[n.field];let c=0;if(r<o?c=-1:r>o&&(c=1),c!==0)return n.direction==="desc"?-c:c}return 0})}}class KernelStorageManager{constructor(){this.initialized=!1,this.initPromise=null,this.quotaCache=null,this.quotaCacheTime=0,this.QUOTA_CACHE_TTL=5e3,this.kv=new IndexedDBKVStore,this.fs=new OPFSFileSystem,this.blob=new IndexedDBBlobStore,this.db=new IndexedDBDatabase}async initialize(){if(!this.initialized)return this.initPromise?this.initPromise:(this.initPromise=this._doInitialize(),this.initPromise)}async _doInitialize(){var e,t,s,i,n,r,o,c;console.log("Initializing storage manager...");try{const l=[(t=(e=this.kv).initialize)==null?void 0:t.call(e),(i=(s=this.fs).initialize)==null?void 0:i.call(s),(r=(n=this.blob).initialize)==null?void 0:r.call(n),(c=(o=this.db).initialize)==null?void 0:c.call(o)].filter(Boolean),d=new Promise((h,u)=>{setTimeout(()=>u(new Error("Storage initialization timeout")),1e4)});await Promise.race([Promise.all(l),d]),this.initialized=!0,console.log("Storage manager initialized successfully")}catch(l){throw console.error("Storage initialization failed:",l),this.initPromise=null,new Error(`Storage initialization failed: ${l instanceof Error?l.message:"Unknown error"}`)}}async quota(){var t;if(!this.initialized)throw new Error("Storage manager not initialized");const e=Date.now();if(this.quotaCache&&e-this.quotaCacheTime<this.QUOTA_CACHE_TTL)return this.quotaCache;try{const s=await((t=navigator.storage)==null?void 0:t.estimate());if(!s)throw new Error("Storage quota not available");return this.quotaCache={used:s.usage||0,available:(s.quota||0)-(s.usage||0),total:s.quota||0},this.quotaCacheTime=e,this.quotaCache}catch(s){return console.error("Failed to get storage quota:",s),{used:0,available:0,total:0}}}isInitialized(){return this.initialized}async clearAll(){var e,t,s,i,n,r;if(!this.initialized)throw new Error("Storage manager not initialized");try{await Promise.all([this.kv.clear(),(t=(e=this.fs).clear)==null?void 0:t.call(e),(i=(s=this.blob).clear)==null?void 0:i.call(s),(r=(n=this.db).clear)==null?void 0:r.call(n)].filter(Boolean)),this.quotaCache=null,this.quotaCacheTime=0,console.log("Storage cleared successfully")}catch(o){throw console.error("Failed to clear storage:",o),new Error(`Storage clear failed: ${o instanceof Error?o.message:"Unknown error"}`)}}async exportData(){if(!this.initialized)throw new Error("Storage manager not initialized");try{const[e,t,s,i]=await Promise.all([this.exportKVData(),this.exportFSData(),this.exportBlobData(),this.exportDBData()]);return{kv:e,fs:t,blob:s,db:i}}catch(e){throw console.error("Failed to export storage data:",e),new Error(`Storage export failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async importData(e){if(!this.initialized)throw new Error("Storage manager not initialized");try{const t=[];e.kv&&t.push(this.importKVData(e.kv)),e.fs&&t.push(this.importFSData(e.fs)),e.blob&&t.push(this.importBlobData(e.blob)),e.db&&t.push(this.importDBData(e.db)),await Promise.all(t),console.log("Storage data imported successfully")}catch(t){throw console.error("Failed to import storage data:",t),new Error(`Storage import failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async exportKVData(){const e={},t=await this.kv.keys();for(const s of t)e[s]=await this.kv.get(s);return e}async exportFSData(){return{}}async exportBlobData(){return{}}async exportDBData(){return{}}async importKVData(e){for(const[t,s]of Object.entries(e))await this.kv.set(t,s)}async importFSData(e){}async importBlobData(e){}async importDBData(e){}}class SandboxRuntime{constructor(e,t,s,i){this.instances=new Map,this._processManager=e,console.log("Process Manager initialized:",!!this._processManager),this.capabilityManager=t,this.ipcRouter=s,this.eventBus=i,window.addEventListener("message",this.handleIframeMessage.bind(this))}async createInstance(e){const t=this.generateInstanceId(),s=this.createIframe(e),i={id:t,manifest:e.manifest,iframe:s,pid:e.pid,windowId:e.windowId,state:"loading",lastActivity:Date.now(),resources:{memory:0,cpu:0,storage:0},messageHandlers:new Map,cleanup:()=>this.cleanupInstance(t)};return this.instances.set(t,i),await this.loadApp(i,e),this.setupIPCBridge(i),await this.injectOSAPIs(i,e),i.state="ready",this.eventBus.emit("sandbox:instance-created",{instanceId:t,manifest:e.manifest,pid:e.pid}),i}createIframe(e){var i,n,r,o,c,l;const t=document.createElement("iframe");t.src=e.manifest.entry.html,t.style.border="none",t.style.width="100%",t.style.height="100%",t.style.display="block";const s=["allow-scripts","allow-same-origin","allow-forms","allow-popups","allow-modals","allow-downloads","allow-top-navigation-by-user-activation"];return(n=(i=e.manifest.capabilities)==null?void 0:i.media)!=null&&n.camera&&s.push("allow-camera"),(o=(r=e.manifest.capabilities)==null?void 0:r.media)!=null&&o.microphone&&s.push("allow-microphone"),(l=(c=e.manifest.capabilities)==null?void 0:c.media)!=null&&l.screen&&s.push("allow-screen-capture"),t.setAttribute("sandbox",s.join(" ")),t.setAttribute("csp",e.csp),t.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),t.setAttribute("loading","eager"),t}async loadApp(e,t){return new Promise((s,i)=>{const n=setTimeout(()=>{i(new Error("App load timeout"))},3e4),r=()=>{clearTimeout(n),e.iframe.removeEventListener("load",r),e.iframe.removeEventListener("error",o),s()},o=c=>{clearTimeout(n),e.iframe.removeEventListener("load",r),e.iframe.removeEventListener("error",o),i(new Error(`App load error: ${c.message}`))};e.iframe.addEventListener("load",r),e.iframe.addEventListener("error",o),document.body.appendChild(e.iframe)})}setupIPCBridge(e){e.messageHandlers.set("ipc",t=>{this.handleIPCMessage(e,t)}),e.messageHandlers.set("capability-request",t=>{this.handleCapabilityRequest(e,t)}),e.messageHandlers.set("storage-request",t=>{this.handleStorageRequest(e,t)})}async injectOSAPIs(e,t){var n;const s={app:{id:e.manifest.id,version:e.manifest.version,name:e.manifest.manifest.name,description:e.manifest.manifest.description},storage:{kv:this.createStorageAPI(e,"kv"),fs:this.createStorageAPI(e,"fs"),blob:this.createStorageAPI(e,"blob"),db:this.createStorageAPI(e,"db"),quota:()=>this.getStorageQuota(e.manifest)},ipc:{call:(r,o,...c)=>this.callAppMethod(e,r,o,c),expose:(r,o)=>this.exposeMethod(e,r,o),broadcast:(r,o)=>this.broadcastMessage(e,r,o),subscribe:(r,o)=>this.subscribeToChannel(e,r,o)},capabilities:{request:r=>this.requestCapability(e,r),has:r=>this.hasCapability(e,r)},window:{id:e.windowId,focus:()=>this.focusWindow(e),minimize:()=>this.minimizeWindow(e),maximize:()=>this.maximizeWindow(e),close:()=>this.closeWindow(e)},events:{on:(r,o)=>this.addEventListener(e,r,o),off:(r,o)=>this.removeEventListener(e,r,o),emit:(r,o)=>this.emitEvent(e,r,o)}},i=`
      (function() {
        // Make OS APIs available globally
        window.OS = ${JSON.stringify(s)};
        
        // Set app ID for IPC
        window.__GLYPH_APP_ID__ = '${e.manifest.id}';
        
        // Emit ready event
        window.dispatchEvent(new CustomEvent('glyphos:ready'));
      })();
    `;try{const r=e.iframe.contentDocument||((n=e.iframe.contentWindow)==null?void 0:n.document);if(r){const o=r.createElement("script");o.textContent=i,r.head.appendChild(o)}}catch(r){console.error("Failed to inject OS APIs:",r)}}handleIframeMessage(e){const{data:t,source:s}=e,i=Array.from(this.instances.values()).find(r=>r.iframe.contentWindow===s);if(!i)return;i.lastActivity=Date.now();const n=i.messageHandlers.get(t.type);if(n)try{n(t)}catch(r){console.error("Error handling iframe message:",r),this.sendErrorToIframe(i,t.id,r)}}handleIPCMessage(e,t){console.log("IPC message:",t)}handleCapabilityRequest(e,t){const{capability:s,callback:i}=t;console.log("Capability request:",s,i),this.capabilityManager.has(e.manifest.id,s)?this.sendToIframe(e,{type:"capability-response",id:t.id,granted:!0}):this.requestUserPermission(e,s,r=>{r&&this.capabilityManager.request(e.manifest.id,s),this.sendToIframe(e,{type:"capability-response",id:t.id,granted:r})})}handleStorageRequest(e,t){const{operation:s,data:i}=t;console.log("Storage request:",s,i);const n=this.getStorageQuota(e.manifest);if(e.resources.storage>=n){this.sendToIframe(e,{type:"storage-response",id:t.id,error:"Storage quota exceeded"});return}this.sendToIframe(e,{type:"storage-response",id:t.id,data:"Storage operation completed"})}createStorageAPI(e,t){return{get:s=>this.storageRequest(e,"get",{type:t,key:s}),set:(s,i)=>this.storageRequest(e,"set",{type:t,key:s,value:i}),delete:s=>this.storageRequest(e,"delete",{type:t,key:s}),list:s=>this.storageRequest(e,"list",{type:t,prefix:s})}}async storageRequest(e,t,s){return new Promise((i,n)=>{const r=this.generateRequestId(),o=c=>{c.id===r&&(e.messageHandlers.delete(`storage-${r}`),c.error?n(new Error(c.error)):i(c.data))};e.messageHandlers.set(`storage-${r}`,o),this.sendToIframe(e,{type:"storage-request",id:r,operation:t,data:s})})}async callAppMethod(e,t,s,i){return this.ipcRouter.call(t,s,i)}exposeMethod(e,t,s){console.log("Exposing method:",t,s)}broadcastMessage(e,t,s){this.ipcRouter.broadcast(t,s)}subscribeToChannel(e,t,s){return this.ipcRouter.subscribe(t,s),()=>this.ipcRouter.unsubscribe(t,s)}requestCapability(e,t){return new Promise(s=>{this.requestUserPermission(e,t,s)})}hasCapability(e,t){return this.capabilityManager.has(e.manifest.id,t)}requestUserPermission(e,t,s){const i=document.createElement("div");i.className="permission-dialog",i.innerHTML=`
      <div class="permission-content">
        <h3>Permission Request</h3>
        <p>App "${e.manifest.manifest.name}" wants to access:</p>
        <p><strong>${t}</strong></p>
        <div class="permission-buttons">
          <button class="permission-deny">Deny</button>
          <button class="permission-allow">Allow</button>
        </div>
      </div>
    `,i.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;const n=i.querySelector(".permission-content");n.style.cssText=`
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;const r=i.querySelector(".permission-deny"),o=i.querySelector(".permission-allow");r.onclick=()=>{document.body.removeChild(i),s(!1)},o.onclick=()=>{document.body.removeChild(i),s(!0)},document.body.appendChild(i)}focusWindow(e){this.eventBus.emit("window:focus",{windowId:e.windowId})}minimizeWindow(e){this.eventBus.emit("window:minimize",{windowId:e.windowId})}maximizeWindow(e){this.eventBus.emit("window:maximize",{windowId:e.windowId})}closeWindow(e){this.eventBus.emit("window:close",{windowId:e.windowId})}addEventListener(e,t,s){this.eventBus.on(`${e.manifest.id}:${t}`,s)}removeEventListener(e,t,s){this.eventBus.off(`${e.manifest.id}:${t}`,s)}emitEvent(e,t,s){this.eventBus.emit(`${e.manifest.id}:${t}`,s)}sendToIframe(e,t){e.iframe.contentWindow&&e.iframe.contentWindow.postMessage(t,"*")}sendErrorToIframe(e,t,s){this.sendToIframe(e,{type:"error",id:t,error:s.message||"Unknown error"})}getStorageQuota(e){var r,o;const t=(o=(r=e.capabilities)==null?void 0:r.storage)==null?void 0:o.quota;if(!t)return 100*1024*1024;const s=t.match(/^(\d+)(KB|MB|GB)$/);if(!s)return 100*1024*1024;const i=parseInt(s[1]);switch(s[2]){case"KB":return i*1024;case"MB":return i*1024*1024;case"GB":return i*1024*1024*1024;default:return 100*1024*1024}}cleanupInstance(e){const t=this.instances.get(e);t&&(t.iframe.parentNode&&t.iframe.parentNode.removeChild(t.iframe),t.messageHandlers.clear(),this.instances.delete(e),this.eventBus.emit("sandbox:instance-cleaned",{instanceId:e}))}getInstance(e){return this.instances.get(e)}getAllInstances(){return Array.from(this.instances.values())}terminateInstance(e){const t=this.instances.get(e);t&&(t.state="terminated",t.cleanup())}suspendInstance(e){const t=this.instances.get(e);t&&(t.state="suspended")}resumeInstance(e){const t=this.instances.get(e);t&&(t.state="running")}generateInstanceId(){return`instance-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateRequestId(){return`req-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}const GAM_VALIDATION_RULES={required:["id","version","manifest","manifest.name","manifest.description","manifest.categories","manifest.icons","author","author.name","author.pubkey","author.registry","entry","entry.html","entry.integrity","signature"],patterns:{id:/^[a-z][a-z0-9-]*(\.[a-z][a-z0-9-]*)+$/,version:/^\d+\.\d+\.\d+(-[a-z0-9.]+)?(\+[a-z0-9.]+)?$/,themeColor:/^#[0-9a-fA-F]{6}$/,pubkey:/^[A-Za-z0-9+/]{43}=$/,integrity:/^sha(256|384|512)-[A-Za-z0-9+/]+=*$/,email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/},lengths:{"manifest.name":{min:1,max:50},"manifest.shortName":{max:12},"manifest.description":{min:10,max:160},"manifest.longDescription":{max:5e3},"author.name":{min:1,max:100}},arrays:{"manifest.categories":{min:1,max:5},"manifest.icons":{min:1},"manifest.tags":{max:20}},enums:{"manifest.display":["standalone","fullscreen","minimal-ui"],"manifest.orientation":["any","portrait","landscape"],"manifest.dir":["ltr","rtl"],"collaboration.crdt":["yjs","automerge","none"],"capabilities.clipboard":["read","write","readwrite"],"signature.algorithm":["ed25519"]},custom:{signatureKeyMatch:a=>a.signature.publicKey===a.author.pubkey,validSemver:a=>{try{return!0}catch{return!1}},secureUrls:a=>{var t,s,i,n;return[a.entry.html,a.author.registry,...((s=(t=a.capabilities)==null?void 0:t.network)==null?void 0:s.fetch)||[],...((n=(i=a.capabilities)==null?void 0:i.network)==null?void 0:n.websocket)||[]].every(r=>r.startsWith("https://")||r.startsWith("http://localhost")||r.startsWith("ipfs://"))},validQuota:a=>a?/^\d+(KB|MB|GB)$/.test(a):!0}};class GAMValidator{static validate(e){const t=[],s=[];for(const i of GAM_VALIDATION_RULES.required)this.getNestedValue(e,i)||t.push({field:i,code:"REQUIRED_FIELD_MISSING",message:`Required field '${i}' is missing`});for(const[i,n]of Object.entries(GAM_VALIDATION_RULES.patterns)){const r=this.getNestedValue(e,i);r&&!n.test(r)&&t.push({field:i,code:"PATTERN_MISMATCH",message:`Field '${i}' does not match required pattern`})}for(const[i,n]of Object.entries(GAM_VALIDATION_RULES.lengths)){const r=this.getNestedValue(e,i);r&&("min"in n&&n.min&&r.length<n.min&&t.push({field:i,code:"TOO_SHORT",message:`Field '${i}' is too short (min: ${n.min})`}),"max"in n&&n.max&&r.length>n.max&&t.push({field:i,code:"TOO_LONG",message:`Field '${i}' is too long (max: ${n.max})`}))}for(const[i,n]of Object.entries(GAM_VALIDATION_RULES.arrays)){const r=this.getNestedValue(e,i);Array.isArray(r)&&("min"in n&&n.min&&r.length<n.min&&t.push({field:i,code:"TOO_FEW_ITEMS",message:`Field '${i}' has too few items (min: ${n.min})`}),"max"in n&&n.max&&r.length>n.max&&t.push({field:i,code:"TOO_MANY_ITEMS",message:`Field '${i}' has too many items (max: ${n.max})`}))}for(const[i,n]of Object.entries(GAM_VALIDATION_RULES.enums)){const r=this.getNestedValue(e,i);r&&!n.includes(r)&&t.push({field:i,code:"INVALID_ENUM",message:`Field '${i}' has invalid value. Allowed: ${n.join(", ")}`})}return e.signature&&e.author&&(GAM_VALIDATION_RULES.custom.signatureKeyMatch(e)||t.push({field:"signature.publicKey",code:"SIGNATURE_KEY_MISMATCH",message:"Signature public key does not match author public key"})),GAM_VALIDATION_RULES.custom.secureUrls(e)||s.push({field:"urls",code:"INSECURE_URL",message:"Some URLs are not HTTPS (security risk)"}),{valid:t.length===0,errors:t,warnings:s}}static getNestedValue(e,t){return t.split(".").reduce((s,i)=>s==null?void 0:s[i],e)}}class AppLoader{constructor(e,t,s,i,n,r={}){this.installations=new Map,this.sandboxRuntime=e,this.processManager=t,this.capabilityManager=s,this._ipcRouter=i,console.log("IPC Router initialized:",!!this._ipcRouter),this.eventBus=n,this.config={verifySignatures:!0,checkTrust:!0,autoUpdate:!1,...r},this.loadInstallations()}async installApp(e){let t;typeof e=="string"?t=await this.loadManifestFromUrl(e):t=e;const s=GAMValidator.validate(t);if(!s.valid)throw new Error(`Invalid manifest: ${s.errors.map(r=>r.message).join(", ")}`);const i=this.installations.get(t.id);if(i&&i.status==="installed")throw new Error(`App ${t.id} is already installed`);const n={id:t.id,installedAt:Date.now(),manifest:t,source:typeof e=="string"?{url:e}:{local:!0},status:"installing",files:{manifest:"",entry:"",assets:[]},verified:!1};this.installations.set(t.id,n);try{return this.config.verifySignatures&&(await this.verifySignature(t),n.verified=!0),this.config.checkTrust&&(n.trustScore=await this.checkTrustScore(t)),await this.downloadAppFiles(n),await this.installAppFiles(n),await this.registerCapabilities(n),n.status="installed",await this.saveInstallation(n),this.eventBus.emit("app:installed",{appId:t.id,manifest:t,installation:n}),n}catch(r){throw n.status="failed",n.error=r.message,await this.saveInstallation(n),r}}async loadManifestFromUrl(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch manifest: ${t.statusText}`);return await t.json()}catch(t){throw new Error(`Failed to load manifest from ${e}: ${t}`)}}async verifySignature(e){if(!e.signature)throw new Error("App signature is missing");if(!e.signature.signature)throw new Error("App signature is invalid");console.log("Signature verification passed (mock)")}async checkTrustScore(e){return .8}async downloadAppFiles(e){const{manifest:t}=e,s=await fetch(t.entry.html);if(!s.ok)throw new Error(`Failed to download entry file: ${s.statusText}`);const i=await s.text();e.files.entry=i;const n=[];for(const r of t.manifest.icons)try{const o=await fetch(r.src);if(o.ok){const c=await o.text();n.push(c)}}catch{console.warn(`Failed to download icon: ${r.src}`)}if(t.manifest.screenshots)for(const r of t.manifest.screenshots)try{const o=await fetch(r.src);if(o.ok){const c=await o.text();n.push(c)}}catch{console.warn(`Failed to download screenshot: ${r.src}`)}e.files.assets=n}async installAppFiles(e){console.log(`Installing app files for ${e.id}`)}async registerCapabilities(e){const{manifest:t}=e;t.capabilities&&(t.capabilities.storage&&await this.capabilityManager.request(t.id,{type:"storage",scope:"app"}),t.capabilities.network&&await this.capabilityManager.request(t.id,{type:"network",origin:{pattern:"*"}}),t.capabilities.media&&(t.capabilities.media.camera&&await this.capabilityManager.request(t.id,{type:"media",device:"camera"}),t.capabilities.media.microphone&&await this.capabilityManager.request(t.id,{type:"media",device:"microphone"}),t.capabilities.media.screen&&await this.capabilityManager.request(t.id,{type:"media",device:"screen"})),t.capabilities.ipc&&await this.capabilityManager.request(t.id,{type:"ipc",target:"*"}))}async loadApp(e,t){const s=this.installations.get(e);if(!s)throw new Error(`App ${e} is not installed`);if(s.status!=="installed")throw new Error(`App ${e} is not ready to load`);const i=await this.processManager.spawn(s.manifest),n={manifest:s.manifest,pid:i.pid,windowId:t,permissions:this.getAppPermissions(s.manifest),csp:this.generateCSP(s.manifest),storageQuota:this.getStorageQuota(s.manifest)},r=await this.sandboxRuntime.createInstance(n);this.eventBus.emit("app:loaded",{appId:e,windowId:t,instanceId:r.id,manifest:s.manifest})}async uninstallApp(e){const t=this.installations.get(e);if(!t)throw new Error(`App ${e} is not installed`);const s=this.sandboxRuntime.getAllInstances();for(const i of s)i.manifest.id===e&&this.sandboxRuntime.terminateInstance(i.id);console.log("Removing capabilities for app:",e),await this.removeAppFiles(t),this.installations.delete(e),await this.saveInstallations(),this.eventBus.emit("app:uninstalled",{appId:e})}async updateApp(e,t){const s=this.installations.get(e);if(!s)throw new Error(`App ${e} is not installed`);s.status="updating";try{let i=t;if(!i)if(s.source.url)i=await this.loadManifestFromUrl(s.source.url);else throw new Error("No update source available");if(i.version===s.manifest.version){s.status="installed";return}const n=await this.installApp(i);this.installations.set(e,n),await this.saveInstallations(),this.eventBus.emit("app:updated",{appId:e,oldVersion:s.manifest.version,newVersion:i.version})}catch(i){throw s.status="installed",i}}getAppPermissions(e){var s,i,n,r,o,c,l;const t=[];return(s=e.capabilities)!=null&&s.storage&&t.push("storage"),(i=e.capabilities)!=null&&i.network&&t.push("network"),(n=e.capabilities)!=null&&n.media&&t.push("media"),(r=e.capabilities)!=null&&r.ipc&&t.push("ipc"),(o=e.capabilities)!=null&&o.notifications&&t.push("notifications"),(c=e.capabilities)!=null&&c.clipboard&&t.push("clipboard"),(l=e.capabilities)!=null&&l.geolocation&&t.push("geolocation"),t}generateCSP(e){var s,i,n,r,o,c,l,d,h,u;const t=[];if(t.push("default-src 'self'"),t.push("script-src 'self' 'unsafe-inline'"),t.push("style-src 'self' 'unsafe-inline'"),t.push("img-src 'self' data: blob:"),t.push("font-src 'self' data:"),t.push("connect-src 'self'"),(i=(s=e.capabilities)==null?void 0:s.network)!=null&&i.fetch){const m=e.capabilities.network.fetch;t.push(`connect-src 'self' ${m.join(" ")}`)}if((r=(n=e.capabilities)==null?void 0:n.network)!=null&&r.websocket){const m=e.capabilities.network.websocket;t.push(`connect-src 'self' ${m.join(" ")}`)}return(c=(o=e.capabilities)==null?void 0:o.media)!=null&&c.camera&&t.push("camera 'self'"),(d=(l=e.capabilities)==null?void 0:l.media)!=null&&d.microphone&&t.push("microphone 'self'"),(u=(h=e.capabilities)==null?void 0:h.media)!=null&&u.screen&&t.push("display-capture 'self'"),t.join("; ")}getStorageQuota(e){var r,o;const t=(o=(r=e.capabilities)==null?void 0:r.storage)==null?void 0:o.quota;if(!t)return 100*1024*1024;const s=t.match(/^(\d+)(KB|MB|GB)$/);if(!s)return 100*1024*1024;const i=parseInt(s[1]);switch(s[2]){case"KB":return i*1024;case"MB":return i*1024*1024;case"GB":return i*1024*1024*1024;default:return 100*1024*1024}}async removeAppFiles(e){console.log(`Removing app files for ${e.id}`)}async loadInstallations(){try{console.log("Loading existing installations...")}catch(e){console.error("Failed to load installations:",e)}}async saveInstallation(e){try{console.log(`Saving installation for ${e.id}`)}catch(t){console.error("Failed to save installation:",t)}}async saveInstallations(){try{console.log("Saving all installations...")}catch(e){console.error("Failed to save installations:",e)}}getInstalledApp(e){return this.installations.get(e)}getAllInstalledApps(){return Array.from(this.installations.values())}isAppInstalled(e){const t=this.installations.get(e);return(t==null?void 0:t.status)==="installed"}getAppStatus(e){const t=this.installations.get(e);return t==null?void 0:t.status}}class RuntimeManager{constructor(e,t,s,i){this.sandboxRuntime=new SandboxRuntime(e,t,s,i),this.appLoader=new AppLoader(this.sandboxRuntime,e,t,s,i)}getSandboxRuntime(){return this.sandboxRuntime}getAppLoader(){return this.appLoader}async installApp(e){return this.appLoader.installApp(e)}async loadApp(e,t){return this.appLoader.loadApp(e,t)}async uninstallApp(e){return this.appLoader.uninstallApp(e)}getInstalledApps(){return this.appLoader.getAllInstalledApps()}isAppInstalled(e){return this.appLoader.isAppInstalled(e)}}class BSPLayout{constructor(e){this.root={bounds:e}}insert(e,t){return this.insertIntoNode(this.root,e,t),this.computeLayout(this.root)}insertIntoNode(e,t,s){if(!e.left&&!e.right){const i=s||this.chooseSplit(e.bounds),n=.5,{leftBounds:r,rightBounds:o}=this.splitBounds(e.bounds,i,n);e.window?e.left={bounds:r,window:e.window}:e.left={bounds:r},e.right={bounds:o,window:t},e.split=i,e.ratio=n,delete e.window}else{const i=this.getSize(e.left),n=this.getSize(e.right);i<=n?this.insertIntoNode(e.left,t,s):this.insertIntoNode(e.right,t,s)}}chooseSplit(e){return e.width>e.height?"vertical":"horizontal"}splitBounds(e,t,s){if(t==="vertical"){const i=e.x+e.width*s;return{leftBounds:{x:e.x,y:e.y,width:e.width*s,height:e.height},rightBounds:{x:i,y:e.y,width:e.width*(1-s),height:e.height}}}else{const i=e.y+e.height*s;return{leftBounds:{x:e.x,y:e.y,width:e.width,height:e.height*s},rightBounds:{x:e.x,y:i,width:e.width,height:e.height*(1-s)}}}}getSize(e){return e.window?1:this.getSize(e.left)+this.getSize(e.right)}computeLayout(e){const t=new Map,s=i=>{i.window?t.set(i.window,i.bounds):i.left&&i.right&&(s(i.left),s(i.right))};return s(e),t}remove(e){return this.removeFromNode(this.root,e),this.computeLayout(this.root)}removeFromNode(e,t){return e.window===t?(delete e.window,!0):e.left&&this.removeFromNode(e.left,t)?(e.right&&Object.assign(e,e.right),!0):e.right&&this.removeFromNode(e.right,t)?(e.left&&Object.assign(e,e.left),!0):!1}adjustRatio(e,t){e.ratio=Math.max(.2,Math.min(.8,t));const{leftBounds:s,rightBounds:i}=this.splitBounds(e.bounds,e.split,e.ratio);e.left&&(e.left.bounds=s),e.right&&(e.right.bounds=i),e.left&&this.updateBounds(e.left),e.right&&this.updateBounds(e.right)}updateBounds(e){if(e.split&&e.left&&e.right){const{leftBounds:t,rightBounds:s}=this.splitBounds(e.bounds,e.split,e.ratio||.5);e.left.bounds=t,e.right.bounds=s,this.updateBounds(e.left),this.updateBounds(e.right)}}}class GridLayout{computeGrid(e,t){const s=t.width/t.height;let i=1,n=e,r=1/0;for(let o=1;o<=e;o++){const c=Math.ceil(e/o),l=o/c,d=Math.abs(s-l);d<r&&(r=d,i=o,n=c)}return{cols:i,rows:n,cellWidth:t.width/i,cellHeight:t.height/n}}layout(e,t){const s=this.computeGrid(e.length,t),i=new Map;return e.forEach((n,r)=>{const o=Math.floor(r/s.cols),c=r%s.cols;i.set(n,{x:t.x+c*s.cellWidth,y:t.y+o*s.cellHeight,width:s.cellWidth,height:s.cellHeight})}),i}}class CascadeLayout{constructor(){this.offset=30}layout(e,t){const s=new Map,i=t.width*.6,n=t.height*.6;return e.forEach((r,o)=>{const c=t.x+o*this.offset%(t.width-i),l=t.y+o*this.offset%(t.height-n);s.set(r,{x:c,y:l,width:i,height:n})}),s}}class MasterStackLayout{constructor(){this.masterRatio=.6}layout(e,t){const s=new Map;if(e.length===0)return s;const i=e[0],n=e.slice(1);if(n.length===0)s.set(i,t);else{const r={x:t.x,y:t.y,width:t.width*this.masterRatio,height:t.height};s.set(i,r);const o={x:t.x+r.width,y:t.y,width:t.width*(1-this.masterRatio),height:t.height},c=o.height/n.length;n.forEach((l,d)=>{s.set(l,{x:o.x,y:o.y+d*c,width:o.width,height:c})})}return s}promoteToMaster(e,t){const s=e.indexOf(t);if(s===-1||s===0)return e;const i=[...e];return[i[0],i[s]]=[i[s],i[0]],i}}class AdaptiveLayout{layout(e,t){const s=e.length;return s===1?new Map([[e[0].id,t]]):s===2?this.splitTwo(e,t):s<=4?new GridLayout().layout(e.map(i=>i.id),t):s<=8?this.bspLayout(e,t):new GridLayout().layout(e.map(i=>i.id),t)}splitTwo(e,t){const s=new Map;return t.width>t.height?(s.set(e[0].id,{x:t.x,y:t.y,width:t.width/2,height:t.height}),s.set(e[1].id,{x:t.x+t.width/2,y:t.y,width:t.width/2,height:t.height})):(s.set(e[0].id,{x:t.x,y:t.y,width:t.width,height:t.height/2}),s.set(e[1].id,{x:t.x,y:t.y+t.height/2,width:t.width,height:t.height/2})),s}bspLayout(e,t){const s=new BSPLayout(t);for(const i of e)s.insert(i.id);return s.computeLayout(s.root)}}class WindowManager{constructor(){this.windows=new Map,this.activeWindow=null,this.screenBounds={x:0,y:0,width:1920,height:1080},this.layoutAlgorithm=new AdaptiveLayout}createWindow(e){const t=this.generateWindowId(),s={id:t,appId:e.appId||"system",title:e.title,url:e.url,bounds:{x:e.x??this.screenBounds.width/2-e.width/2,y:e.y??this.screenBounds.height/2-e.height/2,width:e.width,height:e.height},state:"normal",focused:!1,zIndex:this.windows.size+1};return this.windows.set(t,s),this.focusWindow(t),t}closeWindow(e){return this.windows.has(e)?(this.windows.delete(e),this.activeWindow===e&&(this.activeWindow=this.windows.size>0?Array.from(this.windows.keys())[0]:null),!0):!1}focusWindow(e){return this.windows.has(e)?(this.activeWindow=e,!0):!1}minimizeWindow(e){const t=this.windows.get(e);return t?(t.state="minimized",!0):!1}maximizeWindow(e){const t=this.windows.get(e);return t?(t.state==="maximized"?t.state="normal":(t.state="maximized",t.bounds={...this.screenBounds}),!0):!1}resizeWindow(e,t){const s=this.windows.get(e);return!s||s.state==="maximized"?!1:(s.bounds=t,!0)}moveWindow(e,t,s){const i=this.windows.get(e);return!i||i.state==="maximized"?!1:(i.bounds.x=t,i.bounds.y=s,!0)}applyTilingLayout(e){const t=Array.from(this.windows.values()).filter(i=>i.state!=="minimized");if(t.length===0)return;let s;switch(e){case"bsp":const i=new BSPLayout(this.screenBounds);for(const c of t)i.insert(c.id);s=i.computeLayout(i.root);break;case"grid":s=new GridLayout().layout(t.map(c=>c.id),this.screenBounds);break;case"cascade":s=new CascadeLayout().layout(t.map(c=>c.id),this.screenBounds);break;case"master-stack":s=new MasterStackLayout().layout(t.map(c=>c.id),this.screenBounds);break;case"adaptive":default:s=this.layoutAlgorithm.layout(t,this.screenBounds);break}for(const[i,n]of s){const r=this.windows.get(i);r&&(r.bounds=n,r.state="normal")}}getWindows(){return Array.from(this.windows.values())}getActiveWindow(){return this.activeWindow&&this.windows.get(this.activeWindow)||null}getWindow(e){return this.windows.get(e)||null}setScreenBounds(e){this.screenBounds=e}generateWindowId(){return`window-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class FuzzyMatcher{match(e,t){e=e.toLowerCase(),t=t.toLowerCase();const s=[];let i=0,n=0,r=0;for(let c=0;c<t.length&&!(i>=e.length);c++)if(t[c]===e[i]){s.push(c),n+=1;const l=1-c/t.length;n+=l*.5,s.length>1&&s[s.length-1]===s[s.length-2]+1?r+=.3:r=0,n+=r,(c===0||t[c-1]===" "||t[c-1]==="-")&&(n+=.8);const d=e[i],h=t[c];d===h&&(n+=.1),i++}if(i<e.length)return{score:0,matches:[]};const o=n/t.length;return{score:Math.min(o,1),matches:s}}}class MultiFieldSearch{constructor(){this.weights={name:3,description:1.5,tags:2,categories:1,author:.5}}search(e,t){const s=new FuzzyMatcher,i={},n=s.match(e,t.manifest.name);i.name=n.score;const r=s.match(e,t.manifest.description);if(i.description=r.score,t.manifest.tags){const u=t.manifest.tags.map(m=>s.match(e,m).score);i.tags=Math.max(...u,0)}const o=t.manifest.categories.map(u=>s.match(e,u).score);i.categories=Math.max(...o,0);const c=s.match(e,t.author.name);i.author=c.score;let l=0,d=0;for(const[u,m]of Object.entries(i)){const p=this.weights[u];l+=m*p,d+=p}const h=d>0?l/d:0;return{app:t,score:h,fieldScores:i}}}class PersonalizedRanking{constructor(e){this.userProfile=e}personalize(e){return e.map(t=>{let s=1;const i=this.userProfile.appUsage.get(t.app.id)||0;i>0&&(s*=1+Math.log10(i+1)*.3);const n=this.userProfile.lastUsed.get(t.app.id);if(n){const o=(Date.now()-n)/36e5;o<24?s*=1.5:o<168&&(s*=1.2)}for(const o of t.app.manifest.categories){const c=this.userProfile.categoryPreferences.get(o)||0;s*=1+c*.2}return(Date.now()-new Date(t.app.signature.timestamp).getTime())/(1e3*60*60*24)<30&&(s*=1.1),{...t,score:t.score*s}})}}class TFIDFSearch{constructor(){this.idf=new Map,this.totalDocs=0}buildIndex(e){this.totalDocs=e.length;const t=new Map;for(const s of e){const i=this.extractTerms(s),n=new Set(i);for(const r of n)t.set(r,(t.get(r)||0)+1)}for(const[s,i]of t)this.idf.set(s,Math.log(this.totalDocs/i))}score(e,t){const s=this.tokenize(e),i=this.extractTerms(t),n=new Map;for(const c of i)n.set(c,(n.get(c)||0)+1);const r=Math.max(...n.values(),1);for(const[c,l]of n)n.set(c,l/r);let o=0;for(const c of s){const l=n.get(c)||0,d=this.idf.get(c)||0;o+=l*d}return o}extractTerms(e){const t=[e.manifest.name,e.manifest.description,e.manifest.longDescription||"",...e.manifest.tags||[]].join(" ");return this.tokenize(t)}tokenize(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g,"").split(/\s+/).filter(t=>t.length>2)}}class SearchEngine{constructor(e){this.fuzzyMatcher=new FuzzyMatcher,this.multiField=new MultiFieldSearch,this.tfidf=new TFIDFSearch,this.personalizer=new PersonalizedRanking(e)}search(e,t,s){const i=t.map(o=>this.multiField.search(e,o)).filter(o=>o.score>.1);for(const o of i){const c=this.tfidf.score(e,o.app);o.score=o.score*.7+c*.3}for(const o of i){const c=this.getTrustScore(o.app);o.score*=1+c*.5}let r=this.personalizer.personalize(i);return s!=null&&s.categories&&(r=r.filter(o=>o.app.manifest.categories.some(c=>s.categories.includes(c)))),s!=null&&s.minTrust&&(r=r.filter(o=>this.getTrustScore(o.app)>=s.minTrust)),r.sort((o,c)=>c.score-o.score).slice(0,(s==null?void 0:s.limit)||50).map(o=>({app:o.app,score:o.score,trustScore:this.getTrustScore(o.app),highlights:this.getHighlights(e,o.app)}))}getTrustScore(e){return .8}getHighlights(e,t){const i=this.fuzzyMatcher.match(e,t.manifest.name);return{name:{text:t.manifest.name,matches:i.matches}}}}class CommandPalette{constructor(a={}){this.commands=new Map,this.isVisible=!1,this.currentQuery="",this.selectedIndex=0,this.results=[],this.searchEngine=new SearchEngine({appUsage:new Map,lastUsed:new Map,categoryPreferences:new Map})}registerCommand(a){this.commands.set(a.id,a)}unregisterCommand(a){return this.commands.delete(a)}show(){this.isVisible=!0,this.currentQuery="",this.selectedIndex=0,this.results=[],this.render()}hide(){this.isVisible=!1,this.render()}toggle(){this.isVisible?this.hide():this.show()}updateQuery(a){this.currentQuery=a,this.selectedIndex=0,this.search(),this.render()}selectPrevious(){this.results.length>0&&(this.selectedIndex=(this.selectedIndex-1+this.results.length)%this.results.length,this.render())}selectNext(){this.results.length>0&&(this.selectedIndex=(this.selectedIndex+1)%this.results.length,this.render())}executeSelected(){if(this.results.length===0||this.selectedIndex>=this.results.length)return!1;const a=this.results[this.selectedIndex].command;return this.executeCommand(a),this.hide(),!0}executeCommand(a){try{if(typeof a.handler=="function")a.handler();else if(a.action)switch(a.action.type){case"navigate":this.handleNavigateAction(a.action);break;case"execute":this.handleExecuteAction(a.action);break;case"toggle":this.handleToggleAction(a.action);break;default:console.warn("Unknown action type:",a.action.type)}}catch(e){console.error("Error executing command:",e)}}search(){if(!this.currentQuery.trim()){this.results=Array.from(this.commands.values()).map(e=>({command:e,score:1,highlights:{name:{text:e.name,matches:[]}}})).slice(0,10);return}const a=this.searchEngine.search(this.currentQuery,Array.from(this.commands.values()),{limit:10});this.results=a.map(e=>({command:e.app,score:e.score,highlights:e.highlights}))}render(){const a=document.getElementById("command-palette");if(!a)return;if(!this.isVisible){a.style.display="none";return}a.style.display="block";const e=`
      <div class="command-palette-overlay">
        <div class="command-palette-container">
          <div class="command-palette-input">
            <input 
              type="text" 
              placeholder="Type a command..." 
              value="${this.currentQuery}"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <div class="command-palette-results">
            ${this.renderResults()}
          </div>
        </div>
      </div>
    `;a.innerHTML=e;const t=a.querySelector("input");t&&(t.focus(),t.addEventListener("input",s=>{this.updateQuery(s.target.value)}),t.addEventListener("keydown",s=>{this.handleKeyDown(s)}))}renderResults(){return this.results.length===0?'<div class="command-palette-empty">No commands found</div>':this.results.map((a,e)=>{var i;return`
        <div class="${`command-palette-item ${e===this.selectedIndex?"selected":""}`}" data-index="${e}">
          <div class="command-name">
            ${this.highlightText(a.command.name,a.highlights.name.matches)}
          </div>
          ${a.command.description?`
            <div class="command-description">
              ${this.highlightText(a.command.description,((i=a.highlights.description)==null?void 0:i.matches)||[])}
            </div>
          `:""}
          ${a.command.keyboardShortcut?`
            <div class="command-shortcut">
              ${this.formatKeyboardShortcut(a.command.keyboardShortcut)}
            </div>
          `:""}
        </div>
      `}).join("")}highlightText(a,e){if(e.length===0)return a;let t="",s=0;for(const i of e)t+=a.slice(s,i),t+=`<mark>${a[i]}</mark>`,s=i+1;return t+=a.slice(s),t}formatKeyboardShortcut(a){return a.split("+").map(e=>`<kbd>${e.trim()}</kbd>`).join("+")}handleKeyDown(a){switch(a.key){case"Escape":this.hide(),a.preventDefault();break;case"ArrowUp":this.selectPrevious(),a.preventDefault();break;case"ArrowDown":this.selectNext(),a.preventDefault();break;case"Enter":this.executeSelected()&&a.preventDefault();break;case"Tab":a.shiftKey?this.selectPrevious():this.selectNext(),a.preventDefault();break}}handleNavigateAction(a){a.url&&(window.location.href=a.url)}handleExecuteAction(action){if(action.function)try{eval(action.function)}catch(a){console.error("Error executing function:",a)}}handleToggleAction(a){if(a.target){const e=document.querySelector(a.target);e&&e.classList.toggle(a.class||"active")}}}class Dock{constructor(e={}){this.items=new Map,this.runningApps=new Set,this.pinnedApps=new Set,this.listeners=new Map,this.options={position:"bottom",size:"medium",showLabels:!0,showRunningIndicator:!0,...e},this.render()}addApp(e,t,s=!1){const i={id:e.id,manifest:e,icon:t,isRunning:!1,windowCount:0,isPinned:s};this.items.set(e.id,i),s&&this.pinnedApps.add(e.id),this.render()}removeApp(e){const t=this.items.delete(e);return this.pinnedApps.delete(e),this.runningApps.delete(e),t&&this.render(),t}togglePin(e){const t=this.items.get(e);return t?(t.isPinned=!t.isPinned,t.isPinned?this.pinnedApps.add(e):this.pinnedApps.delete(e),this.render(),t.isPinned):!1}setAppRunning(e,t=1){const s=this.items.get(e);s&&(s.isRunning=!0,s.windowCount=t,this.runningApps.add(e),this.render())}setAppStopped(e){const t=this.items.get(e);t&&(t.isRunning=!1,t.windowCount=0,this.runningApps.delete(e),this.render())}updateWindowCount(e,t){const s=this.items.get(e);s&&(s.windowCount=t,this.render())}launchApp(e){const t=this.items.get(e);t&&(this.emit("app-launch",{appId:e,manifest:t.manifest}),this.setAppRunning(e,1))}focusApp(e){this.emit("app-focus",{appId:e})}render(){const e=document.getElementById("dock");if(!e)return;const t=this.getSortedItems(),s=`
      <div class="dock-container ${this.options.position} ${this.options.size}">
        ${t.map(i=>this.renderItem(i)).join("")}
      </div>
    `;e.innerHTML=s,this.addEventListeners()}getSortedItems(){return Array.from(this.items.values()).sort((t,s)=>t.isPinned&&!s.isPinned?-1:!t.isPinned&&s.isPinned?1:t.isRunning&&!s.isRunning?-1:!t.isRunning&&s.isRunning?1:t.manifest.manifest.name.localeCompare(s.manifest.manifest.name))}renderItem(e){return`
      <div class="${["dock-item",e.isRunning?"running":"",e.isPinned?"pinned":"",e.windowCount>1?"multiple-windows":""].filter(Boolean).join(" ")}" data-app-id="${e.id}">
        <div class="dock-icon">
          <img src="${e.icon}" alt="${e.manifest.manifest.name}" />
          ${this.options.showRunningIndicator&&e.isRunning?`
            <div class="running-indicator"></div>
          `:""}
          ${e.windowCount>1?`
            <div class="window-count">${e.windowCount}</div>
          `:""}
        </div>
        ${this.options.showLabels?`
          <div class="dock-label">${e.manifest.manifest.name}</div>
        `:""}
        <div class="dock-tooltip">
          <div class="tooltip-title">${e.manifest.manifest.name}</div>
          <div class="tooltip-description">${e.manifest.manifest.description}</div>
          ${e.isRunning?`
            <div class="tooltip-status">Running (${e.windowCount} window${e.windowCount>1?"s":""})</div>
          `:""}
        </div>
      </div>
    `}addEventListeners(){const e=document.getElementById("dock");e&&(e.addEventListener("click",t=>{const s=t.target.closest(".dock-item");if(!s)return;const i=s.getAttribute("data-app-id");if(!i)return;const n=this.items.get(i);n&&(n.isRunning?this.focusApp(i):this.launchApp(i))}),e.addEventListener("contextmenu",t=>{const s=t.target.closest(".dock-item");if(!s)return;t.preventDefault();const i=s.getAttribute("data-app-id");i&&this.showContextMenu(t,i)}),e.addEventListener("mouseover",t=>{const s=t.target.closest(".dock-item");s&&s.classList.add("hover")}),e.addEventListener("mouseout",t=>{const s=t.target.closest(".dock-item");s&&s.classList.remove("hover")}))}showContextMenu(e,t){const s=this.items.get(t);if(!s)return;const i=document.createElement("div");i.className="dock-context-menu",i.style.left=`${e.clientX}px`,i.style.top=`${e.clientY}px`;const n=[{label:s.isRunning?"Focus":"Launch",action:()=>{s.isRunning?this.focusApp(t):this.launchApp(t)}},{label:s.isPinned?"Unpin":"Pin",action:()=>this.togglePin(t)},{label:"Remove from Dock",action:()=>this.removeApp(t)}];i.innerHTML=n.map(o=>`
      <div class="context-menu-item" data-action="${o.label}">
        ${o.label}
      </div>
    `).join(""),document.body.appendChild(i),i.addEventListener("click",o=>{const c=o.target.closest(".context-menu-item");if(!c)return;const l=c.getAttribute("data-action"),d=n.find(h=>h.label===l);d&&d.action(),document.body.removeChild(i)});const r=()=>{document.body.contains(i)&&document.body.removeChild(i),document.removeEventListener("click",r)};setTimeout(()=>{document.addEventListener("click",r)},0)}updateOptions(e){this.options={...this.options,...e},this.render()}getItems(){return Array.from(this.items.values())}getRunningApps(){return Array.from(this.runningApps)}getPinnedApps(){return Array.from(this.pinnedApps)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}emit(e,t){const s=this.listeners.get(e)||[];for(const i of s)i(t)}}class TrustComputation{constructor(){this.damping=.85,this.iterations=20}computeTrustScores(e){var n;const t=new Map,s=new Map;for(const[r]of e.nodes)t.set(r,e.userTrusted.has(r)?1:0);for(let r=0;r<this.iterations;r++){for(const[o]of e.nodes){let c=0;const l=1-this.damping;e.userTrusted.has(o)&&(c+=l);const d=this.getIncomingEdges(e,o);for(const h of d){const u=t.get(h)||0,m=((n=e.edges.get(h))==null?void 0:n.size)||1;c+=this.damping*(u/m)}s.set(o,c)}t.clear();for(const[o,c]of s)t.set(o,c);s.clear()}const i=Math.max(...t.values());if(i>0)for(const[r,o]of t)t.set(r,o/i);return t}getIncomingEdges(e,t){const s=new Set;for(const[i,n]of e.edges)n.has(t)&&s.add(i);return s}}class ReputationComputation{computeReputation(e){const t=[],s=this.wilsonScore(e.installCount,e.appCount*100);t.push(s),e.avgAppRating>0&&t.push(e.avgAppRating/5);const i=Math.min(e.age/365,1);t.push(i*.5);const n=Math.min(e.updateFrequency/4,1);t.push(n);const r=Math.max(0,1-e.reportCount/10);return t.reduce((c,l)=>c+l,0)/t.length*r}wilsonScore(e,t){if(t===0)return 0;const s=1.96,i=e/t,n=i+s*s/(2*t)-s*Math.sqrt((i*(1-i)+s*s/(4*t))/t),r=1+s*s/t;return Math.max(0,n/r)}}class TrustScoreCalculator{constructor(){this.weights={direct:1,transitive:.6,reputation:.3}}computeFinalScore(e,t){const s=t.userTrusted.has(e)?1:0,r=new TrustComputation().computeTrustScores(t).get(e)||0,o=t.nodes.get(e),l=new ReputationComputation().computeReputation(o),d=this.computeHops(t,e),h=r*Math.pow(.8,d-1),u=this.weights.direct+this.weights.transitive+this.weights.reputation,m=(s*this.weights.direct+h*this.weights.transitive+l*this.weights.reputation)/u;return{direct:s,transitive:h,reputation:l,final:m,computedAt:Date.now(),hops:d}}computeHops(e,t){if(e.userTrusted.has(t))return 0;const s=[],i=new Set;for(const n of e.userTrusted)s.push([n,0]),i.add(n);for(;s.length>0;){const[n,r]=s.shift(),o=e.edges.get(n)||new Set;for(const c of o){if(c===t)return r+1;i.has(c)||(i.add(c),s.push([c,r+1]))}}return 1/0}}class TrustScoreCache{constructor(){this.cache=new Map,this.cacheTTL=1e3*60*60}get(e,t){const s=this.cache.get(e);if(s&&Date.now()-s.computedAt<this.cacheTTL)return s.score;const n=new TrustScoreCalculator().computeFinalScore(e,t);return this.cache.set(e,{score:n,computedAt:Date.now()}),n}invalidate(e){e?this.cache.delete(e):this.cache.clear()}}let kernel=null,storage=null,runtime=null,windowManager=null,commandPalette=null,dock=null,trustCache=null,searchEngine=null;async function initializeGlyphOS(){console.log("🚀 Starting GlyphOS...");try{storage=new KernelStorageManager,await storage.initialize(),console.log("✅ Storage initialized"),kernel=await initializeKernel(),console.log("✅ Kernel initialized"),runtime=new RuntimeManager(kernel.processes,kernel.capabilities,kernel.ipc,kernel.events),console.log("✅ Runtime manager initialized"),windowManager=new WindowManager,commandPalette=new CommandPalette,dock=new Dock,commandPalette.registerCommand({id:"toggle-command-palette",name:"Toggle Command Palette",description:"Open or close the command palette",keyboardShortcut:"Cmd+K",handler:()=>commandPalette.toggle()}),commandPalette.registerCommand({id:"new-window",name:"New Window",description:"Create a new window",keyboardShortcut:"Cmd+N",handler:()=>{windowManager.createWindow({title:"New Window",width:800,height:600})}}),commandPalette.registerCommand({id:"tile-windows",name:"Tile Windows",description:"Arrange windows in a tiled layout",handler:()=>{windowManager.applyTilingLayout("adaptive")}}),dock.addApp({id:"text-editor",manifest:{name:"Text Editor",shortName:"Editor",description:"Simple text editor",longDescription:"A simple text editor for editing files",categories:["productivity"],tags:["editor","text"],icons:[],display:"standalone",orientation:"any",themeColor:"#007acc",backgroundColor:"#1a1a1a",lang:"en",dir:"ltr"},version:"1.0.0",author:{name:"GlyphOS Team",email:"team@glyphd.com",url:"https://glyphd.com",pubkey:"ed25519:abc123...",registry:"https://registry.glyphd.com"},entry:{html:"/apps/text-editor/index.html",integrity:"sha384-abc123..."},capabilities:{storage:{opfs:!0,indexeddb:!0,quota:"100MB"}},signature:{algorithm:"ed25519",publicKey:"ed25519:abc123...",signature:"abc123...",timestamp:new Date().toISOString()}},"/icons/text-editor.png",!0),dock.addApp({id:"file-manager",manifest:{name:"File Manager",shortName:"Files",description:"Browse and manage files",longDescription:"A file manager for browsing and managing files",categories:["tools"],tags:["files","browser"],icons:[],display:"standalone",orientation:"any",themeColor:"#28ca42",backgroundColor:"#1a1a1a",lang:"en",dir:"ltr"},version:"1.0.0",author:{name:"GlyphOS Team",email:"team@glyphd.com",url:"https://glyphd.com",pubkey:"ed25519:def456...",registry:"https://registry.glyphd.com"},entry:{html:"/apps/file-manager/index.html",integrity:"sha384-def456..."},capabilities:{storage:{opfs:!0,indexeddb:!0,quota:"500MB"}},signature:{algorithm:"ed25519",publicKey:"ed25519:def456...",signature:"def456...",timestamp:new Date().toISOString()}},"/icons/file-manager.png",!0),console.log("✅ Desktop environment initialized"),trustCache=new TrustScoreCache,searchEngine=new SearchEngine({appUsage:new Map,lastUsed:new Map,categoryPreferences:new Map}),console.log("✅ Algorithms initialized"),console.log("🎉 GlyphOS ready!")}catch(a){throw console.error("❌ Failed to initialize GlyphOS:",a),a}}function getKernel(){if(!kernel)throw new Error("GlyphOS not initialized");return kernel}function getStorage(){if(!storage)throw new Error("Storage not initialized");return storage}function getRuntime(){if(!runtime)throw new Error("Runtime manager not initialized");return runtime}function getWindowManager(){if(!windowManager)throw new Error("Window manager not initialized");return windowManager}function getCommandPalette(){if(!commandPalette)throw new Error("Command palette not initialized");return commandPalette}function getDock(){if(!dock)throw new Error("Dock not initialized");return dock}function getTrustCache(){if(!trustCache)throw new Error("Trust cache not initialized");return trustCache}function getSearchEngine(){if(!searchEngine)throw new Error("Search engine not initialized");return searchEngine}function isInitialized(){return kernel!==null&&storage!==null&&windowManager!==null}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeGlyphOS):initializeGlyphOS();window.GlyphOS={getKernel,getStorage,getRuntime,getWindowManager,getCommandPalette,getDock,getTrustCache,getSearchEngine,isInitialized};window.addEventListener("load",()=>{setTimeout(()=>{document.getElementById("loading").style.display="none",document.getElementById("desktop").classList.add("loaded")},2e3)});function attachWindowControls(a,e){console.log("Attaching controls to window:",e);const t=a.querySelectorAll(".window-btn");console.log("Found buttons:",t.length),t.forEach((s,i)=>{console.log(`Attaching listener to button ${i}:`,s.dataset.action),s.addEventListener("click",n=>{n.stopPropagation(),n.preventDefault();const r=s.dataset.action;switch(console.log(`Window control clicked: ${r} for window ${e}`),r){case"close":closeWindow(e);break;case"minimize":minimizeWindow(e);break;case"maximize":toggleMaximize(e);break}})})}function closeWindow(a){var e;try{console.log("Closing window:",a);const s=window.GlyphOS.getWindowManager().closeWindow(a);if(console.log("Close result:",s),s){const i=(e=document.querySelector(`[data-window-id="${a}"]`))==null?void 0:e.closest(".window");i&&i.remove(),renderWindows()}}catch(t){console.error("Error closing window:",t)}}function minimizeWindow(a){console.log("Minimizing window:",a),window.GlyphOS.getWindowManager().minimizeWindow(a),renderWindows()}function toggleMaximize(a){console.log("Maximizing window:",a),window.GlyphOS.getWindowManager().maximizeWindow(a),renderWindows()}function renderWindows(){const a=document.getElementById("windows-container"),e=window.GlyphOS.getWindowManager(),t=e.getWindows();console.log("Rendering windows:",t.length,"windows"),console.log("Window IDs:",t.map(s=>s.id)),a.innerHTML="",t.forEach(s=>{console.log("Rendering window:",s.id,s.title);const i=document.createElement("div");i.className=`window ${s.focused?"focused":""}`,i.id=s.id,i.style.left=`${s.bounds.x}px`,i.style.top=`${s.bounds.y}px`,i.style.width=`${s.bounds.width}px`,i.style.height=`${s.bounds.height}px`,i.style.zIndex=s.zIndex,i.innerHTML=`
          <div class="window-header" data-window-id="${s.id}">
            <div class="window-title">${s.title}</div>
            <div class="window-controls">
              <button class="window-btn minimize" data-action="minimize">−</button>
              <button class="window-btn maximize" data-action="maximize">□</button>
              <button class="window-btn close" data-action="close">×</button>
            </div>
          </div>
          <div class="window-body">
            <iframe class="window-content" src="${s.url}" data-window-id="${s.id}" onload="console.log('Window loaded:', this.src)"></iframe>
          </div>
        `,a.appendChild(i),console.log("Window added to DOM:",i.id),attachWindowControls(i,s.id);const n=i.querySelector(".window-btn.close");n?(console.log("Close button found, adding test handler"),console.log("Close button element:",n),console.log("Close button classes:",n.className),console.log("Close button dataset:",n.dataset),n.addEventListener("click",r=>{r.stopPropagation(),r.preventDefault(),console.log("TEST: Close button clicked!"),console.log("TEST: Event object:",r),console.log("TEST: Calling closeWindow with ID:",s.id),closeWindow(s.id)}),console.log("Close button computed style:",s.getComputedStyle(n)),console.log("Close button offset:",n.offsetWidth,"x",n.offsetHeight)):console.log("Close button NOT found!"),i.addEventListener("mousedown",()=>{e.focusWindow(s.id),renderWindows()})})}const panels={apps:document.getElementById("appsPanel"),files:document.getElementById("filesPanel"),market:document.getElementById("marketPanel")};function openPanel(a){var e,t;Object.values(panels).forEach(s=>s==null?void 0:s.classList.remove("active")),(e=panels[a])==null||e.classList.add("active"),document.querySelectorAll(".dock-btn").forEach(s=>s.classList.remove("active")),(t=document.getElementById(`${a}Btn`))==null||t.classList.add("active")}function closeAllPanels(){Object.values(panels).forEach(a=>a==null?void 0:a.classList.remove("active")),document.querySelectorAll(".dock-btn").forEach(a=>a.classList.remove("active"))}document.getElementById("appsBtn").addEventListener("click",()=>openPanel("apps"));document.getElementById("filesBtn").addEventListener("click",()=>openPanel("files"));document.getElementById("marketBtn").addEventListener("click",()=>openPanel("market"));document.addEventListener("keydown",a=>{a.key==="Escape"&&closeAllPanels()});document.addEventListener("click",a=>{!a.target.closest(".panel")&&!a.target.closest(".dock-btn")&&closeAllPanels()});function populateAppsPanel(){const a=document.getElementById("appGrid"),e=[{id:"com.glyphd.notes",name:"Notes",icon:"📝",url:"http://localhost:3000/apps/notes/index.html",description:"Note-taking app",category:"productivity"},{id:"com.glyphd.canvas",name:"Glyph Canvas",icon:"🎨",url:"http://localhost:3000/apps/canvas/index.html",description:"Creative drawing app",category:"creative"},{id:"com.glyphd.collab",name:"Live Collab",icon:"🤝",url:"http://localhost:3000/apps/collab/index.html",description:"Real-time collaboration",category:"productivity"},{id:"com.glyphd.aichat",name:"AI Chat",icon:"🤖",url:"http://localhost:3000/apps/aichat/index.html",description:"Chat with AI",category:"ai"},{id:"com.glyphd.monitor",name:"System Monitor",icon:"📊",url:"http://localhost:3000/apps/monitor/index.html",description:"System performance monitor",category:"tools"},{id:"com.glyphd.command",name:"Command Center",icon:"⚡",url:"http://localhost:3000/apps/command/index.html",description:"App launcher and workflows",category:"tools"},{id:"com.glyphd.memory",name:"Memory Graph",icon:"🧠",url:"http://localhost:3000/apps/memory/index.html",description:"Knowledge graph visualization",category:"ai"},{id:"com.glyphd.studio",name:"Studio Player",icon:"🎬",url:"http://localhost:3000/apps/studio/index.html",description:"Media player and visualizer",category:"creative"},{id:"com.glyphd.focus",name:"Focus",icon:"🎯",url:"http://localhost:3000/apps/focus/index.html",description:"Pomodoro timer and focus tool",category:"productivity"},{id:"com.glyphd.market",name:"Market",icon:"🏪",url:"http://localhost:3000/apps/market/index.html",description:"App store and discovery",category:"tools"}];a.innerHTML="",e.forEach(t=>{const s=document.createElement("div");s.className="app-item",s.dataset.category=t.category,s.title=t.description,s.innerHTML=`
          <div class="app-item-icon">${t.icon}</div>
          <div class="app-item-name">${t.name}</div>
        `,s.addEventListener("click",()=>{launchApp(t),closeAllPanels()}),a.appendChild(s)})}document.querySelectorAll(".category-chip").forEach(a=>{a.addEventListener("click",()=>{document.querySelectorAll(".category-chip").forEach(s=>s.classList.remove("active")),a.classList.add("active");const e=a.dataset.category;document.querySelectorAll(".app-item").forEach(s=>{e==="all"||s.dataset.category===e?s.style.display="flex":s.style.display="none"})})});document.getElementById("appSearch").addEventListener("input",a=>{const e=a.target.value.toLowerCase();document.querySelectorAll(".app-item").forEach(s=>{s.querySelector(".app-item-name").textContent.toLowerCase().includes(e)?s.style.display="flex":s.style.display="none"})});function populateMarketPanel(){const a=document.getElementById("featuredApps"),e=document.getElementById("marketGrid"),t=[{name:"AI Assistant",icon:"🤖",desc:"Advanced AI helper"},{name:"Code Editor",icon:"💻",desc:"Full-featured code editor"},{name:"Design Tool",icon:"🎨",desc:"Professional design suite"}];a.innerHTML=t.map(i=>`
        <div class="market-app">
          <div class="market-app-icon">${i.icon}</div>
          <div class="market-app-name">${i.name}</div>
          <div class="market-app-desc">${i.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join("");const s=[{name:"Calculator",icon:"🧮",desc:"Scientific calculator"},{name:"Calendar",icon:"📅",desc:"Event management"},{name:"Weather",icon:"🌤️",desc:"Weather forecast"},{name:"Music Player",icon:"🎵",desc:"Audio player"},{name:"Photo Editor",icon:"📸",desc:"Image editing"},{name:"Task Manager",icon:"✅",desc:"Task organization"}];e.innerHTML=s.map(i=>`
        <div class="market-app">
          <div class="market-app-icon">${i.icon}</div>
          <div class="market-app-name">${i.name}</div>
          <div class="market-app-desc">${i.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join("")}function launchApp(a){try{const t=window.GlyphOS.getWindowManager().createWindow({appId:a.id,title:a.name,url:a.url,width:800,height:600,x:Math.random()*200+100,y:Math.random()*200+100});console.log(`${a.name} launched with window ID:`,t),renderWindows()}catch(e){console.error(`Failed to launch ${a.name}:`,e)}}window.addEventListener("load",()=>{setTimeout(()=>{document.getElementById("loading").style.display="none",document.getElementById("desktop").classList.add("loaded"),populateAppsPanel(),populateMarketPanel()},2e3)});document.addEventListener("keydown",a=>{(a.metaKey||a.ctrlKey)&&a.key===" "&&(a.preventDefault(),openPanel("apps"))});
