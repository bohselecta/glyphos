(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const create$5=()=>new Map,copy=n=>{const e=create$5();return n.forEach((t,r)=>{e.set(r,t)}),e},setIfUndefined=(n,e,t)=>{let r=n.get(e);return r===void 0&&n.set(e,r=t()),r},map=(n,e)=>{const t=[];for(const[r,s]of n)t.push(e(s,r));return t},any=(n,e)=>{for(const[t,r]of n)if(e(r,t))return!0;return!1},create$4=()=>new Set,last=n=>n[n.length-1],appendTo=(n,e)=>{for(let t=0;t<e.length;t++)n.push(e[t])},from=Array.from,isArray=Array.isArray;class ObservableV2{constructor(){this._observers=create$5()}on(e,t){return setIfUndefined(this._observers,e,create$4).add(t),t}once(e,t){const r=(...s)=>{this.off(e,r),t(...s)};this.on(e,r)}off(e,t){const r=this._observers.get(e);r!==void 0&&(r.delete(t),r.size===0&&this._observers.delete(e))}emit(e,t){return from((this._observers.get(e)||create$5()).values()).forEach(r=>r(...t))}destroy(){this._observers=create$5()}}class Observable{constructor(){this._observers=create$5()}on(e,t){setIfUndefined(this._observers,e,create$4).add(t)}once(e,t){const r=(...s)=>{this.off(e,r),t(...s)};this.on(e,r)}off(e,t){const r=this._observers.get(e);r!==void 0&&(r.delete(t),r.size===0&&this._observers.delete(e))}emit(e,t){return from((this._observers.get(e)||create$5()).values()).forEach(r=>r(...t))}destroy(){this._observers=create$5()}}const floor=Math.floor,abs=Math.abs,log10=Math.log10,min=(n,e)=>n<e?n:e,max=(n,e)=>n>e?n:e,isNegativeZero=n=>n!==0?n<0:1/n<0,BIT1=1,BIT2=2,BIT3=4,BIT4=8,BIT6=32,BIT7=64,BIT8=128,BITS5=31,BITS6=63,BITS7=127,BITS31=2147483647,MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER,isInteger=Number.isInteger||(n=>typeof n=="number"&&isFinite(n)&&floor(n)===n),fromCharCode=String.fromCharCode,toLowerCase=n=>n.toLowerCase(),trimLeftRegex=/^\s*/g,trimLeft=n=>n.replace(trimLeftRegex,""),fromCamelCaseRegex=/([A-Z])/g,fromCamelCase=(n,e)=>trimLeft(n.replace(fromCamelCaseRegex,t=>`${e}${toLowerCase(t)}`)),_encodeUtf8Polyfill=n=>{const e=unescape(encodeURIComponent(n)),t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.codePointAt(s);return r},utf8TextEncoder=typeof TextEncoder<"u"?new TextEncoder:null,_encodeUtf8Native=n=>utf8TextEncoder.encode(n),encodeUtf8=utf8TextEncoder?_encodeUtf8Native:_encodeUtf8Polyfill;let utf8TextDecoder=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});utf8TextDecoder&&utf8TextDecoder.decode(new Uint8Array).length===1&&(utf8TextDecoder=null);class Encoder{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const createEncoder=()=>new Encoder,length$1=n=>{let e=n.cpos;for(let t=0;t<n.bufs.length;t++)e+=n.bufs[t].length;return e},toUint8Array=n=>{const e=new Uint8Array(length$1(n));let t=0;for(let r=0;r<n.bufs.length;r++){const s=n.bufs[r];e.set(s,t),t+=s.length}return e.set(new Uint8Array(n.cbuf.buffer,0,n.cpos),t),e},verifyLen=(n,e)=>{const t=n.cbuf.length;t-n.cpos<e&&(n.bufs.push(new Uint8Array(n.cbuf.buffer,0,n.cpos)),n.cbuf=new Uint8Array(max(t,e)*2),n.cpos=0)},write=(n,e)=>{const t=n.cbuf.length;n.cpos===t&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(t*2),n.cpos=0),n.cbuf[n.cpos++]=e},writeUint8=write,writeVarUint=(n,e)=>{for(;e>BITS7;)write(n,BIT8|BITS7&e),e=floor(e/128);write(n,BITS7&e)},writeVarInt=(n,e)=>{const t=isNegativeZero(e);for(t&&(e=-e),write(n,(e>BITS6?BIT8:0)|(t?BIT7:0)|BITS6&e),e=floor(e/64);e>0;)write(n,(e>BITS7?BIT8:0)|BITS7&e),e=floor(e/128)},_strBuffer=new Uint8Array(3e4),_maxStrBSize=_strBuffer.length/3,_writeVarStringNative=(n,e)=>{if(e.length<_maxStrBSize){const t=utf8TextEncoder.encodeInto(e,_strBuffer).written||0;writeVarUint(n,t);for(let r=0;r<t;r++)write(n,_strBuffer[r])}else writeVarUint8Array(n,encodeUtf8(e))},_writeVarStringPolyfill=(n,e)=>{const t=unescape(encodeURIComponent(e)),r=t.length;writeVarUint(n,r);for(let s=0;s<r;s++)write(n,t.codePointAt(s))},writeVarString=utf8TextEncoder&&utf8TextEncoder.encodeInto?_writeVarStringNative:_writeVarStringPolyfill,writeUint8Array=(n,e)=>{const t=n.cbuf.length,r=n.cpos,s=min(t-r,e.length),i=e.length-s;n.cbuf.set(e.subarray(0,s),r),n.cpos+=s,i>0&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(max(t*2,i)),n.cbuf.set(e.subarray(s)),n.cpos=i)},writeVarUint8Array=(n,e)=>{writeVarUint(n,e.byteLength),writeUint8Array(n,e)},writeOnDataView=(n,e)=>{verifyLen(n,e);const t=new DataView(n.cbuf.buffer,n.cpos,e);return n.cpos+=e,t},writeFloat32=(n,e)=>writeOnDataView(n,4).setFloat32(0,e,!1),writeFloat64=(n,e)=>writeOnDataView(n,8).setFloat64(0,e,!1),writeBigInt64=(n,e)=>writeOnDataView(n,8).setBigInt64(0,e,!1),floatTestBed=new DataView(new ArrayBuffer(4)),isFloat32=n=>(floatTestBed.setFloat32(0,n),floatTestBed.getFloat32(0)===n),writeAny=(n,e)=>{switch(typeof e){case"string":write(n,119),writeVarString(n,e);break;case"number":isInteger(e)&&abs(e)<=BITS31?(write(n,125),writeVarInt(n,e)):isFloat32(e)?(write(n,124),writeFloat32(n,e)):(write(n,123),writeFloat64(n,e));break;case"bigint":write(n,122),writeBigInt64(n,e);break;case"object":if(e===null)write(n,126);else if(isArray(e)){write(n,117),writeVarUint(n,e.length);for(let t=0;t<e.length;t++)writeAny(n,e[t])}else if(e instanceof Uint8Array)write(n,116),writeVarUint8Array(n,e);else{write(n,118);const t=Object.keys(e);writeVarUint(n,t.length);for(let r=0;r<t.length;r++){const s=t[r];writeVarString(n,s),writeAny(n,e[s])}}break;case"boolean":write(n,e?120:121);break;default:write(n,127)}};class RleEncoder extends Encoder{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&writeVarUint(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const flushUintOptRleEncoder=n=>{n.count>0&&(writeVarInt(n.encoder,n.count===1?n.s:-n.s),n.count>1&&writeVarUint(n.encoder,n.count-2))};class UintOptRleEncoder{constructor(){this.encoder=new Encoder,this.s=0,this.count=0}write(e){this.s===e?this.count++:(flushUintOptRleEncoder(this),this.count=1,this.s=e)}toUint8Array(){return flushUintOptRleEncoder(this),toUint8Array(this.encoder)}}const flushIntDiffOptRleEncoder=n=>{if(n.count>0){const e=n.diff*2+(n.count===1?0:1);writeVarInt(n.encoder,e),n.count>1&&writeVarUint(n.encoder,n.count-2)}};class IntDiffOptRleEncoder{constructor(){this.encoder=new Encoder,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(flushIntDiffOptRleEncoder(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return flushIntDiffOptRleEncoder(this),toUint8Array(this.encoder)}}class StringEncoder{constructor(){this.sarr=[],this.s="",this.lensE=new UintOptRleEncoder}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new Encoder;return this.sarr.push(this.s),this.s="",writeVarString(e,this.sarr.join("")),writeUint8Array(e,this.lensE.toUint8Array()),toUint8Array(e)}}const create$3=n=>new Error(n),methodUnimplemented=()=>{throw create$3("Method unimplemented")},unexpectedCase=()=>{throw create$3("Unexpected case")},errorUnexpectedEndOfArray=create$3("Unexpected end of array"),errorIntegerOutOfRange=create$3("Integer out of Range");class Decoder{constructor(e){this.arr=e,this.pos=0}}const createDecoder=n=>new Decoder(n),hasContent=n=>n.pos!==n.arr.length,readUint8Array=(n,e)=>{const t=new Uint8Array(n.arr.buffer,n.pos+n.arr.byteOffset,e);return n.pos+=e,t},readVarUint8Array=n=>readUint8Array(n,readVarUint(n)),readUint8=n=>n.arr[n.pos++],readVarUint=n=>{let e=0,t=1;const r=n.arr.length;for(;n.pos<r;){const s=n.arr[n.pos++];if(e=e+(s&BITS7)*t,t*=128,s<BIT8)return e;if(e>MAX_SAFE_INTEGER)throw errorIntegerOutOfRange}throw errorUnexpectedEndOfArray},readVarInt=n=>{let e=n.arr[n.pos++],t=e&BITS6,r=64;const s=(e&BIT7)>0?-1:1;if(!(e&BIT8))return s*t;const i=n.arr.length;for(;n.pos<i;){if(e=n.arr[n.pos++],t=t+(e&BITS7)*r,r*=128,e<BIT8)return s*t;if(t>MAX_SAFE_INTEGER)throw errorIntegerOutOfRange}throw errorUnexpectedEndOfArray},_readVarStringPolyfill=n=>{let e=readVarUint(n);if(e===0)return"";{let t=String.fromCodePoint(readUint8(n));if(--e<100)for(;e--;)t+=String.fromCodePoint(readUint8(n));else for(;e>0;){const r=e<1e4?e:1e4,s=n.arr.subarray(n.pos,n.pos+r);n.pos+=r,t+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(t))}},_readVarStringNative=n=>utf8TextDecoder.decode(readVarUint8Array(n)),readVarString=utf8TextDecoder?_readVarStringNative:_readVarStringPolyfill,readFromDataView=(n,e)=>{const t=new DataView(n.arr.buffer,n.arr.byteOffset+n.pos,e);return n.pos+=e,t},readFloat32=n=>readFromDataView(n,4).getFloat32(0,!1),readFloat64=n=>readFromDataView(n,8).getFloat64(0,!1),readBigInt64=n=>readFromDataView(n,8).getBigInt64(0,!1),readAnyLookupTable=[n=>{},n=>null,readVarInt,readFloat32,readFloat64,readBigInt64,n=>!1,n=>!0,readVarString,n=>{const e=readVarUint(n),t={};for(let r=0;r<e;r++){const s=readVarString(n);t[s]=readAny(n)}return t},n=>{const e=readVarUint(n),t=[];for(let r=0;r<e;r++)t.push(readAny(n));return t},readVarUint8Array],readAny=n=>readAnyLookupTable[127-readUint8(n)](n);class RleDecoder extends Decoder{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),hasContent(this)?this.count=readVarUint(this)+1:this.count=-1),this.count--,this.s}}class UintOptRleDecoder extends Decoder{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=readVarInt(this);const e=isNegativeZero(this.s);this.count=1,e&&(this.s=-this.s,this.count=readVarUint(this)+2)}return this.count--,this.s}}class IntDiffOptRleDecoder extends Decoder{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=readVarInt(this),t=e&1;this.diff=floor(e/2),this.count=1,t&&(this.count=readVarUint(this)+2)}return this.s+=this.diff,this.count--,this.s}}class StringDecoder{constructor(e){this.decoder=new UintOptRleDecoder(e),this.str=readVarString(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}const getRandomValues=crypto.getRandomValues.bind(crypto),rand=Math.random,uint32=()=>getRandomValues(new Uint32Array(1))[0],uuidv4Template="10000000-1000-4000-8000"+-1e11,uuidv4=()=>uuidv4Template.replace(/[018]/g,n=>(n^uint32()&15>>n/4).toString(16)),getUnixTime=Date.now,create$2=n=>new Promise(n);Promise.all.bind(Promise);const reject=n=>Promise.reject(n),resolve=n=>Promise.resolve(n),undefinedToNull=n=>n===void 0?null:n;class VarStoragePolyfill{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}}let _localStorage=new VarStoragePolyfill,usePolyfill=!0;try{typeof localStorage<"u"&&localStorage&&(_localStorage=localStorage,usePolyfill=!1)}catch{}const varStorage=_localStorage,onChange=n=>usePolyfill||addEventListener("storage",n),offChange=n=>usePolyfill||removeEventListener("storage",n),assign=Object.assign,keys=Object.keys,forEach=(n,e)=>{for(const t in n)e(n[t],t)},length=n=>keys(n).length,size=n=>keys(n).length,isEmpty=n=>{for(const e in n)return!1;return!0},every=(n,e)=>{for(const t in n)if(!e(n[t],t))return!1;return!0},hasProperty=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),equalFlat=(n,e)=>n===e||size(n)===size(e)&&every(n,(t,r)=>(t!==void 0||hasProperty(e,r))&&e[r]===t),freeze=Object.freeze,deepFreeze=n=>{for(const e in n){const t=n[e];(typeof t=="object"||typeof t=="function")&&deepFreeze(n[e])}return freeze(n)},EqualityTraitSymbol=Symbol("Equality"),callAll=(n,e,t=0)=>{try{for(;t<n.length;t++)n[t](...e)}finally{t<n.length&&callAll(n,e,t+1)}},nop=()=>{},id=n=>n,equalityDeep=(n,e)=>{if(n===e)return!0;if(n==null||e==null||n.constructor!==e.constructor)return!1;if(n[EqualityTraitSymbol]!=null)return n[EqualityTraitSymbol](e);switch(n.constructor){case ArrayBuffer:n=new Uint8Array(n),e=new Uint8Array(e);case Uint8Array:{if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.length;t++)if(n[t]!==e[t])return!1;break}case Set:{if(n.size!==e.size)return!1;for(const t of n)if(!e.has(t))return!1;break}case Map:{if(n.size!==e.size)return!1;for(const t of n.keys())if(!e.has(t)||!equalityDeep(n.get(t),e.get(t)))return!1;break}case Object:if(length(n)!==length(e))return!1;for(const t in n)if(!hasProperty(n,t)||!equalityDeep(n[t],e[t]))return!1;break;case Array:if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!equalityDeep(n[t],e[t]))return!1;break;default:return!1}return!0},isOneOf=(n,e)=>e.includes(n);var define_process_env_default={};const isNode=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",isBrowser=typeof window<"u"&&typeof document<"u"&&!isNode;let params;const computeParams=()=>{if(params===void 0)if(isNode){params=create$5();const n=process.argv;let e=null;for(let t=0;t<n.length;t++){const r=n[t];r[0]==="-"?(e!==null&&params.set(e,""),e=r):e!==null&&(params.set(e,r),e=null)}e!==null&&params.set(e,"")}else typeof location=="object"?(params=create$5(),(location.search||"?").slice(1).split("&").forEach(n=>{if(n.length!==0){const[e,t]=n.split("=");params.set(`--${fromCamelCase(e,"-")}`,t),params.set(`-${fromCamelCase(e,"-")}`,t)}})):params=create$5();return params},hasParam=n=>computeParams().has(n),getVariable=n=>undefinedToNull(isNode?define_process_env_default[n.toUpperCase().replaceAll("-","_")]:varStorage.getItem(n)),hasConf=n=>hasParam("--"+n)||getVariable(n)!==null;hasConf("production");const forceColor=isNode&&isOneOf(define_process_env_default.FORCE_COLOR,["true","1","2"]),supportsColor=forceColor||!hasParam("--no-colors")&&!hasConf("no-color")&&(!isNode||process.stdout.isTTY)&&(!isNode||hasParam("--color")||getVariable("COLORTERM")!==null||(getVariable("TERM")||"").includes("color")),createUint8ArrayFromLen=n=>new Uint8Array(n),createUint8ArrayViewFromArrayBuffer=(n,e,t)=>new Uint8Array(n,e,t),createUint8ArrayFromArrayBuffer=n=>new Uint8Array(n),toBase64Browser=n=>{let e="";for(let t=0;t<n.byteLength;t++)e+=fromCharCode(n[t]);return btoa(e)},toBase64Node=n=>Buffer.from(n.buffer,n.byteOffset,n.byteLength).toString("base64"),fromBase64Browser=n=>{const e=atob(n),t=createUint8ArrayFromLen(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t},fromBase64Node=n=>{const e=Buffer.from(n,"base64");return createUint8ArrayViewFromArrayBuffer(e.buffer,e.byteOffset,e.byteLength)},toBase64=isBrowser?toBase64Browser:toBase64Node,fromBase64=isBrowser?fromBase64Browser:fromBase64Node,copyUint8Array=n=>{const e=createUint8ArrayFromLen(n.byteLength);return e.set(n),e};class Pair{constructor(e,t){this.left=e,this.right=t}}const create$1=(n,e)=>new Pair(n,e);typeof DOMParser<"u"&&new DOMParser;const mapToStyleString=n=>map(n,(e,t)=>`${t}:${e};`).join(""),stringify=JSON.stringify,create=Symbol,BOLD=create(),UNBOLD=create(),BLUE=create(),GREY=create(),GREEN=create(),RED=create(),PURPLE=create(),ORANGE=create(),UNCOLOR=create(),computeNoColorLoggingArgs=n=>{var s;n.length===1&&((s=n[0])==null?void 0:s.constructor)===Function&&(n=n[0]());const e=[],t=[];let r=0;for(;r<n.length;r++){const i=n[r];if(i===void 0)break;if(i.constructor===String||i.constructor===Number)e.push(i);else if(i.constructor===Object)break}for(r>0&&t.push(e.join(""));r<n.length;r++){const i=n[r];i instanceof Symbol||t.push(i)}return t},loggingColors=[GREEN,PURPLE,ORANGE,BLUE];let nextColor=0,lastLoggingTime=getUnixTime();const createModuleLogger$1=(n,e)=>{const t=loggingColors[nextColor],r=getVariable("log"),s=r!==null&&(r==="*"||r==="true"||new RegExp(r,"gi").test(e));return nextColor=(nextColor+1)%loggingColors.length,e+=": ",s?(...i)=>{var l;i.length===1&&((l=i[0])==null?void 0:l.constructor)===Function&&(i=i[0]());const a=getUnixTime(),c=a-lastLoggingTime;lastLoggingTime=a,n(t,e,UNCOLOR,...i.map(p=>{switch(p!=null&&p.constructor===Uint8Array&&(p=Array.from(p)),typeof p){case"string":case"symbol":return p;default:return stringify(p)}}),t," +"+c+"ms")}:nop},_browserStyleMap={[BOLD]:create$1("font-weight","bold"),[UNBOLD]:create$1("font-weight","normal"),[BLUE]:create$1("color","blue"),[GREEN]:create$1("color","green"),[GREY]:create$1("color","grey"),[RED]:create$1("color","red"),[PURPLE]:create$1("color","purple"),[ORANGE]:create$1("color","orange"),[UNCOLOR]:create$1("color","black")},computeBrowserLoggingArgs=n=>{var a;n.length===1&&((a=n[0])==null?void 0:a.constructor)===Function&&(n=n[0]());const e=[],t=[],r=create$5();let s=[],i=0;for(;i<n.length;i++){const c=n[i],l=_browserStyleMap[c];if(l!==void 0)r.set(l.left,l.right);else{if(c===void 0)break;if(c.constructor===String||c.constructor===Number){const p=mapToStyleString(r);i>0||p.length>0?(e.push("%c"+c),t.push(p)):e.push(c)}else break}}for(i>0&&(s=t,s.unshift(e.join("")));i<n.length;i++){const c=n[i];c instanceof Symbol||s.push(c)}return s},computeLoggingArgs=supportsColor?computeBrowserLoggingArgs:computeNoColorLoggingArgs,print=(...n)=>{console.log(...computeLoggingArgs(n)),vconsoles.forEach(e=>e.print(n))},warn=(...n)=>{console.warn(...computeLoggingArgs(n)),n.unshift(ORANGE),vconsoles.forEach(e=>e.print(n))},vconsoles=create$4(),createModuleLogger=n=>createModuleLogger$1(print,n),createIterator=n=>({[Symbol.iterator](){return this},next:n}),iteratorFilter=(n,e)=>createIterator(()=>{let t;do t=n.next();while(!t.done&&!e(t.value));return t}),iteratorMap=(n,e)=>createIterator(()=>{const{done:t,value:r}=n.next();return{done:t,value:t?void 0:e(r)}});class DeleteItem{constructor(e,t){this.clock=e,this.len=t}}class DeleteSet{constructor(){this.clients=new Map}}const iterateDeletedStructs=(n,e,t)=>e.clients.forEach((r,s)=>{const i=n.doc.store.clients.get(s);if(i!=null){const a=i[i.length-1],c=a.id.clock+a.length;for(let l=0,p=r[l];l<r.length&&p.clock<c;p=r[++l])iterateStructs(n,i,p.clock,p.len,t)}}),findIndexDS=(n,e)=>{let t=0,r=n.length-1;for(;t<=r;){const s=floor((t+r)/2),i=n[s],a=i.clock;if(a<=e){if(e<a+i.len)return s;t=s+1}else r=s-1}return null},isDeleted=(n,e)=>{const t=n.clients.get(e.client);return t!==void 0&&findIndexDS(t,e.clock)!==null},sortAndMergeDeleteSet=n=>{n.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let t,r;for(t=1,r=1;t<e.length;t++){const s=e[r-1],i=e[t];s.clock+s.len>=i.clock?s.len=max(s.len,i.clock+i.len-s.clock):(r<t&&(e[r]=i),r++)}e.length=r})},mergeDeleteSets=n=>{const e=new DeleteSet;for(let t=0;t<n.length;t++)n[t].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let a=t+1;a<n.length;a++)appendTo(i,n[a].clients.get(s)||[]);e.clients.set(s,i)}});return sortAndMergeDeleteSet(e),e},addToDeleteSet=(n,e,t,r)=>{setIfUndefined(n.clients,e,()=>[]).push(new DeleteItem(t,r))},createDeleteSet=()=>new DeleteSet,createDeleteSetFromStructStore=n=>{const e=createDeleteSet();return n.clients.forEach((t,r)=>{const s=[];for(let i=0;i<t.length;i++){const a=t[i];if(a.deleted){const c=a.id.clock;let l=a.length;if(i+1<t.length)for(let p=t[i+1];i+1<t.length&&p.deleted;p=t[++i+1])l+=p.length;s.push(new DeleteItem(c,l))}}s.length>0&&e.clients.set(r,s)}),e},writeDeleteSet=(n,e)=>{writeVarUint(n.restEncoder,e.clients.size),from(e.clients.entries()).sort((t,r)=>r[0]-t[0]).forEach(([t,r])=>{n.resetDsCurVal(),writeVarUint(n.restEncoder,t);const s=r.length;writeVarUint(n.restEncoder,s);for(let i=0;i<s;i++){const a=r[i];n.writeDsClock(a.clock),n.writeDsLen(a.len)}})},readDeleteSet=n=>{const e=new DeleteSet,t=readVarUint(n.restDecoder);for(let r=0;r<t;r++){n.resetDsCurVal();const s=readVarUint(n.restDecoder),i=readVarUint(n.restDecoder);if(i>0){const a=setIfUndefined(e.clients,s,()=>[]);for(let c=0;c<i;c++)a.push(new DeleteItem(n.readDsClock(),n.readDsLen()))}}return e},readAndApplyDeleteSet=(n,e,t)=>{const r=new DeleteSet,s=readVarUint(n.restDecoder);for(let i=0;i<s;i++){n.resetDsCurVal();const a=readVarUint(n.restDecoder),c=readVarUint(n.restDecoder),l=t.clients.get(a)||[],p=getState(t,a);for(let m=0;m<c;m++){const h=n.readDsClock(),f=h+n.readDsLen();if(h<p){p<f&&addToDeleteSet(r,a,p,f-p);let y=findIndexSS(l,h),g=l[y];for(!g.deleted&&g.id.clock<h&&(l.splice(y+1,0,splitItem(e,g,h-g.id.clock)),y++);y<l.length&&(g=l[y++],g.id.clock<f);)g.deleted||(f<g.id.clock+g.length&&l.splice(y,0,splitItem(e,g,f-g.id.clock)),g.delete(e))}else addToDeleteSet(r,a,h,f-h)}}if(r.clients.size>0){const i=new UpdateEncoderV2;return writeVarUint(i.restEncoder,0),writeDeleteSet(i,r),i.toUint8Array()}return null},generateNewClientId=uint32;class Doc extends ObservableV2{constructor({guid:e=uuidv4(),collectionid:t=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:a=!1,shouldLoad:c=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=generateNewClientId(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new StructStore,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=a,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=create$2(p=>{this.on("load",()=>{this.isLoaded=!0,p(this)})});const l=()=>create$2(p=>{const m=h=>{(h===void 0||h===!0)&&(this.off("sync",m),p())};this.on("sync",m)});this.on("sync",p=>{p===!1&&this.isSynced&&(this.whenSynced=l()),this.isSynced=p===void 0||p===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){const e=this._item;e!==null&&!this.shouldLoad&&transact$1(e.parent.doc,t=>{t.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(from(this.subdocs).map(e=>e.guid))}transact(e,t=null){return transact$1(this,e,t)}get(e,t=AbstractType){const r=setIfUndefined(this.share,e,()=>{const i=new t;return i._integrate(this,null),i}),s=r.constructor;if(t!==AbstractType&&s!==t)if(s===AbstractType){const i=new t;i._map=r._map,r._map.forEach(a=>{for(;a!==null;a=a.left)a.parent=i}),i._start=r._start;for(let a=i._start;a!==null;a=a.right)a.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,YArray)}getText(e=""){return this.get(e,YText)}getMap(e=""){return this.get(e,YMap)}getXmlElement(e=""){return this.get(e,YXmlElement)}getXmlFragment(e=""){return this.get(e,YXmlFragment)}toJSON(){const e={};return this.share.forEach((t,r)=>{e[r]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,from(this.subdocs).forEach(t=>t.destroy());const e=this._item;if(e!==null){this._item=null;const t=e.content;t.doc=new Doc({guid:this.guid,...t.opts,shouldLoad:!1}),t.doc._item=e,transact$1(e.parent.doc,r=>{const s=t.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class DSDecoderV1{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return readVarUint(this.restDecoder)}readDsLen(){return readVarUint(this.restDecoder)}}class UpdateDecoderV1 extends DSDecoderV1{readLeftID(){return createID(readVarUint(this.restDecoder),readVarUint(this.restDecoder))}readRightID(){return createID(readVarUint(this.restDecoder),readVarUint(this.restDecoder))}readClient(){return readVarUint(this.restDecoder)}readInfo(){return readUint8(this.restDecoder)}readString(){return readVarString(this.restDecoder)}readParentInfo(){return readVarUint(this.restDecoder)===1}readTypeRef(){return readVarUint(this.restDecoder)}readLen(){return readVarUint(this.restDecoder)}readAny(){return readAny(this.restDecoder)}readBuf(){return copyUint8Array(readVarUint8Array(this.restDecoder))}readJSON(){return JSON.parse(readVarString(this.restDecoder))}readKey(){return readVarString(this.restDecoder)}}class DSDecoderV2{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=readVarUint(this.restDecoder),this.dsCurrVal}readDsLen(){const e=readVarUint(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class UpdateDecoderV2 extends DSDecoderV2{constructor(e){super(e),this.keys=[],readVarUint(e),this.keyClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(e)),this.clientDecoder=new UintOptRleDecoder(readVarUint8Array(e)),this.leftClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(e)),this.rightClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(e)),this.infoDecoder=new RleDecoder(readVarUint8Array(e),readUint8),this.stringDecoder=new StringDecoder(readVarUint8Array(e)),this.parentInfoDecoder=new RleDecoder(readVarUint8Array(e),readUint8),this.typeRefDecoder=new UintOptRleDecoder(readVarUint8Array(e)),this.lenDecoder=new UintOptRleDecoder(readVarUint8Array(e))}readLeftID(){return new ID(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new ID(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return readAny(this.restDecoder)}readBuf(){return readVarUint8Array(this.restDecoder)}readJSON(){return readAny(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const t=this.stringDecoder.read();return this.keys.push(t),t}}}class DSEncoderV1{constructor(){this.restEncoder=createEncoder()}toUint8Array(){return toUint8Array(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){writeVarUint(this.restEncoder,e)}writeDsLen(e){writeVarUint(this.restEncoder,e)}}class UpdateEncoderV1 extends DSEncoderV1{writeLeftID(e){writeVarUint(this.restEncoder,e.client),writeVarUint(this.restEncoder,e.clock)}writeRightID(e){writeVarUint(this.restEncoder,e.client),writeVarUint(this.restEncoder,e.clock)}writeClient(e){writeVarUint(this.restEncoder,e)}writeInfo(e){writeUint8(this.restEncoder,e)}writeString(e){writeVarString(this.restEncoder,e)}writeParentInfo(e){writeVarUint(this.restEncoder,e?1:0)}writeTypeRef(e){writeVarUint(this.restEncoder,e)}writeLen(e){writeVarUint(this.restEncoder,e)}writeAny(e){writeAny(this.restEncoder,e)}writeBuf(e){writeVarUint8Array(this.restEncoder,e)}writeJSON(e){writeVarString(this.restEncoder,JSON.stringify(e))}writeKey(e){writeVarString(this.restEncoder,e)}}class DSEncoderV2{constructor(){this.restEncoder=createEncoder(),this.dsCurrVal=0}toUint8Array(){return toUint8Array(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const t=e-this.dsCurrVal;this.dsCurrVal=e,writeVarUint(this.restEncoder,t)}writeDsLen(e){e===0&&unexpectedCase(),writeVarUint(this.restEncoder,e-1),this.dsCurrVal+=e}}class UpdateEncoderV2 extends DSEncoderV2{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new IntDiffOptRleEncoder,this.clientEncoder=new UintOptRleEncoder,this.leftClockEncoder=new IntDiffOptRleEncoder,this.rightClockEncoder=new IntDiffOptRleEncoder,this.infoEncoder=new RleEncoder(writeUint8),this.stringEncoder=new StringEncoder,this.parentInfoEncoder=new RleEncoder(writeUint8),this.typeRefEncoder=new UintOptRleEncoder,this.lenEncoder=new UintOptRleEncoder}toUint8Array(){const e=createEncoder();return writeVarUint(e,0),writeVarUint8Array(e,this.keyClockEncoder.toUint8Array()),writeVarUint8Array(e,this.clientEncoder.toUint8Array()),writeVarUint8Array(e,this.leftClockEncoder.toUint8Array()),writeVarUint8Array(e,this.rightClockEncoder.toUint8Array()),writeVarUint8Array(e,toUint8Array(this.infoEncoder)),writeVarUint8Array(e,this.stringEncoder.toUint8Array()),writeVarUint8Array(e,toUint8Array(this.parentInfoEncoder)),writeVarUint8Array(e,this.typeRefEncoder.toUint8Array()),writeVarUint8Array(e,this.lenEncoder.toUint8Array()),writeUint8Array(e,toUint8Array(this.restEncoder)),toUint8Array(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){writeAny(this.restEncoder,e)}writeBuf(e){writeVarUint8Array(this.restEncoder,e)}writeJSON(e){writeAny(this.restEncoder,e)}writeKey(e){const t=this.keyMap.get(e);t===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}}const writeStructs=(n,e,t,r)=>{r=max(r,e[0].id.clock);const s=findIndexSS(e,r);writeVarUint(n.restEncoder,e.length-s),n.writeClient(t),writeVarUint(n.restEncoder,r);const i=e[s];i.write(n,r-i.id.clock);for(let a=s+1;a<e.length;a++)e[a].write(n,0)},writeClientsStructs=(n,e,t)=>{const r=new Map;t.forEach((s,i)=>{getState(e,i)>s&&r.set(i,s)}),getStateVector(e).forEach((s,i)=>{t.has(i)||r.set(i,0)}),writeVarUint(n.restEncoder,r.size),from(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{writeStructs(n,e.clients.get(s),s,i)})},readClientsStructRefs=(n,e)=>{const t=create$5(),r=readVarUint(n.restDecoder);for(let s=0;s<r;s++){const i=readVarUint(n.restDecoder),a=new Array(i),c=n.readClient();let l=readVarUint(n.restDecoder);t.set(c,{i:0,refs:a});for(let p=0;p<i;p++){const m=n.readInfo();switch(BITS5&m){case 0:{const h=n.readLen();a[p]=new GC(createID(c,l),h),l+=h;break}case 10:{const h=readVarUint(n.restDecoder);a[p]=new Skip(createID(c,l),h),l+=h;break}default:{const h=(m&(BIT7|BIT8))===0,f=new Item(createID(c,l),null,(m&BIT8)===BIT8?n.readLeftID():null,null,(m&BIT7)===BIT7?n.readRightID():null,h?n.readParentInfo()?e.get(n.readString()):n.readLeftID():null,h&&(m&BIT6)===BIT6?n.readString():null,readItemContent(n,m));a[p]=f,l+=f.length}}}}return t},integrateStructs=(n,e,t)=>{const r=[];let s=from(t.keys()).sort((y,g)=>y-g);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let y=t.get(s[s.length-1]);for(;y.refs.length===y.i;)if(s.pop(),s.length>0)y=t.get(s[s.length-1]);else return null;return y};let a=i();if(a===null)return null;const c=new StructStore,l=new Map,p=(y,g)=>{const _=l.get(y);(_==null||_>g)&&l.set(y,g)};let m=a.refs[a.i++];const h=new Map,f=()=>{for(const y of r){const g=y.id.client,_=t.get(g);_?(_.i--,c.clients.set(g,_.refs.slice(_.i)),t.delete(g),_.i=0,_.refs=[]):c.clients.set(g,[y]),s=s.filter(L=>L!==g)}r.length=0};for(;;){if(m.constructor!==Skip){const g=setIfUndefined(h,m.id.client,()=>getState(e,m.id.client))-m.id.clock;if(g<0)r.push(m),p(m.id.client,m.id.clock-1),f();else{const _=m.getMissing(n,e);if(_!==null){r.push(m);const L=t.get(_)||{refs:[],i:0};if(L.refs.length===L.i)p(_,getState(e,_)),f();else{m=L.refs[L.i++];continue}}else(g===0||g<m.length)&&(m.integrate(n,g),h.set(m.id.client,m.id.clock+m.length))}}if(r.length>0)m=r.pop();else if(a!==null&&a.i<a.refs.length)m=a.refs[a.i++];else{if(a=i(),a===null)break;m=a.refs[a.i++]}}if(c.clients.size>0){const y=new UpdateEncoderV2;return writeClientsStructs(y,c,new Map),writeVarUint(y.restEncoder,0),{missing:l,update:y.toUint8Array()}}return null},writeStructsFromTransaction=(n,e)=>writeClientsStructs(n,e.doc.store,e.beforeState),readUpdateV2=(n,e,t,r=new UpdateDecoderV2(n))=>transact$1(e,s=>{s.local=!1;let i=!1;const a=s.doc,c=a.store,l=readClientsStructRefs(r,a),p=integrateStructs(s,c,l),m=c.pendingStructs;if(m){for(const[f,y]of m.missing)if(y<getState(c,f)){i=!0;break}if(p){for(const[f,y]of p.missing){const g=m.missing.get(f);(g==null||g>y)&&m.missing.set(f,y)}m.update=mergeUpdatesV2([m.update,p.update])}}else c.pendingStructs=p;const h=readAndApplyDeleteSet(r,s,c);if(c.pendingDs){const f=new UpdateDecoderV2(createDecoder(c.pendingDs));readVarUint(f.restDecoder);const y=readAndApplyDeleteSet(f,s,c);h&&y?c.pendingDs=mergeUpdatesV2([h,y]):c.pendingDs=h||y}else c.pendingDs=h;if(i){const f=c.pendingStructs.update;c.pendingStructs=null,applyUpdateV2(s.doc,f)}},t,!1),applyUpdateV2=(n,e,t,r=UpdateDecoderV2)=>{const s=createDecoder(e);readUpdateV2(s,n,t,new r(s))},applyUpdate=(n,e,t)=>applyUpdateV2(n,e,t,UpdateDecoderV1),writeStateAsUpdate=(n,e,t=new Map)=>{writeClientsStructs(n,e.store,t),writeDeleteSet(n,createDeleteSetFromStructStore(e.store))},encodeStateAsUpdateV2=(n,e=new Uint8Array([0]),t=new UpdateEncoderV2)=>{const r=decodeStateVector(e);writeStateAsUpdate(t,n,r);const s=[t.toUint8Array()];if(n.store.pendingDs&&s.push(n.store.pendingDs),n.store.pendingStructs&&s.push(diffUpdateV2(n.store.pendingStructs.update,e)),s.length>1){if(t.constructor===UpdateEncoderV1)return mergeUpdates(s.map((i,a)=>a===0?i:convertUpdateFormatV2ToV1(i)));if(t.constructor===UpdateEncoderV2)return mergeUpdatesV2(s)}return s[0]},encodeStateAsUpdate=(n,e)=>encodeStateAsUpdateV2(n,e,new UpdateEncoderV1),readStateVector=n=>{const e=new Map,t=readVarUint(n.restDecoder);for(let r=0;r<t;r++){const s=readVarUint(n.restDecoder),i=readVarUint(n.restDecoder);e.set(s,i)}return e},decodeStateVector=n=>readStateVector(new DSDecoderV1(createDecoder(n))),writeStateVector=(n,e)=>(writeVarUint(n.restEncoder,e.size),from(e.entries()).sort((t,r)=>r[0]-t[0]).forEach(([t,r])=>{writeVarUint(n.restEncoder,t),writeVarUint(n.restEncoder,r)}),n),writeDocumentStateVector=(n,e)=>writeStateVector(n,getStateVector(e.store)),encodeStateVectorV2=(n,e=new DSEncoderV2)=>(n instanceof Map?writeStateVector(e,n):writeDocumentStateVector(e,n),e.toUint8Array()),encodeStateVector=n=>encodeStateVectorV2(n,new DSEncoderV1);class EventHandler{constructor(){this.l=[]}}const createEventHandler=()=>new EventHandler,addEventHandlerListener=(n,e)=>n.l.push(e),removeEventHandlerListener=(n,e)=>{const t=n.l,r=t.length;n.l=t.filter(s=>e!==s),r===n.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},callEventHandlerListeners=(n,e,t)=>callAll(n.l,[e,t]);class ID{constructor(e,t){this.client=e,this.clock=t}}const compareIDs=(n,e)=>n===e||n!==null&&e!==null&&n.client===e.client&&n.clock===e.clock,createID=(n,e)=>new ID(n,e),findRootTypeKey=n=>{for(const[e,t]of n.doc.share.entries())if(t===n)return e;throw unexpectedCase()};class Snapshot{constructor(e,t){this.ds=e,this.sv=t}}const createSnapshot=(n,e)=>new Snapshot(n,e),snapshot=n=>createSnapshot(createDeleteSetFromStructStore(n.store),getStateVector(n.store)),isVisible=(n,e)=>e===void 0?!n.deleted:e.sv.has(n.id.client)&&(e.sv.get(n.id.client)||0)>n.id.clock&&!isDeleted(e.ds,n.id),splitSnapshotAffectedStructs=(n,e)=>{const t=setIfUndefined(n.meta,splitSnapshotAffectedStructs,create$4),r=n.doc.store;t.has(e)||(e.sv.forEach((s,i)=>{s<getState(r,i)&&getItemCleanStart(n,createID(i,s))}),iterateDeletedStructs(n,e.ds,s=>{}),t.add(e))};class StructStore{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const getStateVector=n=>{const e=new Map;return n.clients.forEach((t,r)=>{const s=t[t.length-1];e.set(r,s.id.clock+s.length)}),e},getState=(n,e)=>{const t=n.clients.get(e);if(t===void 0)return 0;const r=t[t.length-1];return r.id.clock+r.length},addStruct=(n,e)=>{let t=n.clients.get(e.id.client);if(t===void 0)t=[],n.clients.set(e.id.client,t);else{const r=t[t.length-1];if(r.id.clock+r.length!==e.id.clock)throw unexpectedCase()}t.push(e)},findIndexSS=(n,e)=>{let t=0,r=n.length-1,s=n[r],i=s.id.clock;if(i===e)return r;let a=floor(e/(i+s.length-1)*r);for(;t<=r;){if(s=n[a],i=s.id.clock,i<=e){if(e<i+s.length)return a;t=a+1}else r=a-1;a=floor((t+r)/2)}throw unexpectedCase()},find=(n,e)=>{const t=n.clients.get(e.client);return t[findIndexSS(t,e.clock)]},getItem=find,findIndexCleanStart=(n,e,t)=>{const r=findIndexSS(e,t),s=e[r];return s.id.clock<t&&s instanceof Item?(e.splice(r+1,0,splitItem(n,s,t-s.id.clock)),r+1):r},getItemCleanStart=(n,e)=>{const t=n.doc.store.clients.get(e.client);return t[findIndexCleanStart(n,t,e.clock)]},getItemCleanEnd=(n,e,t)=>{const r=e.clients.get(t.client),s=findIndexSS(r,t.clock),i=r[s];return t.clock!==i.id.clock+i.length-1&&i.constructor!==GC&&r.splice(s+1,0,splitItem(n,i,t.clock-i.id.clock+1)),i},replaceStruct=(n,e,t)=>{const r=n.clients.get(e.id.client);r[findIndexSS(r,e.id.clock)]=t},iterateStructs=(n,e,t,r,s)=>{if(r===0)return;const i=t+r;let a=findIndexCleanStart(n,e,t),c;do c=e[a++],i<c.id.clock+c.length&&findIndexCleanStart(n,e,i),s(c);while(a<e.length&&e[a].id.clock<i)};class Transaction{constructor(e,t,r){this.doc=e,this.deleteSet=new DeleteSet,this.beforeState=getStateVector(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const writeUpdateMessageFromTransaction=(n,e)=>e.deleteSet.clients.size===0&&!any(e.afterState,(t,r)=>e.beforeState.get(r)!==t)?!1:(sortAndMergeDeleteSet(e.deleteSet),writeStructsFromTransaction(n,e),writeDeleteSet(n,e.deleteSet),!0),addChangedTypeToTransaction=(n,e,t)=>{const r=e._item;(r===null||r.id.clock<(n.beforeState.get(r.id.client)||0)&&!r.deleted)&&setIfUndefined(n.changed,e,create$4).add(t)},tryToMergeWithLefts=(n,e)=>{let t=n[e],r=n[e-1],s=e;for(;s>0;t=r,r=n[--s-1]){if(r.deleted===t.deleted&&r.constructor===t.constructor&&r.mergeWith(t)){t instanceof Item&&t.parentSub!==null&&t.parent._map.get(t.parentSub)===t&&t.parent._map.set(t.parentSub,r);continue}break}const i=e-s;return i&&n.splice(e+1-i,i),i},tryGcDeleteSet=(n,e,t)=>{for(const[r,s]of n.clients.entries()){const i=e.clients.get(r);for(let a=s.length-1;a>=0;a--){const c=s[a],l=c.clock+c.len;for(let p=findIndexSS(i,c.clock),m=i[p];p<i.length&&m.id.clock<l;m=i[++p]){const h=i[p];if(c.clock+c.len<=h.id.clock)break;h instanceof Item&&h.deleted&&!h.keep&&t(h)&&h.gc(e,!1)}}}},tryMergeDeleteSet=(n,e)=>{n.clients.forEach((t,r)=>{const s=e.clients.get(r);for(let i=t.length-1;i>=0;i--){const a=t[i],c=min(s.length-1,1+findIndexSS(s,a.clock+a.len-1));for(let l=c,p=s[l];l>0&&p.id.clock>=a.clock;p=s[l])l-=1+tryToMergeWithLefts(s,l)}})},cleanupTransactions=(n,e)=>{if(e<n.length){const t=n[e],r=t.doc,s=r.store,i=t.deleteSet,a=t._mergeStructs;try{sortAndMergeDeleteSet(i),t.afterState=getStateVector(t.doc.store),r.emit("beforeObserverCalls",[t,r]);const c=[];t.changed.forEach((l,p)=>c.push(()=>{(p._item===null||!p._item.deleted)&&p._callObserver(t,l)})),c.push(()=>{t.changedParentTypes.forEach((l,p)=>{p._dEH.l.length>0&&(p._item===null||!p._item.deleted)&&(l=l.filter(m=>m.target._item===null||!m.target._item.deleted),l.forEach(m=>{m.currentTarget=p,m._path=null}),l.sort((m,h)=>m.path.length-h.path.length),callEventHandlerListeners(p._dEH,l,t))})}),c.push(()=>r.emit("afterTransaction",[t,r])),callAll(c,[]),t._needFormattingCleanup&&cleanupYTextAfterTransaction(t)}finally{r.gc&&tryGcDeleteSet(i,s,r.gcFilter),tryMergeDeleteSet(i,s),t.afterState.forEach((m,h)=>{const f=t.beforeState.get(h)||0;if(f!==m){const y=s.clients.get(h),g=max(findIndexSS(y,f),1);for(let _=y.length-1;_>=g;)_-=1+tryToMergeWithLefts(y,_)}});for(let m=a.length-1;m>=0;m--){const{client:h,clock:f}=a[m].id,y=s.clients.get(h),g=findIndexSS(y,f);g+1<y.length&&tryToMergeWithLefts(y,g+1)>1||g>0&&tryToMergeWithLefts(y,g)}if(!t.local&&t.afterState.get(r.clientID)!==t.beforeState.get(r.clientID)&&(print(ORANGE,BOLD,"[yjs] ",UNBOLD,RED,"Changed the client-id because another client seems to be using it."),r.clientID=generateNewClientId()),r.emit("afterTransactionCleanup",[t,r]),r._observers.has("update")){const m=new UpdateEncoderV1;writeUpdateMessageFromTransaction(m,t)&&r.emit("update",[m.toUint8Array(),t.origin,r,t])}if(r._observers.has("updateV2")){const m=new UpdateEncoderV2;writeUpdateMessageFromTransaction(m,t)&&r.emit("updateV2",[m.toUint8Array(),t.origin,r,t])}const{subdocsAdded:c,subdocsLoaded:l,subdocsRemoved:p}=t;(c.size>0||p.size>0||l.size>0)&&(c.forEach(m=>{m.clientID=r.clientID,m.collectionid==null&&(m.collectionid=r.collectionid),r.subdocs.add(m)}),p.forEach(m=>r.subdocs.delete(m)),r.emit("subdocs",[{loaded:l,added:c,removed:p},r,t]),p.forEach(m=>m.destroy())),n.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,n])):cleanupTransactions(n,e+1)}}},transact$1=(n,e,t=null,r=!0)=>{const s=n._transactionCleanups;let i=!1,a=null;n._transaction===null&&(i=!0,n._transaction=new Transaction(n,t,r),s.push(n._transaction),s.length===1&&n.emit("beforeAllTransactions",[n]),n.emit("beforeTransaction",[n._transaction,n]));try{a=e(n._transaction)}finally{if(i){const c=n._transaction===s[0];n._transaction=null,c&&cleanupTransactions(s,0)}}return a};function*lazyStructReaderGenerator(n){const e=readVarUint(n.restDecoder);for(let t=0;t<e;t++){const r=readVarUint(n.restDecoder),s=n.readClient();let i=readVarUint(n.restDecoder);for(let a=0;a<r;a++){const c=n.readInfo();if(c===10){const l=readVarUint(n.restDecoder);yield new Skip(createID(s,i),l),i+=l}else if(BITS5&c){const l=(c&(BIT7|BIT8))===0,p=new Item(createID(s,i),null,(c&BIT8)===BIT8?n.readLeftID():null,null,(c&BIT7)===BIT7?n.readRightID():null,l?n.readParentInfo()?n.readString():n.readLeftID():null,l&&(c&BIT6)===BIT6?n.readString():null,readItemContent(n,c));yield p,i+=p.length}else{const l=n.readLen();yield new GC(createID(s,i),l),i+=l}}}}class LazyStructReader{constructor(e,t){this.gen=lazyStructReaderGenerator(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Skip);return this.curr}}class LazyStructWriter{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const mergeUpdates=n=>mergeUpdatesV2(n,UpdateDecoderV1,UpdateEncoderV1),sliceStruct=(n,e)=>{if(n.constructor===GC){const{client:t,clock:r}=n.id;return new GC(createID(t,r+e),n.length-e)}else if(n.constructor===Skip){const{client:t,clock:r}=n.id;return new Skip(createID(t,r+e),n.length-e)}else{const t=n,{client:r,clock:s}=t.id;return new Item(createID(r,s+e),null,createID(r,s+e-1),null,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e))}},mergeUpdatesV2=(n,e=UpdateDecoderV2,t=UpdateEncoderV2)=>{if(n.length===1)return n[0];const r=n.map(m=>new e(createDecoder(m)));let s=r.map(m=>new LazyStructReader(m,!0)),i=null;const a=new t,c=new LazyStructWriter(a);for(;s=s.filter(f=>f.curr!==null),s.sort((f,y)=>{if(f.curr.id.client===y.curr.id.client){const g=f.curr.id.clock-y.curr.id.clock;return g===0?f.curr.constructor===y.curr.constructor?0:f.curr.constructor===Skip?1:-1:g}else return y.curr.id.client-f.curr.id.client}),s.length!==0;){const m=s[0],h=m.curr.id.client;if(i!==null){let f=m.curr,y=!1;for(;f!==null&&f.id.clock+f.length<=i.struct.id.clock+i.struct.length&&f.id.client>=i.struct.id.client;)f=m.next(),y=!0;if(f===null||f.id.client!==h||y&&f.id.clock>i.struct.id.clock+i.struct.length)continue;if(h!==i.struct.id.client)writeStructToLazyStructWriter(c,i.struct,i.offset),i={struct:f,offset:0},m.next();else if(i.struct.id.clock+i.struct.length<f.id.clock)if(i.struct.constructor===Skip)i.struct.length=f.id.clock+f.length-i.struct.id.clock;else{writeStructToLazyStructWriter(c,i.struct,i.offset);const g=f.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Skip(createID(h,i.struct.id.clock+i.struct.length),g),offset:0}}else{const g=i.struct.id.clock+i.struct.length-f.id.clock;g>0&&(i.struct.constructor===Skip?i.struct.length-=g:f=sliceStruct(f,g)),i.struct.mergeWith(f)||(writeStructToLazyStructWriter(c,i.struct,i.offset),i={struct:f,offset:0},m.next())}}else i={struct:m.curr,offset:0},m.next();for(let f=m.curr;f!==null&&f.id.client===h&&f.id.clock===i.struct.id.clock+i.struct.length&&f.constructor!==Skip;f=m.next())writeStructToLazyStructWriter(c,i.struct,i.offset),i={struct:f,offset:0}}i!==null&&(writeStructToLazyStructWriter(c,i.struct,i.offset),i=null),finishLazyStructWriting(c);const l=r.map(m=>readDeleteSet(m)),p=mergeDeleteSets(l);return writeDeleteSet(a,p),a.toUint8Array()},diffUpdateV2=(n,e,t=UpdateDecoderV2,r=UpdateEncoderV2)=>{const s=decodeStateVector(e),i=new r,a=new LazyStructWriter(i),c=new t(createDecoder(n)),l=new LazyStructReader(c,!1);for(;l.curr;){const m=l.curr,h=m.id.client,f=s.get(h)||0;if(l.curr.constructor===Skip){l.next();continue}if(m.id.clock+m.length>f)for(writeStructToLazyStructWriter(a,m,max(f-m.id.clock,0)),l.next();l.curr&&l.curr.id.client===h;)writeStructToLazyStructWriter(a,l.curr,0),l.next();else for(;l.curr&&l.curr.id.client===h&&l.curr.id.clock+l.curr.length<=f;)l.next()}finishLazyStructWriting(a);const p=readDeleteSet(c);return writeDeleteSet(i,p),i.toUint8Array()},flushLazyStructWriter=n=>{n.written>0&&(n.clientStructs.push({written:n.written,restEncoder:toUint8Array(n.encoder.restEncoder)}),n.encoder.restEncoder=createEncoder(),n.written=0)},writeStructToLazyStructWriter=(n,e,t)=>{n.written>0&&n.currClient!==e.id.client&&flushLazyStructWriter(n),n.written===0&&(n.currClient=e.id.client,n.encoder.writeClient(e.id.client),writeVarUint(n.encoder.restEncoder,e.id.clock+t)),e.write(n.encoder,t),n.written++},finishLazyStructWriting=n=>{flushLazyStructWriter(n);const e=n.encoder.restEncoder;writeVarUint(e,n.clientStructs.length);for(let t=0;t<n.clientStructs.length;t++){const r=n.clientStructs[t];writeVarUint(e,r.written),writeUint8Array(e,r.restEncoder)}},convertUpdateFormat=(n,e,t,r)=>{const s=new t(createDecoder(n)),i=new LazyStructReader(s,!1),a=new r,c=new LazyStructWriter(a);for(let p=i.curr;p!==null;p=i.next())writeStructToLazyStructWriter(c,e(p),0);finishLazyStructWriting(c);const l=readDeleteSet(s);return writeDeleteSet(a,l),a.toUint8Array()},convertUpdateFormatV2ToV1=n=>convertUpdateFormat(n,id,UpdateDecoderV2,UpdateEncoderV1),errorComputeChanges="You must not compute changes after the event-handler fired.";class YEvent{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=getPathTo(this.currentTarget,this.target))}deletes(e){return isDeleted(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw create$3(errorComputeChanges);const e=new Map,t=this.target;this.transaction.changed.get(t).forEach(s=>{if(s!==null){const i=t._map.get(s);let a,c;if(this.adds(i)){let l=i.left;for(;l!==null&&this.adds(l);)l=l.left;if(this.deletes(i))if(l!==null&&this.deletes(l))a="delete",c=last(l.content.getContent());else return;else l!==null&&this.deletes(l)?(a="update",c=last(l.content.getContent())):(a="add",c=void 0)}else if(this.deletes(i))a="delete",c=last(i.content.getContent());else return;e.set(s,{action:a,oldValue:c})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw create$3(errorComputeChanges);const t=this.target,r=create$4(),s=create$4(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(t).has(null)){let c=null;const l=()=>{c&&i.push(c)};for(let p=t._start;p!==null;p=p.right)p.deleted?this.deletes(p)&&!this.adds(p)&&((c===null||c.delete===void 0)&&(l(),c={delete:0}),c.delete+=p.length,s.add(p)):this.adds(p)?((c===null||c.insert===void 0)&&(l(),c={insert:[]}),c.insert=c.insert.concat(p.content.getContent()),r.add(p)):((c===null||c.retain===void 0)&&(l(),c={retain:0}),c.retain+=p.length);c!==null&&c.retain===void 0&&l()}this._changes=e}return e}}const getPathTo=(n,e)=>{const t=[];for(;e._item!==null&&e!==n;){if(e._item.parentSub!==null)t.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;t.unshift(r)}e=e._item.parent}return t},warnPrematureAccess=()=>{warn("Invalid access: Add Yjs type to a document before reading data.")},maxSearchMarker=80;let globalSearchMarkerTimestamp=0;class ArraySearchMarker{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=globalSearchMarkerTimestamp++}}const refreshMarkerTimestamp=n=>{n.timestamp=globalSearchMarkerTimestamp++},overwriteMarker=(n,e,t)=>{n.p.marker=!1,n.p=e,e.marker=!0,n.index=t,n.timestamp=globalSearchMarkerTimestamp++},markPosition=(n,e,t)=>{if(n.length>=maxSearchMarker){const r=n.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return overwriteMarker(r,e,t),r}else{const r=new ArraySearchMarker(e,t);return n.push(r),r}},findMarker=(n,e)=>{if(n._start===null||e===0||n._searchMarker===null)return null;const t=n._searchMarker.length===0?null:n._searchMarker.reduce((i,a)=>abs(e-i.index)<abs(e-a.index)?i:a);let r=n._start,s=0;for(t!==null&&(r=t.p,s=t.index,refreshMarkerTimestamp(t));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return t!==null&&abs(t.index-s)<r.parent.length/maxSearchMarker?(overwriteMarker(t,r,s),t):markPosition(n._searchMarker,r,s)},updateMarkerChanges=(n,e,t)=>{for(let r=n.length-1;r>=0;r--){const s=n[r];if(t>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){n.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||t>0&&e===s.index)&&(s.index=max(e,s.index+t))}},callTypeObservers=(n,e,t)=>{const r=n,s=e.changedParentTypes;for(;setIfUndefined(s,n,()=>[]).push(t),n._item!==null;)n=n._item.parent;callEventHandlerListeners(r._eH,t,e)};class AbstractType{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=createEventHandler(),this._dEH=createEventHandler(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw methodUnimplemented()}clone(){throw methodUnimplemented()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){addEventHandlerListener(this._eH,e)}observeDeep(e){addEventHandlerListener(this._dEH,e)}unobserve(e){removeEventHandlerListener(this._eH,e)}unobserveDeep(e){removeEventHandlerListener(this._dEH,e)}toJSON(){}}const typeListSlice=(n,e,t)=>{n.doc??warnPrematureAccess(),e<0&&(e=n._length+e),t<0&&(t=n._length+t);let r=t-e;const s=[];let i=n._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const a=i.content.getContent();if(a.length<=e)e-=a.length;else{for(let c=e;c<a.length&&r>0;c++)s.push(a[c]),r--;e=0}}i=i.right}return s},typeListToArray=n=>{n.doc??warnPrematureAccess();const e=[];let t=n._start;for(;t!==null;){if(t.countable&&!t.deleted){const r=t.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}t=t.right}return e},typeListForEach=(n,e)=>{let t=0,r=n._start;for(n.doc??warnPrematureAccess();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],t++,n)}r=r.right}},typeListMap=(n,e)=>{const t=[];return typeListForEach(n,(r,s)=>{t.push(e(r,s,n))}),t},typeListCreateIterator=n=>{let e=n._start,t=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(t===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};t=e.content.getContent(),r=0,e=e.right}const s=t[r++];return t.length<=r&&(t=null),{done:!1,value:s}}}},typeListGet=(n,e)=>{n.doc??warnPrematureAccess();const t=findMarker(n,e);let r=n._start;for(t!==null&&(r=t.p,e-=t.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},typeListInsertGenericsAfter=(n,e,t,r)=>{let s=t;const i=n.doc,a=i.clientID,c=i.store,l=t===null?e._start:t.right;let p=[];const m=()=>{p.length>0&&(s=new Item(createID(a,getState(c,a)),s,s&&s.lastId,l,l&&l.id,e,null,new ContentAny(p)),s.integrate(n,0),p=[])};r.forEach(h=>{if(h===null)p.push(h);else switch(h.constructor){case Number:case Object:case Boolean:case Array:case String:p.push(h);break;default:switch(m(),h.constructor){case Uint8Array:case ArrayBuffer:s=new Item(createID(a,getState(c,a)),s,s&&s.lastId,l,l&&l.id,e,null,new ContentBinary(new Uint8Array(h))),s.integrate(n,0);break;case Doc:s=new Item(createID(a,getState(c,a)),s,s&&s.lastId,l,l&&l.id,e,null,new ContentDoc(h)),s.integrate(n,0);break;default:if(h instanceof AbstractType)s=new Item(createID(a,getState(c,a)),s,s&&s.lastId,l,l&&l.id,e,null,new ContentType(h)),s.integrate(n,0);else throw new Error("Unexpected content type in insert operation")}}}),m()},lengthExceeded=()=>create$3("Length exceeded!"),typeListInsertGenerics=(n,e,t,r)=>{if(t>e._length)throw lengthExceeded();if(t===0)return e._searchMarker&&updateMarkerChanges(e._searchMarker,t,r.length),typeListInsertGenericsAfter(n,e,null,r);const s=t,i=findMarker(e,t);let a=e._start;for(i!==null&&(a=i.p,t-=i.index,t===0&&(a=a.prev,t+=a&&a.countable&&!a.deleted?a.length:0));a!==null;a=a.right)if(!a.deleted&&a.countable){if(t<=a.length){t<a.length&&getItemCleanStart(n,createID(a.id.client,a.id.clock+t));break}t-=a.length}return e._searchMarker&&updateMarkerChanges(e._searchMarker,s,r.length),typeListInsertGenericsAfter(n,e,a,r)},typeListPushGenerics=(n,e,t)=>{let s=(e._searchMarker||[]).reduce((i,a)=>a.index>i.index?a:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return typeListInsertGenericsAfter(n,e,s,t)},typeListDelete=(n,e,t,r)=>{if(r===0)return;const s=t,i=r,a=findMarker(e,t);let c=e._start;for(a!==null&&(c=a.p,t-=a.index);c!==null&&t>0;c=c.right)!c.deleted&&c.countable&&(t<c.length&&getItemCleanStart(n,createID(c.id.client,c.id.clock+t)),t-=c.length);for(;r>0&&c!==null;)c.deleted||(r<c.length&&getItemCleanStart(n,createID(c.id.client,c.id.clock+r)),c.delete(n),r-=c.length),c=c.right;if(r>0)throw lengthExceeded();e._searchMarker&&updateMarkerChanges(e._searchMarker,s,-i+r)},typeMapDelete=(n,e,t)=>{const r=e._map.get(t);r!==void 0&&r.delete(n)},typeMapSet=(n,e,t,r)=>{const s=e._map.get(t)||null,i=n.doc,a=i.clientID;let c;if(r==null)c=new ContentAny([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:c=new ContentAny([r]);break;case Uint8Array:c=new ContentBinary(r);break;case Doc:c=new ContentDoc(r);break;default:if(r instanceof AbstractType)c=new ContentType(r);else throw new Error("Unexpected content type")}new Item(createID(a,getState(i.store,a)),s,s&&s.lastId,null,null,e,t,c).integrate(n,0)},typeMapGet=(n,e)=>{n.doc??warnPrematureAccess();const t=n._map.get(e);return t!==void 0&&!t.deleted?t.content.getContent()[t.length-1]:void 0},typeMapGetAll=n=>{const e={};return n.doc??warnPrematureAccess(),n._map.forEach((t,r)=>{t.deleted||(e[r]=t.content.getContent()[t.length-1])}),e},typeMapHas=(n,e)=>{n.doc??warnPrematureAccess();const t=n._map.get(e);return t!==void 0&&!t.deleted},typeMapGetAllSnapshot=(n,e)=>{const t={};return n._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&isVisible(i,e)&&(t[s]=i.content.getContent()[i.length-1])}),t},createMapIterator=n=>(n.doc??warnPrematureAccess(),iteratorFilter(n._map.entries(),e=>!e[1].deleted));class YArrayEvent extends YEvent{}class YArray extends AbstractType{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const t=new YArray;return t.push(e),t}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new YArray}clone(){const e=new YArray;return e.insert(0,this.toArray().map(t=>t instanceof AbstractType?t.clone():t)),e}get length(){return this.doc??warnPrematureAccess(),this._length}_callObserver(e,t){super._callObserver(e,t),callTypeObservers(this,e,new YArrayEvent(this,e))}insert(e,t){this.doc!==null?transact$1(this.doc,r=>{typeListInsertGenerics(r,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){this.doc!==null?transact$1(this.doc,t=>{typeListPushGenerics(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){this.doc!==null?transact$1(this.doc,r=>{typeListDelete(r,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return typeListGet(this,e)}toArray(){return typeListToArray(this)}slice(e=0,t=this.length){return typeListSlice(this,e,t)}toJSON(){return this.map(e=>e instanceof AbstractType?e.toJSON():e)}map(e){return typeListMap(this,e)}forEach(e){typeListForEach(this,e)}[Symbol.iterator](){return typeListCreateIterator(this)}_write(e){e.writeTypeRef(YArrayRefID)}}const readYArray=n=>new YArray;class YMapEvent extends YEvent{constructor(e,t,r){super(e,t),this.keysChanged=r}}class YMap extends AbstractType{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new YMap}clone(){const e=new YMap;return this.forEach((t,r)=>{e.set(r,t instanceof AbstractType?t.clone():t)}),e}_callObserver(e,t){callTypeObservers(this,e,new YMapEvent(this,e,t))}toJSON(){this.doc??warnPrematureAccess();const e={};return this._map.forEach((t,r)=>{if(!t.deleted){const s=t.content.getContent()[t.length-1];e[r]=s instanceof AbstractType?s.toJSON():s}}),e}get size(){return[...createMapIterator(this)].length}keys(){return iteratorMap(createMapIterator(this),e=>e[0])}values(){return iteratorMap(createMapIterator(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return iteratorMap(createMapIterator(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??warnPrematureAccess(),this._map.forEach((t,r)=>{t.deleted||e(t.content.getContent()[t.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?transact$1(this.doc,t=>{typeMapDelete(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return this.doc!==null?transact$1(this.doc,r=>{typeMapSet(r,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return typeMapGet(this,e)}has(e){return typeMapHas(this,e)}clear(){this.doc!==null?transact$1(this.doc,e=>{this.forEach(function(t,r,s){typeMapDelete(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(YMapRefID)}}const readYMap=n=>new YMap,equalAttrs=(n,e)=>n===e||typeof n=="object"&&typeof e=="object"&&n&&e&&equalFlat(n,e);class ItemTextListPosition{constructor(e,t,r,s){this.left=e,this.right=t,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&unexpectedCase(),this.right.content.constructor){case ContentFormat:this.right.deleted||updateCurrentAttributes(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const findNextPosition=(n,e,t)=>{for(;e.right!==null&&t>0;){switch(e.right.content.constructor){case ContentFormat:e.right.deleted||updateCurrentAttributes(e.currentAttributes,e.right.content);break;default:e.right.deleted||(t<e.right.length&&getItemCleanStart(n,createID(e.right.id.client,e.right.id.clock+t)),e.index+=e.right.length,t-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},findPosition=(n,e,t,r)=>{const s=new Map,i=r?findMarker(e,t):null;if(i){const a=new ItemTextListPosition(i.p.left,i.p,i.index,s);return findNextPosition(n,a,t-i.index)}else{const a=new ItemTextListPosition(null,e._start,0,s);return findNextPosition(n,a,t)}},insertNegatedAttributes=(n,e,t,r)=>{for(;t.right!==null&&(t.right.deleted===!0||t.right.content.constructor===ContentFormat&&equalAttrs(r.get(t.right.content.key),t.right.content.value));)t.right.deleted||r.delete(t.right.content.key),t.forward();const s=n.doc,i=s.clientID;r.forEach((a,c)=>{const l=t.left,p=t.right,m=new Item(createID(i,getState(s.store,i)),l,l&&l.lastId,p,p&&p.id,e,null,new ContentFormat(c,a));m.integrate(n,0),t.right=m,t.forward()})},updateCurrentAttributes=(n,e)=>{const{key:t,value:r}=e;r===null?n.delete(t):n.set(t,r)},minimizeAttributeChanges=(n,e)=>{for(;n.right!==null;){if(!(n.right.deleted||n.right.content.constructor===ContentFormat&&equalAttrs(e[n.right.content.key]??null,n.right.content.value)))break;n.forward()}},insertAttributes=(n,e,t,r)=>{const s=n.doc,i=s.clientID,a=new Map;for(const c in r){const l=r[c],p=t.currentAttributes.get(c)??null;if(!equalAttrs(p,l)){a.set(c,p);const{left:m,right:h}=t;t.right=new Item(createID(i,getState(s.store,i)),m,m&&m.lastId,h,h&&h.id,e,null,new ContentFormat(c,l)),t.right.integrate(n,0),t.forward()}}return a},insertText=(n,e,t,r,s)=>{t.currentAttributes.forEach((f,y)=>{s[y]===void 0&&(s[y]=null)});const i=n.doc,a=i.clientID;minimizeAttributeChanges(t,s);const c=insertAttributes(n,e,t,s),l=r.constructor===String?new ContentString(r):r instanceof AbstractType?new ContentType(r):new ContentEmbed(r);let{left:p,right:m,index:h}=t;e._searchMarker&&updateMarkerChanges(e._searchMarker,t.index,l.getLength()),m=new Item(createID(a,getState(i.store,a)),p,p&&p.lastId,m,m&&m.id,e,null,l),m.integrate(n,0),t.right=m,t.index=h,t.forward(),insertNegatedAttributes(n,e,t,c)},formatText=(n,e,t,r,s)=>{const i=n.doc,a=i.clientID;minimizeAttributeChanges(t,s);const c=insertAttributes(n,e,t,s);e:for(;t.right!==null&&(r>0||c.size>0&&(t.right.deleted||t.right.content.constructor===ContentFormat));){if(!t.right.deleted)switch(t.right.content.constructor){case ContentFormat:{const{key:l,value:p}=t.right.content,m=s[l];if(m!==void 0){if(equalAttrs(m,p))c.delete(l);else{if(r===0)break e;c.set(l,p)}t.right.delete(n)}else t.currentAttributes.set(l,p);break}default:r<t.right.length&&getItemCleanStart(n,createID(t.right.id.client,t.right.id.clock+r)),r-=t.right.length;break}t.forward()}if(r>0){let l="";for(;r>0;r--)l+=`
`;t.right=new Item(createID(a,getState(i.store,a)),t.left,t.left&&t.left.lastId,t.right,t.right&&t.right.id,e,null,new ContentString(l)),t.right.integrate(n,0),t.forward()}insertNegatedAttributes(n,e,t,c)},cleanupFormattingGap=(n,e,t,r,s)=>{let i=e;const a=create$5();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===ContentFormat){const p=i.content;a.set(p.key,p)}i=i.right}let c=0,l=!1;for(;e!==i;){if(t===e&&(l=!0),!e.deleted){const p=e.content;switch(p.constructor){case ContentFormat:{const{key:m,value:h}=p,f=r.get(m)??null;(a.get(m)!==p||f===h)&&(e.delete(n),c++,!l&&(s.get(m)??null)===h&&f!==h&&(f===null?s.delete(m):s.set(m,f))),!l&&!e.deleted&&updateCurrentAttributes(s,p);break}}}e=e.right}return c},cleanupContextlessFormattingGap=(n,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const t=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===ContentFormat){const r=e.content.key;t.has(r)?e.delete(n):t.add(r)}e=e.left}},cleanupYTextFormatting=n=>{let e=0;return transact$1(n.doc,t=>{let r=n._start,s=n._start,i=create$5();const a=copy(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case ContentFormat:updateCurrentAttributes(a,s.content);break;default:e+=cleanupFormattingGap(t,r,s,i,a),i=copy(a),r=s;break}s=s.right}}),e},cleanupYTextAfterTransaction=n=>{const e=new Set,t=n.doc;for(const[r,s]of n.afterState.entries()){const i=n.beforeState.get(r)||0;s!==i&&iterateStructs(n,t.store.clients.get(r),i,s,a=>{!a.deleted&&a.content.constructor===ContentFormat&&a.constructor!==GC&&e.add(a.parent)})}transact$1(t,r=>{iterateDeletedStructs(n,n.deleteSet,s=>{if(s instanceof GC||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===ContentFormat?e.add(i):cleanupContextlessFormattingGap(r,s)});for(const s of e)cleanupYTextFormatting(s)})},deleteText=(n,e,t)=>{const r=t,s=copy(e.currentAttributes),i=e.right;for(;t>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case ContentType:case ContentEmbed:case ContentString:t<e.right.length&&getItemCleanStart(n,createID(e.right.id.client,e.right.id.clock+t)),t-=e.right.length,e.right.delete(n);break}e.forward()}i&&cleanupFormattingGap(n,i,e.right,s,e.currentAttributes);const a=(e.left||e.right).parent;return a._searchMarker&&updateMarkerChanges(a._searchMarker,e.index,-r+t),e};class YTextEvent extends YEvent{constructor(e,t,r){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,t=[];transact$1(e,r=>{const s=new Map,i=new Map;let a=this.target._start,c=null;const l={};let p="",m=0,h=0;const f=()=>{if(c!==null){let y=null;switch(c){case"delete":h>0&&(y={delete:h}),h=0;break;case"insert":(typeof p=="object"||p.length>0)&&(y={insert:p},s.size>0&&(y.attributes={},s.forEach((g,_)=>{g!==null&&(y.attributes[_]=g)}))),p="";break;case"retain":m>0&&(y={retain:m},isEmpty(l)||(y.attributes=assign({},l))),m=0;break}y&&t.push(y),c=null}};for(;a!==null;){switch(a.content.constructor){case ContentType:case ContentEmbed:this.adds(a)?this.deletes(a)||(f(),c="insert",p=a.content.getContent()[0],f()):this.deletes(a)?(c!=="delete"&&(f(),c="delete"),h+=1):a.deleted||(c!=="retain"&&(f(),c="retain"),m+=1);break;case ContentString:this.adds(a)?this.deletes(a)||(c!=="insert"&&(f(),c="insert"),p+=a.content.str):this.deletes(a)?(c!=="delete"&&(f(),c="delete"),h+=a.length):a.deleted||(c!=="retain"&&(f(),c="retain"),m+=a.length);break;case ContentFormat:{const{key:y,value:g}=a.content;if(this.adds(a)){if(!this.deletes(a)){const _=s.get(y)??null;equalAttrs(_,g)?g!==null&&a.delete(r):(c==="retain"&&f(),equalAttrs(g,i.get(y)??null)?delete l[y]:l[y]=g)}}else if(this.deletes(a)){i.set(y,g);const _=s.get(y)??null;equalAttrs(_,g)||(c==="retain"&&f(),l[y]=_)}else if(!a.deleted){i.set(y,g);const _=l[y];_!==void 0&&(equalAttrs(_,g)?_!==null&&a.delete(r):(c==="retain"&&f(),g===null?delete l[y]:l[y]=g))}a.deleted||(c==="insert"&&f(),updateCurrentAttributes(s,a.content));break}}a=a.right}for(f();t.length>0;){const y=t[t.length-1];if(y.retain!==void 0&&y.attributes===void 0)t.pop();else break}}),this._delta=t}return this._delta}}class YText extends AbstractType{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??warnPrematureAccess(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new YText}clone(){const e=new YText;return e.applyDelta(this.toDelta()),e}_callObserver(e,t){super._callObserver(e,t);const r=new YTextEvent(this,e,t);callTypeObservers(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??warnPrematureAccess();let e="",t=this._start;for(;t!==null;)!t.deleted&&t.countable&&t.content.constructor===ContentString&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){this.doc!==null?transact$1(this.doc,r=>{const s=new ItemTextListPosition(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const a=e[i];if(a.insert!==void 0){const c=!t&&typeof a.insert=="string"&&i===e.length-1&&s.right===null&&a.insert.slice(-1)===`
`?a.insert.slice(0,-1):a.insert;(typeof c!="string"||c.length>0)&&insertText(r,this,s,c,a.attributes||{})}else a.retain!==void 0?formatText(r,this,s,a.retain,a.attributes||{}):a.delete!==void 0&&deleteText(r,s,a.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,r){this.doc??warnPrematureAccess();const s=[],i=new Map,a=this.doc;let c="",l=this._start;function p(){if(c.length>0){const h={};let f=!1;i.forEach((g,_)=>{f=!0,h[_]=g});const y={insert:c};f&&(y.attributes=h),s.push(y),c=""}}const m=()=>{for(;l!==null;){if(isVisible(l,e)||t!==void 0&&isVisible(l,t))switch(l.content.constructor){case ContentString:{const h=i.get("ychange");e!==void 0&&!isVisible(l,e)?(h===void 0||h.user!==l.id.client||h.type!=="removed")&&(p(),i.set("ychange",r?r("removed",l.id):{type:"removed"})):t!==void 0&&!isVisible(l,t)?(h===void 0||h.user!==l.id.client||h.type!=="added")&&(p(),i.set("ychange",r?r("added",l.id):{type:"added"})):h!==void 0&&(p(),i.delete("ychange")),c+=l.content.str;break}case ContentType:case ContentEmbed:{p();const h={insert:l.content.getContent()[0]};if(i.size>0){const f={};h.attributes=f,i.forEach((y,g)=>{f[g]=y})}s.push(h);break}case ContentFormat:isVisible(l,e)&&(p(),updateCurrentAttributes(i,l.content));break}l=l.right}p()};return e||t?transact$1(a,h=>{e&&splitSnapshotAffectedStructs(h,e),t&&splitSnapshotAffectedStructs(h,t),m()},"cleanup"):m(),s}insert(e,t,r){if(t.length<=0)return;const s=this.doc;s!==null?transact$1(s,i=>{const a=findPosition(i,this,e,!r);r||(r={},a.currentAttributes.forEach((c,l)=>{r[l]=c})),insertText(i,this,a,t,r)}):this._pending.push(()=>this.insert(e,t,r))}insertEmbed(e,t,r){const s=this.doc;s!==null?transact$1(s,i=>{const a=findPosition(i,this,e,!r);insertText(i,this,a,t,r||{})}):this._pending.push(()=>this.insertEmbed(e,t,r||{}))}delete(e,t){if(t===0)return;const r=this.doc;r!==null?transact$1(r,s=>{deleteText(s,findPosition(s,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,r){if(t===0)return;const s=this.doc;s!==null?transact$1(s,i=>{const a=findPosition(i,this,e,!1);a.right!==null&&formatText(i,this,a,t,r)}):this._pending.push(()=>this.format(e,t,r))}removeAttribute(e){this.doc!==null?transact$1(this.doc,t=>{typeMapDelete(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){this.doc!==null?transact$1(this.doc,r=>{typeMapSet(r,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return typeMapGet(this,e)}getAttributes(){return typeMapGetAll(this)}_write(e){e.writeTypeRef(YTextRefID)}}const readYText=n=>new YText;class YXmlTreeWalker{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??warnPrematureAccess()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(t)))do if(t=e.content.type,!e.deleted&&(t.constructor===YXmlElement||t.constructor===YXmlFragment)&&t._start!==null)e=t._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class YXmlFragment extends AbstractType{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new YXmlFragment}clone(){const e=new YXmlFragment;return e.insert(0,this.toArray().map(t=>t instanceof AbstractType?t.clone():t)),e}get length(){return this.doc??warnPrematureAccess(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new YXmlTreeWalker(this,e)}querySelector(e){e=e.toUpperCase();const r=new YXmlTreeWalker(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),from(new YXmlTreeWalker(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){callTypeObservers(this,e,new YXmlEvent(this,t,e))}toString(){return typeListMap(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),typeListForEach(this,i=>{s.insertBefore(i.toDOM(e,t,r),null)}),s}insert(e,t){this.doc!==null?transact$1(this.doc,r=>{typeListInsertGenerics(r,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(this.doc!==null)transact$1(this.doc,r=>{const s=e&&e instanceof AbstractType?e._item:e;typeListInsertGenericsAfter(r,this,s,t)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw create$3("Reference item not found");r.splice(s,0,...t)}}delete(e,t=1){this.doc!==null?transact$1(this.doc,r=>{typeListDelete(r,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return typeListToArray(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return typeListGet(this,e)}slice(e=0,t=this.length){return typeListSlice(this,e,t)}forEach(e){typeListForEach(this,e)}_write(e){e.writeTypeRef(YXmlFragmentRefID)}}const readYXmlFragment=n=>new YXmlFragment;class YXmlElement extends YXmlFragment{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new YXmlElement(this.nodeName)}clone(){const e=new YXmlElement(this.nodeName),t=this.getAttributes();return forEach(t,(r,s)=>{typeof r=="string"&&e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof AbstractType?r.clone():r)),e}toString(){const e=this.getAttributes(),t=[],r=[];for(const c in e)r.push(c);r.sort();const s=r.length;for(let c=0;c<s;c++){const l=r[c];t.push(l+'="'+e[l]+'"')}const i=this.nodeName.toLocaleLowerCase(),a=t.length>0?" "+t.join(" "):"";return`<${i}${a}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?transact$1(this.doc,t=>{typeMapDelete(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){this.doc!==null?transact$1(this.doc,r=>{typeMapSet(r,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return typeMapGet(this,e)}hasAttribute(e){return typeMapHas(this,e)}getAttributes(e){return e?typeMapGetAllSnapshot(this,e):typeMapGetAll(this)}toDOM(e=document,t={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const a in i){const c=i[a];typeof c=="string"&&s.setAttribute(a,c)}return typeListForEach(this,a=>{s.appendChild(a.toDOM(e,t,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(YXmlElementRefID),e.writeKey(this.nodeName)}}const readYXmlElement=n=>new YXmlElement(n.readKey());class YXmlEvent extends YEvent{constructor(e,t,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class YXmlHook extends YMap{constructor(e){super(),this.hookName=e}_copy(){return new YXmlHook(this.hookName)}clone(){const e=new YXmlHook(this.hookName);return this.forEach((t,r)=>{e.set(r,t)}),e}toDOM(e=document,t={},r){const s=t[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(YXmlHookRefID),e.writeKey(this.hookName)}}const readYXmlHook=n=>new YXmlHook(n.readKey());class YXmlText extends YText{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new YXmlText}clone(){const e=new YXmlText;return e.applyDelta(this.toDelta()),e}toDOM(e=document,t,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const t=[];for(const s in e.attributes){const i=[];for(const a in e.attributes[s])i.push({key:a,value:e.attributes[s][a]});i.sort((a,c)=>a.key<c.key?-1:1),t.push({nodeName:s,attrs:i})}t.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<t.length;s++){const i=t[s];r+=`<${i.nodeName}`;for(let a=0;a<i.attrs.length;a++){const c=i.attrs[a];r+=` ${c.key}="${c.value}"`}r+=">"}r+=e.insert;for(let s=t.length-1;s>=0;s--)r+=`</${t[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(YXmlTextRefID)}}const readYXmlText=n=>new YXmlText;class AbstractStruct{constructor(e,t){this.id=e,this.length=t}get deleted(){throw methodUnimplemented()}mergeWith(e){return!1}write(e,t,r){throw methodUnimplemented()}integrate(e,t){throw methodUnimplemented()}}const structGCRefNumber=0;class GC extends AbstractStruct{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),addStruct(e.doc.store,this)}write(e,t){e.writeInfo(structGCRefNumber),e.writeLen(this.length-t)}getMissing(e,t){return null}}class ContentBinary{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new ContentBinary(this.content)}splice(e){throw methodUnimplemented()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}}const readContentBinary=n=>new ContentBinary(n.readBuf());class ContentDeleted{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new ContentDeleted(this.len)}splice(e){const t=new ContentDeleted(this.len-e);return this.len=e,t}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){addToDeleteSet(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}}const readContentDeleted=n=>new ContentDeleted(n.readLen()),createDocFromOpts=(n,e)=>new Doc({guid:n,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class ContentDoc{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),e.meta!==null&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new ContentDoc(createDocFromOpts(this.doc.guid,this.opts))}splice(e){throw methodUnimplemented()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const readContentDoc=n=>new ContentDoc(createDocFromOpts(n.readString(),n.readAny()));class ContentEmbed{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new ContentEmbed(this.embed)}splice(e){throw methodUnimplemented()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}}const readContentEmbed=n=>new ContentEmbed(n.readJSON());class ContentFormat{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ContentFormat(this.key,this.value)}splice(e){throw methodUnimplemented()}mergeWith(e){return!1}integrate(e,t){const r=t.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const readContentFormat=n=>new ContentFormat(n.readKey(),n.readJSON());class ContentJSON{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new ContentJSON(this.arr)}splice(e){const t=new ContentJSON(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const r=this.arr.length;e.writeLen(r-t);for(let s=t;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const readContentJSON=n=>{const e=n.readLen(),t=[];for(let r=0;r<e;r++){const s=n.readString();s==="undefined"?t.push(void 0):t.push(JSON.parse(s))}return new ContentJSON(t)},isDevMode=getVariable("node_env")==="development";class ContentAny{constructor(e){this.arr=e,isDevMode&&deepFreeze(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new ContentAny(this.arr)}splice(e){const t=new ContentAny(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const r=this.arr.length;e.writeLen(r-t);for(let s=t;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const readContentAny=n=>{const e=n.readLen(),t=[];for(let r=0;r<e;r++)t.push(n.readAny());return new ContentAny(t)};class ContentString{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new ContentString(this.str)}splice(e){const t=new ContentString(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",t.str=""+t.str.slice(1)),t}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(t===0?this.str:this.str.slice(t))}getRef(){return 4}}const readContentString=n=>new ContentString(n.readString()),typeRefs=[readYArray,readYMap,readYText,readYXmlElement,readYXmlFragment,readYXmlHook,readYXmlText],YArrayRefID=0,YMapRefID=1,YTextRefID=2,YXmlElementRefID=3,YXmlFragmentRefID=4,YXmlHookRefID=5,YXmlTextRefID=6;class ContentType{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ContentType(this.type._copy())}splice(e){throw methodUnimplemented()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;t!==null;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;t!==null;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}}const readContentType=n=>new ContentType(typeRefs[n.readTypeRef()](n)),splitItem=(n,e,t)=>{const{client:r,clock:s}=e.id,i=new Item(createID(r,s+t),e,createID(r,s+t-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=createID(e.redone.client,e.redone.clock+t)),e.right=i,i.right!==null&&(i.right.left=i),n._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=t,i};class Item extends AbstractStruct{constructor(e,t,r,s,i,a,c,l){super(e,l.getLength()),this.origin=r,this.left=t,this.right=s,this.rightOrigin=i,this.parent=a,this.parentSub=c,this.redone=null,this.content=l,this.info=this.content.isCountable()?BIT2:0}set marker(e){(this.info&BIT4)>0!==e&&(this.info^=BIT4)}get marker(){return(this.info&BIT4)>0}get keep(){return(this.info&BIT1)>0}set keep(e){this.keep!==e&&(this.info^=BIT1)}get countable(){return(this.info&BIT2)>0}get deleted(){return(this.info&BIT3)>0}set deleted(e){this.deleted!==e&&(this.info^=BIT3)}markDeleted(){this.info|=BIT3}getMissing(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=getState(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=getState(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===ID&&this.id.client!==this.parent.client&&this.parent.clock>=getState(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=getItemCleanEnd(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=getItemCleanStart(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===GC||this.right&&this.right.constructor===GC)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===Item?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===Item&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===ID){const r=getItem(t,this.parent);r.constructor===GC?this.parent=null:this.parent=r.content.type}return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=getItemCleanEnd(e,e.doc.store,createID(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,a=new Set;for(;s!==null&&s!==this.right;){if(a.add(s),i.add(s),compareIDs(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(compareIDs(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&a.has(getItem(e.doc.store,s.origin)))i.has(getItem(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),addStruct(e.doc.store,this),this.content.integrate(e,this),addChangedTypeToTransaction(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new GC(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:createID(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&compareIDs(e.origin,this.lastId)&&this.right===e&&compareIDs(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const t=this.parent._searchMarker;return t&&t.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const t=this.parent;this.countable&&this.parentSub===null&&(t._length-=this.length),this.markDeleted(),addToDeleteSet(e.deleteSet,this.id.client,this.id.clock,this.length),addChangedTypeToTransaction(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw unexpectedCase();this.content.gc(e),t?replaceStruct(e,this,new GC(this.id,this.length)):this.content=new ContentDeleted(this.length)}write(e,t){const r=t>0?createID(this.id.client,this.id.clock+t-1):this.origin,s=this.rightOrigin,i=this.parentSub,a=this.content.getRef()&BITS5|(r===null?0:BIT8)|(s===null?0:BIT7)|(i===null?0:BIT6);if(e.writeInfo(a),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const c=this.parent;if(c._item!==void 0){const l=c._item;if(l===null){const p=findRootTypeKey(c);e.writeParentInfo(!0),e.writeString(p)}else e.writeParentInfo(!1),e.writeLeftID(l.id)}else c.constructor===String?(e.writeParentInfo(!0),e.writeString(c)):c.constructor===ID?(e.writeParentInfo(!1),e.writeLeftID(c)):unexpectedCase();i!==null&&e.writeString(i)}this.content.write(e,t)}}const readItemContent=(n,e)=>contentRefs[e&BITS5](n),contentRefs=[()=>{unexpectedCase()},readContentDeleted,readContentJSON,readContentBinary,readContentString,readContentEmbed,readContentFormat,readContentType,readContentAny,readContentDoc,()=>{unexpectedCase()}],structSkipRefNumber=10;class Skip extends AbstractStruct{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){unexpectedCase()}write(e,t){e.writeInfo(structSkipRefNumber),writeVarUint(e.restEncoder,this.length-t)}getMissing(e,t){return null}}const glo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},importIdentifier="__ $YJS$ __";glo[importIdentifier]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");glo[importIdentifier]=!0;const reconnectTimeoutBase=1200,maxReconnectTimeout=2500,messageReconnectTimeout=3e4,setupWS=n=>{if(n.shouldConnect&&n.ws===null){const e=new WebSocket(n.url),t=n.binaryType;let r=null;t&&(e.binaryType=t),n.ws=e,n.connecting=!0,n.connected=!1,e.onmessage=a=>{n.lastMessageReceived=getUnixTime();const c=a.data,l=typeof c=="string"?JSON.parse(c):c;l&&l.type==="pong"&&(clearTimeout(r),r=setTimeout(i,messageReconnectTimeout/2)),n.emit("message",[l,n])};const s=a=>{n.ws!==null&&(n.ws=null,n.connecting=!1,n.connected?(n.connected=!1,n.emit("disconnect",[{type:"disconnect",error:a},n])):n.unsuccessfulReconnects++,setTimeout(setupWS,min(log10(n.unsuccessfulReconnects+1)*reconnectTimeoutBase,maxReconnectTimeout),n)),clearTimeout(r)},i=()=>{n.ws===e&&n.send({type:"ping"})};e.onclose=()=>s(null),e.onerror=a=>s(a),e.onopen=()=>{n.lastMessageReceived=getUnixTime(),n.connecting=!1,n.connected=!0,n.unsuccessfulReconnects=0,n.emit("connect",[{type:"connect"},n]),r=setTimeout(i,messageReconnectTimeout/2)}}};class WebsocketClient extends Observable{constructor(e,{binaryType:t}={}){super(),this.url=e,this.ws=null,this.binaryType=t||null,this.connected=!1,this.connecting=!1,this.unsuccessfulReconnects=0,this.lastMessageReceived=0,this.shouldConnect=!0,this._checkInterval=setInterval(()=>{this.connected&&messageReconnectTimeout<getUnixTime()-this.lastMessageReceived&&this.ws.close()},messageReconnectTimeout/2),setupWS(this)}send(e){this.ws&&this.ws.send(JSON.stringify(e))}destroy(){clearInterval(this._checkInterval),this.disconnect(),super.destroy()}disconnect(){this.shouldConnect=!1,this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.connected&&this.ws===null&&setupWS(this)}}const channels=new Map;class LocalStoragePolyfill{constructor(e){this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&this.onmessage!==null&&this.onmessage({data:fromBase64(t.newValue||"")}),onChange(this._onChange)}postMessage(e){varStorage.setItem(this.room,toBase64(createUint8ArrayFromArrayBuffer(e)))}close(){offChange(this._onChange)}}const BC=typeof BroadcastChannel>"u"?LocalStoragePolyfill:BroadcastChannel,getChannel=n=>setIfUndefined(channels,n,()=>{const e=create$4(),t=new BC(n);return t.onmessage=r=>e.forEach(s=>s(r.data,"broadcastchannel")),{bc:t,subs:e}}),subscribe=(n,e)=>(getChannel(n).subs.add(e),e),unsubscribe=(n,e)=>{const t=getChannel(n),r=t.subs.delete(e);return r&&t.subs.size===0&&(t.bc.close(),channels.delete(n)),r},publish=(n,e,t=null)=>{const r=getChannel(n);r.bc.postMessage(e),r.subs.forEach(s=>s(e,t))},createMutex=()=>{let n=!0;return(e,t)=>{if(n){n=!1;try{e()}finally{n=!0}}else t!==void 0&&t()}};var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function commonjsRequire(n){throw new Error('Could not dynamically require "'+n+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var simplepeer_min={exports:{}};(function(n,e){(function(t){n.exports=t()})(function(){var t=Math.floor,r=Math.abs,s=Math.pow;return function(){function i(a,c,l){function p(f,y){if(!c[f]){if(!a[f]){var g=typeof commonjsRequire=="function"&&commonjsRequire;if(!y&&g)return g(f,!0);if(m)return m(f,!0);var _=new Error("Cannot find module '"+f+"'");throw _.code="MODULE_NOT_FOUND",_}var L=c[f]={exports:{}};a[f][0].call(L.exports,function(x){var O=a[f][1][x];return p(O||x)},L,L.exports,i,a,c,l)}return c[f].exports}for(var m=typeof commonjsRequire=="function"&&commonjsRequire,h=0;h<l.length;h++)p(l[h]);return p}return i}()({1:[function(i,a,c){function l(S){var v=S.length;if(0<v%4)throw new Error("Invalid string. Length must be a multiple of 4");var I=S.indexOf("=");I===-1&&(I=v);var C=I===v?0:4-I%4;return[I,C]}function p(S,v,I){return 3*(v+I)/4-I}function m(S){var v,I,C=l(S),R=C[0],B=C[1],A=new L(p(S,R,B)),T=0,P=0<B?R-4:R;for(I=0;I<P;I+=4)v=_[S.charCodeAt(I)]<<18|_[S.charCodeAt(I+1)]<<12|_[S.charCodeAt(I+2)]<<6|_[S.charCodeAt(I+3)],A[T++]=255&v>>16,A[T++]=255&v>>8,A[T++]=255&v;return B===2&&(v=_[S.charCodeAt(I)]<<2|_[S.charCodeAt(I+1)]>>4,A[T++]=255&v),B===1&&(v=_[S.charCodeAt(I)]<<10|_[S.charCodeAt(I+1)]<<4|_[S.charCodeAt(I+2)]>>2,A[T++]=255&v>>8,A[T++]=255&v),A}function h(S){return g[63&S>>18]+g[63&S>>12]+g[63&S>>6]+g[63&S]}function f(S,v,I){for(var C,R=[],B=v;B<I;B+=3)C=(16711680&S[B]<<16)+(65280&S[B+1]<<8)+(255&S[B+2]),R.push(h(C));return R.join("")}function y(S){for(var v,I=S.length,C=I%3,R=[],B=16383,A=0,T=I-C;A<T;A+=B)R.push(f(S,A,A+B>T?T:A+B));return C===1?(v=S[I-1],R.push(g[v>>2]+g[63&v<<4]+"==")):C===2&&(v=(S[I-2]<<8)+S[I-1],R.push(g[v>>10]+g[63&v>>4]+g[63&v<<2]+"=")),R.join("")}c.byteLength=function(S){var v=l(S),I=v[0],C=v[1];return 3*(I+C)/4-C},c.toByteArray=m,c.fromByteArray=y;for(var g=[],_=[],L=typeof Uint8Array>"u"?Array:Uint8Array,x="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",O=0,w=x.length;O<w;++O)g[O]=x[O],_[x.charCodeAt(O)]=O;_[45]=62,_[95]=63},{}],2:[function(){},{}],3:[function(i,a,c){(function(){(function(){var l=String.fromCharCode,p=Math.min;function m(o){if(2147483647<o)throw new RangeError('The value "'+o+'" is invalid for option "size"');var d=new Uint8Array(o);return d.__proto__=h.prototype,d}function h(o,d,u){if(typeof o=="number"){if(typeof d=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return _(o)}return f(o,d,u)}function f(o,d,u){if(typeof o=="string")return L(o,d);if(ArrayBuffer.isView(o))return x(o);if(o==null)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(D(o,ArrayBuffer)||o&&D(o.buffer,ArrayBuffer))return O(o,d,u);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');var E=o.valueOf&&o.valueOf();if(E!=null&&E!==o)return h.from(E,d,u);var k=w(o);if(k)return k;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return h.from(o[Symbol.toPrimitive]("string"),d,u);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}function y(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(0>o)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function g(o,d,u){return y(o),0>=o||d===void 0?m(o):typeof u=="string"?m(o).fill(d,u):m(o).fill(d)}function _(o){return y(o),m(0>o?0:0|S(o))}function L(o,d){if((typeof d!="string"||d==="")&&(d="utf8"),!h.isEncoding(d))throw new TypeError("Unknown encoding: "+d);var u=0|v(o,d),E=m(u),k=E.write(o,d);return k!==u&&(E=E.slice(0,k)),E}function x(o){for(var d=0>o.length?0:0|S(o.length),u=m(d),E=0;E<d;E+=1)u[E]=255&o[E];return u}function O(o,d,u){if(0>d||o.byteLength<d)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<d+(u||0))throw new RangeError('"length" is outside of buffer bounds');var E;return E=d===void 0&&u===void 0?new Uint8Array(o):u===void 0?new Uint8Array(o,d):new Uint8Array(o,d,u),E.__proto__=h.prototype,E}function w(o){if(h.isBuffer(o)){var d=0|S(o.length),u=m(d);return u.length===0||o.copy(u,0,0,d),u}return o.length===void 0?o.type==="Buffer"&&Array.isArray(o.data)?x(o.data):void 0:typeof o.length!="number"||U(o.length)?m(0):x(o)}function S(o){if(o>=2147483647)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x7fffffff bytes");return 0|o}function v(o,d){if(h.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||D(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);var u=o.length,E=2<arguments.length&&arguments[2]===!0;if(!E&&u===0)return 0;for(var k=!1;;)switch(d){case"ascii":case"latin1":case"binary":return u;case"utf8":case"utf-8":return de(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*u;case"hex":return u>>>1;case"base64":return ne(o).length;default:if(k)return E?-1:de(o).length;d=(""+d).toLowerCase(),k=!0}}function I(o,d,u){var E=!1;if((d===void 0||0>d)&&(d=0),d>this.length||((u===void 0||u>this.length)&&(u=this.length),0>=u)||(u>>>=0,d>>>=0,u<=d))return"";for(o||(o="utf8");;)switch(o){case"hex":return te(this,d,u);case"utf8":case"utf-8":return Q(this,d,u);case"ascii":return z(this,d,u);case"latin1":case"binary":return ue(this,d,u);case"base64":return Y(this,d,u);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ie(this,d,u);default:if(E)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),E=!0}}function C(o,d,u){var E=o[d];o[d]=o[u],o[u]=E}function R(o,d,u,E,k){if(o.length===0)return-1;if(typeof u=="string"?(E=u,u=0):2147483647<u?u=2147483647:-2147483648>u&&(u=-2147483648),u=+u,U(u)&&(u=k?0:o.length-1),0>u&&(u=o.length+u),u>=o.length){if(k)return-1;u=o.length-1}else if(0>u)if(k)u=0;else return-1;if(typeof d=="string"&&(d=h.from(d,E)),h.isBuffer(d))return d.length===0?-1:B(o,d,u,E,k);if(typeof d=="number")return d&=255,typeof Uint8Array.prototype.indexOf=="function"?k?Uint8Array.prototype.indexOf.call(o,d,u):Uint8Array.prototype.lastIndexOf.call(o,d,u):B(o,[d],u,E,k);throw new TypeError("val must be string, number or Buffer")}function B(o,d,u,E,k){function M(fe,we){return V===1?fe[we]:fe.readUInt16BE(we*V)}var V=1,H=o.length,J=d.length;if(E!==void 0&&(E=(E+"").toLowerCase(),E==="ucs2"||E==="ucs-2"||E==="utf16le"||E==="utf-16le")){if(2>o.length||2>d.length)return-1;V=2,H/=2,J/=2,u/=2}var G;if(k){var W=-1;for(G=u;G<H;G++)if(M(o,G)!==M(d,W===-1?0:G-W))W!==-1&&(G-=G-W),W=-1;else if(W===-1&&(W=G),G-W+1===J)return W*V}else for(u+J>H&&(u=H-J),G=u;0<=G;G--){for(var Z=!0,he=0;he<J;he++)if(M(o,G+he)!==M(d,he)){Z=!1;break}if(Z)return G}return-1}function A(o,d,u,E){u=+u||0;var k=o.length-u;E?(E=+E,E>k&&(E=k)):E=k;var M=d.length;E>M/2&&(E=M/2);for(var V,H=0;H<E;++H){if(V=parseInt(d.substr(2*H,2),16),U(V))return H;o[u+H]=V}return H}function T(o,d,u,E){return se(de(d,o.length-u),o,u,E)}function P(o,d,u,E){return se(ye(d),o,u,E)}function F(o,d,u,E){return P(o,d,u,E)}function j(o,d,u,E){return se(ne(d),o,u,E)}function q(o,d,u,E){return se(ce(d,o.length-u),o,u,E)}function Y(o,d,u){return d===0&&u===o.length?N.fromByteArray(o):N.fromByteArray(o.slice(d,u))}function Q(o,d,u){u=p(o.length,u);for(var E=[],k=d;k<u;){var M=o[k],V=null,H=239<M?4:223<M?3:191<M?2:1;if(k+H<=u){var J,G,W,Z;H===1?128>M&&(V=M):H===2?(J=o[k+1],(192&J)==128&&(Z=(31&M)<<6|63&J,127<Z&&(V=Z))):H===3?(J=o[k+1],G=o[k+2],(192&J)==128&&(192&G)==128&&(Z=(15&M)<<12|(63&J)<<6|63&G,2047<Z&&(55296>Z||57343<Z)&&(V=Z))):H===4&&(J=o[k+1],G=o[k+2],W=o[k+3],(192&J)==128&&(192&G)==128&&(192&W)==128&&(Z=(15&M)<<18|(63&J)<<12|(63&G)<<6|63&W,65535<Z&&1114112>Z&&(V=Z)))}V===null?(V=65533,H=1):65535<V&&(V-=65536,E.push(55296|1023&V>>>10),V=56320|1023&V),E.push(V),k+=H}return ee(E)}function ee(o){var d=o.length;if(d<=4096)return l.apply(String,o);for(var u="",E=0;E<d;)u+=l.apply(String,o.slice(E,E+=4096));return u}function z(o,d,u){var E="";u=p(o.length,u);for(var k=d;k<u;++k)E+=l(127&o[k]);return E}function ue(o,d,u){var E="";u=p(o.length,u);for(var k=d;k<u;++k)E+=l(o[k]);return E}function te(o,d,u){var E=o.length;(!d||0>d)&&(d=0),(!u||0>u||u>E)&&(u=E);for(var k="",M=d;M<u;++M)k+=le(o[M]);return k}function ie(o,d,u){for(var E=o.slice(d,u),k="",M=0;M<E.length;M+=2)k+=l(E[M]+256*E[M+1]);return k}function X(o,d,u){if(o%1!=0||0>o)throw new RangeError("offset is not uint");if(o+d>u)throw new RangeError("Trying to access beyond buffer length")}function K(o,d,u,E,k,M){if(!h.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(d>k||d<M)throw new RangeError('"value" argument is out of bounds');if(u+E>o.length)throw new RangeError("Index out of range")}function re(o,d,u,E){if(u+E>o.length)throw new RangeError("Index out of range");if(0>u)throw new RangeError("Index out of range")}function oe(o,d,u,E,k){return d=+d,u>>>=0,k||re(o,d,u,4),$.write(o,d,u,E,23,4),u+4}function ae(o,d,u,E,k){return d=+d,u>>>=0,k||re(o,d,u,8),$.write(o,d,u,E,52,8),u+8}function me(o){if(o=o.split("=")[0],o=o.trim().replace(b,""),2>o.length)return"";for(;o.length%4!=0;)o+="=";return o}function le(o){return 16>o?"0"+o.toString(16):o.toString(16)}function de(o,d){d=d||1/0;for(var u,E=o.length,k=null,M=[],V=0;V<E;++V){if(u=o.charCodeAt(V),55295<u&&57344>u){if(!k){if(56319<u){-1<(d-=3)&&M.push(239,191,189);continue}else if(V+1===E){-1<(d-=3)&&M.push(239,191,189);continue}k=u;continue}if(56320>u){-1<(d-=3)&&M.push(239,191,189),k=u;continue}u=(k-55296<<10|u-56320)+65536}else k&&-1<(d-=3)&&M.push(239,191,189);if(k=null,128>u){if(0>(d-=1))break;M.push(u)}else if(2048>u){if(0>(d-=2))break;M.push(192|u>>6,128|63&u)}else if(65536>u){if(0>(d-=3))break;M.push(224|u>>12,128|63&u>>6,128|63&u)}else if(1114112>u){if(0>(d-=4))break;M.push(240|u>>18,128|63&u>>12,128|63&u>>6,128|63&u)}else throw new Error("Invalid code point")}return M}function ye(o){for(var d=[],u=0;u<o.length;++u)d.push(255&o.charCodeAt(u));return d}function ce(o,d){for(var u,E,k,M=[],V=0;V<o.length&&!(0>(d-=2));++V)u=o.charCodeAt(V),E=u>>8,k=u%256,M.push(k),M.push(E);return M}function ne(o){return N.toByteArray(me(o))}function se(o,d,u,E){for(var k=0;k<E&&!(k+u>=d.length||k>=o.length);++k)d[k+u]=o[k];return k}function D(o,d){return o instanceof d||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===d.name}function U(o){return o!==o}var N=i("base64-js"),$=i("ieee754");c.Buffer=h,c.SlowBuffer=function(o){return+o!=o&&(o=0),h.alloc(+o)},c.INSPECT_MAX_BYTES=50,c.kMaxLength=2147483647,h.TYPED_ARRAY_SUPPORT=function(){try{var o=new Uint8Array(1);return o.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},o.foo()===42}catch{return!1}}(),h.TYPED_ARRAY_SUPPORT||typeof console>"u"||typeof console.error!="function"||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){return h.isBuffer(this)?this.buffer:void 0}}),Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){return h.isBuffer(this)?this.byteOffset:void 0}}),typeof Symbol<"u"&&Symbol.species!=null&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),h.poolSize=8192,h.from=function(o,d,u){return f(o,d,u)},h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array,h.alloc=function(o,d,u){return g(o,d,u)},h.allocUnsafe=function(o){return _(o)},h.allocUnsafeSlow=function(o){return _(o)},h.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==h.prototype},h.compare=function(o,d){if(D(o,Uint8Array)&&(o=h.from(o,o.offset,o.byteLength)),D(d,Uint8Array)&&(d=h.from(d,d.offset,d.byteLength)),!h.isBuffer(o)||!h.isBuffer(d))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===d)return 0;for(var u=o.length,E=d.length,k=0,M=p(u,E);k<M;++k)if(o[k]!==d[k]){u=o[k],E=d[k];break}return u<E?-1:E<u?1:0},h.isEncoding=function(o){switch((o+"").toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(o,d){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return h.alloc(0);var u;if(d===void 0)for(d=0,u=0;u<o.length;++u)d+=o[u].length;var E=h.allocUnsafe(d),k=0;for(u=0;u<o.length;++u){var M=o[u];if(D(M,Uint8Array)&&(M=h.from(M)),!h.isBuffer(M))throw new TypeError('"list" argument must be an Array of Buffers');M.copy(E,k),k+=M.length}return E},h.byteLength=v,h.prototype._isBuffer=!0,h.prototype.swap16=function(){var o=this.length;if(o%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var d=0;d<o;d+=2)C(this,d,d+1);return this},h.prototype.swap32=function(){var o=this.length;if(o%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var d=0;d<o;d+=4)C(this,d,d+3),C(this,d+1,d+2);return this},h.prototype.swap64=function(){var o=this.length;if(o%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var d=0;d<o;d+=8)C(this,d,d+7),C(this,d+1,d+6),C(this,d+2,d+5),C(this,d+3,d+4);return this},h.prototype.toString=function(){var o=this.length;return o===0?"":arguments.length===0?Q(this,0,o):I.apply(this,arguments)},h.prototype.toLocaleString=h.prototype.toString,h.prototype.equals=function(o){if(!h.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o||h.compare(this,o)===0},h.prototype.inspect=function(){var o="",d=c.INSPECT_MAX_BYTES;return o=this.toString("hex",0,d).replace(/(.{2})/g,"$1 ").trim(),this.length>d&&(o+=" ... "),"<Buffer "+o+">"},h.prototype.compare=function(o,d,u,E,k){if(D(o,Uint8Array)&&(o=h.from(o,o.offset,o.byteLength)),!h.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(d===void 0&&(d=0),u===void 0&&(u=o?o.length:0),E===void 0&&(E=0),k===void 0&&(k=this.length),0>d||u>o.length||0>E||k>this.length)throw new RangeError("out of range index");if(E>=k&&d>=u)return 0;if(E>=k)return-1;if(d>=u)return 1;if(d>>>=0,u>>>=0,E>>>=0,k>>>=0,this===o)return 0;for(var M=k-E,V=u-d,H=p(M,V),J=this.slice(E,k),G=o.slice(d,u),W=0;W<H;++W)if(J[W]!==G[W]){M=J[W],V=G[W];break}return M<V?-1:V<M?1:0},h.prototype.includes=function(o,d,u){return this.indexOf(o,d,u)!==-1},h.prototype.indexOf=function(o,d,u){return R(this,o,d,u,!0)},h.prototype.lastIndexOf=function(o,d,u){return R(this,o,d,u,!1)},h.prototype.write=function(o,d,u,E){if(d===void 0)E="utf8",u=this.length,d=0;else if(u===void 0&&typeof d=="string")E=d,u=this.length,d=0;else if(isFinite(d))d>>>=0,isFinite(u)?(u>>>=0,E===void 0&&(E="utf8")):(E=u,u=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");var k=this.length-d;if((u===void 0||u>k)&&(u=k),0<o.length&&(0>u||0>d)||d>this.length)throw new RangeError("Attempt to write outside buffer bounds");E||(E="utf8");for(var M=!1;;)switch(E){case"hex":return A(this,o,d,u);case"utf8":case"utf-8":return T(this,o,d,u);case"ascii":return P(this,o,d,u);case"latin1":case"binary":return F(this,o,d,u);case"base64":return j(this,o,d,u);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return q(this,o,d,u);default:if(M)throw new TypeError("Unknown encoding: "+E);E=(""+E).toLowerCase(),M=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},h.prototype.slice=function(o,d){var u=this.length;o=~~o,d=d===void 0?u:~~d,0>o?(o+=u,0>o&&(o=0)):o>u&&(o=u),0>d?(d+=u,0>d&&(d=0)):d>u&&(d=u),d<o&&(d=o);var E=this.subarray(o,d);return E.__proto__=h.prototype,E},h.prototype.readUIntLE=function(o,d,u){o>>>=0,d>>>=0,u||X(o,d,this.length);for(var E=this[o],k=1,M=0;++M<d&&(k*=256);)E+=this[o+M]*k;return E},h.prototype.readUIntBE=function(o,d,u){o>>>=0,d>>>=0,u||X(o,d,this.length);for(var E=this[o+--d],k=1;0<d&&(k*=256);)E+=this[o+--d]*k;return E},h.prototype.readUInt8=function(o,d){return o>>>=0,d||X(o,1,this.length),this[o]},h.prototype.readUInt16LE=function(o,d){return o>>>=0,d||X(o,2,this.length),this[o]|this[o+1]<<8},h.prototype.readUInt16BE=function(o,d){return o>>>=0,d||X(o,2,this.length),this[o]<<8|this[o+1]},h.prototype.readUInt32LE=function(o,d){return o>>>=0,d||X(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+16777216*this[o+3]},h.prototype.readUInt32BE=function(o,d){return o>>>=0,d||X(o,4,this.length),16777216*this[o]+(this[o+1]<<16|this[o+2]<<8|this[o+3])},h.prototype.readIntLE=function(o,d,u){o>>>=0,d>>>=0,u||X(o,d,this.length);for(var E=this[o],k=1,M=0;++M<d&&(k*=256);)E+=this[o+M]*k;return k*=128,E>=k&&(E-=s(2,8*d)),E},h.prototype.readIntBE=function(o,d,u){o>>>=0,d>>>=0,u||X(o,d,this.length);for(var E=d,k=1,M=this[o+--E];0<E&&(k*=256);)M+=this[o+--E]*k;return k*=128,M>=k&&(M-=s(2,8*d)),M},h.prototype.readInt8=function(o,d){return o>>>=0,d||X(o,1,this.length),128&this[o]?-1*(255-this[o]+1):this[o]},h.prototype.readInt16LE=function(o,d){o>>>=0,d||X(o,2,this.length);var u=this[o]|this[o+1]<<8;return 32768&u?4294901760|u:u},h.prototype.readInt16BE=function(o,d){o>>>=0,d||X(o,2,this.length);var u=this[o+1]|this[o]<<8;return 32768&u?4294901760|u:u},h.prototype.readInt32LE=function(o,d){return o>>>=0,d||X(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},h.prototype.readInt32BE=function(o,d){return o>>>=0,d||X(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},h.prototype.readFloatLE=function(o,d){return o>>>=0,d||X(o,4,this.length),$.read(this,o,!0,23,4)},h.prototype.readFloatBE=function(o,d){return o>>>=0,d||X(o,4,this.length),$.read(this,o,!1,23,4)},h.prototype.readDoubleLE=function(o,d){return o>>>=0,d||X(o,8,this.length),$.read(this,o,!0,52,8)},h.prototype.readDoubleBE=function(o,d){return o>>>=0,d||X(o,8,this.length),$.read(this,o,!1,52,8)},h.prototype.writeUIntLE=function(o,d,u,E){if(o=+o,d>>>=0,u>>>=0,!E){var k=s(2,8*u)-1;K(this,o,d,u,k,0)}var M=1,V=0;for(this[d]=255&o;++V<u&&(M*=256);)this[d+V]=255&o/M;return d+u},h.prototype.writeUIntBE=function(o,d,u,E){if(o=+o,d>>>=0,u>>>=0,!E){var k=s(2,8*u)-1;K(this,o,d,u,k,0)}var M=u-1,V=1;for(this[d+M]=255&o;0<=--M&&(V*=256);)this[d+M]=255&o/V;return d+u},h.prototype.writeUInt8=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,1,255,0),this[d]=255&o,d+1},h.prototype.writeUInt16LE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,2,65535,0),this[d]=255&o,this[d+1]=o>>>8,d+2},h.prototype.writeUInt16BE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,2,65535,0),this[d]=o>>>8,this[d+1]=255&o,d+2},h.prototype.writeUInt32LE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,4,4294967295,0),this[d+3]=o>>>24,this[d+2]=o>>>16,this[d+1]=o>>>8,this[d]=255&o,d+4},h.prototype.writeUInt32BE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,4,4294967295,0),this[d]=o>>>24,this[d+1]=o>>>16,this[d+2]=o>>>8,this[d+3]=255&o,d+4},h.prototype.writeIntLE=function(o,d,u,E){if(o=+o,d>>>=0,!E){var k=s(2,8*u-1);K(this,o,d,u,k-1,-k)}var M=0,V=1,H=0;for(this[d]=255&o;++M<u&&(V*=256);)0>o&&H===0&&this[d+M-1]!==0&&(H=1),this[d+M]=255&(o/V>>0)-H;return d+u},h.prototype.writeIntBE=function(o,d,u,E){if(o=+o,d>>>=0,!E){var k=s(2,8*u-1);K(this,o,d,u,k-1,-k)}var M=u-1,V=1,H=0;for(this[d+M]=255&o;0<=--M&&(V*=256);)0>o&&H===0&&this[d+M+1]!==0&&(H=1),this[d+M]=255&(o/V>>0)-H;return d+u},h.prototype.writeInt8=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,1,127,-128),0>o&&(o=255+o+1),this[d]=255&o,d+1},h.prototype.writeInt16LE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,2,32767,-32768),this[d]=255&o,this[d+1]=o>>>8,d+2},h.prototype.writeInt16BE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,2,32767,-32768),this[d]=o>>>8,this[d+1]=255&o,d+2},h.prototype.writeInt32LE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,4,2147483647,-2147483648),this[d]=255&o,this[d+1]=o>>>8,this[d+2]=o>>>16,this[d+3]=o>>>24,d+4},h.prototype.writeInt32BE=function(o,d,u){return o=+o,d>>>=0,u||K(this,o,d,4,2147483647,-2147483648),0>o&&(o=4294967295+o+1),this[d]=o>>>24,this[d+1]=o>>>16,this[d+2]=o>>>8,this[d+3]=255&o,d+4},h.prototype.writeFloatLE=function(o,d,u){return oe(this,o,d,!0,u)},h.prototype.writeFloatBE=function(o,d,u){return oe(this,o,d,!1,u)},h.prototype.writeDoubleLE=function(o,d,u){return ae(this,o,d,!0,u)},h.prototype.writeDoubleBE=function(o,d,u){return ae(this,o,d,!1,u)},h.prototype.copy=function(o,d,u,E){if(!h.isBuffer(o))throw new TypeError("argument should be a Buffer");if(u||(u=0),E||E===0||(E=this.length),d>=o.length&&(d=o.length),d||(d=0),0<E&&E<u&&(E=u),E===u||o.length===0||this.length===0)return 0;if(0>d)throw new RangeError("targetStart out of bounds");if(0>u||u>=this.length)throw new RangeError("Index out of range");if(0>E)throw new RangeError("sourceEnd out of bounds");E>this.length&&(E=this.length),o.length-d<E-u&&(E=o.length-d+u);var k=E-u;if(this===o&&typeof Uint8Array.prototype.copyWithin=="function")this.copyWithin(d,u,E);else if(this===o&&u<d&&d<E)for(var M=k-1;0<=M;--M)o[M+d]=this[M+u];else Uint8Array.prototype.set.call(o,this.subarray(u,E),d);return k},h.prototype.fill=function(o,d,u,E){if(typeof o=="string"){if(typeof d=="string"?(E=d,d=0,u=this.length):typeof u=="string"&&(E=u,u=this.length),E!==void 0&&typeof E!="string")throw new TypeError("encoding must be a string");if(typeof E=="string"&&!h.isEncoding(E))throw new TypeError("Unknown encoding: "+E);if(o.length===1){var k=o.charCodeAt(0);(E==="utf8"&&128>k||E==="latin1")&&(o=k)}}else typeof o=="number"&&(o&=255);if(0>d||this.length<d||this.length<u)throw new RangeError("Out of range index");if(u<=d)return this;d>>>=0,u=u===void 0?this.length:u>>>0,o||(o=0);var M;if(typeof o=="number")for(M=d;M<u;++M)this[M]=o;else{var V=h.isBuffer(o)?o:h.from(o,E),H=V.length;if(H===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(M=0;M<u-d;++M)this[M+d]=V[M%H]}return this};var b=/[^+/0-9A-Za-z-_]/g}).call(this)}).call(this,i("buffer").Buffer)},{"base64-js":1,buffer:3,ieee754:9}],4:[function(i,a,c){(function(l){(function(){function p(){let h;try{h=c.storage.getItem("debug")}catch{}return!h&&typeof l<"u"&&"env"in l&&(h=l.env.DEBUG),h}c.formatArgs=function(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+a.exports.humanize(this.diff),!this.useColors)return;const f="color: "+this.color;h.splice(1,0,f,"color: inherit");let y=0,g=0;h[0].replace(/%[a-zA-Z%]/g,_=>{_==="%%"||(y++,_==="%c"&&(g=y))}),h.splice(g,0,f)},c.save=function(h){try{h?c.storage.setItem("debug",h):c.storage.removeItem("debug")}catch{}},c.load=p,c.useColors=function(){return!!(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))||!(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&(typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},c.storage=function(){try{return localStorage}catch{}}(),c.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),c.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],c.log=console.debug||console.log||(()=>{}),a.exports=i("./common")(c);const{formatters:m}=a.exports;m.j=function(h){try{return JSON.stringify(h)}catch(f){return"[UnexpectedJSONParseError]: "+f.message}}}).call(this)}).call(this,i("_process"))},{"./common":5,_process:12}],5:[function(i,a){a.exports=function(c){function l(h){function f(..._){if(!f.enabled)return;const L=f,x=+new Date,O=x-(y||x);L.diff=O,L.prev=y,L.curr=x,y=x,_[0]=l.coerce(_[0]),typeof _[0]!="string"&&_.unshift("%O");let w=0;_[0]=_[0].replace(/%([a-zA-Z%])/g,(v,I)=>{if(v==="%%")return"%";w++;const C=l.formatters[I];if(typeof C=="function"){const R=_[w];v=C.call(L,R),_.splice(w,1),w--}return v}),l.formatArgs.call(L,_),(L.log||l.log).apply(L,_)}let y,g=null;return f.namespace=h,f.useColors=l.useColors(),f.color=l.selectColor(h),f.extend=p,f.destroy=l.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>g===null?l.enabled(h):g,set:_=>{g=_}}),typeof l.init=="function"&&l.init(f),f}function p(h,f){const y=l(this.namespace+(typeof f>"u"?":":f)+h);return y.log=this.log,y}function m(h){return h.toString().substring(2,h.toString().length-2).replace(/\.\*\?$/,"*")}return l.debug=l,l.default=l,l.coerce=function(h){return h instanceof Error?h.stack||h.message:h},l.disable=function(){const h=[...l.names.map(m),...l.skips.map(m).map(f=>"-"+f)].join(",");return l.enable(""),h},l.enable=function(h){l.save(h),l.names=[],l.skips=[];let f;const y=(typeof h=="string"?h:"").split(/[\s,]+/),g=y.length;for(f=0;f<g;f++)y[f]&&(h=y[f].replace(/\*/g,".*?"),h[0]==="-"?l.skips.push(new RegExp("^"+h.substr(1)+"$")):l.names.push(new RegExp("^"+h+"$")))},l.enabled=function(h){if(h[h.length-1]==="*")return!0;let f,y;for(f=0,y=l.skips.length;f<y;f++)if(l.skips[f].test(h))return!1;for(f=0,y=l.names.length;f<y;f++)if(l.names[f].test(h))return!0;return!1},l.humanize=i("ms"),l.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(c).forEach(h=>{l[h]=c[h]}),l.names=[],l.skips=[],l.formatters={},l.selectColor=function(h){let f=0;for(let y=0;y<h.length;y++)f=(f<<5)-f+h.charCodeAt(y),f|=0;return l.colors[r(f)%l.colors.length]},l.enable(l.load()),l}},{ms:11}],6:[function(i,a){function c(l,p){for(const m in p)Object.defineProperty(l,m,{value:p[m],enumerable:!0,configurable:!0});return l}a.exports=function(l,p,m){if(!l||typeof l=="string")throw new TypeError("Please pass an Error to err-code");m||(m={}),typeof p=="object"&&(m=p,p=""),p&&(m.code=p);try{return c(l,m)}catch{m.message=l.message,m.stack=l.stack;const f=function(){};return f.prototype=Object.create(Object.getPrototypeOf(l)),c(new f,m)}}},{}],7:[function(i,a){function c(A){console&&console.warn&&console.warn(A)}function l(){l.init.call(this)}function p(A){if(typeof A!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof A)}function m(A){return A._maxListeners===void 0?l.defaultMaxListeners:A._maxListeners}function h(A,T,P,F){var j,q,Y;if(p(P),q=A._events,q===void 0?(q=A._events=Object.create(null),A._eventsCount=0):(q.newListener!==void 0&&(A.emit("newListener",T,P.listener?P.listener:P),q=A._events),Y=q[T]),Y===void 0)Y=q[T]=P,++A._eventsCount;else if(typeof Y=="function"?Y=q[T]=F?[P,Y]:[Y,P]:F?Y.unshift(P):Y.push(P),j=m(A),0<j&&Y.length>j&&!Y.warned){Y.warned=!0;var Q=new Error("Possible EventEmitter memory leak detected. "+Y.length+" "+(T+" listeners added. Use emitter.setMaxListeners() to increase limit"));Q.name="MaxListenersExceededWarning",Q.emitter=A,Q.type=T,Q.count=Y.length,c(Q)}return A}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function y(A,T,P){var F={fired:!1,wrapFn:void 0,target:A,type:T,listener:P},j=f.bind(F);return j.listener=P,F.wrapFn=j,j}function g(A,T,P){var F=A._events;if(F===void 0)return[];var j=F[T];return j===void 0?[]:typeof j=="function"?P?[j.listener||j]:[j]:P?O(j):L(j,j.length)}function _(A){var T=this._events;if(T!==void 0){var P=T[A];if(typeof P=="function")return 1;if(P!==void 0)return P.length}return 0}function L(A,T){for(var P=Array(T),F=0;F<T;++F)P[F]=A[F];return P}function x(A,T){for(;T+1<A.length;T++)A[T]=A[T+1];A.pop()}function O(A){for(var T=Array(A.length),P=0;P<T.length;++P)T[P]=A[P].listener||A[P];return T}function w(A,T,P){typeof A.on=="function"&&S(A,"error",T,P)}function S(A,T,P,F){if(typeof A.on=="function")F.once?A.once(T,P):A.on(T,P);else if(typeof A.addEventListener=="function")A.addEventListener(T,function j(q){F.once&&A.removeEventListener(T,j),P(q)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof A)}var v,I=typeof Reflect=="object"?Reflect:null,C=I&&typeof I.apply=="function"?I.apply:function(A,T,P){return Function.prototype.apply.call(A,T,P)};v=I&&typeof I.ownKeys=="function"?I.ownKeys:Object.getOwnPropertySymbols?function(A){return Object.getOwnPropertyNames(A).concat(Object.getOwnPropertySymbols(A))}:function(A){return Object.getOwnPropertyNames(A)};var R=Number.isNaN||function(A){return A!==A};a.exports=l,a.exports.once=function(A,T){return new Promise(function(P,F){function j(Y){A.removeListener(T,q),F(Y)}function q(){typeof A.removeListener=="function"&&A.removeListener("error",j),P([].slice.call(arguments))}S(A,T,q,{once:!0}),T!=="error"&&w(A,j,{once:!0})})},l.EventEmitter=l,l.prototype._events=void 0,l.prototype._eventsCount=0,l.prototype._maxListeners=void 0;var B=10;Object.defineProperty(l,"defaultMaxListeners",{enumerable:!0,get:function(){return B},set:function(A){if(typeof A!="number"||0>A||R(A))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+A+".");B=A}}),l.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},l.prototype.setMaxListeners=function(A){if(typeof A!="number"||0>A||R(A))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+A+".");return this._maxListeners=A,this},l.prototype.getMaxListeners=function(){return m(this)},l.prototype.emit=function(A){for(var T=[],P=1;P<arguments.length;P++)T.push(arguments[P]);var F=A==="error",j=this._events;if(j!==void 0)F=F&&j.error===void 0;else if(!F)return!1;if(F){var q;if(0<T.length&&(q=T[0]),q instanceof Error)throw q;var Y=new Error("Unhandled error."+(q?" ("+q.message+")":""));throw Y.context=q,Y}var Q=j[A];if(Q===void 0)return!1;if(typeof Q=="function")C(Q,this,T);else for(var ee=Q.length,z=L(Q,ee),P=0;P<ee;++P)C(z[P],this,T);return!0},l.prototype.addListener=function(A,T){return h(this,A,T,!1)},l.prototype.on=l.prototype.addListener,l.prototype.prependListener=function(A,T){return h(this,A,T,!0)},l.prototype.once=function(A,T){return p(T),this.on(A,y(this,A,T)),this},l.prototype.prependOnceListener=function(A,T){return p(T),this.prependListener(A,y(this,A,T)),this},l.prototype.removeListener=function(A,T){var P,F,j,q,Y;if(p(T),F=this._events,F===void 0)return this;if(P=F[A],P===void 0)return this;if(P===T||P.listener===T)--this._eventsCount==0?this._events=Object.create(null):(delete F[A],F.removeListener&&this.emit("removeListener",A,P.listener||T));else if(typeof P!="function"){for(j=-1,q=P.length-1;0<=q;q--)if(P[q]===T||P[q].listener===T){Y=P[q].listener,j=q;break}if(0>j)return this;j===0?P.shift():x(P,j),P.length===1&&(F[A]=P[0]),F.removeListener!==void 0&&this.emit("removeListener",A,Y||T)}return this},l.prototype.off=l.prototype.removeListener,l.prototype.removeAllListeners=function(A){var T,P,F;if(P=this._events,P===void 0)return this;if(P.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):P[A]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete P[A]),this;if(arguments.length===0){var j,q=Object.keys(P);for(F=0;F<q.length;++F)j=q[F],j!=="removeListener"&&this.removeAllListeners(j);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(T=P[A],typeof T=="function")this.removeListener(A,T);else if(T!==void 0)for(F=T.length-1;0<=F;F--)this.removeListener(A,T[F]);return this},l.prototype.listeners=function(A){return g(this,A,!0)},l.prototype.rawListeners=function(A){return g(this,A,!1)},l.listenerCount=function(A,T){return typeof A.listenerCount=="function"?A.listenerCount(T):_.call(A,T)},l.prototype.listenerCount=_,l.prototype.eventNames=function(){return 0<this._eventsCount?v(this._events):[]}},{}],8:[function(i,a){a.exports=function(){if(typeof globalThis>"u")return null;var c={RTCPeerConnection:globalThis.RTCPeerConnection||globalThis.mozRTCPeerConnection||globalThis.webkitRTCPeerConnection,RTCSessionDescription:globalThis.RTCSessionDescription||globalThis.mozRTCSessionDescription||globalThis.webkitRTCSessionDescription,RTCIceCandidate:globalThis.RTCIceCandidate||globalThis.mozRTCIceCandidate||globalThis.webkitRTCIceCandidate};return c.RTCPeerConnection?c:null}},{}],9:[function(i,a,c){/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */c.read=function(l,p,m,h,f){var y,g,_=8*f-h-1,L=(1<<_)-1,x=L>>1,O=-7,w=m?f-1:0,S=m?-1:1,v=l[p+w];for(w+=S,y=v&(1<<-O)-1,v>>=-O,O+=_;0<O;y=256*y+l[p+w],w+=S,O-=8);for(g=y&(1<<-O)-1,y>>=-O,O+=h;0<O;g=256*g+l[p+w],w+=S,O-=8);if(y===0)y=1-x;else{if(y===L)return g?NaN:(v?-1:1)*(1/0);g+=s(2,h),y-=x}return(v?-1:1)*g*s(2,y-h)},c.write=function(l,p,m,h,f,y){var g,_,L,x=Math.LN2,O=Math.log,w=8*y-f-1,S=(1<<w)-1,v=S>>1,I=f===23?s(2,-24)-s(2,-77):0,C=h?0:y-1,R=h?1:-1,B=0>p||p===0&&0>1/p?1:0;for(p=r(p),isNaN(p)||p===1/0?(_=isNaN(p)?1:0,g=S):(g=t(O(p)/x),1>p*(L=s(2,-g))&&(g--,L*=2),p+=1<=g+v?I/L:I*s(2,1-v),2<=p*L&&(g++,L/=2),g+v>=S?(_=0,g=S):1<=g+v?(_=(p*L-1)*s(2,f),g+=v):(_=p*s(2,v-1)*s(2,f),g=0));8<=f;l[m+C]=255&_,C+=R,_/=256,f-=8);for(g=g<<f|_,w+=f;0<w;l[m+C]=255&g,C+=R,g/=256,w-=8);l[m+C-R]|=128*B}},{}],10:[function(i,a){a.exports=typeof Object.create=="function"?function(c,l){l&&(c.super_=l,c.prototype=Object.create(l.prototype,{constructor:{value:c,enumerable:!1,writable:!0,configurable:!0}}))}:function(c,l){if(l){c.super_=l;var p=function(){};p.prototype=l.prototype,c.prototype=new p,c.prototype.constructor=c}}},{}],11:[function(i,a){var c=Math.round;function l(f){if(f+="",!(100<f.length)){var y=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(f);if(y){var g=parseFloat(y[1]),_=(y[2]||"ms").toLowerCase();return _==="years"||_==="year"||_==="yrs"||_==="yr"||_==="y"?315576e5*g:_==="weeks"||_==="week"||_==="w"?6048e5*g:_==="days"||_==="day"||_==="d"?864e5*g:_==="hours"||_==="hour"||_==="hrs"||_==="hr"||_==="h"?36e5*g:_==="minutes"||_==="minute"||_==="mins"||_==="min"||_==="m"?6e4*g:_==="seconds"||_==="second"||_==="secs"||_==="sec"||_==="s"?1e3*g:_==="milliseconds"||_==="millisecond"||_==="msecs"||_==="msec"||_==="ms"?g:void 0}}}function p(f){var y=r(f);return 864e5<=y?c(f/864e5)+"d":36e5<=y?c(f/36e5)+"h":6e4<=y?c(f/6e4)+"m":1e3<=y?c(f/1e3)+"s":f+"ms"}function m(f){var y=r(f);return 864e5<=y?h(f,y,864e5,"day"):36e5<=y?h(f,y,36e5,"hour"):6e4<=y?h(f,y,6e4,"minute"):1e3<=y?h(f,y,1e3,"second"):f+" ms"}function h(f,y,g,_){return c(f/g)+" "+_+(y>=1.5*g?"s":"")}a.exports=function(f,y){y=y||{};var g=typeof f;if(g=="string"&&0<f.length)return l(f);if(g==="number"&&isFinite(f))return y.long?m(f):p(f);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(f))}},{}],12:[function(i,a){function c(){throw new Error("setTimeout has not been defined")}function l(){throw new Error("clearTimeout has not been defined")}function p(I){if(_===setTimeout)return setTimeout(I,0);if((_===c||!_)&&setTimeout)return _=setTimeout,setTimeout(I,0);try{return _(I,0)}catch{try{return _.call(null,I,0)}catch{return _.call(this,I,0)}}}function m(I){if(L===clearTimeout)return clearTimeout(I);if((L===l||!L)&&clearTimeout)return L=clearTimeout,clearTimeout(I);try{return L(I)}catch{try{return L.call(null,I)}catch{return L.call(this,I)}}}function h(){S&&O&&(S=!1,O.length?w=O.concat(w):v=-1,w.length&&f())}function f(){if(!S){var I=p(h);S=!0;for(var C=w.length;C;){for(O=w,w=[];++v<C;)O&&O[v].run();v=-1,C=w.length}O=null,S=!1,m(I)}}function y(I,C){this.fun=I,this.array=C}function g(){}var _,L,x=a.exports={};(function(){try{_=typeof setTimeout=="function"?setTimeout:c}catch{_=c}try{L=typeof clearTimeout=="function"?clearTimeout:l}catch{L=l}})();var O,w=[],S=!1,v=-1;x.nextTick=function(I){var C=Array(arguments.length-1);if(1<arguments.length)for(var R=1;R<arguments.length;R++)C[R-1]=arguments[R];w.push(new y(I,C)),w.length!==1||S||p(f)},y.prototype.run=function(){this.fun.apply(null,this.array)},x.title="browser",x.browser=!0,x.env={},x.argv=[],x.version="",x.versions={},x.on=g,x.addListener=g,x.once=g,x.off=g,x.removeListener=g,x.removeAllListeners=g,x.emit=g,x.prependListener=g,x.prependOnceListener=g,x.listeners=function(){return[]},x.binding=function(){throw new Error("process.binding is not supported")},x.cwd=function(){return"/"},x.chdir=function(){throw new Error("process.chdir is not supported")},x.umask=function(){return 0}},{}],13:[function(i,a){(function(c){(function(){/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let l;a.exports=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window>"u"?c:window):p=>(l||(l=Promise.resolve())).then(p).catch(m=>setTimeout(()=>{throw m},0))}).call(this)}).call(this,typeof commonjsGlobal>"u"?typeof self>"u"?typeof window>"u"?{}:window:self:commonjsGlobal)},{}],14:[function(i,a){(function(c,l){(function(){var p=i("safe-buffer").Buffer,m=l.crypto||l.msCrypto;a.exports=m&&m.getRandomValues?function(h,f){if(h>4294967295)throw new RangeError("requested too many random bytes");var y=p.allocUnsafe(h);if(0<h)if(65536<h)for(var g=0;g<h;g+=65536)m.getRandomValues(y.slice(g,g+65536));else m.getRandomValues(y);return typeof f=="function"?c.nextTick(function(){f(null,y)}):y}:function(){throw new Error(`Secure random number generation is not supported by this browser.
Use Chrome, Firefox or Internet Explorer 11`)}}).call(this)}).call(this,i("_process"),typeof commonjsGlobal>"u"?typeof self>"u"?typeof window>"u"?{}:window:self:commonjsGlobal)},{_process:12,"safe-buffer":30}],15:[function(i,a){function c(g,_){g.prototype=Object.create(_.prototype),g.prototype.constructor=g,g.__proto__=_}function l(g,_,L){function x(w,S,v){return typeof _=="string"?_:_(w,S,v)}L||(L=Error);var O=function(w){function S(v,I,C){return w.call(this,x(v,I,C))||this}return c(S,w),S}(L);O.prototype.name=L.name,O.prototype.code=g,y[g]=O}function p(g,_){if(Array.isArray(g)){var L=g.length;return g=g.map(function(x){return x+""}),2<L?"one of ".concat(_," ").concat(g.slice(0,L-1).join(", "),", or ")+g[L-1]:L===2?"one of ".concat(_," ").concat(g[0]," or ").concat(g[1]):"of ".concat(_," ").concat(g[0])}return"of ".concat(_," ").concat(g+"")}function m(g,_,L){return g.substr(0,_.length)===_}function h(g,_,L){return(L===void 0||L>g.length)&&(L=g.length),g.substring(L-_.length,L)===_}function f(g,_,L){return typeof L!="number"&&(L=0),!(L+_.length>g.length)&&g.indexOf(_,L)!==-1}var y={};l("ERR_INVALID_OPT_VALUE",function(g,_){return'The value "'+_+'" is invalid for option "'+g+'"'},TypeError),l("ERR_INVALID_ARG_TYPE",function(g,_,L){var x;typeof _=="string"&&m(_,"not ")?(x="must not be",_=_.replace(/^not /,"")):x="must be";var O;if(h(g," argument"))O="The ".concat(g," ").concat(x," ").concat(p(_,"type"));else{var w=f(g,".")?"property":"argument";O='The "'.concat(g,'" ').concat(w," ").concat(x," ").concat(p(_,"type"))}return O+=". Received type ".concat(typeof L),O},TypeError),l("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),l("ERR_METHOD_NOT_IMPLEMENTED",function(g){return"The "+g+" method is not implemented"}),l("ERR_STREAM_PREMATURE_CLOSE","Premature close"),l("ERR_STREAM_DESTROYED",function(g){return"Cannot call "+g+" after a stream was destroyed"}),l("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),l("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),l("ERR_STREAM_WRITE_AFTER_END","write after end"),l("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),l("ERR_UNKNOWN_ENCODING",function(g){return"Unknown encoding: "+g},TypeError),l("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),a.exports.codes=y},{}],16:[function(i,a){(function(c){(function(){function l(x){return this instanceof l?(f.call(this,x),y.call(this,x),this.allowHalfOpen=!0,void(x&&(x.readable===!1&&(this.readable=!1),x.writable===!1&&(this.writable=!1),x.allowHalfOpen===!1&&(this.allowHalfOpen=!1,this.once("end",p))))):new l(x)}function p(){this._writableState.ended||c.nextTick(m,this)}function m(x){x.end()}var h=Object.keys||function(x){var O=[];for(var w in x)O.push(w);return O};a.exports=l;var f=i("./_stream_readable"),y=i("./_stream_writable");i("inherits")(l,f);for(var g,_=h(y.prototype),L=0;L<_.length;L++)g=_[L],l.prototype[g]||(l.prototype[g]=y.prototype[g]);Object.defineProperty(l.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(l.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(l.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(l.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState!==void 0&&this._writableState!==void 0&&this._readableState.destroyed&&this._writableState.destroyed},set:function(x){this._readableState===void 0||this._writableState===void 0||(this._readableState.destroyed=x,this._writableState.destroyed=x)}})}).call(this)}).call(this,i("_process"))},{"./_stream_readable":18,"./_stream_writable":20,_process:12,inherits:10}],17:[function(i,a){function c(p){return this instanceof c?void l.call(this,p):new c(p)}a.exports=c;var l=i("./_stream_transform");i("inherits")(c,l),c.prototype._transform=function(p,m,h){h(null,p)}},{"./_stream_transform":19,inherits:10}],18:[function(i,a){(function(c,l){(function(){function p(b){return ie.from(b)}function m(b){return ie.isBuffer(b)||b instanceof X}function h(b,o,d){return typeof b.prependListener=="function"?b.prependListener(o,d):void(b._events&&b._events[o]?Array.isArray(b._events[o])?b._events[o].unshift(d):b._events[o]=[d,b._events[o]]:b.on(o,d))}function f(b,o,d){ee=ee||i("./_stream_duplex"),b=b||{},typeof d!="boolean"&&(d=o instanceof ee),this.objectMode=!!b.objectMode,d&&(this.objectMode=this.objectMode||!!b.readableObjectMode),this.highWaterMark=ye(this,b,"readableHighWaterMark",d),this.buffer=new me,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=b.emitClose!==!1,this.autoDestroy=!!b.autoDestroy,this.destroyed=!1,this.defaultEncoding=b.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,b.encoding&&(!re&&(re=i("string_decoder/").StringDecoder),this.decoder=new re(b.encoding),this.encoding=b.encoding)}function y(b){if(ee=ee||i("./_stream_duplex"),!(this instanceof y))return new y(b);var o=this instanceof ee;this._readableState=new f(b,this,o),this.readable=!0,b&&(typeof b.read=="function"&&(this._read=b.read),typeof b.destroy=="function"&&(this._destroy=b.destroy)),te.call(this)}function g(b,o,d,u,E){z("readableAddChunk",o);var k=b._readableState;if(o===null)k.reading=!1,w(b,k);else{var M;if(E||(M=L(k,o)),M)N(b,M);else if(!(k.objectMode||o&&0<o.length))u||(k.reading=!1,I(b,k));else if(typeof o=="string"||k.objectMode||Object.getPrototypeOf(o)===ie.prototype||(o=p(o)),u)k.endEmitted?N(b,new U):_(b,k,o,!0);else if(k.ended)N(b,new se);else{if(k.destroyed)return!1;k.reading=!1,k.decoder&&!d?(o=k.decoder.write(o),k.objectMode||o.length!==0?_(b,k,o,!1):I(b,k)):_(b,k,o,!1)}}return!k.ended&&(k.length<k.highWaterMark||k.length===0)}function _(b,o,d,u){o.flowing&&o.length===0&&!o.sync?(o.awaitDrain=0,b.emit("data",d)):(o.length+=o.objectMode?1:d.length,u?o.buffer.unshift(d):o.buffer.push(d),o.needReadable&&S(b)),I(b,o)}function L(b,o){var d;return m(o)||typeof o=="string"||o===void 0||b.objectMode||(d=new ne("chunk",["string","Buffer","Uint8Array"],o)),d}function x(b){return 1073741824<=b?b=1073741824:(b--,b|=b>>>1,b|=b>>>2,b|=b>>>4,b|=b>>>8,b|=b>>>16,b++),b}function O(b,o){return 0>=b||o.length===0&&o.ended?0:o.objectMode?1:b===b?(b>o.highWaterMark&&(o.highWaterMark=x(b)),b<=o.length?b:o.ended?o.length:(o.needReadable=!0,0)):o.flowing&&o.length?o.buffer.head.data.length:o.length}function w(b,o){if(z("onEofChunk"),!o.ended){if(o.decoder){var d=o.decoder.end();d&&d.length&&(o.buffer.push(d),o.length+=o.objectMode?1:d.length)}o.ended=!0,o.sync?S(b):(o.needReadable=!1,!o.emittedReadable&&(o.emittedReadable=!0,v(b)))}}function S(b){var o=b._readableState;z("emitReadable",o.needReadable,o.emittedReadable),o.needReadable=!1,o.emittedReadable||(z("emitReadable",o.flowing),o.emittedReadable=!0,c.nextTick(v,b))}function v(b){var o=b._readableState;z("emitReadable_",o.destroyed,o.length,o.ended),!o.destroyed&&(o.length||o.ended)&&(b.emit("readable"),o.emittedReadable=!1),o.needReadable=!o.flowing&&!o.ended&&o.length<=o.highWaterMark,F(b)}function I(b,o){o.readingMore||(o.readingMore=!0,c.nextTick(C,b,o))}function C(b,o){for(;!o.reading&&!o.ended&&(o.length<o.highWaterMark||o.flowing&&o.length===0);){var d=o.length;if(z("maybeReadMore read 0"),b.read(0),d===o.length)break}o.readingMore=!1}function R(b){return function(){var o=b._readableState;z("pipeOnDrain",o.awaitDrain),o.awaitDrain&&o.awaitDrain--,o.awaitDrain===0&&ue(b,"data")&&(o.flowing=!0,F(b))}}function B(b){var o=b._readableState;o.readableListening=0<b.listenerCount("readable"),o.resumeScheduled&&!o.paused?o.flowing=!0:0<b.listenerCount("data")&&b.resume()}function A(b){z("readable nexttick read 0"),b.read(0)}function T(b,o){o.resumeScheduled||(o.resumeScheduled=!0,c.nextTick(P,b,o))}function P(b,o){z("resume",o.reading),o.reading||b.read(0),o.resumeScheduled=!1,b.emit("resume"),F(b),o.flowing&&!o.reading&&b.read(0)}function F(b){var o=b._readableState;for(z("flow",o.flowing);o.flowing&&b.read()!==null;);}function j(b,o){if(o.length===0)return null;var d;return o.objectMode?d=o.buffer.shift():!b||b>=o.length?(d=o.decoder?o.buffer.join(""):o.buffer.length===1?o.buffer.first():o.buffer.concat(o.length),o.buffer.clear()):d=o.buffer.consume(b,o.decoder),d}function q(b){var o=b._readableState;z("endReadable",o.endEmitted),o.endEmitted||(o.ended=!0,c.nextTick(Y,o,b))}function Y(b,o){if(z("endReadableNT",b.endEmitted,b.length),!b.endEmitted&&b.length===0&&(b.endEmitted=!0,o.readable=!1,o.emit("end"),b.autoDestroy)){var d=o._writableState;(!d||d.autoDestroy&&d.finished)&&o.destroy()}}function Q(b,o){for(var d=0,u=b.length;d<u;d++)if(b[d]===o)return d;return-1}a.exports=y;var ee;y.ReadableState=f;var z;i("events").EventEmitter;var ue=function(b,o){return b.listeners(o).length},te=i("./internal/streams/stream"),ie=i("buffer").Buffer,X=l.Uint8Array||function(){},K=i("util");z=K&&K.debuglog?K.debuglog("stream"):function(){};var re,oe,ae,me=i("./internal/streams/buffer_list"),le=i("./internal/streams/destroy"),de=i("./internal/streams/state"),ye=de.getHighWaterMark,ce=i("../errors").codes,ne=ce.ERR_INVALID_ARG_TYPE,se=ce.ERR_STREAM_PUSH_AFTER_EOF,D=ce.ERR_METHOD_NOT_IMPLEMENTED,U=ce.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;i("inherits")(y,te);var N=le.errorOrDestroy,$=["error","close","destroy","pause","resume"];Object.defineProperty(y.prototype,"destroyed",{enumerable:!1,get:function(){return this._readableState!==void 0&&this._readableState.destroyed},set:function(b){this._readableState&&(this._readableState.destroyed=b)}}),y.prototype.destroy=le.destroy,y.prototype._undestroy=le.undestroy,y.prototype._destroy=function(b,o){o(b)},y.prototype.push=function(b,o){var d,u=this._readableState;return u.objectMode?d=!0:typeof b=="string"&&(o=o||u.defaultEncoding,o!==u.encoding&&(b=ie.from(b,o),o=""),d=!0),g(this,b,o,!1,d)},y.prototype.unshift=function(b){return g(this,b,null,!0,!1)},y.prototype.isPaused=function(){return this._readableState.flowing===!1},y.prototype.setEncoding=function(b){re||(re=i("string_decoder/").StringDecoder);var o=new re(b);this._readableState.decoder=o,this._readableState.encoding=this._readableState.decoder.encoding;for(var d=this._readableState.buffer.head,u="";d!==null;)u+=o.write(d.data),d=d.next;return this._readableState.buffer.clear(),u!==""&&this._readableState.buffer.push(u),this._readableState.length=u.length,this},y.prototype.read=function(b){z("read",b),b=parseInt(b,10);var o=this._readableState,d=b;if(b!==0&&(o.emittedReadable=!1),b===0&&o.needReadable&&((o.highWaterMark===0?0<o.length:o.length>=o.highWaterMark)||o.ended))return z("read: emitReadable",o.length,o.ended),o.length===0&&o.ended?q(this):S(this),null;if(b=O(b,o),b===0&&o.ended)return o.length===0&&q(this),null;var u=o.needReadable;z("need readable",u),(o.length===0||o.length-b<o.highWaterMark)&&(u=!0,z("length less than watermark",u)),o.ended||o.reading?(u=!1,z("reading or ended",u)):u&&(z("do read"),o.reading=!0,o.sync=!0,o.length===0&&(o.needReadable=!0),this._read(o.highWaterMark),o.sync=!1,!o.reading&&(b=O(d,o)));var E;return E=0<b?j(b,o):null,E===null?(o.needReadable=o.length<=o.highWaterMark,b=0):(o.length-=b,o.awaitDrain=0),o.length===0&&(!o.ended&&(o.needReadable=!0),d!==b&&o.ended&&q(this)),E!==null&&this.emit("data",E),E},y.prototype._read=function(){N(this,new D("_read()"))},y.prototype.pipe=function(b,o){function d(pe,ge){z("onunpipe"),pe===G&&ge&&ge.hasUnpiped===!1&&(ge.hasUnpiped=!0,E())}function u(){z("onend"),b.end()}function E(){z("cleanup"),b.removeListener("close",V),b.removeListener("finish",H),b.removeListener("drain",fe),b.removeListener("error",M),b.removeListener("unpipe",d),G.removeListener("end",u),G.removeListener("end",J),G.removeListener("data",k),we=!0,W.awaitDrain&&(!b._writableState||b._writableState.needDrain)&&fe()}function k(pe){z("ondata");var ge=b.write(pe);z("dest.write",ge),ge===!1&&((W.pipesCount===1&&W.pipes===b||1<W.pipesCount&&Q(W.pipes,b)!==-1)&&!we&&(z("false write response, pause",W.awaitDrain),W.awaitDrain++),G.pause())}function M(pe){z("onerror",pe),J(),b.removeListener("error",M),ue(b,"error")===0&&N(b,pe)}function V(){b.removeListener("finish",H),J()}function H(){z("onfinish"),b.removeListener("close",V),J()}function J(){z("unpipe"),G.unpipe(b)}var G=this,W=this._readableState;switch(W.pipesCount){case 0:W.pipes=b;break;case 1:W.pipes=[W.pipes,b];break;default:W.pipes.push(b)}W.pipesCount+=1,z("pipe count=%d opts=%j",W.pipesCount,o);var Z=(!o||o.end!==!1)&&b!==c.stdout&&b!==c.stderr,he=Z?u:J;W.endEmitted?c.nextTick(he):G.once("end",he),b.on("unpipe",d);var fe=R(G);b.on("drain",fe);var we=!1;return G.on("data",k),h(b,"error",M),b.once("close",V),b.once("finish",H),b.emit("pipe",G),W.flowing||(z("pipe resume"),G.resume()),b},y.prototype.unpipe=function(b){var o=this._readableState,d={hasUnpiped:!1};if(o.pipesCount===0)return this;if(o.pipesCount===1)return b&&b!==o.pipes?this:(b||(b=o.pipes),o.pipes=null,o.pipesCount=0,o.flowing=!1,b&&b.emit("unpipe",this,d),this);if(!b){var u=o.pipes,E=o.pipesCount;o.pipes=null,o.pipesCount=0,o.flowing=!1;for(var k=0;k<E;k++)u[k].emit("unpipe",this,{hasUnpiped:!1});return this}var M=Q(o.pipes,b);return M===-1?this:(o.pipes.splice(M,1),o.pipesCount-=1,o.pipesCount===1&&(o.pipes=o.pipes[0]),b.emit("unpipe",this,d),this)},y.prototype.on=function(b,o){var d=te.prototype.on.call(this,b,o),u=this._readableState;return b==="data"?(u.readableListening=0<this.listenerCount("readable"),u.flowing!==!1&&this.resume()):b=="readable"&&!u.endEmitted&&!u.readableListening&&(u.readableListening=u.needReadable=!0,u.flowing=!1,u.emittedReadable=!1,z("on readable",u.length,u.reading),u.length?S(this):!u.reading&&c.nextTick(A,this)),d},y.prototype.addListener=y.prototype.on,y.prototype.removeListener=function(b,o){var d=te.prototype.removeListener.call(this,b,o);return b==="readable"&&c.nextTick(B,this),d},y.prototype.removeAllListeners=function(b){var o=te.prototype.removeAllListeners.apply(this,arguments);return(b==="readable"||b===void 0)&&c.nextTick(B,this),o},y.prototype.resume=function(){var b=this._readableState;return b.flowing||(z("resume"),b.flowing=!b.readableListening,T(this,b)),b.paused=!1,this},y.prototype.pause=function(){return z("call pause flowing=%j",this._readableState.flowing),this._readableState.flowing!==!1&&(z("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},y.prototype.wrap=function(b){var o=this,d=this._readableState,u=!1;for(var E in b.on("end",function(){if(z("wrapped end"),d.decoder&&!d.ended){var M=d.decoder.end();M&&M.length&&o.push(M)}o.push(null)}),b.on("data",function(M){if(z("wrapped data"),d.decoder&&(M=d.decoder.write(M)),!(d.objectMode&&M==null)&&(d.objectMode||M&&M.length)){var V=o.push(M);V||(u=!0,b.pause())}}),b)this[E]===void 0&&typeof b[E]=="function"&&(this[E]=function(M){return function(){return b[M].apply(b,arguments)}}(E));for(var k=0;k<$.length;k++)b.on($[k],this.emit.bind(this,$[k]));return this._read=function(M){z("wrapped _read",M),u&&(u=!1,b.resume())},this},typeof Symbol=="function"&&(y.prototype[Symbol.asyncIterator]=function(){return oe===void 0&&(oe=i("./internal/streams/async_iterator")),oe(this)}),Object.defineProperty(y.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(y.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(y.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(b){this._readableState&&(this._readableState.flowing=b)}}),y._fromList=j,Object.defineProperty(y.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),typeof Symbol=="function"&&(y.from=function(b,o){return ae===void 0&&(ae=i("./internal/streams/from")),ae(y,b,o)})}).call(this)}).call(this,i("_process"),typeof commonjsGlobal>"u"?typeof self>"u"?typeof window>"u"?{}:window:self:commonjsGlobal)},{"../errors":15,"./_stream_duplex":16,"./internal/streams/async_iterator":21,"./internal/streams/buffer_list":22,"./internal/streams/destroy":23,"./internal/streams/from":25,"./internal/streams/state":27,"./internal/streams/stream":28,_process:12,buffer:3,events:7,inherits:10,"string_decoder/":31,util:2}],19:[function(i,a){function c(x,O){var w=this._transformState;w.transforming=!1;var S=w.writecb;if(S===null)return this.emit("error",new y);w.writechunk=null,w.writecb=null,O!=null&&this.push(O),S(x);var v=this._readableState;v.reading=!1,(v.needReadable||v.length<v.highWaterMark)&&this._read(v.highWaterMark)}function l(x){return this instanceof l?(L.call(this,x),this._transformState={afterTransform:c.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,x&&(typeof x.transform=="function"&&(this._transform=x.transform),typeof x.flush=="function"&&(this._flush=x.flush)),void this.on("prefinish",p)):new l(x)}function p(){var x=this;typeof this._flush!="function"||this._readableState.destroyed?m(this,null,null):this._flush(function(O,w){m(x,O,w)})}function m(x,O,w){if(O)return x.emit("error",O);if(w!=null&&x.push(w),x._writableState.length)throw new _;if(x._transformState.transforming)throw new g;return x.push(null)}a.exports=l;var h=i("../errors").codes,f=h.ERR_METHOD_NOT_IMPLEMENTED,y=h.ERR_MULTIPLE_CALLBACK,g=h.ERR_TRANSFORM_ALREADY_TRANSFORMING,_=h.ERR_TRANSFORM_WITH_LENGTH_0,L=i("./_stream_duplex");i("inherits")(l,L),l.prototype.push=function(x,O){return this._transformState.needTransform=!1,L.prototype.push.call(this,x,O)},l.prototype._transform=function(x,O,w){w(new f("_transform()"))},l.prototype._write=function(x,O,w){var S=this._transformState;if(S.writecb=w,S.writechunk=x,S.writeencoding=O,!S.transforming){var v=this._readableState;(S.needTransform||v.needReadable||v.length<v.highWaterMark)&&this._read(v.highWaterMark)}},l.prototype._read=function(){var x=this._transformState;x.writechunk===null||x.transforming?x.needTransform=!0:(x.transforming=!0,this._transform(x.writechunk,x.writeencoding,x.afterTransform))},l.prototype._destroy=function(x,O){L.prototype._destroy.call(this,x,function(w){O(w)})}},{"../errors":15,"./_stream_duplex":16,inherits:10}],20:[function(i,a){(function(c,l){(function(){function p(D){var U=this;this.next=null,this.entry=null,this.finish=function(){q(U,D)}}function m(D){return z.from(D)}function h(D){return z.isBuffer(D)||D instanceof ue}function f(){}function y(D,U,N){Y=Y||i("./_stream_duplex"),D=D||{},typeof N!="boolean"&&(N=U instanceof Y),this.objectMode=!!D.objectMode,N&&(this.objectMode=this.objectMode||!!D.writableObjectMode),this.highWaterMark=X(this,D,"writableHighWaterMark",N),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var $=D.decodeStrings===!1;this.decodeStrings=!$,this.defaultEncoding=D.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(b){I(U,b)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=D.emitClose!==!1,this.autoDestroy=!!D.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new p(this)}function g(D){Y=Y||i("./_stream_duplex");var U=this instanceof Y;return U||se.call(g,this)?(this._writableState=new y(D,this,U),this.writable=!0,D&&(typeof D.write=="function"&&(this._write=D.write),typeof D.writev=="function"&&(this._writev=D.writev),typeof D.destroy=="function"&&(this._destroy=D.destroy),typeof D.final=="function"&&(this._final=D.final)),void ee.call(this)):new g(D)}function _(D,U){var N=new ye;ne(D,N),c.nextTick(U,N)}function L(D,U,N,$){var b;return N===null?b=new de:typeof N!="string"&&!U.objectMode&&(b=new re("chunk",["string","Buffer"],N)),!b||(ne(D,b),c.nextTick($,b),!1)}function x(D,U,N){return D.objectMode||D.decodeStrings===!1||typeof U!="string"||(U=z.from(U,N)),U}function O(D,U,N,$,b,o){if(!N){var d=x(U,$,b);$!==d&&(N=!0,b="buffer",$=d)}var u=U.objectMode?1:$.length;U.length+=u;var E=U.length<U.highWaterMark;if(E||(U.needDrain=!0),U.writing||U.corked){var k=U.lastBufferedRequest;U.lastBufferedRequest={chunk:$,encoding:b,isBuf:N,callback:o,next:null},k?k.next=U.lastBufferedRequest:U.bufferedRequest=U.lastBufferedRequest,U.bufferedRequestCount+=1}else w(D,U,!1,u,$,b,o);return E}function w(D,U,N,$,b,o,d){U.writelen=$,U.writecb=d,U.writing=!0,U.sync=!0,U.destroyed?U.onwrite(new le("write")):N?D._writev(b,U.onwrite):D._write(b,o,U.onwrite),U.sync=!1}function S(D,U,N,$,b){--U.pendingcb,N?(c.nextTick(b,$),c.nextTick(F,D,U),D._writableState.errorEmitted=!0,ne(D,$)):(b($),D._writableState.errorEmitted=!0,ne(D,$),F(D,U))}function v(D){D.writing=!1,D.writecb=null,D.length-=D.writelen,D.writelen=0}function I(D,U){var N=D._writableState,$=N.sync,b=N.writecb;if(typeof b!="function")throw new ae;if(v(N),U)S(D,N,$,U,b);else{var o=A(N)||D.destroyed;o||N.corked||N.bufferProcessing||!N.bufferedRequest||B(D,N),$?c.nextTick(C,D,N,o,b):C(D,N,o,b)}}function C(D,U,N,$){N||R(D,U),U.pendingcb--,$(),F(D,U)}function R(D,U){U.length===0&&U.needDrain&&(U.needDrain=!1,D.emit("drain"))}function B(D,U){U.bufferProcessing=!0;var N=U.bufferedRequest;if(D._writev&&N&&N.next){var $=U.bufferedRequestCount,b=Array($),o=U.corkedRequestsFree;o.entry=N;for(var d=0,u=!0;N;)b[d]=N,N.isBuf||(u=!1),N=N.next,d+=1;b.allBuffers=u,w(D,U,!0,U.length,b,"",o.finish),U.pendingcb++,U.lastBufferedRequest=null,o.next?(U.corkedRequestsFree=o.next,o.next=null):U.corkedRequestsFree=new p(U),U.bufferedRequestCount=0}else{for(;N;){var E=N.chunk,k=N.encoding,M=N.callback,V=U.objectMode?1:E.length;if(w(D,U,!1,V,E,k,M),N=N.next,U.bufferedRequestCount--,U.writing)break}N===null&&(U.lastBufferedRequest=null)}U.bufferedRequest=N,U.bufferProcessing=!1}function A(D){return D.ending&&D.length===0&&D.bufferedRequest===null&&!D.finished&&!D.writing}function T(D,U){D._final(function(N){U.pendingcb--,N&&ne(D,N),U.prefinished=!0,D.emit("prefinish"),F(D,U)})}function P(D,U){U.prefinished||U.finalCalled||(typeof D._final!="function"||U.destroyed?(U.prefinished=!0,D.emit("prefinish")):(U.pendingcb++,U.finalCalled=!0,c.nextTick(T,D,U)))}function F(D,U){var N=A(U);if(N&&(P(D,U),U.pendingcb===0&&(U.finished=!0,D.emit("finish"),U.autoDestroy))){var $=D._readableState;(!$||$.autoDestroy&&$.endEmitted)&&D.destroy()}return N}function j(D,U,N){U.ending=!0,F(D,U),N&&(U.finished?c.nextTick(N):D.once("finish",N)),U.ended=!0,D.writable=!1}function q(D,U,N){var $=D.entry;for(D.entry=null;$;){var b=$.callback;U.pendingcb--,b(N),$=$.next}U.corkedRequestsFree.next=D}a.exports=g;var Y;g.WritableState=y;var Q={deprecate:i("util-deprecate")},ee=i("./internal/streams/stream"),z=i("buffer").Buffer,ue=l.Uint8Array||function(){},te=i("./internal/streams/destroy"),ie=i("./internal/streams/state"),X=ie.getHighWaterMark,K=i("../errors").codes,re=K.ERR_INVALID_ARG_TYPE,oe=K.ERR_METHOD_NOT_IMPLEMENTED,ae=K.ERR_MULTIPLE_CALLBACK,me=K.ERR_STREAM_CANNOT_PIPE,le=K.ERR_STREAM_DESTROYED,de=K.ERR_STREAM_NULL_VALUES,ye=K.ERR_STREAM_WRITE_AFTER_END,ce=K.ERR_UNKNOWN_ENCODING,ne=te.errorOrDestroy;i("inherits")(g,ee),y.prototype.getBuffer=function(){for(var D=this.bufferedRequest,U=[];D;)U.push(D),D=D.next;return U},function(){try{Object.defineProperty(y.prototype,"buffer",{get:Q.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch{}}();var se;typeof Symbol=="function"&&Symbol.hasInstance&&typeof Function.prototype[Symbol.hasInstance]=="function"?(se=Function.prototype[Symbol.hasInstance],Object.defineProperty(g,Symbol.hasInstance,{value:function(D){return!!se.call(this,D)||this===g&&D&&D._writableState instanceof y}})):se=function(D){return D instanceof this},g.prototype.pipe=function(){ne(this,new me)},g.prototype.write=function(D,U,N){var $=this._writableState,b=!1,o=!$.objectMode&&h(D);return o&&!z.isBuffer(D)&&(D=m(D)),typeof U=="function"&&(N=U,U=null),o?U="buffer":!U&&(U=$.defaultEncoding),typeof N!="function"&&(N=f),$.ending?_(this,N):(o||L(this,$,D,N))&&($.pendingcb++,b=O(this,$,o,D,U,N)),b},g.prototype.cork=function(){this._writableState.corked++},g.prototype.uncork=function(){var D=this._writableState;D.corked&&(D.corked--,!D.writing&&!D.corked&&!D.bufferProcessing&&D.bufferedRequest&&B(this,D))},g.prototype.setDefaultEncoding=function(D){if(typeof D=="string"&&(D=D.toLowerCase()),!(-1<["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((D+"").toLowerCase())))throw new ce(D);return this._writableState.defaultEncoding=D,this},Object.defineProperty(g.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(g.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),g.prototype._write=function(D,U,N){N(new oe("_write()"))},g.prototype._writev=null,g.prototype.end=function(D,U,N){var $=this._writableState;return typeof D=="function"?(N=D,D=null,U=null):typeof U=="function"&&(N=U,U=null),D!=null&&this.write(D,U),$.corked&&($.corked=1,this.uncork()),$.ending||j(this,$,N),this},Object.defineProperty(g.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(g.prototype,"destroyed",{enumerable:!1,get:function(){return this._writableState!==void 0&&this._writableState.destroyed},set:function(D){this._writableState&&(this._writableState.destroyed=D)}}),g.prototype.destroy=te.destroy,g.prototype._undestroy=te.undestroy,g.prototype._destroy=function(D,U){U(D)}}).call(this)}).call(this,i("_process"),typeof commonjsGlobal>"u"?typeof self>"u"?typeof window>"u"?{}:window:self:commonjsGlobal)},{"../errors":15,"./_stream_duplex":16,"./internal/streams/destroy":23,"./internal/streams/state":27,"./internal/streams/stream":28,_process:12,buffer:3,inherits:10,"util-deprecate":32}],21:[function(i,a){(function(c){(function(){function l(R,B,A){return B in R?Object.defineProperty(R,B,{value:A,enumerable:!0,configurable:!0,writable:!0}):R[B]=A,R}function p(R,B){return{value:R,done:B}}function m(R){var B=R[_];if(B!==null){var A=R[v].read();A!==null&&(R[w]=null,R[_]=null,R[L]=null,B(p(A,!1)))}}function h(R){c.nextTick(m,R)}function f(R,B){return function(A,T){R.then(function(){return B[O]?void A(p(void 0,!0)):void B[S](A,T)},T)}}var y,g=i("./end-of-stream"),_=Symbol("lastResolve"),L=Symbol("lastReject"),x=Symbol("error"),O=Symbol("ended"),w=Symbol("lastPromise"),S=Symbol("handlePromise"),v=Symbol("stream"),I=Object.getPrototypeOf(function(){}),C=Object.setPrototypeOf((y={get stream(){return this[v]},next:function(){var R=this,B=this[x];if(B!==null)return Promise.reject(B);if(this[O])return Promise.resolve(p(void 0,!0));if(this[v].destroyed)return new Promise(function(F,j){c.nextTick(function(){R[x]?j(R[x]):F(p(void 0,!0))})});var A,T=this[w];if(T)A=new Promise(f(T,this));else{var P=this[v].read();if(P!==null)return Promise.resolve(p(P,!1));A=new Promise(this[S])}return this[w]=A,A}},l(y,Symbol.asyncIterator,function(){return this}),l(y,"return",function(){var R=this;return new Promise(function(B,A){R[v].destroy(null,function(T){return T?void A(T):void B(p(void 0,!0))})})}),y),I);a.exports=function(R){var B,A=Object.create(C,(B={},l(B,v,{value:R,writable:!0}),l(B,_,{value:null,writable:!0}),l(B,L,{value:null,writable:!0}),l(B,x,{value:null,writable:!0}),l(B,O,{value:R._readableState.endEmitted,writable:!0}),l(B,S,{value:function(T,P){var F=A[v].read();F?(A[w]=null,A[_]=null,A[L]=null,T(p(F,!1))):(A[_]=T,A[L]=P)},writable:!0}),B));return A[w]=null,g(R,function(T){if(T&&T.code!=="ERR_STREAM_PREMATURE_CLOSE"){var P=A[L];return P!==null&&(A[w]=null,A[_]=null,A[L]=null,P(T)),void(A[x]=T)}var F=A[_];F!==null&&(A[w]=null,A[_]=null,A[L]=null,F(p(void 0,!0))),A[O]=!0}),R.on("readable",h.bind(null,A)),A}}).call(this)}).call(this,i("_process"))},{"./end-of-stream":24,_process:12}],22:[function(i,a){function c(w,S){var v=Object.keys(w);if(Object.getOwnPropertySymbols){var I=Object.getOwnPropertySymbols(w);S&&(I=I.filter(function(C){return Object.getOwnPropertyDescriptor(w,C).enumerable})),v.push.apply(v,I)}return v}function l(w){for(var S,v=1;v<arguments.length;v++)S=arguments[v]==null?{}:arguments[v],v%2?c(Object(S),!0).forEach(function(I){p(w,I,S[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(w,Object.getOwnPropertyDescriptors(S)):c(Object(S)).forEach(function(I){Object.defineProperty(w,I,Object.getOwnPropertyDescriptor(S,I))});return w}function p(w,S,v){return S in w?Object.defineProperty(w,S,{value:v,enumerable:!0,configurable:!0,writable:!0}):w[S]=v,w}function m(w,S){if(!(w instanceof S))throw new TypeError("Cannot call a class as a function")}function h(w,S){for(var v,I=0;I<S.length;I++)v=S[I],v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(w,v.key,v)}function f(w,S,v){return S&&h(w.prototype,S),w}function y(w,S,v){_.prototype.copy.call(w,S,v)}var g=i("buffer"),_=g.Buffer,L=i("util"),x=L.inspect,O=x&&x.custom||"inspect";a.exports=function(){function w(){m(this,w),this.head=null,this.tail=null,this.length=0}return f(w,[{key:"push",value:function(S){var v={data:S,next:null};0<this.length?this.tail.next=v:this.head=v,this.tail=v,++this.length}},{key:"unshift",value:function(S){var v={data:S,next:this.head};this.length===0&&(this.tail=v),this.head=v,++this.length}},{key:"shift",value:function(){if(this.length!==0){var S=this.head.data;return this.head=this.length===1?this.tail=null:this.head.next,--this.length,S}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(S){if(this.length===0)return"";for(var v=this.head,I=""+v.data;v=v.next;)I+=S+v.data;return I}},{key:"concat",value:function(S){if(this.length===0)return _.alloc(0);for(var v=_.allocUnsafe(S>>>0),I=this.head,C=0;I;)y(I.data,v,C),C+=I.data.length,I=I.next;return v}},{key:"consume",value:function(S,v){var I;return S<this.head.data.length?(I=this.head.data.slice(0,S),this.head.data=this.head.data.slice(S)):S===this.head.data.length?I=this.shift():I=v?this._getString(S):this._getBuffer(S),I}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(S){var v=this.head,I=1,C=v.data;for(S-=C.length;v=v.next;){var R=v.data,B=S>R.length?R.length:S;if(C+=B===R.length?R:R.slice(0,S),S-=B,S===0){B===R.length?(++I,this.head=v.next?v.next:this.tail=null):(this.head=v,v.data=R.slice(B));break}++I}return this.length-=I,C}},{key:"_getBuffer",value:function(S){var v=_.allocUnsafe(S),I=this.head,C=1;for(I.data.copy(v),S-=I.data.length;I=I.next;){var R=I.data,B=S>R.length?R.length:S;if(R.copy(v,v.length-S,0,B),S-=B,S===0){B===R.length?(++C,this.head=I.next?I.next:this.tail=null):(this.head=I,I.data=R.slice(B));break}++C}return this.length-=C,v}},{key:O,value:function(S,v){return x(this,l({},v,{depth:0,customInspect:!1}))}}]),w}()},{buffer:3,util:2}],23:[function(i,a){(function(c){(function(){function l(h,f){m(h,f),p(h)}function p(h){h._writableState&&!h._writableState.emitClose||h._readableState&&!h._readableState.emitClose||h.emit("close")}function m(h,f){h.emit("error",f)}a.exports={destroy:function(h,f){var y=this,g=this._readableState&&this._readableState.destroyed,_=this._writableState&&this._writableState.destroyed;return g||_?(f?f(h):h&&(this._writableState?!this._writableState.errorEmitted&&(this._writableState.errorEmitted=!0,c.nextTick(m,this,h)):c.nextTick(m,this,h)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(h||null,function(L){!f&&L?y._writableState?y._writableState.errorEmitted?c.nextTick(p,y):(y._writableState.errorEmitted=!0,c.nextTick(l,y,L)):c.nextTick(l,y,L):f?(c.nextTick(p,y),f(L)):c.nextTick(p,y)}),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(h,f){var y=h._readableState,g=h._writableState;y&&y.autoDestroy||g&&g.autoDestroy?h.destroy(f):h.emit("error",f)}}}).call(this)}).call(this,i("_process"))},{_process:12}],24:[function(i,a){function c(f){var y=!1;return function(){if(!y){y=!0;for(var g=arguments.length,_=Array(g),L=0;L<g;L++)_[L]=arguments[L];f.apply(this,_)}}}function l(){}function p(f){return f.setHeader&&typeof f.abort=="function"}function m(f,y,g){if(typeof y=="function")return m(f,null,y);y||(y={}),g=c(g||l);var _=y.readable||y.readable!==!1&&f.readable,L=y.writable||y.writable!==!1&&f.writable,x=function(){f.writable||w()},O=f._writableState&&f._writableState.finished,w=function(){L=!1,O=!0,_||g.call(f)},S=f._readableState&&f._readableState.endEmitted,v=function(){_=!1,S=!0,L||g.call(f)},I=function(B){g.call(f,B)},C=function(){var B;return _&&!S?(f._readableState&&f._readableState.ended||(B=new h),g.call(f,B)):L&&!O?(f._writableState&&f._writableState.ended||(B=new h),g.call(f,B)):void 0},R=function(){f.req.on("finish",w)};return p(f)?(f.on("complete",w),f.on("abort",C),f.req?R():f.on("request",R)):L&&!f._writableState&&(f.on("end",x),f.on("close",x)),f.on("end",v),f.on("finish",w),y.error!==!1&&f.on("error",I),f.on("close",C),function(){f.removeListener("complete",w),f.removeListener("abort",C),f.removeListener("request",R),f.req&&f.req.removeListener("finish",w),f.removeListener("end",x),f.removeListener("close",x),f.removeListener("finish",w),f.removeListener("end",v),f.removeListener("error",I),f.removeListener("close",C)}}var h=i("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;a.exports=m},{"../../../errors":15}],25:[function(i,a){a.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],26:[function(i,a){function c(O){var w=!1;return function(){w||(w=!0,O.apply(void 0,arguments))}}function l(O){if(O)throw O}function p(O){return O.setHeader&&typeof O.abort=="function"}function m(O,w,S,v){v=c(v);var I=!1;O.on("close",function(){I=!0}),g===void 0&&(g=i("./end-of-stream")),g(O,{readable:w,writable:S},function(R){return R?v(R):(I=!0,void v())});var C=!1;return function(R){if(!I)return C?void 0:(C=!0,p(O)?O.abort():typeof O.destroy=="function"?O.destroy():void v(R||new x("pipe")))}}function h(O){O()}function f(O,w){return O.pipe(w)}function y(O){return O.length&&typeof O[O.length-1]=="function"?O.pop():l}var g,_=i("../../../errors").codes,L=_.ERR_MISSING_ARGS,x=_.ERR_STREAM_DESTROYED;a.exports=function(){for(var O=arguments.length,w=Array(O),S=0;S<O;S++)w[S]=arguments[S];var v=y(w);if(Array.isArray(w[0])&&(w=w[0]),2>w.length)throw new L("streams");var I,C=w.map(function(R,B){var A=B<w.length-1;return m(R,A,0<B,function(T){I||(I=T),T&&C.forEach(h),A||(C.forEach(h),v(I))})});return w.reduce(f)}},{"../../../errors":15,"./end-of-stream":24}],27:[function(i,a){function c(p,m,h){return p.highWaterMark==null?m?p[h]:null:p.highWaterMark}var l=i("../../../errors").codes.ERR_INVALID_OPT_VALUE;a.exports={getHighWaterMark:function(p,m,h,f){var y=c(m,f,h);if(y!=null){if(!(isFinite(y)&&t(y)===y)||0>y){var g=f?h:"highWaterMark";throw new l(g,y)}return t(y)}return p.objectMode?16:16384}}},{"../../../errors":15}],28:[function(i,a){a.exports=i("events").EventEmitter},{events:7}],29:[function(i,a,c){c=a.exports=i("./lib/_stream_readable.js"),c.Stream=c,c.Readable=c,c.Writable=i("./lib/_stream_writable.js"),c.Duplex=i("./lib/_stream_duplex.js"),c.Transform=i("./lib/_stream_transform.js"),c.PassThrough=i("./lib/_stream_passthrough.js"),c.finished=i("./lib/internal/streams/end-of-stream.js"),c.pipeline=i("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":16,"./lib/_stream_passthrough.js":17,"./lib/_stream_readable.js":18,"./lib/_stream_transform.js":19,"./lib/_stream_writable.js":20,"./lib/internal/streams/end-of-stream.js":24,"./lib/internal/streams/pipeline.js":26}],30:[function(i,a,c){function l(f,y){for(var g in f)y[g]=f[g]}function p(f,y,g){return h(f,y,g)}/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */var m=i("buffer"),h=m.Buffer;h.from&&h.alloc&&h.allocUnsafe&&h.allocUnsafeSlow?a.exports=m:(l(m,c),c.Buffer=p),p.prototype=Object.create(h.prototype),l(h,p),p.from=function(f,y,g){if(typeof f=="number")throw new TypeError("Argument must not be a number");return h(f,y,g)},p.alloc=function(f,y,g){if(typeof f!="number")throw new TypeError("Argument must be a number");var _=h(f);return y===void 0?_.fill(0):typeof g=="string"?_.fill(y,g):_.fill(y),_},p.allocUnsafe=function(f){if(typeof f!="number")throw new TypeError("Argument must be a number");return h(f)},p.allocUnsafeSlow=function(f){if(typeof f!="number")throw new TypeError("Argument must be a number");return m.SlowBuffer(f)}},{buffer:3}],31:[function(i,a,c){function l(C){if(!C)return"utf8";for(var R;;)switch(C){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return C;default:if(R)return;C=(""+C).toLowerCase(),R=!0}}function p(C){var R=l(C);if(typeof R!="string"&&(v.isEncoding===I||!I(C)))throw new Error("Unknown encoding: "+C);return R||C}function m(C){this.encoding=p(C);var R;switch(this.encoding){case"utf16le":this.text=_,this.end=L,R=4;break;case"utf8":this.fillLast=g,R=4;break;case"base64":this.text=x,this.end=O,R=3;break;default:return this.write=w,void(this.end=S)}this.lastNeed=0,this.lastTotal=0,this.lastChar=v.allocUnsafe(R)}function h(C){return 127>=C?0:C>>5==6?2:C>>4==14?3:C>>3==30?4:C>>6==2?-1:-2}function f(C,R,B){var A=R.length-1;if(A<B)return 0;var T=h(R[A]);return 0<=T?(0<T&&(C.lastNeed=T-1),T):--A<B||T===-2?0:(T=h(R[A]),0<=T?(0<T&&(C.lastNeed=T-2),T):--A<B||T===-2?0:(T=h(R[A]),0<=T?(0<T&&(T===2?T=0:C.lastNeed=T-3),T):0))}function y(C,R){if((192&R[0])!=128)return C.lastNeed=0,"";if(1<C.lastNeed&&1<R.length){if((192&R[1])!=128)return C.lastNeed=1,"";if(2<C.lastNeed&&2<R.length&&(192&R[2])!=128)return C.lastNeed=2,""}}function g(C){var R=this.lastTotal-this.lastNeed,B=y(this,C);return B===void 0?this.lastNeed<=C.length?(C.copy(this.lastChar,R,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(C.copy(this.lastChar,R,0,C.length),void(this.lastNeed-=C.length)):B}function _(C,R){if((C.length-R)%2==0){var B=C.toString("utf16le",R);if(B){var A=B.charCodeAt(B.length-1);if(55296<=A&&56319>=A)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=C[C.length-2],this.lastChar[1]=C[C.length-1],B.slice(0,-1)}return B}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=C[C.length-1],C.toString("utf16le",R,C.length-1)}function L(C){var R=C&&C.length?this.write(C):"";if(this.lastNeed){var B=this.lastTotal-this.lastNeed;return R+this.lastChar.toString("utf16le",0,B)}return R}function x(C,R){var B=(C.length-R)%3;return B==0?C.toString("base64",R):(this.lastNeed=3-B,this.lastTotal=3,B==1?this.lastChar[0]=C[C.length-1]:(this.lastChar[0]=C[C.length-2],this.lastChar[1]=C[C.length-1]),C.toString("base64",R,C.length-B))}function O(C){var R=C&&C.length?this.write(C):"";return this.lastNeed?R+this.lastChar.toString("base64",0,3-this.lastNeed):R}function w(C){return C.toString(this.encoding)}function S(C){return C&&C.length?this.write(C):""}var v=i("safe-buffer").Buffer,I=v.isEncoding||function(C){switch(C=""+C,C&&C.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};c.StringDecoder=m,m.prototype.write=function(C){if(C.length===0)return"";var R,B;if(this.lastNeed){if(R=this.fillLast(C),R===void 0)return"";B=this.lastNeed,this.lastNeed=0}else B=0;return B<C.length?R?R+this.text(C,B):this.text(C,B):R||""},m.prototype.end=function(C){var R=C&&C.length?this.write(C):"";return this.lastNeed?R+"":R},m.prototype.text=function(C,R){var B=f(this,C,R);if(!this.lastNeed)return C.toString("utf8",R);this.lastTotal=B;var A=C.length-(B-this.lastNeed);return C.copy(this.lastChar,0,A),C.toString("utf8",R,A)},m.prototype.fillLast=function(C){return this.lastNeed<=C.length?(C.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(C.copy(this.lastChar,this.lastTotal-this.lastNeed,0,C.length),void(this.lastNeed-=C.length))}},{"safe-buffer":30}],32:[function(i,a){(function(c){(function(){function l(p){try{if(!c.localStorage)return!1}catch{return!1}var m=c.localStorage[p];return m!=null&&(m+"").toLowerCase()==="true"}a.exports=function(p,m){function h(){if(!f){if(l("throwDeprecation"))throw new Error(m);l("traceDeprecation")?console.trace(m):console.warn(m),f=!0}return p.apply(this,arguments)}if(l("noDeprecation"))return p;var f=!1;return h}}).call(this)}).call(this,typeof commonjsGlobal>"u"?typeof self>"u"?typeof window>"u"?{}:window:self:commonjsGlobal)},{}],"/":[function(i,a){function c(O){return O.replace(/a=ice-options:trickle\s\n/g,"")}function l(O){console.warn(O)}/*! simple-peer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */const p=i("debug")("simple-peer"),m=i("get-browser-rtc"),h=i("randombytes"),f=i("readable-stream"),y=i("queue-microtask"),g=i("err-code"),{Buffer:_}=i("buffer"),L=65536;class x extends f.Duplex{constructor(w){if(w=Object.assign({allowHalfOpen:!1},w),super(w),this._id=h(4).toString("hex").slice(0,7),this._debug("new peer %o",w),this.channelName=w.initiator?w.channelName||h(20).toString("hex"):null,this.initiator=w.initiator||!1,this.channelConfig=w.channelConfig||x.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},x.config,w.config),this.offerOptions=w.offerOptions||{},this.answerOptions=w.answerOptions||{},this.sdpTransform=w.sdpTransform||(S=>S),this.streams=w.streams||(w.stream?[w.stream]:[]),this.trickle=w.trickle===void 0||w.trickle,this.allowHalfTrickle=w.allowHalfTrickle!==void 0&&w.allowHalfTrickle,this.iceCompleteTimeout=w.iceCompleteTimeout||5e3,this.destroyed=!1,this.destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,this._wrtc=w.wrtc&&typeof w.wrtc=="object"?w.wrtc:m(),!this._wrtc)throw g(typeof window>"u"?new Error("No WebRTC support: Specify `opts.wrtc` option in this environment"):new Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._senderMap=new Map,this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new this._wrtc.RTCPeerConnection(this.config)}catch(S){return void this.destroy(g(S,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc=typeof this._pc._peerConnectionId=="number",this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=S=>{this._onIceCandidate(S)},typeof this._pc.peerIdentity=="object"&&this._pc.peerIdentity.catch(S=>{this.destroy(g(S,"ERR_PC_PEER_IDENTITY"))}),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=S=>{this._setupData(S)},this.streams&&this.streams.forEach(S=>{this.addStream(S)}),this._pc.ontrack=S=>{this._onTrack(S)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&this._channel.readyState==="open"}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(w){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if(typeof w=="string")try{w=JSON.parse(w)}catch{w={}}this._debug("signal()"),w.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),w.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(w.transceiverRequest.kind,w.transceiverRequest.init)),w.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(w.candidate):this._pendingCandidates.push(w.candidate)),w.sdp&&this._pc.setRemoteDescription(new this._wrtc.RTCSessionDescription(w)).then(()=>{this.destroyed||(this._pendingCandidates.forEach(S=>{this._addIceCandidate(S)}),this._pendingCandidates=[],this._pc.remoteDescription.type==="offer"&&this._createAnswer())}).catch(S=>{this.destroy(g(S,"ERR_SET_REMOTE_DESCRIPTION"))}),w.sdp||w.candidate||w.renegotiate||w.transceiverRequest||this.destroy(g(new Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(w){const S=new this._wrtc.RTCIceCandidate(w);this._pc.addIceCandidate(S).catch(v=>{!S.address||S.address.endsWith(".local")?l("Ignoring unsupported ICE candidate."):this.destroy(g(v,"ERR_ADD_ICE_CANDIDATE"))})}send(w){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(w)}}addTransceiver(w,S){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(w,S),this._needsNegotiation()}catch(v){this.destroy(g(v,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:w,init:S}})}}addStream(w){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),w.getTracks().forEach(S=>{this.addTrack(S,w)})}}addTrack(w,S){if(this.destroying)return;if(this.destroyed)throw g(new Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const v=this._senderMap.get(w)||new Map;let I=v.get(S);if(!I)I=this._pc.addTrack(w,S),v.set(S,I),this._senderMap.set(w,v),this._needsNegotiation();else throw I.removed?g(new Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):g(new Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED")}replaceTrack(w,S,v){if(this.destroying)return;if(this.destroyed)throw g(new Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const I=this._senderMap.get(w),C=I?I.get(v):null;if(!C)throw g(new Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");S&&this._senderMap.set(S,I),C.replaceTrack==null?this.destroy(g(new Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK")):C.replaceTrack(S)}removeTrack(w,S){if(this.destroying)return;if(this.destroyed)throw g(new Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const v=this._senderMap.get(w),I=v?v.get(S):null;if(!I)throw g(new Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{I.removed=!0,this._pc.removeTrack(I)}catch(C){C.name==="NS_ERROR_UNEXPECTED"?this._sendersAwaitingStable.push(I):this.destroy(g(C,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(w){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),w.getTracks().forEach(S=>{this.removeTrack(S,w)})}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,y(()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1}))}negotiate(){if(!this.destroying){if(this.destroyed)throw g(new Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout(()=>{this._createOffer()},0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}destroy(w){this._destroy(w,()=>{})}_destroy(w,S){this.destroyed||this.destroying||(this.destroying=!0,this._debug("destroying (error: %s)",w&&(w.message||w)),y(()=>{if(this.destroyed=!0,this.destroying=!1,this._debug("destroy (error: %s)",w&&(w.message||w)),this.readable=this.writable=!1,this._readableState.ended||this.push(null),this._writableState.finished||this.end(),this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch{}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch{}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,w&&this.emit("error",w),this.emit("close"),S()}))}_setupData(w){if(!w.channel)return this.destroy(g(new Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=w.channel,this._channel.binaryType="arraybuffer",typeof this._channel.bufferedAmountLowThreshold=="number"&&(this._channel.bufferedAmountLowThreshold=L),this.channelName=this._channel.label,this._channel.onmessage=v=>{this._onChannelMessage(v)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=v=>{const I=v.error instanceof Error?v.error:new Error(`Datachannel error: ${v.message} ${v.filename}:${v.lineno}:${v.colno}`);this.destroy(g(I,"ERR_DATA_CHANNEL"))};let S=!1;this._closingInterval=setInterval(()=>{this._channel&&this._channel.readyState==="closing"?(S&&this._onChannelClose(),S=!0):S=!1},5e3)}_read(){}_write(w,S,v){if(this.destroyed)return v(g(new Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(w)}catch(I){return this.destroy(g(I,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>L?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=v):v(null)}else this._debug("write before connect"),this._chunk=w,this._cb=v}_onFinish(){if(!this.destroyed){const w=()=>{setTimeout(()=>this.destroy(),1e3)};this._connected?w():this.once("connect",w)}}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout(()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))},this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then(w=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(w.sdp=c(w.sdp)),w.sdp=this.sdpTransform(w.sdp);const S=()=>{if(!this.destroyed){const v=this._pc.localDescription||w;this._debug("signal"),this.emit("signal",{type:v.type,sdp:v.sdp})}};this._pc.setLocalDescription(w).then(()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?S():this.once("_iceComplete",S))}).catch(v=>{this.destroy(g(v,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch(w=>{this.destroy(g(w,"ERR_CREATE_OFFER"))})}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach(w=>{w.mid||!w.sender.track||w.requested||(w.requested=!0,this.addTransceiver(w.sender.track.kind))})}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then(w=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(w.sdp=c(w.sdp)),w.sdp=this.sdpTransform(w.sdp);const S=()=>{if(!this.destroyed){const v=this._pc.localDescription||w;this._debug("signal"),this.emit("signal",{type:v.type,sdp:v.sdp}),this.initiator||this._requestMissingTransceivers()}};this._pc.setLocalDescription(w).then(()=>{this.destroyed||(this.trickle||this._iceComplete?S():this.once("_iceComplete",S))}).catch(v=>{this.destroy(g(v,"ERR_SET_LOCAL_DESCRIPTION"))})}).catch(w=>{this.destroy(g(w,"ERR_CREATE_ANSWER"))})}_onConnectionStateChange(){this.destroyed||this._pc.connectionState==="failed"&&this.destroy(g(new Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const w=this._pc.iceConnectionState,S=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",w,S),this.emit("iceStateChange",w,S),(w==="connected"||w==="completed")&&(this._pcReady=!0,this._maybeReady()),w==="failed"&&this.destroy(g(new Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),w==="closed"&&this.destroy(g(new Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(w){const S=v=>(Object.prototype.toString.call(v.values)==="[object Array]"&&v.values.forEach(I=>{Object.assign(v,I)}),v);this._pc.getStats.length===0||this._isReactNativeWebrtc?this._pc.getStats().then(v=>{const I=[];v.forEach(C=>{I.push(S(C))}),w(null,I)},v=>w(v)):0<this._pc.getStats.length?this._pc.getStats(v=>{if(this.destroyed)return;const I=[];v.result().forEach(C=>{const R={};C.names().forEach(B=>{R[B]=C.stat(B)}),R.id=C.id,R.type=C.type,R.timestamp=C.timestamp,I.push(S(R))}),w(null,I)},v=>w(v)):w(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const w=()=>{this.destroyed||this.getStats((S,v)=>{if(this.destroyed)return;S&&(v=[]);const I={},C={},R={};let B=!1;v.forEach(T=>{(T.type==="remotecandidate"||T.type==="remote-candidate")&&(I[T.id]=T),(T.type==="localcandidate"||T.type==="local-candidate")&&(C[T.id]=T),(T.type==="candidatepair"||T.type==="candidate-pair")&&(R[T.id]=T)});const A=T=>{B=!0;let P=C[T.localCandidateId];P&&(P.ip||P.address)?(this.localAddress=P.ip||P.address,this.localPort=+P.port):P&&P.ipAddress?(this.localAddress=P.ipAddress,this.localPort=+P.portNumber):typeof T.googLocalAddress=="string"&&(P=T.googLocalAddress.split(":"),this.localAddress=P[0],this.localPort=+P[1]),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let F=I[T.remoteCandidateId];F&&(F.ip||F.address)?(this.remoteAddress=F.ip||F.address,this.remotePort=+F.port):F&&F.ipAddress?(this.remoteAddress=F.ipAddress,this.remotePort=+F.portNumber):typeof T.googRemoteAddress=="string"&&(F=T.googRemoteAddress.split(":"),this.remoteAddress=F[0],this.remotePort=+F[1]),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(v.forEach(T=>{T.type==="transport"&&T.selectedCandidatePairId&&A(R[T.selectedCandidatePairId]),(T.type==="googCandidatePair"&&T.googActiveConnection==="true"||(T.type==="candidatepair"||T.type==="candidate-pair")&&T.selected)&&A(T)}),!B&&(!Object.keys(R).length||Object.keys(C).length))return void setTimeout(w,100);if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(P){return this.destroy(g(P,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const T=this._cb;this._cb=null,T(null)}typeof this._channel.bufferedAmountLowThreshold!="number"&&(this._interval=setInterval(()=>this._onInterval(),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")})};w()}_onInterval(){this._cb&&this._channel&&!(this._channel.bufferedAmount>L)&&this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||(this._pc.signalingState==="stable"&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach(w=>{this._pc.removeTrack(w),this._queuedNegotiation=!0}),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(w){this.destroyed||(w.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:w.candidate.candidate,sdpMLineIndex:w.candidate.sdpMLineIndex,sdpMid:w.candidate.sdpMid}}):!w.candidate&&!this._iceComplete&&(this._iceComplete=!0,this.emit("_iceComplete")),w.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(w){if(this.destroyed)return;let S=w.data;S instanceof ArrayBuffer&&(S=_.from(S)),this.push(S)}_onChannelBufferedAmountLow(){if(!this.destroyed&&this._cb){this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const w=this._cb;this._cb=null,w(null)}}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.destroy())}_onTrack(w){this.destroyed||w.streams.forEach(S=>{this._debug("on track"),this.emit("track",w.track,S),this._remoteTracks.push({track:w.track,stream:S}),this._remoteStreams.some(v=>v.id===S.id)||(this._remoteStreams.push(S),y(()=>{this._debug("on stream"),this.emit("stream",S)}))})}_debug(){const w=[].slice.call(arguments);w[0]="["+this._id+"] "+w[0],p.apply(null,w)}}x.WEBRTC_SUPPORT=!!m(),x.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},x.channelConfig={},a.exports=x},{buffer:3,debug:4,"err-code":6,"get-browser-rtc":8,"queue-microtask":13,randombytes:14,"readable-stream":29}]},{},[])("/")})})(simplepeer_min);var simplepeer_minExports=simplepeer_min.exports;const Peer=getDefaultExportFromCjs(simplepeer_minExports),messageYjsSyncStep1=0,messageYjsSyncStep2=1,messageYjsUpdate=2,writeSyncStep1=(n,e)=>{writeVarUint(n,messageYjsSyncStep1);const t=encodeStateVector(e);writeVarUint8Array(n,t)},writeSyncStep2=(n,e,t)=>{writeVarUint(n,messageYjsSyncStep2),writeVarUint8Array(n,encodeStateAsUpdate(e,t))},readSyncStep1=(n,e,t)=>writeSyncStep2(e,t,readVarUint8Array(n)),readSyncStep2=(n,e,t)=>{try{applyUpdate(e,readVarUint8Array(n),t)}catch(r){console.error("Caught error while handling a Yjs update",r)}},writeUpdate=(n,e)=>{writeVarUint(n,messageYjsUpdate),writeVarUint8Array(n,e)},readUpdate=readSyncStep2,readSyncMessage=(n,e,t,r)=>{const s=readVarUint(n);switch(s){case messageYjsSyncStep1:readSyncStep1(n,e,t);break;case messageYjsSyncStep2:readSyncStep2(n,t,r);break;case messageYjsUpdate:readUpdate(n,t,r);break;default:throw new Error("Unknown message type")}return s},outdatedTimeout=3e4;class Awareness extends Observable{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const t=getUnixTime();this.getLocalState()!==null&&outdatedTimeout/2<=t-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const r=[];this.meta.forEach((s,i)=>{i!==this.clientID&&outdatedTimeout<=t-s.lastUpdated&&this.states.has(i)&&r.push(i)}),r.length>0&&removeAwarenessStates(this,r,"timeout")},floor(outdatedTimeout/10)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,r=this.meta.get(t),s=r===void 0?0:r.clock+1,i=this.states.get(t);e===null?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:s,lastUpdated:getUnixTime()});const a=[],c=[],l=[],p=[];e===null?p.push(t):i==null?e!=null&&a.push(t):(c.push(t),equalityDeep(i,e)||l.push(t)),(a.length>0||l.length>0||p.length>0)&&this.emit("change",[{added:a,updated:l,removed:p},"local"]),this.emit("update",[{added:a,updated:c,removed:p},"local"])}setLocalStateField(e,t){const r=this.getLocalState();r!==null&&this.setLocalState({...r,[e]:t})}getStates(){return this.states}}const removeAwarenessStates=(n,e,t)=>{const r=[];for(let s=0;s<e.length;s++){const i=e[s];if(n.states.has(i)){if(n.states.delete(i),i===n.clientID){const a=n.meta.get(i);n.meta.set(i,{clock:a.clock+1,lastUpdated:getUnixTime()})}r.push(i)}}r.length>0&&(n.emit("change",[{added:[],updated:[],removed:r},t]),n.emit("update",[{added:[],updated:[],removed:r},t]))},encodeAwarenessUpdate=(n,e,t=n.states)=>{const r=e.length,s=createEncoder();writeVarUint(s,r);for(let i=0;i<r;i++){const a=e[i],c=t.get(a)||null,l=n.meta.get(a).clock;writeVarUint(s,a),writeVarUint(s,l),writeVarString(s,JSON.stringify(c))}return toUint8Array(s)},applyAwarenessUpdate=(n,e,t)=>{const r=createDecoder(e),s=getUnixTime(),i=[],a=[],c=[],l=[],p=readVarUint(r);for(let m=0;m<p;m++){const h=readVarUint(r);let f=readVarUint(r);const y=JSON.parse(readVarString(r)),g=n.meta.get(h),_=n.states.get(h),L=g===void 0?0:g.clock;(L<f||L===f&&y===null&&n.states.has(h))&&(y===null?h===n.clientID&&n.getLocalState()!=null?f++:n.states.delete(h):n.states.set(h,y),n.meta.set(h,{clock:f,lastUpdated:s}),g===void 0&&y!==null?i.push(h):g!==void 0&&y===null?l.push(h):y!==null&&(equalityDeep(y,_)||c.push(h),a.push(h)))}(i.length>0||c.length>0||l.length>0)&&n.emit("change",[{added:i,updated:c,removed:l},t]),(i.length>0||a.length>0||l.length>0)&&n.emit("update",[{added:i,updated:a,removed:l},t])},deriveKey=(n,e)=>{const t=encodeUtf8(n).buffer,r=encodeUtf8(e).buffer;return crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveKey"]).then(s=>crypto.subtle.deriveKey({name:"PBKDF2",salt:r,iterations:1e5,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"]))},encrypt=(n,e)=>{if(!e)return resolve(n);const t=crypto.getRandomValues(new Uint8Array(12));return crypto.subtle.encrypt({name:"AES-GCM",iv:t},e,n).then(r=>{const s=createEncoder();return writeVarString(s,"AES-GCM"),writeVarUint8Array(s,t),writeVarUint8Array(s,new Uint8Array(r)),toUint8Array(s)})},encryptJson=(n,e)=>{const t=createEncoder();return writeAny(t,n),encrypt(toUint8Array(t),e)},decrypt=(n,e)=>{if(!e)return resolve(n);const t=createDecoder(n);readVarString(t)!=="AES-GCM"&&reject(create$3("Unknown encryption algorithm"));const s=readVarUint8Array(t),i=readVarUint8Array(t);return crypto.subtle.decrypt({name:"AES-GCM",iv:s},e,i).then(a=>new Uint8Array(a))},decryptJson=(n,e)=>decrypt(n,e).then(t=>readAny(createDecoder(new Uint8Array(t)))),log=createModuleLogger("y-webrtc"),messageSync=0,messageQueryAwareness=3,messageAwareness=1,messageBcPeerId=4,signalingConns=new Map,rooms=new Map,checkIsSynced=n=>{let e=!0;n.webrtcConns.forEach(t=>{t.synced||(e=!1)}),(!e&&n.synced||e&&!n.synced)&&(n.synced=e,n.provider.emit("synced",[{synced:e}]),log("synced ",BOLD,n.name,UNBOLD," with all peers"))},readMessage=(n,e,t)=>{const r=createDecoder(e),s=createEncoder(),i=readVarUint(r);if(n===void 0)return null;const a=n.awareness,c=n.doc;let l=!1;switch(i){case messageSync:{writeVarUint(s,messageSync);const p=readSyncMessage(r,s,c,n);p===messageYjsSyncStep2&&!n.synced&&t(),p===messageYjsSyncStep1&&(l=!0);break}case messageQueryAwareness:writeVarUint(s,messageAwareness),writeVarUint8Array(s,encodeAwarenessUpdate(a,Array.from(a.getStates().keys()))),l=!0;break;case messageAwareness:applyAwarenessUpdate(a,readVarUint8Array(r),n);break;case messageBcPeerId:{const p=readUint8(r)===1,m=readVarString(r);if(m!==n.peerId&&(n.bcConns.has(m)&&!p||!n.bcConns.has(m)&&p)){const h=[],f=[];p?(n.bcConns.add(m),f.push(m)):(n.bcConns.delete(m),h.push(m)),n.provider.emit("peers",[{added:f,removed:h,webrtcPeers:Array.from(n.webrtcConns.keys()),bcPeers:Array.from(n.bcConns)}]),broadcastBcPeerId(n)}break}default:return console.error("Unable to compute message"),s}return l?s:null},readPeerMessage=(n,e)=>{const t=n.room;return log("received message from ",BOLD,n.remotePeerId,GREY," (",t.name,")",UNBOLD,UNCOLOR),readMessage(t,e,()=>{n.synced=!0,log("synced ",BOLD,t.name,UNBOLD," with ",BOLD,n.remotePeerId),checkIsSynced(t)})},sendWebrtcConn=(n,e)=>{log("send message to ",BOLD,n.remotePeerId,UNBOLD,GREY," (",n.room.name,")",UNCOLOR);try{n.peer.send(toUint8Array(e))}catch{}},broadcastWebrtcConn=(n,e)=>{log("broadcast message in ",BOLD,n.name,UNBOLD),n.webrtcConns.forEach(t=>{try{t.peer.send(e)}catch{}})};class WebrtcConn{constructor(e,t,r,s){log("establishing connection to ",BOLD,r),this.room=s,this.remotePeerId=r,this.glareToken=void 0,this.closed=!1,this.connected=!1,this.synced=!1,this.peer=new Peer({initiator:t,...s.provider.peerOpts}),this.peer.on("signal",i=>{this.glareToken===void 0&&(this.glareToken=Date.now()+Math.random()),publishSignalingMessage(e,s,{to:r,from:s.peerId,type:"signal",token:this.glareToken,signal:i})}),this.peer.on("connect",()=>{log("connected to ",BOLD,r),this.connected=!0;const a=s.provider.doc,c=s.awareness,l=createEncoder();writeVarUint(l,messageSync),writeSyncStep1(l,a),sendWebrtcConn(this,l);const p=c.getStates();if(p.size>0){const m=createEncoder();writeVarUint(m,messageAwareness),writeVarUint8Array(m,encodeAwarenessUpdate(c,Array.from(p.keys()))),sendWebrtcConn(this,m)}}),this.peer.on("close",()=>{this.connected=!1,this.closed=!0,s.webrtcConns.has(this.remotePeerId)&&(s.webrtcConns.delete(this.remotePeerId),s.provider.emit("peers",[{removed:[this.remotePeerId],added:[],webrtcPeers:Array.from(s.webrtcConns.keys()),bcPeers:Array.from(s.bcConns)}])),checkIsSynced(s),this.peer.destroy(),log("closed connection to ",BOLD,r),announceSignalingInfo(s)}),this.peer.on("error",i=>{log("Error in connection to ",BOLD,r,": ",i),announceSignalingInfo(s)}),this.peer.on("data",i=>{const a=readPeerMessage(this,i);a!==null&&sendWebrtcConn(this,a)})}destroy(){this.peer.destroy()}}const broadcastBcMessage=(n,e)=>encrypt(e,n.key).then(t=>n.mux(()=>publish(n.name,t))),broadcastRoomMessage=(n,e)=>{n.bcconnected&&broadcastBcMessage(n,e),broadcastWebrtcConn(n,e)},announceSignalingInfo=n=>{signalingConns.forEach(e=>{e.connected&&(e.send({type:"subscribe",topics:[n.name]}),n.webrtcConns.size<n.provider.maxConns&&publishSignalingMessage(e,n,{type:"announce",from:n.peerId}))})},broadcastBcPeerId=n=>{if(n.provider.filterBcConns){const e=createEncoder();writeVarUint(e,messageBcPeerId),writeUint8(e,1),writeVarString(e,n.peerId),broadcastBcMessage(n,toUint8Array(e))}};class Room{constructor(e,t,r,s){this.peerId=uuidv4(),this.doc=e,this.awareness=t.awareness,this.provider=t,this.synced=!1,this.name=r,this.key=s,this.webrtcConns=new Map,this.bcConns=new Set,this.mux=createMutex(),this.bcconnected=!1,this._bcSubscriber=i=>decrypt(new Uint8Array(i),s).then(a=>this.mux(()=>{const c=readMessage(this,a,()=>{});c&&broadcastBcMessage(this,toUint8Array(c))})),this._docUpdateHandler=(i,a)=>{const c=createEncoder();writeVarUint(c,messageSync),writeUpdate(c,i),broadcastRoomMessage(this,toUint8Array(c))},this._awarenessUpdateHandler=({added:i,updated:a,removed:c},l)=>{const p=i.concat(a).concat(c),m=createEncoder();writeVarUint(m,messageAwareness),writeVarUint8Array(m,encodeAwarenessUpdate(this.awareness,p)),broadcastRoomMessage(this,toUint8Array(m))},this._beforeUnloadHandler=()=>{removeAwarenessStates(this.awareness,[e.clientID],"window unload"),rooms.forEach(i=>{i.disconnect()})},typeof window<"u"?window.addEventListener("beforeunload",this._beforeUnloadHandler):typeof process<"u"&&process.on("exit",this._beforeUnloadHandler)}connect(){this.doc.on("update",this._docUpdateHandler),this.awareness.on("update",this._awarenessUpdateHandler),announceSignalingInfo(this);const e=this.name;subscribe(e,this._bcSubscriber),this.bcconnected=!0,broadcastBcPeerId(this);const t=createEncoder();writeVarUint(t,messageSync),writeSyncStep1(t,this.doc),broadcastBcMessage(this,toUint8Array(t));const r=createEncoder();writeVarUint(r,messageSync),writeSyncStep2(r,this.doc),broadcastBcMessage(this,toUint8Array(r));const s=createEncoder();writeVarUint(s,messageQueryAwareness),broadcastBcMessage(this,toUint8Array(s));const i=createEncoder();writeVarUint(i,messageAwareness),writeVarUint8Array(i,encodeAwarenessUpdate(this.awareness,[this.doc.clientID])),broadcastBcMessage(this,toUint8Array(i))}disconnect(){signalingConns.forEach(t=>{t.connected&&t.send({type:"unsubscribe",topics:[this.name]})}),removeAwarenessStates(this.awareness,[this.doc.clientID],"disconnect");const e=createEncoder();writeVarUint(e,messageBcPeerId),writeUint8(e,0),writeVarString(e,this.peerId),broadcastBcMessage(this,toUint8Array(e)),unsubscribe(this.name,this._bcSubscriber),this.bcconnected=!1,this.doc.off("update",this._docUpdateHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.webrtcConns.forEach(t=>t.destroy())}destroy(){this.disconnect(),typeof window<"u"?window.removeEventListener("beforeunload",this._beforeUnloadHandler):typeof process<"u"&&process.off("exit",this._beforeUnloadHandler)}}const openRoom=(n,e,t,r)=>{if(rooms.has(t))throw create$3(`A Yjs Doc connected to room "${t}" already exists!`);const s=new Room(n,e,t,r);return rooms.set(t,s),s},publishSignalingMessage=(n,e,t)=>{e.key?encryptJson(t,e.key).then(r=>{n.send({type:"publish",topic:e.name,data:toBase64(r)})}):n.send({type:"publish",topic:e.name,data:t})};class SignalingConn extends WebsocketClient{constructor(e){super(e),this.providers=new Set,this.on("connect",()=>{log(`connected (${e})`);const t=Array.from(rooms.keys());this.send({type:"subscribe",topics:t}),rooms.forEach(r=>publishSignalingMessage(this,r,{type:"announce",from:r.peerId}))}),this.on("message",t=>{switch(t.type){case"publish":{const r=t.topic,s=rooms.get(r);if(s==null||typeof r!="string")return;const i=a=>{const c=s.webrtcConns,l=s.peerId;if(a==null||a.from===l||a.to!==void 0&&a.to!==l||s.bcConns.has(a.from))return;const p=c.has(a.from)?()=>{}:()=>s.provider.emit("peers",[{removed:[],added:[a.from],webrtcPeers:Array.from(s.webrtcConns.keys()),bcPeers:Array.from(s.bcConns)}]);switch(a.type){case"announce":c.size<s.provider.maxConns&&(setIfUndefined(c,a.from,()=>new WebrtcConn(this,!0,a.from,s)),p());break;case"signal":if(a.signal.type==="offer"){const m=c.get(a.from);if(m){const h=a.token,f=m.glareToken;if(f&&f>h){log("offer rejected: ",a.from);return}m.glareToken=void 0}}if(a.signal.type==="answer"){log("offer answered by: ",a.from);const m=c.get(a.from);m.glareToken=void 0}a.to===l&&(setIfUndefined(c,a.from,()=>new WebrtcConn(this,!1,a.from,s)).peer.signal(a.signal),p());break}};s.key?typeof t.data=="string"&&decryptJson(fromBase64(t.data),s.key).then(i):i(t.data)}}}),this.on("disconnect",()=>log(`disconnect (${e})`))}}const emitStatus=n=>{n.emit("status",[{connected:n.connected}])};class WebrtcProvider extends ObservableV2{constructor(e,t,{signaling:r=["wss://y-webrtc-eu.fly.dev"],password:s=null,awareness:i=new Awareness(t),maxConns:a=20+floor(rand()*15),filterBcConns:c=!0,peerOpts:l={}}={}){super(),this.roomName=e,this.doc=t,this.filterBcConns=c,this.awareness=i,this.shouldConnect=!1,this.signalingUrls=r,this.signalingConns=[],this.maxConns=a,this.peerOpts=l,this.key=s?deriveKey(s,e):resolve(null),this.room=null,this.key.then(p=>{this.room=openRoom(t,this,e,p),this.shouldConnect?this.room.connect():this.room.disconnect(),emitStatus(this)}),this.connect(),this.destroy=this.destroy.bind(this),t.on("destroy",this.destroy)}get connected(){return this.room!==null&&this.shouldConnect}connect(){this.shouldConnect=!0,this.signalingUrls.forEach(e=>{const t=setIfUndefined(signalingConns,e,()=>new SignalingConn(e));this.signalingConns.push(t),t.providers.add(this)}),this.room&&(this.room.connect(),emitStatus(this))}disconnect(){this.shouldConnect=!1,this.signalingConns.forEach(e=>{e.providers.delete(this),e.providers.size===0&&(e.destroy(),signalingConns.delete(e.url))}),this.room&&(this.room.disconnect(),emitStatus(this))}destroy(){this.doc.off("destroy",this.destroy),this.key.then(()=>{this.room.destroy(),rooms.delete(this.roomName)}),super.destroy()}}const rtop=n=>create$2((e,t)=>{n.onerror=r=>t(new Error(r.target.error)),n.onsuccess=r=>e(r.target.result)}),openDB=(n,e)=>create$2((t,r)=>{const s=indexedDB.open(n);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(create$3(i.target.error)),s.onsuccess=i=>{const a=i.target.result;a.onversionchange=()=>{a.close()},t(a)}}),deleteDB=n=>rtop(indexedDB.deleteDatabase(n)),createStores=(n,e)=>e.forEach(t=>n.createObjectStore.apply(n,t)),transact=(n,e,t="readwrite")=>{const r=n.transaction(e,t);return e.map(s=>getStore(r,s))},count=(n,e)=>rtop(n.count(e)),get=(n,e)=>rtop(n.get(e)),del=(n,e)=>rtop(n.delete(e)),put=(n,e,t)=>rtop(n.put(e,t)),addAutoKey=(n,e)=>rtop(n.add(e)),getAll=(n,e,t)=>rtop(n.getAll(e,t)),queryFirst=(n,e,t)=>{let r=null;return iterateKeys(n,e,s=>(r=s,!1),t).then(()=>r)},getLastKey=(n,e=null)=>queryFirst(n,e,"prev"),iterateOnRequest=(n,e)=>create$2((t,r)=>{n.onerror=r,n.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return t();i.continue()}}),iterateKeys=(n,e,t,r="next")=>iterateOnRequest(n.openKeyCursor(e,r),s=>t(s.key)),getStore=(n,e)=>n.objectStore(e),createIDBKeyRangeUpperBound=(n,e)=>IDBKeyRange.upperBound(n,e),createIDBKeyRangeLowerBound=(n,e)=>IDBKeyRange.lowerBound(n,e),customStoreName="custom",updatesStoreName="updates",PREFERRED_TRIM_SIZE=500,fetchUpdates=(n,e=()=>{},t=()=>{})=>{const[r]=transact(n.db,[updatesStoreName]);return getAll(r,createIDBKeyRangeLowerBound(n._dbref,!1)).then(s=>{n._destroyed||(e(r),transact$1(n.doc,()=>{s.forEach(i=>applyUpdate(n.doc,i))},n,!1),t(r))}).then(()=>getLastKey(r).then(s=>{n._dbref=s+1})).then(()=>count(r).then(s=>{n._dbsize=s})).then(()=>r)},storeState=(n,e=!0)=>fetchUpdates(n).then(t=>{(e||n._dbsize>=PREFERRED_TRIM_SIZE)&&addAutoKey(t,encodeStateAsUpdate(n.doc)).then(()=>del(t,createIDBKeyRangeUpperBound(n._dbref,!0))).then(()=>count(t).then(r=>{n._dbsize=r}))});class IndexeddbPersistence extends Observable{constructor(e,t){super(),this.doc=t,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=openDB(e,r=>createStores(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=create$2(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,fetchUpdates(this,a=>addAutoKey(a,encodeStateAsUpdate(t)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=transact(this.db,[updatesStoreName]);addAutoKey(i,r),++this._dbsize>=PREFERRED_TRIM_SIZE&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{storeState(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},t.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),t.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{deleteDB(this.name)})}get(e){return this._db.then(t=>{const[r]=transact(t,[customStoreName],"readonly");return get(r,e)})}set(e,t){return this._db.then(r=>{const[s]=transact(r,[customStoreName]);return put(s,t,e)})}del(e){return this._db.then(t=>{const[r]=transact(t,[customStoreName]);return del(r,e)})}}class YDocWrapper{constructor(e){this.yDoc=e}getText(e){return this.yDoc.getText(e)}getMap(e){return this.yDoc.getMap(e)}getArray(e){return this.yDoc.getArray(e)}getXmlFragment(e){return this.yDoc.getXmlFragment(e)}undo(){console.warn("Undo not implemented")}redo(){console.warn("Redo not implemented")}transact(e){this.yDoc.transact(e)}snapshot(){return snapshot(this.yDoc)}restore(e){console.warn("Restore not implemented")}on(e,t){this.yDoc.on(e,t)}off(e,t){this.yDoc.off(e,t)}}class RoomManagerImpl{constructor(){this.rooms=new Map}async create(e){const t=`room-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,r=new Doc,s=new YDocWrapper(r),i=new WebrtcProvider(t,r,{signaling:["wss://signaling.glyphd.com","wss://y-webrtc-signaling-eu.herokuapp.com"],maxConns:(e==null?void 0:e.maxPeers)||20});let a=null;e!=null&&e.persistent&&(a=new IndexeddbPersistence(t,r));const c={id:i.awareness.clientID.toString(),name:"User",color:"#"+Math.floor(Math.random()*16777215).toString(16),state:"connected",connection:"webrtc",joinedAt:Date.now()},l={id:t,appId:(e==null?void 0:e.appId)||"unknown",doc:s,peers:new Map,localPeer:c,awareness:i.awareness,invite:()=>t,fork:async()=>this.create(e),save:async()=>{},load:async()=>{},on:(p,m)=>{p==="peer-join"?i.awareness.on("change",h=>{h.added.forEach(f=>m({id:f}))}):p==="peer-leave"&&i.awareness.on("change",h=>{h.removed.forEach(f=>m({id:f}))})},off:()=>{},close:async()=>{i.destroy(),a&&a.destroy(),this.rooms.delete(t)}};return this.rooms.set(t,l),l}async join(e,t){const r=new Doc,s=new YDocWrapper(r),i=new WebrtcProvider(e,r,{signaling:["wss://signaling.glyphd.com","wss://y-webrtc-signaling-eu.herokuapp.com"]}),a=new IndexeddbPersistence(e,r),c={id:i.awareness.clientID.toString(),name:"User",color:"#"+Math.floor(Math.random()*16777215).toString(16),state:"connected",connection:"webrtc",joinedAt:Date.now()},l={id:e,appId:"unknown",doc:s,peers:new Map,localPeer:c,awareness:i.awareness,invite:()=>e,fork:async()=>this.create(),save:async()=>{},load:async()=>{},on:(p,m)=>{p==="peer-join"?i.awareness.on("change",h=>{h.added.forEach(f=>m({id:f}))}):p==="peer-leave"&&i.awareness.on("change",h=>{h.removed.forEach(f=>m({id:f}))})},off:()=>{},close:async()=>{i.destroy(),a.destroy(),this.rooms.delete(e)}};return this.rooms.set(e,l),l}async leave(e){const t=this.rooms.get(e);t&&await t.close()}listRooms(){return Array.from(this.rooms.values())}getRoom(e){return this.rooms.get(e)||null}}class AIManagerImpl{async complete(e,t){return console.warn("AI provider not configured"),`AI response to: ${e}`}async*stream(e,t){yield"AI",yield" streaming",yield" not",yield" implemented"}async embed(e,t){return new Array(1536).fill(0).map(()=>Math.random())}async chat(e,t){return{role:"assistant",content:`Response to: ${e[e.length-1].content}`}}getUsage(){return{tokensUsed:0,tokensRemaining:1e4,requestCount:0,providers:{}}}setKey(e,t){console.log("AI key set")}listProviders(){return[]}}class IPCAPIImpl{constructor(){this.exposed=new Map,this.subscribers=new Map}expose(e,t){this.exposed.set(e,t)}unexpose(e){this.exposed.delete(e)}async call(e,t,...r){const s=this.exposed.get(t);if(!s)throw new Error(`Method ${t} not found`);return s(...r)}broadcast(e,t){const r=this.subscribers.get(e);r&&r.forEach(s=>s(t))}subscribe(e,t){this.subscribers.has(e)||this.subscribers.set(e,new Set),this.subscribers.get(e).add(t)}unsubscribe(e,t){const r=this.subscribers.get(e);r&&r.delete(t)}discover(){return{}}}class CapabilityAPIImpl{constructor(){this.capabilities=new Set}async request(e){return this.capabilities.add(JSON.stringify(e)),{token:"granted",capability:e,grantedAt:Date.now()}}has(e){return!0}list(){return[]}revoke(e){}}class EventAPIImpl{constructor(){this.listeners=new Map}emit(e,t){const r=this.listeners.get(e);r&&r.forEach(s=>s(t))}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){const r=s=>{t(s),this.off(e,r)};this.on(e,r)}off(e,t){const r=this.listeners.get(e);r&&r.delete(t)}}class LifecycleAPIImpl{constructor(e){this.context=e}getManifest(){return this.context.manifest}getAppId(){return this.context.appId}getProcessId(){return this.context.processId}getWindowId(){return this.context.windowId||null}async close(){window.close()}minimize(){console.log("Minimize not implemented in SDK")}maximize(){console.log("Maximize not implemented in SDK")}restore(){console.log("Restore not implemented in SDK")}setTitle(e){document.title=e}getState(){return{appId:this.getAppId(),processId:this.getProcessId(),windowId:this.getWindowId(),state:"running",startedAt:Date.now(),lastActive:Date.now()}}async saveState(e){}async restoreState(){return null}}class UtilsAPIImpl{constructor(){this.base64={encode(e){return btoa(typeof e=="string"?e:String.fromCharCode(...e))},decode(e){return atob(e)}},this.json={stringify:JSON.stringify,parse:JSON.parse},this.date={now:Date.now,format(e,t){return new Date(e).toISOString()},parse(e){return new Date(e).getTime()}},this.url={parse(e){const t=new URL(e);return{protocol:t.protocol,host:t.hostname,port:t.port?parseInt(t.port):void 0,path:t.pathname,query:Object.fromEntries(t.searchParams),hash:t.hash?t.hash.substring(1):void 0}},build(e){const t=new URL(`${e.protocol}//${e.host}${e.path}`);return e.port&&(t.port=e.port.toString()),e.query&&Object.entries(e.query).forEach(([r,s])=>{t.searchParams.set(r,s)}),e.hash&&(t.hash=e.hash),t.toString()},resolve(e,t){return new URL(t,e).toString()}},this.validate={email(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)},url(e){try{return new URL(e),!0}catch{return!1}},semver(e){return/^\d+\.\d+\.\d+/.test(e)}}}uuid(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}async hash(e){const r=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(s)).map(a=>a.toString(16).padStart(2,"0")).join("")}}function createOS(n){var y,g,_,L,x,O,w,S;const e=new RoomManagerImpl,t=new AIManagerImpl,r=new IPCAPIImpl,s=new CapabilityAPIImpl,i=new EventAPIImpl,a=new LifecycleAPIImpl({}),c=new UtilsAPIImpl,l=((g=(y=window.GlyphOS)==null?void 0:y.getStorage)==null?void 0:g.call(y))||null,p=((L=(_=window.GlyphOS)==null?void 0:_.getWindowManager)==null?void 0:L.call(_))||null,m=((O=(x=window.GlyphOS)==null?void 0:x.getCommandPalette)==null?void 0:O.call(x))||null,h=((S=(w=window.GlyphOS)==null?void 0:w.getDock)==null?void 0:S.call(w))||null;return{storage:l,ipc:r,ai:t,rooms:e,windows:p,workspaces:null,commands:m,dock:h,federation:null,capabilities:s,events:i,lifecycle:a,fs:(l==null?void 0:l.fs)||null,utils:c}}function injectOS(n){const e=createOS();return window.OS=e,e}typeof window<"u"&&!window.OS&&injectOS();(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&["quick-test.js","test-apps.js","comprehensive-test.js"].forEach(e=>{const t=document.createElement("script");t.src=`/${e}`,t.onerror=()=>console.log(`Test script ${e} not found (OK in production)`),document.body.appendChild(t)});class KernelEventBus{constructor(){this.listeners=new Map,this.onceListeners=new Map}emit(e,t){const r=this.listeners.get(e);if(r)for(const i of r)try{i(t)}catch(a){console.error(`Error in event handler for ${e}:`,a)}const s=this.onceListeners.get(e);if(s){for(const i of s)try{i(t)}catch(a){console.error(`Error in once event handler for ${e}:`,a)}this.onceListeners.delete(e)}}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}once(e,t){this.onceListeners.has(e)||this.onceListeners.set(e,new Set),this.onceListeners.get(e).add(t)}off(e,t){const r=this.listeners.get(e);r&&(r.delete(t),r.size===0&&this.listeners.delete(e));const s=this.onceListeners.get(e);s&&(s.delete(t),s.size===0&&this.onceListeners.delete(e))}removeAllListeners(e){e?(this.listeners.delete(e),this.onceListeners.delete(e)):(this.listeners.clear(),this.onceListeners.clear())}listenerCount(e){var s,i;const t=((s=this.listeners.get(e))==null?void 0:s.size)||0,r=((i=this.onceListeners.get(e))==null?void 0:i.size)||0;return t+r}eventNames(){const e=new Set;for(const t of this.listeners.keys())e.add(t);for(const t of this.onceListeners.keys())e.add(t);return Array.from(e)}}class KernelCapabilityManager{constructor(){this.grantedCapabilities=new Map,this.capabilityConstraints=new Map,this.initializeDefaultConstraints()}async request(e,t){const r=this.getCapabilityToken(e,t);if(r)return r;if(!this.validateCapabilityFormat(t))throw new Error(`Invalid capability format: ${JSON.stringify(t)}`);const s=this.capabilityConstraints.get(this.getCapabilityKey(t));if(s&&!this.satisfiesConstraints(t,s))throw new Error(`Capability constraints not satisfied: ${JSON.stringify(t)}`);const i={capability:t,grantedAt:Date.now(),expiresAt:s==null?void 0:s.expiresAt};return this.grantedCapabilities.has(e)||this.grantedCapabilities.set(e,new Map),this.grantedCapabilities.get(e).set(this.getCapabilityKey(t),i),i}has(e,t){const r=this.getCapabilityToken(e,t);return r?r.expiresAt&&Date.now()>r.expiresAt?(this.revoke(e,t),!1):!0:!1}revoke(e,t){const r=this.grantedCapabilities.get(e);r&&(r.delete(this.getCapabilityKey(t)),r.size===0&&this.grantedCapabilities.delete(e))}list(e){const t=this.grantedCapabilities.get(e);if(!t)return[];const r=[];for(const s of t.values())(!s.expiresAt||Date.now()<=s.expiresAt)&&r.push(s.capability);return r}validate(e){const t=[],r=[];if(e.capabilities.storage){const s=e.capabilities.storage;if(s.quota&&this.parseByteSize(s.quota)>1024*1024*1024&&r.push(`Storage quota ${s.quota} is very large`),s.scopes)for(const i of s.scopes)/^[a-zA-Z0-9_-]+$/.test(i)||t.push(`Invalid storage scope: ${i}`)}if(e.capabilities.network){const s=e.capabilities.network;if(s.fetch)for(const i of s.fetch)this.isValidURLPattern(i)||t.push(`Invalid fetch URL pattern: ${i}`);if(s.websocket)for(const i of s.websocket)this.isValidURLPattern(i)||t.push(`Invalid WebSocket URL pattern: ${i}`)}if(e.capabilities.ai){const s=e.capabilities.ai;if(s.maxTokens&&s.maxTokens>1e5&&r.push(`AI max tokens ${s.maxTokens} is very high`),s.providers){const i=["openai","anthropic","xai","ollama"];for(const a of s.providers)!i.includes(a)&&!a.startsWith("custom:")&&r.push(`Unknown AI provider: ${a}`)}}if(e.capabilities.ipc){const s=e.capabilities.ipc;if(s.expose)for(const i of s.expose)/^[a-zA-Z][a-zA-Z0-9_]*$/.test(i.name)||t.push(`Invalid IPC method name: ${i.name}`);if(s.consume)for(const i of s.consume)this.isValidServicePattern(i)||t.push(`Invalid IPC service pattern: ${i}`)}return{valid:t.length===0,errors:t.length>0?t:void 0,warnings:r.length>0?r:void 0}}getCapabilityToken(e,t){const r=this.grantedCapabilities.get(e);return r&&r.get(this.getCapabilityKey(t))||null}getCapabilityKey(e){return JSON.stringify(e)}validateCapabilityFormat(e){if(!e.type)return!1;switch(e.type){case"storage":return typeof e.scope=="string";case"network":return typeof e.origin=="string";case"ai":return typeof e.provider=="string";case"ipc":return typeof e.target=="string";case"media":return["camera","microphone","screen"].includes(e.device);case"notifications":return!0;case"clipboard":return["read","write"].includes(e.mode);case"geolocation":return!0;default:return!1}}satisfiesConstraints(e,t){return!0}initializeDefaultConstraints(){this.capabilityConstraints.set("storage",{maxQuota:1024*1024*1024,allowedScopes:["documents","cache","temp","user"]}),this.capabilityConstraints.set("network",{maxRequestsPerMinute:100,allowedOrigins:["*"]}),this.capabilityConstraints.set("ai",{maxTokensPerRequest:1e5,maxRequestsPerHour:1e3})}parseByteSize(e){const t={B:1,KB:1024,MB:1048576,GB:1073741824},r=e.match(/^(\d+(?:\.\d+)?)\s*(B|KB|MB|GB)$/i);if(!r)return 0;const s=parseFloat(r[1]),i=r[2].toUpperCase();return s*t[i]}isValidURLPattern(e){if(e==="*")return!0;try{return new URL(e),!0}catch{return/^https?:\/\/[^*]+\*$/.test(e)}}isValidServicePattern(e){return/^[a-zA-Z][a-zA-Z0-9_.]*$/.test(e)}}class KernelIPCRouter{constructor(){this.exposedMethods=new Map,this.broadcastSubscribers=new Map,this.pendingRequests=new Map,this.messageCounter=0,this.setupMessageHandling()}expose(e,t){this.exposedMethods.has(e)&&console.warn(`Method ${e} is already exposed, replacing handler`),this.exposedMethods.set(e,t)}unexpose(e){this.exposedMethods.delete(e)}async call(e,t,r){const s=this.generateMessageId(),i={id:s,type:"request",from:"kernel",to:e,method:t,payload:r,timestamp:Date.now()};return new Promise((a,c)=>{const l=setTimeout(()=>{this.pendingRequests.delete(s),c(new Error(`IPC call timeout: ${t}`))},3e4);this.pendingRequests.set(s,{resolve:a,reject:c,timeout:l}),this.sendMessage(i)})}broadcast(e,t){const r={id:this.generateMessageId(),type:"broadcast",from:"kernel",to:null,method:e,payload:t,timestamp:Date.now()};this.sendMessage(r)}subscribe(e,t){this.broadcastSubscribers.has(e)||this.broadcastSubscribers.set(e,new Set),this.broadcastSubscribers.get(e).add(t)}unsubscribe(e,t){const r=this.broadcastSubscribers.get(e);r&&(r.delete(t),r.size===0&&this.broadcastSubscribers.delete(e))}discover(){const e={},t=Array.from(this.exposedMethods.keys());return e.kernel={methods:t.map(r=>({name:r,params:[],returns:"any"})),channels:Array.from(this.broadcastSubscribers.keys())},e}handleMessage(e){switch(e.type){case"request":this.handleRequest(e);break;case"response":this.handleResponse(e);break;case"broadcast":this.handleBroadcast(e);break;case"error":this.handleError(e);break}}async handleRequest(e){const t=this.exposedMethods.get(e.method);if(!t){this.sendErrorResponse(e.id,"METHOD_NOT_FOUND",`Method ${e.method} not found`);return}try{const r=await t(...e.payload);this.sendResponse(e.id,r)}catch(r){this.sendErrorResponse(e.id,"HANDLER_ERROR",r instanceof Error?r.message:String(r))}}handleResponse(e){const t=this.pendingRequests.get(e.id);t&&(clearTimeout(t.timeout),this.pendingRequests.delete(e.id),t.resolve(e.payload))}handleBroadcast(e){const t=this.broadcastSubscribers.get(e.method);if(t)for(const r of t)try{r(e.payload,e.from)}catch(s){console.error(`Error in broadcast handler for ${e.method}:`,s)}}handleError(e){var r;const t=this.pendingRequests.get(e.id);if(t){clearTimeout(t.timeout),this.pendingRequests.delete(e.id);const s=new Error(((r=e.error)==null?void 0:r.message)||"Unknown IPC error");t.reject(s)}}sendResponse(e,t){const r={id:this.generateMessageId(),type:"response",from:"kernel",to:null,method:"",payload:t,timestamp:Date.now(),replyTo:e};this.sendMessage(r)}sendErrorResponse(e,t,r){const s={id:this.generateMessageId(),type:"error",from:"kernel",to:null,method:"",payload:null,timestamp:Date.now(),replyTo:e,error:{code:t,message:r}};this.sendMessage(s)}sendMessage(e){console.log("Sending IPC message:",e)}setupMessageHandling(){this.handleMessage=this.handleMessage.bind(this)}generateMessageId(){return`msg_${++this.messageCounter}_${Date.now()}`}}class KernelProcessManager{constructor(){this.processes=new Map,this.appToProcess=new Map,this.eventHandlers=new Map,this.maxConcurrentApps=10,this.resourceMonitor=new ResourceMonitor,this.startResourceMonitoring()}async spawn(e,t){const r=this.appToProcess.get(e.id);if(r){const a=this.processes.get(r);if(a&&a.state==="running")throw new Error(`App ${e.id} is already running`)}this.processes.size>=this.maxConcurrentApps&&await this.suspendLeastRecentlyUsed();const s=this.generateProcessId(),i={pid:s,appId:e.id,manifest:e,state:"spawning",spawnedAt:Date.now(),resourceUsage:{cpu:0,memory:0,storage:0,network:{sent:0,received:0,requests:0}}};return this.processes.set(s,i),this.appToProcess.set(e.id,s),this.emitEvent("spawn",i),i.state="running",new ProcessHandleImpl(s,this)}async kill(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);this.processes.delete(e),this.appToProcess.delete(t.appId),this.emitEvent("exit",t)}async suspend(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);if(t.state!=="running")throw new Error(`Process ${e} is not running`);t.state="suspended",this.emitEvent("suspend",t)}async resume(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);if(t.state!=="suspended")throw new Error(`Process ${e} is not suspended`);t.state="running",this.emitEvent("resume",t)}getProcess(e){return this.processes.get(e)||null}listProcesses(){return Array.from(this.processes.values())}isRunning(e){const t=this.appToProcess.get(e);if(!t)return!1;const r=this.processes.get(t);return r?r.state==="running":!1}getPID(e){return this.appToProcess.get(e)||null}getResourceUsage(e){const t=this.processes.get(e);if(!t)throw new Error(`Process ${e} not found`);return t.resourceUsage}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,new Set),this.eventHandlers.get(e).add(t)}off(e,t){const r=this.eventHandlers.get(e);r&&(r.delete(t),r.size===0&&this.eventHandlers.delete(e))}async suspendLeastRecentlyUsed(){const e=Array.from(this.processes.values()).filter(t=>t.state==="running").sort((t,r)=>t.spawnedAt-r.spawnedAt);e.length>0&&await this.suspend(e[0].pid)}generateProcessId(){return`proc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}emitEvent(e,t){const r=this.eventHandlers.get(e);if(r)for(const s of r)try{s(t)}catch(i){console.error(`Error in process event handler for ${e}:`,i)}}startResourceMonitoring(){this.resourceMonitor.start(),setInterval(()=>{this.updateResourceUsage()},1e3)}updateResourceUsage(){for(const e of this.processes.values())e.resourceUsage.cpu=Math.random()*10,e.resourceUsage.memory=Math.random()*50*1024*1024}}class ProcessHandleImpl{constructor(e,t){this.pid=e,this.manager=t}async kill(){await this.manager.kill(this.pid)}async suspend(){await this.manager.suspend(this.pid)}async resume(){await this.manager.resume(this.pid)}getInfo(){const e=this.manager.getProcess(this.pid);if(!e)throw new Error(`Process ${this.pid} not found`);return e}}class ResourceMonitor{constructor(){this.monitoring=!1}start(){this.monitoring=!0}stop(){this.monitoring=!1}isMonitoring(){return this.monitoring}}class Kernel{constructor(){this.initialized=!1,this.startTime=Date.now(),this.events=new KernelEventBus,this.capabilities=new KernelCapabilityManager,this.ipc=new KernelIPCRouter,this.processes=new KernelProcessManager,this.setupEventHandlers()}async initialize(){if(this.initialized)throw new Error("Kernel is already initialized");console.log("Initializing GlyphOS Kernel..."),this.initialized=!0,console.log("GlyphOS Kernel initialized successfully")}async shutdown(){if(!this.initialized)return;console.log("Shutting down GlyphOS Kernel...");const e=this.processes.listProcesses();for(const t of e)try{await this.processes.kill(t.pid)}catch(r){console.error(`Error killing process ${t.pid}:`,r)}this.initialized=!1,console.log("GlyphOS Kernel shutdown complete")}isInitialized(){return this.initialized}getStatus(){return{initialized:this.initialized,processCount:this.processes.listProcesses().length,runningProcesses:this.processes.listProcesses().filter(e=>e.state==="running").length,exposedMethods:Object.keys(this.ipc.discover()).length,uptime:Date.now()-this.startTime}}setupEventHandlers(){this.processes.on("spawn",e=>{this.events.emit("process:spawn",e)}),this.processes.on("exit",e=>{this.events.emit("process:exit",e)}),this.processes.on("crash",e=>{this.events.emit("process:crash",e),console.error(`Process ${e.pid} crashed`)}),this.events.on("app:install",e=>{console.log("App installed:",e)}),this.events.on("app:uninstall",e=>{console.log("App uninstalled:",e)}),this.events.on("network:online",()=>{console.log("Network is online")}),this.events.on("network:offline",()=>{console.log("Network is offline")})}}let kernelInstance=null;function getKernel$1(){return kernelInstance||(kernelInstance=new Kernel),kernelInstance}async function initializeKernel(){const n=getKernel$1();return await n.initialize(),n}class IndexedDBKVStore{constructor(){this.db=null,this.dbName="glyphos-kv",this.storeName="kv-store",this.version=1}async initialize(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${r.error}`))},r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(this.storeName)||i.createObjectStore(this.storeName)}})}async get(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,r)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);a.onerror=()=>{r(new Error(`Failed to get key ${e}: ${a.error}`))},a.onsuccess=()=>{t(a.result||null)}})}async set(e,t){if(!this.db)throw new Error("Store not initialized");return new Promise((r,s)=>{const c=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(t,e);c.onerror=()=>{s(new Error(`Failed to set key ${e}: ${c.error}`))},c.onsuccess=()=>{r()}})}async delete(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,r)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);a.onerror=()=>{r(new Error(`Failed to delete key ${e}: ${a.error}`))},a.onsuccess=()=>{t()}})}async has(e){return await this.get(e)!==null}async keys(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAllKeys();i.onerror=()=>{t(new Error(`Failed to get keys: ${i.error}`))},i.onsuccess=()=>{e(i.result)}})}async clear(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onerror=()=>{t(new Error(`Failed to clear store: ${i.error}`))},i.onsuccess=()=>{e()}})}async getMany(e){const t=e.map(r=>this.get(r));return Promise.all(t)}async setMany(e){const t=Object.entries(e).map(([r,s])=>this.set(r,s));await Promise.all(t)}async deleteMany(e){const t=e.map(r=>this.delete(r));await Promise.all(t)}}class OPFSFileSystem{constructor(){this.rootHandle=null,this.watchers=new Map}async initialize(){try{this.rootHandle=await navigator.storage.getDirectory(),console.log("OPFS initialized successfully")}catch(e){throw console.error("Failed to initialize OPFS:",e),new Error("OPFS not available")}}async read(e,t){const s=await(await this.getFileHandle(e)).getFile();if((t==null?void 0:t.encoding)==="utf8")return await s.text();{const i=await s.arrayBuffer();return new Uint8Array(i)}}async write(e,t){const r=this.getDirPath(e),s=this.getFileName(e);await this.ensureDirectory(r);const c=await(await(await this.getDirectoryHandle(r)).getFileHandle(s,{create:!0})).createWritable();if(typeof t=="string")await c.write(t);else{const l=new ArrayBuffer(t.length);new Uint8Array(l).set(t),await c.write(l)}await c.close(),this.notifyWatchers(e,"modify")}async delete(e,t){const r=this.getDirPath(e),s=this.getFileName(e),i=await this.getDirectoryHandle(r);try{t!=null&&t.recursive?await i.removeEntry(s,{recursive:!0}):await i.removeEntry(s),this.notifyWatchers(e,"delete")}catch(a){if(a instanceof Error&&a.name==="NotFoundError")return;throw a}}async list(e){await this.getDirectoryHandle(e);const t=[];return console.warn("Directory listing not fully implemented yet"),t}async mkdir(e){await this.ensureDirectory(e)}async exists(e){try{return await this.getHandle(e),!0}catch{return!1}}async stat(e){const t=await this.getHandle(e);if(t.kind==="directory")return{size:0,created:Date.now(),modified:Date.now(),accessed:Date.now(),isDirectory:!0,isFile:!1};{const r=await t.getFile();return{size:r.size,created:r.lastModified,modified:r.lastModified,accessed:r.lastModified,isDirectory:!1,isFile:!0}}}async copy(e,t){const r=await this.read(e);await this.write(t,r)}async move(e,t){await this.copy(e,t),await this.delete(e)}watch(e,t){const r=new WatchHandleImpl(e,t,this);return this.watchers.set(e,r),r}async clear(){if(!this.rootHandle)throw new Error("OPFS not initialized");console.warn("OPFS clearing not fully implemented yet")}async getFileHandle(e){const t=await this.getHandle(e);if(t.kind!=="file")throw new Error(`Path ${e} is not a file`);return t}async getDirectoryHandle(e){const t=await this.getHandle(e);if(t.kind!=="directory")throw new Error(`Path ${e} is not a directory`);return t}async getHandle(e){if(!this.rootHandle)throw new Error("OPFS not initialized");const t=this.normalizePath(e).split("/").filter(Boolean);let r=this.rootHandle;for(const s of t)try{r=await r.getDirectoryHandle(s)}catch{return await r.getFileHandle(s)}return r}async ensureDirectory(e){if(!this.rootHandle)throw new Error("OPFS not initialized");const t=this.normalizePath(e).split("/").filter(Boolean);let r=this.rootHandle;for(const s of t)try{r=await r.getDirectoryHandle(s)}catch{r=await r.getDirectoryHandle(s,{create:!0})}}getDirPath(e){const t=this.normalizePath(e),r=t.lastIndexOf("/");return r===0?"/":t.substring(0,r)}getFileName(e){const t=this.normalizePath(e),r=t.lastIndexOf("/");return t.substring(r+1)}normalizePath(e){return e.replace(/\/+/g,"/").replace(/\/$/,"")||"/"}notifyWatchers(e,t){for(const[r,s]of this.watchers)e.startsWith(r)&&s.notify({type:t,path:e})}}class WatchHandleImpl{constructor(e,t,r){this._path=e,this.handler=t,this._fs=r}close(){console.log(`Closing watch handle for ${this._path}`),console.log(`File system: ${this._fs?"available":"unavailable"}`)}notify(e){try{this.handler(e)}catch(t){console.error("Error in watch handler:",t)}}}class IndexedDBBlobStore{constructor(){this.db=null,this.dbName="glyphos-blobs",this.storeName="blob-store",this.version=1}async initialize(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${r.error}`))},r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=s=>{const i=s.target.result;if(!i.objectStoreNames.contains(this.storeName)){const a=i.createObjectStore(this.storeName,{keyPath:"key"});a.createIndex("created","created",{unique:!1}),a.createIndex("size","size",{unique:!1})}}})}async put(e,t){if(!this.db)throw new Error("Store not initialized");const r=t instanceof Blob?t:new Blob([t]),s=r.size,i=r.type,a=Date.now();return new Promise((c,l)=>{const m=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),h={key:e,data:r,size:s,type:i,created:a},f=m.put(h);f.onerror=()=>{l(new Error(`Failed to store blob ${e}: ${f.error}`))},f.onsuccess=()=>{const y=URL.createObjectURL(r);c({key:e,size:s,type:i,url:y})}})}async get(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,r)=>{const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);a.onerror=()=>{r(new Error(`Failed to get blob ${e}: ${a.error}`))},a.onsuccess=()=>{const c=a.result;t(c?c.data:null)}})}async delete(e){if(!this.db)throw new Error("Store not initialized");return new Promise((t,r)=>{const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);a.onerror=()=>{r(new Error(`Failed to delete blob ${e}: ${a.error}`))},a.onsuccess=()=>{t()}})}async getURL(e){const t=await this.get(e);return t?URL.createObjectURL(t):null}async list(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onerror=()=>{t(new Error(`Failed to list blobs: ${i.error}`))},i.onsuccess=()=>{const a=i.result.map(c=>({key:c.key,size:c.size,type:c.type,created:c.created}));e(a)}})}async clear(){if(!this.db)throw new Error("Store not initialized");return new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();i.onerror=()=>{t(new Error(`Failed to clear blobs: ${i.error}`))},i.onsuccess=()=>{e()}})}async getTotalSize(){return(await this.list()).reduce((t,r)=>t+r.size,0)}async getCount(){return(await this.list()).length}}class IndexedDBDatabase{constructor(){this.db=null,this.dbName="glyphos-database",this.version=1}async initialize(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${r.error}`))},r.onsuccess=()=>{this.db=r.result,e()},r.onupgradeneeded=s=>{}})}async createTable(e,t){if(!this.db)throw new Error("Database not initialized");if(!this.db.objectStoreNames.contains(e))return new Promise((r,s)=>{const i=this.db.transaction([],"versionchange"),a=i.objectStore(e)||this.db.createObjectStore(e,{keyPath:"id",autoIncrement:!0});if(t.indexes)for(const c of t.indexes){const l=c.columns.join("_"),p=c.unique||!1;a.createIndex(l,c.columns,{unique:p})}i.oncomplete=()=>r(),i.onerror=()=>s(new Error(`Failed to create table ${e}: ${i.error}`))})}async insert(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((r,s)=>{const a=this.db.transaction([e],"readwrite").objectStore(e);let c=0;const l=t.length;if(l===0){r();return}for(const p of t){const m=a.add(p);m.onsuccess=()=>{c++,c===l&&r()},m.onerror=()=>{s(new Error(`Failed to insert record: ${m.error}`))}}})}async query(e,t){if(!this.db)throw new Error("Database not initialized");return new Promise((r,s)=>{const c=this.db.transaction([e],"readonly").objectStore(e).getAll();c.onerror=()=>{s(new Error(`Failed to query table ${e}: ${c.error}`))},c.onsuccess=()=>{let l=c.result;t.where&&(l=this.applyWhereClause(l,t.where)),t.orderBy&&(l=this.applyOrderBy(l,t.orderBy)),t.offset&&(l=l.slice(t.offset)),t.limit&&(l=l.slice(0,t.limit)),r(l)}})}async update(e,t,r){if(!this.db)throw new Error("Database not initialized");const s=await this.query(e,t);return s.length===0?0:new Promise((i,a)=>{const l=this.db.transaction([e],"readwrite").objectStore(e);let p=0;const m=s.length;for(const h of s){const f={...h,...r},y=l.put(f);y.onsuccess=()=>{p++,p===m&&i(m)},y.onerror=()=>{a(new Error(`Failed to update record: ${y.error}`))}}})}async delete(e,t){if(!this.db)throw new Error("Database not initialized");const r=await this.query(e,t);return r.length===0?0:new Promise((s,i)=>{const c=this.db.transaction([e],"readwrite").objectStore(e);let l=0;const p=r.length;for(const m of r){const h=c.delete(m.id);h.onsuccess=()=>{l++,l===p&&s(p)},h.onerror=()=>{i(new Error(`Failed to delete record: ${h.error}`))}}})}async count(e,t){if(!this.db)throw new Error("Database not initialized");return t?(await this.query(e,t)).length:new Promise((s,i)=>{const l=this.db.transaction([e],"readonly").objectStore(e).count();l.onerror=()=>{i(new Error(`Failed to count table ${e}: ${l.error}`))},l.onsuccess=()=>{s(l.result)}})}async clear(e){if(!this.db)throw new Error("Database not initialized");return new Promise((t,r)=>{const a=this.db.transaction([e],"readwrite").objectStore(e).clear();a.onerror=()=>{r(new Error(`Failed to clear table ${e}: ${a.error}`))},a.onsuccess=()=>{t()}})}applyWhereClause(e,t){return e.filter(r=>this.evaluateWhereClause(r,t))}evaluateWhereClause(e,t){if("field"in t){const r=e[t.field];switch(t.op){case"=":return r===t.value;case"!=":return r!==t.value;case">":return r>t.value;case">=":return r>=t.value;case"<":return r<t.value;case"<=":return r<=t.value;case"in":return Array.isArray(t.value)&&t.value.includes(r);case"contains":return typeof r=="string"&&r.includes(t.value);default:return!1}}else{if("and"in t)return t.and.every(r=>this.evaluateWhereClause(e,r));if("or"in t)return t.or.some(r=>this.evaluateWhereClause(e,r))}return!1}applyOrderBy(e,t){return e.sort((r,s)=>{for(const i of t){const a=r[i.field],c=s[i.field];let l=0;if(a<c?l=-1:a>c&&(l=1),l!==0)return i.direction==="desc"?-l:l}return 0})}}class KernelStorageManager{constructor(){this.initialized=!1,this.initPromise=null,this.quotaCache=null,this.quotaCacheTime=0,this.QUOTA_CACHE_TTL=5e3,this.kv=new IndexedDBKVStore,this.fs=new OPFSFileSystem,this.blob=new IndexedDBBlobStore,this.db=new IndexedDBDatabase}async initialize(){if(!this.initialized)return this.initPromise?this.initPromise:(this.initPromise=this._doInitialize(),this.initPromise)}async _doInitialize(){var e,t,r,s,i,a,c,l;console.log("Initializing storage manager...");try{const p=[(t=(e=this.kv).initialize)==null?void 0:t.call(e),(s=(r=this.fs).initialize)==null?void 0:s.call(r),(a=(i=this.blob).initialize)==null?void 0:a.call(i),(l=(c=this.db).initialize)==null?void 0:l.call(c)].filter(Boolean),m=new Promise((h,f)=>{setTimeout(()=>f(new Error("Storage initialization timeout")),1e4)});await Promise.race([Promise.all(p),m]),this.initialized=!0,console.log("Storage manager initialized successfully")}catch(p){throw console.error("Storage initialization failed:",p),this.initPromise=null,new Error(`Storage initialization failed: ${p instanceof Error?p.message:"Unknown error"}`)}}async quota(){var t;if(!this.initialized)throw new Error("Storage manager not initialized");const e=Date.now();if(this.quotaCache&&e-this.quotaCacheTime<this.QUOTA_CACHE_TTL)return this.quotaCache;try{const r=await((t=navigator.storage)==null?void 0:t.estimate());if(!r)throw new Error("Storage quota not available");return this.quotaCache={used:r.usage||0,available:(r.quota||0)-(r.usage||0),total:r.quota||0},this.quotaCacheTime=e,this.quotaCache}catch(r){return console.error("Failed to get storage quota:",r),{used:0,available:0,total:0}}}isInitialized(){return this.initialized}async clearAll(){var e,t,r,s,i,a;if(!this.initialized)throw new Error("Storage manager not initialized");try{await Promise.all([this.kv.clear(),(t=(e=this.fs).clear)==null?void 0:t.call(e),(s=(r=this.blob).clear)==null?void 0:s.call(r),(a=(i=this.db).clear)==null?void 0:a.call(i)].filter(Boolean)),this.quotaCache=null,this.quotaCacheTime=0,console.log("Storage cleared successfully")}catch(c){throw console.error("Failed to clear storage:",c),new Error(`Storage clear failed: ${c instanceof Error?c.message:"Unknown error"}`)}}async exportData(){if(!this.initialized)throw new Error("Storage manager not initialized");try{const[e,t,r,s]=await Promise.all([this.exportKVData(),this.exportFSData(),this.exportBlobData(),this.exportDBData()]);return{kv:e,fs:t,blob:r,db:s}}catch(e){throw console.error("Failed to export storage data:",e),new Error(`Storage export failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async importData(e){if(!this.initialized)throw new Error("Storage manager not initialized");try{const t=[];e.kv&&t.push(this.importKVData(e.kv)),e.fs&&t.push(this.importFSData(e.fs)),e.blob&&t.push(this.importBlobData(e.blob)),e.db&&t.push(this.importDBData(e.db)),await Promise.all(t),console.log("Storage data imported successfully")}catch(t){throw console.error("Failed to import storage data:",t),new Error(`Storage import failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async exportKVData(){const e={},t=await this.kv.keys();for(const r of t)e[r]=await this.kv.get(r);return e}async exportFSData(){return{}}async exportBlobData(){return{}}async exportDBData(){return{}}async importKVData(e){for(const[t,r]of Object.entries(e))await this.kv.set(t,r)}async importFSData(e){}async importBlobData(e){}async importDBData(e){}}class SandboxRuntime{constructor(e,t,r,s){this.instances=new Map,this._processManager=e,console.log("Process Manager initialized:",!!this._processManager),this.capabilityManager=t,this.ipcRouter=r,this.eventBus=s,window.addEventListener("message",this.handleIframeMessage.bind(this))}async createInstance(e){const t=this.generateInstanceId(),r=this.createIframe(e),s={id:t,manifest:e.manifest,iframe:r,pid:e.pid,windowId:e.windowId,state:"loading",lastActivity:Date.now(),resources:{memory:0,cpu:0,storage:0},messageHandlers:new Map,cleanup:()=>this.cleanupInstance(t)};return this.instances.set(t,s),await this.loadApp(s,e),this.setupIPCBridge(s),await this.injectOSAPIs(s,e),s.state="ready",this.eventBus.emit("sandbox:instance-created",{instanceId:t,manifest:e.manifest,pid:e.pid}),s}createIframe(e){var s,i,a,c,l,p;const t=document.createElement("iframe");t.src=e.manifest.entry.html,t.style.border="none",t.style.width="100%",t.style.height="100%",t.style.display="block";const r=["allow-scripts","allow-same-origin","allow-forms","allow-popups","allow-modals","allow-downloads","allow-top-navigation-by-user-activation"];return(i=(s=e.manifest.capabilities)==null?void 0:s.media)!=null&&i.camera&&r.push("allow-camera"),(c=(a=e.manifest.capabilities)==null?void 0:a.media)!=null&&c.microphone&&r.push("allow-microphone"),(p=(l=e.manifest.capabilities)==null?void 0:l.media)!=null&&p.screen&&r.push("allow-screen-capture"),t.setAttribute("sandbox",r.join(" ")),t.setAttribute("csp",e.csp),t.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),t.setAttribute("loading","eager"),t}async loadApp(e,t){return new Promise((r,s)=>{const i=setTimeout(()=>{s(new Error("App load timeout"))},3e4),a=()=>{clearTimeout(i),e.iframe.removeEventListener("load",a),e.iframe.removeEventListener("error",c),r()},c=l=>{clearTimeout(i),e.iframe.removeEventListener("load",a),e.iframe.removeEventListener("error",c),s(new Error(`App load error: ${l.message}`))};e.iframe.addEventListener("load",a),e.iframe.addEventListener("error",c),document.body.appendChild(e.iframe)})}setupIPCBridge(e){e.messageHandlers.set("ipc",t=>{this.handleIPCMessage(e,t)}),e.messageHandlers.set("capability-request",t=>{this.handleCapabilityRequest(e,t)}),e.messageHandlers.set("storage-request",t=>{this.handleStorageRequest(e,t)})}async injectOSAPIs(e,t){var i;const r={app:{id:e.manifest.id,version:e.manifest.version,name:e.manifest.manifest.name,description:e.manifest.manifest.description},storage:{kv:this.createStorageAPI(e,"kv"),fs:this.createStorageAPI(e,"fs"),blob:this.createStorageAPI(e,"blob"),db:this.createStorageAPI(e,"db"),quota:()=>this.getStorageQuota(e.manifest)},ipc:{call:(a,c,...l)=>this.callAppMethod(e,a,c,l),expose:(a,c)=>this.exposeMethod(e,a,c),broadcast:(a,c)=>this.broadcastMessage(e,a,c),subscribe:(a,c)=>this.subscribeToChannel(e,a,c)},capabilities:{request:a=>this.requestCapability(e,a),has:a=>this.hasCapability(e,a)},window:{id:e.windowId,focus:()=>this.focusWindow(e),minimize:()=>this.minimizeWindow(e),maximize:()=>this.maximizeWindow(e),close:()=>this.closeWindow(e)},events:{on:(a,c)=>this.addEventListener(e,a,c),off:(a,c)=>this.removeEventListener(e,a,c),emit:(a,c)=>this.emitEvent(e,a,c)}},s=`
      (function() {
        // Make OS APIs available globally
        window.OS = ${JSON.stringify(r)};
        
        // Set app ID for IPC
        window.__GLYPH_APP_ID__ = '${e.manifest.id}';
        
        // Emit ready event
        window.dispatchEvent(new CustomEvent('glyphos:ready'));
      })();
    `;try{const a=e.iframe.contentDocument||((i=e.iframe.contentWindow)==null?void 0:i.document);if(a){const c=a.createElement("script");c.textContent=s,a.head.appendChild(c)}}catch(a){console.error("Failed to inject OS APIs:",a)}}handleIframeMessage(e){const{data:t,source:r}=e,s=Array.from(this.instances.values()).find(a=>a.iframe.contentWindow===r);if(!s)return;s.lastActivity=Date.now();const i=s.messageHandlers.get(t.type);if(i)try{i(t)}catch(a){console.error("Error handling iframe message:",a),this.sendErrorToIframe(s,t.id,a)}}handleIPCMessage(e,t){console.log("IPC message:",t)}handleCapabilityRequest(e,t){const{capability:r,callback:s}=t;console.log("Capability request:",r,s),this.capabilityManager.has(e.manifest.id,r)?this.sendToIframe(e,{type:"capability-response",id:t.id,granted:!0}):this.requestUserPermission(e,r,a=>{a&&this.capabilityManager.request(e.manifest.id,r),this.sendToIframe(e,{type:"capability-response",id:t.id,granted:a})})}handleStorageRequest(e,t){const{operation:r,data:s}=t;console.log("Storage request:",r,s);const i=this.getStorageQuota(e.manifest);if(e.resources.storage>=i){this.sendToIframe(e,{type:"storage-response",id:t.id,error:"Storage quota exceeded"});return}this.sendToIframe(e,{type:"storage-response",id:t.id,data:"Storage operation completed"})}createStorageAPI(e,t){return{get:r=>this.storageRequest(e,"get",{type:t,key:r}),set:(r,s)=>this.storageRequest(e,"set",{type:t,key:r,value:s}),delete:r=>this.storageRequest(e,"delete",{type:t,key:r}),list:r=>this.storageRequest(e,"list",{type:t,prefix:r})}}async storageRequest(e,t,r){return new Promise((s,i)=>{const a=this.generateRequestId(),c=l=>{l.id===a&&(e.messageHandlers.delete(`storage-${a}`),l.error?i(new Error(l.error)):s(l.data))};e.messageHandlers.set(`storage-${a}`,c),this.sendToIframe(e,{type:"storage-request",id:a,operation:t,data:r})})}async callAppMethod(e,t,r,s){return this.ipcRouter.call(t,r,s)}exposeMethod(e,t,r){console.log("Exposing method:",t,r)}broadcastMessage(e,t,r){this.ipcRouter.broadcast(t,r)}subscribeToChannel(e,t,r){return this.ipcRouter.subscribe(t,r),()=>this.ipcRouter.unsubscribe(t,r)}requestCapability(e,t){return new Promise(r=>{this.requestUserPermission(e,t,r)})}hasCapability(e,t){return this.capabilityManager.has(e.manifest.id,t)}requestUserPermission(e,t,r){const s=document.createElement("div");s.className="permission-dialog",s.innerHTML=`
      <div class="permission-content">
        <h3>Permission Request</h3>
        <p>App "${e.manifest.manifest.name}" wants to access:</p>
        <p><strong>${t}</strong></p>
        <div class="permission-buttons">
          <button class="permission-deny">Deny</button>
          <button class="permission-allow">Allow</button>
        </div>
      </div>
    `,s.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    `;const i=s.querySelector(".permission-content");i.style.cssText=`
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;const a=s.querySelector(".permission-deny"),c=s.querySelector(".permission-allow");a.onclick=()=>{document.body.removeChild(s),r(!1)},c.onclick=()=>{document.body.removeChild(s),r(!0)},document.body.appendChild(s)}focusWindow(e){this.eventBus.emit("window:focus",{windowId:e.windowId})}minimizeWindow(e){this.eventBus.emit("window:minimize",{windowId:e.windowId})}maximizeWindow(e){this.eventBus.emit("window:maximize",{windowId:e.windowId})}closeWindow(e){this.eventBus.emit("window:close",{windowId:e.windowId})}addEventListener(e,t,r){this.eventBus.on(`${e.manifest.id}:${t}`,r)}removeEventListener(e,t,r){this.eventBus.off(`${e.manifest.id}:${t}`,r)}emitEvent(e,t,r){this.eventBus.emit(`${e.manifest.id}:${t}`,r)}sendToIframe(e,t){e.iframe.contentWindow&&e.iframe.contentWindow.postMessage(t,"*")}sendErrorToIframe(e,t,r){this.sendToIframe(e,{type:"error",id:t,error:r.message||"Unknown error"})}getStorageQuota(e){var a,c;const t=(c=(a=e.capabilities)==null?void 0:a.storage)==null?void 0:c.quota;if(!t)return 100*1024*1024;const r=t.match(/^(\d+)(KB|MB|GB)$/);if(!r)return 100*1024*1024;const s=parseInt(r[1]);switch(r[2]){case"KB":return s*1024;case"MB":return s*1024*1024;case"GB":return s*1024*1024*1024;default:return 100*1024*1024}}cleanupInstance(e){const t=this.instances.get(e);t&&(t.iframe.parentNode&&t.iframe.parentNode.removeChild(t.iframe),t.messageHandlers.clear(),this.instances.delete(e),this.eventBus.emit("sandbox:instance-cleaned",{instanceId:e}))}getInstance(e){return this.instances.get(e)}getAllInstances(){return Array.from(this.instances.values())}terminateInstance(e){const t=this.instances.get(e);t&&(t.state="terminated",t.cleanup())}suspendInstance(e){const t=this.instances.get(e);t&&(t.state="suspended")}resumeInstance(e){const t=this.instances.get(e);t&&(t.state="running")}generateInstanceId(){return`instance-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateRequestId(){return`req-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}const GAM_VALIDATION_RULES={required:["id","version","manifest","manifest.name","manifest.description","manifest.categories","manifest.icons","author","author.name","author.pubkey","author.registry","entry","entry.html","entry.integrity","signature"],patterns:{id:/^[a-z][a-z0-9-]*(\.[a-z][a-z0-9-]*)+$/,version:/^\d+\.\d+\.\d+(-[a-z0-9.]+)?(\+[a-z0-9.]+)?$/,themeColor:/^#[0-9a-fA-F]{6}$/,pubkey:/^[A-Za-z0-9+/]{43}=$/,integrity:/^sha(256|384|512)-[A-Za-z0-9+/]+=*$/,email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/},lengths:{"manifest.name":{min:1,max:50},"manifest.shortName":{max:12},"manifest.description":{min:10,max:160},"manifest.longDescription":{max:5e3},"author.name":{min:1,max:100}},arrays:{"manifest.categories":{min:1,max:5},"manifest.icons":{min:1},"manifest.tags":{max:20}},enums:{"manifest.display":["standalone","fullscreen","minimal-ui"],"manifest.orientation":["any","portrait","landscape"],"manifest.dir":["ltr","rtl"],"collaboration.crdt":["yjs","automerge","none"],"capabilities.clipboard":["read","write","readwrite"],"signature.algorithm":["ed25519"]},custom:{signatureKeyMatch:n=>n.signature.publicKey===n.author.pubkey,validSemver:n=>{try{return!0}catch{return!1}},secureUrls:n=>{var t,r,s,i;return[n.entry.html,n.author.registry,...((r=(t=n.capabilities)==null?void 0:t.network)==null?void 0:r.fetch)||[],...((i=(s=n.capabilities)==null?void 0:s.network)==null?void 0:i.websocket)||[]].every(a=>a.startsWith("https://")||a.startsWith("http://localhost")||a.startsWith("ipfs://"))},validQuota:n=>n?/^\d+(KB|MB|GB)$/.test(n):!0}};class GAMValidator{static validate(e){const t=[],r=[];for(const s of GAM_VALIDATION_RULES.required)this.getNestedValue(e,s)||t.push({field:s,code:"REQUIRED_FIELD_MISSING",message:`Required field '${s}' is missing`});for(const[s,i]of Object.entries(GAM_VALIDATION_RULES.patterns)){const a=this.getNestedValue(e,s);a&&!i.test(a)&&t.push({field:s,code:"PATTERN_MISMATCH",message:`Field '${s}' does not match required pattern`})}for(const[s,i]of Object.entries(GAM_VALIDATION_RULES.lengths)){const a=this.getNestedValue(e,s);a&&("min"in i&&i.min&&a.length<i.min&&t.push({field:s,code:"TOO_SHORT",message:`Field '${s}' is too short (min: ${i.min})`}),"max"in i&&i.max&&a.length>i.max&&t.push({field:s,code:"TOO_LONG",message:`Field '${s}' is too long (max: ${i.max})`}))}for(const[s,i]of Object.entries(GAM_VALIDATION_RULES.arrays)){const a=this.getNestedValue(e,s);Array.isArray(a)&&("min"in i&&i.min&&a.length<i.min&&t.push({field:s,code:"TOO_FEW_ITEMS",message:`Field '${s}' has too few items (min: ${i.min})`}),"max"in i&&i.max&&a.length>i.max&&t.push({field:s,code:"TOO_MANY_ITEMS",message:`Field '${s}' has too many items (max: ${i.max})`}))}for(const[s,i]of Object.entries(GAM_VALIDATION_RULES.enums)){const a=this.getNestedValue(e,s);a&&!i.includes(a)&&t.push({field:s,code:"INVALID_ENUM",message:`Field '${s}' has invalid value. Allowed: ${i.join(", ")}`})}return e.signature&&e.author&&(GAM_VALIDATION_RULES.custom.signatureKeyMatch(e)||t.push({field:"signature.publicKey",code:"SIGNATURE_KEY_MISMATCH",message:"Signature public key does not match author public key"})),GAM_VALIDATION_RULES.custom.secureUrls(e)||r.push({field:"urls",code:"INSECURE_URL",message:"Some URLs are not HTTPS (security risk)"}),{valid:t.length===0,errors:t,warnings:r}}static getNestedValue(e,t){return t.split(".").reduce((r,s)=>r==null?void 0:r[s],e)}}class AppLoader{constructor(e,t,r,s,i,a={}){this.installations=new Map,this.sandboxRuntime=e,this.processManager=t,this.capabilityManager=r,this._ipcRouter=s,console.log("IPC Router initialized:",!!this._ipcRouter),this.eventBus=i,this.config={verifySignatures:!0,checkTrust:!0,autoUpdate:!1,...a},this.loadInstallations()}async installApp(e){let t;typeof e=="string"?t=await this.loadManifestFromUrl(e):t=e;const r=GAMValidator.validate(t);if(!r.valid)throw new Error(`Invalid manifest: ${r.errors.map(a=>a.message).join(", ")}`);const s=this.installations.get(t.id);if(s&&s.status==="installed")throw new Error(`App ${t.id} is already installed`);const i={id:t.id,installedAt:Date.now(),manifest:t,source:typeof e=="string"?{url:e}:{local:!0},status:"installing",files:{manifest:"",entry:"",assets:[]},verified:!1};this.installations.set(t.id,i);try{return this.config.verifySignatures&&(await this.verifySignature(t),i.verified=!0),this.config.checkTrust&&(i.trustScore=await this.checkTrustScore(t)),await this.downloadAppFiles(i),await this.installAppFiles(i),await this.registerCapabilities(i),i.status="installed",await this.saveInstallation(i),this.eventBus.emit("app:installed",{appId:t.id,manifest:t,installation:i}),i}catch(a){throw i.status="failed",i.error=a.message,await this.saveInstallation(i),a}}async loadManifestFromUrl(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch manifest: ${t.statusText}`);return await t.json()}catch(t){throw new Error(`Failed to load manifest from ${e}: ${t}`)}}async verifySignature(e){if(!e.signature)throw new Error("App signature is missing");if(!e.signature.signature)throw new Error("App signature is invalid");console.log("Signature verification passed (mock)")}async checkTrustScore(e){return .8}async downloadAppFiles(e){const{manifest:t}=e,r=await fetch(t.entry.html);if(!r.ok)throw new Error(`Failed to download entry file: ${r.statusText}`);const s=await r.text();e.files.entry=s;const i=[];for(const a of t.manifest.icons)try{const c=await fetch(a.src);if(c.ok){const l=await c.text();i.push(l)}}catch{console.warn(`Failed to download icon: ${a.src}`)}if(t.manifest.screenshots)for(const a of t.manifest.screenshots)try{const c=await fetch(a.src);if(c.ok){const l=await c.text();i.push(l)}}catch{console.warn(`Failed to download screenshot: ${a.src}`)}e.files.assets=i}async installAppFiles(e){console.log(`Installing app files for ${e.id}`)}async registerCapabilities(e){const{manifest:t}=e;t.capabilities&&(t.capabilities.storage&&await this.capabilityManager.request(t.id,{type:"storage",scope:"app"}),t.capabilities.network&&await this.capabilityManager.request(t.id,{type:"network",origin:{pattern:"*"}}),t.capabilities.media&&(t.capabilities.media.camera&&await this.capabilityManager.request(t.id,{type:"media",device:"camera"}),t.capabilities.media.microphone&&await this.capabilityManager.request(t.id,{type:"media",device:"microphone"}),t.capabilities.media.screen&&await this.capabilityManager.request(t.id,{type:"media",device:"screen"})),t.capabilities.ipc&&await this.capabilityManager.request(t.id,{type:"ipc",target:"*"}))}async loadApp(e,t){const r=this.installations.get(e);if(!r)throw new Error(`App ${e} is not installed`);if(r.status!=="installed")throw new Error(`App ${e} is not ready to load`);const s=await this.processManager.spawn(r.manifest),i={manifest:r.manifest,pid:s.pid,windowId:t,permissions:this.getAppPermissions(r.manifest),csp:this.generateCSP(r.manifest),storageQuota:this.getStorageQuota(r.manifest)},a=await this.sandboxRuntime.createInstance(i);this.eventBus.emit("app:loaded",{appId:e,windowId:t,instanceId:a.id,manifest:r.manifest})}async uninstallApp(e){const t=this.installations.get(e);if(!t)throw new Error(`App ${e} is not installed`);const r=this.sandboxRuntime.getAllInstances();for(const s of r)s.manifest.id===e&&this.sandboxRuntime.terminateInstance(s.id);console.log("Removing capabilities for app:",e),await this.removeAppFiles(t),this.installations.delete(e),await this.saveInstallations(),this.eventBus.emit("app:uninstalled",{appId:e})}async updateApp(e,t){const r=this.installations.get(e);if(!r)throw new Error(`App ${e} is not installed`);r.status="updating";try{let s=t;if(!s)if(r.source.url)s=await this.loadManifestFromUrl(r.source.url);else throw new Error("No update source available");if(s.version===r.manifest.version){r.status="installed";return}const i=await this.installApp(s);this.installations.set(e,i),await this.saveInstallations(),this.eventBus.emit("app:updated",{appId:e,oldVersion:r.manifest.version,newVersion:s.version})}catch(s){throw r.status="installed",s}}getAppPermissions(e){var r,s,i,a,c,l,p;const t=[];return(r=e.capabilities)!=null&&r.storage&&t.push("storage"),(s=e.capabilities)!=null&&s.network&&t.push("network"),(i=e.capabilities)!=null&&i.media&&t.push("media"),(a=e.capabilities)!=null&&a.ipc&&t.push("ipc"),(c=e.capabilities)!=null&&c.notifications&&t.push("notifications"),(l=e.capabilities)!=null&&l.clipboard&&t.push("clipboard"),(p=e.capabilities)!=null&&p.geolocation&&t.push("geolocation"),t}generateCSP(e){var r,s,i,a,c,l,p,m,h,f;const t=[];if(t.push("default-src 'self'"),t.push("script-src 'self' 'unsafe-inline'"),t.push("style-src 'self' 'unsafe-inline'"),t.push("img-src 'self' data: blob:"),t.push("font-src 'self' data:"),t.push("connect-src 'self'"),(s=(r=e.capabilities)==null?void 0:r.network)!=null&&s.fetch){const y=e.capabilities.network.fetch;t.push(`connect-src 'self' ${y.join(" ")}`)}if((a=(i=e.capabilities)==null?void 0:i.network)!=null&&a.websocket){const y=e.capabilities.network.websocket;t.push(`connect-src 'self' ${y.join(" ")}`)}return(l=(c=e.capabilities)==null?void 0:c.media)!=null&&l.camera&&t.push("camera 'self'"),(m=(p=e.capabilities)==null?void 0:p.media)!=null&&m.microphone&&t.push("microphone 'self'"),(f=(h=e.capabilities)==null?void 0:h.media)!=null&&f.screen&&t.push("display-capture 'self'"),t.join("; ")}getStorageQuota(e){var a,c;const t=(c=(a=e.capabilities)==null?void 0:a.storage)==null?void 0:c.quota;if(!t)return 100*1024*1024;const r=t.match(/^(\d+)(KB|MB|GB)$/);if(!r)return 100*1024*1024;const s=parseInt(r[1]);switch(r[2]){case"KB":return s*1024;case"MB":return s*1024*1024;case"GB":return s*1024*1024*1024;default:return 100*1024*1024}}async removeAppFiles(e){console.log(`Removing app files for ${e.id}`)}async loadInstallations(){try{console.log("Loading existing installations...")}catch(e){console.error("Failed to load installations:",e)}}async saveInstallation(e){try{console.log(`Saving installation for ${e.id}`)}catch(t){console.error("Failed to save installation:",t)}}async saveInstallations(){try{console.log("Saving all installations...")}catch(e){console.error("Failed to save installations:",e)}}getInstalledApp(e){return this.installations.get(e)}getAllInstalledApps(){return Array.from(this.installations.values())}isAppInstalled(e){const t=this.installations.get(e);return(t==null?void 0:t.status)==="installed"}getAppStatus(e){const t=this.installations.get(e);return t==null?void 0:t.status}}class RuntimeManager{constructor(e,t,r,s){this.sandboxRuntime=new SandboxRuntime(e,t,r,s),this.appLoader=new AppLoader(this.sandboxRuntime,e,t,r,s)}getSandboxRuntime(){return this.sandboxRuntime}getAppLoader(){return this.appLoader}async installApp(e){return this.appLoader.installApp(e)}async loadApp(e,t){return this.appLoader.loadApp(e,t)}async uninstallApp(e){return this.appLoader.uninstallApp(e)}getInstalledApps(){return this.appLoader.getAllInstalledApps()}isAppInstalled(e){return this.appLoader.isAppInstalled(e)}}class BSPLayout{constructor(e){this.root={bounds:e}}insert(e,t){return this.insertIntoNode(this.root,e,t),this.computeLayout(this.root)}insertIntoNode(e,t,r){if(!e.left&&!e.right){const s=r||this.chooseSplit(e.bounds),i=.5,{leftBounds:a,rightBounds:c}=this.splitBounds(e.bounds,s,i);e.window?e.left={bounds:a,window:e.window}:e.left={bounds:a},e.right={bounds:c,window:t},e.split=s,e.ratio=i,delete e.window}else{const s=this.getSize(e.left),i=this.getSize(e.right);s<=i?this.insertIntoNode(e.left,t,r):this.insertIntoNode(e.right,t,r)}}chooseSplit(e){return e.width>e.height?"vertical":"horizontal"}splitBounds(e,t,r){if(t==="vertical"){const s=e.x+e.width*r;return{leftBounds:{x:e.x,y:e.y,width:e.width*r,height:e.height},rightBounds:{x:s,y:e.y,width:e.width*(1-r),height:e.height}}}else{const s=e.y+e.height*r;return{leftBounds:{x:e.x,y:e.y,width:e.width,height:e.height*r},rightBounds:{x:e.x,y:s,width:e.width,height:e.height*(1-r)}}}}getSize(e){return e.window?1:this.getSize(e.left)+this.getSize(e.right)}computeLayout(e){const t=new Map,r=s=>{s.window?t.set(s.window,s.bounds):s.left&&s.right&&(r(s.left),r(s.right))};return r(e),t}remove(e){return this.removeFromNode(this.root,e),this.computeLayout(this.root)}removeFromNode(e,t){return e.window===t?(delete e.window,!0):e.left&&this.removeFromNode(e.left,t)?(e.right&&Object.assign(e,e.right),!0):e.right&&this.removeFromNode(e.right,t)?(e.left&&Object.assign(e,e.left),!0):!1}adjustRatio(e,t){e.ratio=Math.max(.2,Math.min(.8,t));const{leftBounds:r,rightBounds:s}=this.splitBounds(e.bounds,e.split,e.ratio);e.left&&(e.left.bounds=r),e.right&&(e.right.bounds=s),e.left&&this.updateBounds(e.left),e.right&&this.updateBounds(e.right)}updateBounds(e){if(e.split&&e.left&&e.right){const{leftBounds:t,rightBounds:r}=this.splitBounds(e.bounds,e.split,e.ratio||.5);e.left.bounds=t,e.right.bounds=r,this.updateBounds(e.left),this.updateBounds(e.right)}}}class GridLayout{computeGrid(e,t){const r=t.width/t.height;let s=1,i=e,a=1/0;for(let c=1;c<=e;c++){const l=Math.ceil(e/c),p=c/l,m=Math.abs(r-p);m<a&&(a=m,s=c,i=l)}return{cols:s,rows:i,cellWidth:t.width/s,cellHeight:t.height/i}}layout(e,t){const r=this.computeGrid(e.length,t),s=new Map;return e.forEach((i,a)=>{const c=Math.floor(a/r.cols),l=a%r.cols;s.set(i,{x:t.x+l*r.cellWidth,y:t.y+c*r.cellHeight,width:r.cellWidth,height:r.cellHeight})}),s}}class CascadeLayout{constructor(){this.offset=30}layout(e,t){const r=new Map,s=t.width*.6,i=t.height*.6;return e.forEach((a,c)=>{const l=t.x+c*this.offset%(t.width-s),p=t.y+c*this.offset%(t.height-i);r.set(a,{x:l,y:p,width:s,height:i})}),r}}class MasterStackLayout{constructor(){this.masterRatio=.6}layout(e,t){const r=new Map;if(e.length===0)return r;const s=e[0],i=e.slice(1);if(i.length===0)r.set(s,t);else{const a={x:t.x,y:t.y,width:t.width*this.masterRatio,height:t.height};r.set(s,a);const c={x:t.x+a.width,y:t.y,width:t.width*(1-this.masterRatio),height:t.height},l=c.height/i.length;i.forEach((p,m)=>{r.set(p,{x:c.x,y:c.y+m*l,width:c.width,height:l})})}return r}promoteToMaster(e,t){const r=e.indexOf(t);if(r===-1||r===0)return e;const s=[...e];return[s[0],s[r]]=[s[r],s[0]],s}}class AdaptiveLayout{layout(e,t){const r=e.length;return r===1?new Map([[e[0].id,t]]):r===2?this.splitTwo(e,t):r<=4?new GridLayout().layout(e.map(s=>s.id),t):r<=8?this.bspLayout(e,t):new GridLayout().layout(e.map(s=>s.id),t)}splitTwo(e,t){const r=new Map;return t.width>t.height?(r.set(e[0].id,{x:t.x,y:t.y,width:t.width/2,height:t.height}),r.set(e[1].id,{x:t.x+t.width/2,y:t.y,width:t.width/2,height:t.height})):(r.set(e[0].id,{x:t.x,y:t.y,width:t.width,height:t.height/2}),r.set(e[1].id,{x:t.x,y:t.y+t.height/2,width:t.width,height:t.height/2})),r}bspLayout(e,t){const r=new BSPLayout(t);for(const s of e)r.insert(s.id);return r.computeLayout(r.root)}}class WindowManager{constructor(){this.windows=new Map,this.activeWindow=null,this.screenBounds={x:0,y:0,width:1920,height:1080},this.layoutAlgorithm=new AdaptiveLayout}createWindow(e){const t=this.generateWindowId(),r={id:t,appId:e.appId||"system",title:e.title,url:e.url,bounds:{x:e.x??this.screenBounds.width/2-e.width/2,y:e.y??this.screenBounds.height/2-e.height/2,width:e.width,height:e.height},state:"normal",focused:!1,zIndex:this.windows.size+1};return this.windows.set(t,r),this.focusWindow(t),t}closeWindow(e){return this.windows.has(e)?(this.windows.delete(e),this.activeWindow===e&&(this.activeWindow=this.windows.size>0?Array.from(this.windows.keys())[0]:null),!0):!1}focusWindow(e){return this.windows.has(e)?(this.activeWindow=e,!0):!1}minimizeWindow(e){const t=this.windows.get(e);return t?(t.state="minimized",!0):!1}maximizeWindow(e){const t=this.windows.get(e);return t?(t.state==="maximized"?t.state="normal":(t.state="maximized",t.bounds={...this.screenBounds}),!0):!1}resizeWindow(e,t){const r=this.windows.get(e);return!r||r.state==="maximized"?!1:(r.bounds=t,!0)}moveWindow(e,t,r){const s=this.windows.get(e);return!s||s.state==="maximized"?!1:(s.bounds.x=t,s.bounds.y=r,!0)}applyTilingLayout(e){const t=Array.from(this.windows.values()).filter(s=>s.state!=="minimized");if(t.length===0)return;let r;switch(e){case"bsp":const s=new BSPLayout(this.screenBounds);for(const l of t)s.insert(l.id);r=s.computeLayout(s.root);break;case"grid":r=new GridLayout().layout(t.map(l=>l.id),this.screenBounds);break;case"cascade":r=new CascadeLayout().layout(t.map(l=>l.id),this.screenBounds);break;case"master-stack":r=new MasterStackLayout().layout(t.map(l=>l.id),this.screenBounds);break;case"adaptive":default:r=this.layoutAlgorithm.layout(t,this.screenBounds);break}for(const[s,i]of r){const a=this.windows.get(s);a&&(a.bounds=i,a.state="normal")}}getWindows(){return Array.from(this.windows.values())}getActiveWindow(){return this.activeWindow&&this.windows.get(this.activeWindow)||null}getWindow(e){return this.windows.get(e)||null}setScreenBounds(e){this.screenBounds=e}generateWindowId(){return`window-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}}class FuzzyMatcher{match(e,t){e=e.toLowerCase(),t=t.toLowerCase();const r=[];let s=0,i=0,a=0;for(let l=0;l<t.length&&!(s>=e.length);l++)if(t[l]===e[s]){r.push(l),i+=1;const p=1-l/t.length;i+=p*.5,r.length>1&&r[r.length-1]===r[r.length-2]+1?a+=.3:a=0,i+=a,(l===0||t[l-1]===" "||t[l-1]==="-")&&(i+=.8);const m=e[s],h=t[l];m===h&&(i+=.1),s++}if(s<e.length)return{score:0,matches:[]};const c=i/t.length;return{score:Math.min(c,1),matches:r}}}class MultiFieldSearch{constructor(){this.weights={name:3,description:1.5,tags:2,categories:1,author:.5}}search(e,t){const r=new FuzzyMatcher,s={},i=r.match(e,t.manifest.name);s.name=i.score;const a=r.match(e,t.manifest.description);if(s.description=a.score,t.manifest.tags){const f=t.manifest.tags.map(y=>r.match(e,y).score);s.tags=Math.max(...f,0)}const c=t.manifest.categories.map(f=>r.match(e,f).score);s.categories=Math.max(...c,0);const l=r.match(e,t.author.name);s.author=l.score;let p=0,m=0;for(const[f,y]of Object.entries(s)){const g=this.weights[f];p+=y*g,m+=g}const h=m>0?p/m:0;return{app:t,score:h,fieldScores:s}}}class PersonalizedRanking{constructor(e){this.userProfile=e}personalize(e){return e.map(t=>{let r=1;const s=this.userProfile.appUsage.get(t.app.id)||0;s>0&&(r*=1+Math.log10(s+1)*.3);const i=this.userProfile.lastUsed.get(t.app.id);if(i){const c=(Date.now()-i)/36e5;c<24?r*=1.5:c<168&&(r*=1.2)}for(const c of t.app.manifest.categories){const l=this.userProfile.categoryPreferences.get(c)||0;r*=1+l*.2}return(Date.now()-new Date(t.app.signature.timestamp).getTime())/(1e3*60*60*24)<30&&(r*=1.1),{...t,score:t.score*r}})}}class TFIDFSearch{constructor(){this.idf=new Map,this.totalDocs=0}buildIndex(e){this.totalDocs=e.length;const t=new Map;for(const r of e){const s=this.extractTerms(r),i=new Set(s);for(const a of i)t.set(a,(t.get(a)||0)+1)}for(const[r,s]of t)this.idf.set(r,Math.log(this.totalDocs/s))}score(e,t){const r=this.tokenize(e),s=this.extractTerms(t),i=new Map;for(const l of s)i.set(l,(i.get(l)||0)+1);const a=Math.max(...i.values(),1);for(const[l,p]of i)i.set(l,p/a);let c=0;for(const l of r){const p=i.get(l)||0,m=this.idf.get(l)||0;c+=p*m}return c}extractTerms(e){const t=[e.manifest.name,e.manifest.description,e.manifest.longDescription||"",...e.manifest.tags||[]].join(" ");return this.tokenize(t)}tokenize(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g,"").split(/\s+/).filter(t=>t.length>2)}}class SearchEngine{constructor(e){this.fuzzyMatcher=new FuzzyMatcher,this.multiField=new MultiFieldSearch,this.tfidf=new TFIDFSearch,this.personalizer=new PersonalizedRanking(e)}search(e,t,r){const s=t.map(c=>this.multiField.search(e,c)).filter(c=>c.score>.1);for(const c of s){const l=this.tfidf.score(e,c.app);c.score=c.score*.7+l*.3}for(const c of s){const l=this.getTrustScore(c.app);c.score*=1+l*.5}let a=this.personalizer.personalize(s);return r!=null&&r.categories&&(a=a.filter(c=>c.app.manifest.categories.some(l=>r.categories.includes(l)))),r!=null&&r.minTrust&&(a=a.filter(c=>this.getTrustScore(c.app)>=r.minTrust)),a.sort((c,l)=>l.score-c.score).slice(0,(r==null?void 0:r.limit)||50).map(c=>({app:c.app,score:c.score,trustScore:this.getTrustScore(c.app),highlights:this.getHighlights(e,c.app)}))}getTrustScore(e){return .8}getHighlights(e,t){const s=this.fuzzyMatcher.match(e,t.manifest.name);return{name:{text:t.manifest.name,matches:s.matches}}}}class CommandPalette{constructor(n={}){this.commands=new Map,this.isVisible=!1,this.currentQuery="",this.selectedIndex=0,this.results=[],this.searchEngine=new SearchEngine({appUsage:new Map,lastUsed:new Map,categoryPreferences:new Map})}registerCommand(n){this.commands.set(n.id,n)}unregisterCommand(n){return this.commands.delete(n)}show(){this.isVisible=!0,this.currentQuery="",this.selectedIndex=0,this.results=[],this.render()}hide(){this.isVisible=!1,this.render()}toggle(){this.isVisible?this.hide():this.show()}updateQuery(n){this.currentQuery=n,this.selectedIndex=0,this.search(),this.render()}selectPrevious(){this.results.length>0&&(this.selectedIndex=(this.selectedIndex-1+this.results.length)%this.results.length,this.render())}selectNext(){this.results.length>0&&(this.selectedIndex=(this.selectedIndex+1)%this.results.length,this.render())}executeSelected(){if(this.results.length===0||this.selectedIndex>=this.results.length)return!1;const n=this.results[this.selectedIndex].command;return this.executeCommand(n),this.hide(),!0}executeCommand(n){try{if(typeof n.handler=="function")n.handler();else if(n.action)switch(n.action.type){case"navigate":this.handleNavigateAction(n.action);break;case"execute":this.handleExecuteAction(n.action);break;case"toggle":this.handleToggleAction(n.action);break;default:console.warn("Unknown action type:",n.action.type)}}catch(e){console.error("Error executing command:",e)}}search(){if(!this.currentQuery.trim()){this.results=Array.from(this.commands.values()).map(e=>({command:e,score:1,highlights:{name:{text:e.name,matches:[]}}})).slice(0,10);return}const n=this.searchEngine.search(this.currentQuery,Array.from(this.commands.values()),{limit:10});this.results=n.map(e=>({command:e.app,score:e.score,highlights:e.highlights}))}render(){const n=document.getElementById("command-palette");if(!n)return;if(!this.isVisible){n.style.display="none";return}n.style.display="block";const e=`
      <div class="command-palette-overlay">
        <div class="command-palette-container">
          <div class="command-palette-input">
            <input 
              type="text" 
              placeholder="Type a command..." 
              value="${this.currentQuery}"
              autocomplete="off"
              spellcheck="false"
            />
          </div>
          <div class="command-palette-results">
            ${this.renderResults()}
          </div>
        </div>
      </div>
    `;n.innerHTML=e;const t=n.querySelector("input");t&&(t.focus(),t.addEventListener("input",r=>{this.updateQuery(r.target.value)}),t.addEventListener("keydown",r=>{this.handleKeyDown(r)}))}renderResults(){return this.results.length===0?'<div class="command-palette-empty">No commands found</div>':this.results.map((n,e)=>{var s;return`
        <div class="${`command-palette-item ${e===this.selectedIndex?"selected":""}`}" data-index="${e}">
          <div class="command-name">
            ${this.highlightText(n.command.name,n.highlights.name.matches)}
          </div>
          ${n.command.description?`
            <div class="command-description">
              ${this.highlightText(n.command.description,((s=n.highlights.description)==null?void 0:s.matches)||[])}
            </div>
          `:""}
          ${n.command.keyboardShortcut?`
            <div class="command-shortcut">
              ${this.formatKeyboardShortcut(n.command.keyboardShortcut)}
            </div>
          `:""}
        </div>
      `}).join("")}highlightText(n,e){if(e.length===0)return n;let t="",r=0;for(const s of e)t+=n.slice(r,s),t+=`<mark>${n[s]}</mark>`,r=s+1;return t+=n.slice(r),t}formatKeyboardShortcut(n){return n.split("+").map(e=>`<kbd>${e.trim()}</kbd>`).join("+")}handleKeyDown(n){switch(n.key){case"Escape":this.hide(),n.preventDefault();break;case"ArrowUp":this.selectPrevious(),n.preventDefault();break;case"ArrowDown":this.selectNext(),n.preventDefault();break;case"Enter":this.executeSelected()&&n.preventDefault();break;case"Tab":n.shiftKey?this.selectPrevious():this.selectNext(),n.preventDefault();break}}handleNavigateAction(n){n.url&&(window.location.href=n.url)}handleExecuteAction(action){if(action.function)try{eval(action.function)}catch(n){console.error("Error executing function:",n)}}handleToggleAction(n){if(n.target){const e=document.querySelector(n.target);e&&e.classList.toggle(n.class||"active")}}}class Dock{constructor(e={}){this.items=new Map,this.runningApps=new Set,this.pinnedApps=new Set,this.listeners=new Map,this.options={position:"bottom",size:"medium",showLabels:!0,showRunningIndicator:!0,...e},this.render()}addApp(e,t,r=!1){const s={id:e.id,manifest:e,icon:t,isRunning:!1,windowCount:0,isPinned:r};this.items.set(e.id,s),r&&this.pinnedApps.add(e.id),this.render()}removeApp(e){const t=this.items.delete(e);return this.pinnedApps.delete(e),this.runningApps.delete(e),t&&this.render(),t}togglePin(e){const t=this.items.get(e);return t?(t.isPinned=!t.isPinned,t.isPinned?this.pinnedApps.add(e):this.pinnedApps.delete(e),this.render(),t.isPinned):!1}setAppRunning(e,t=1){const r=this.items.get(e);r&&(r.isRunning=!0,r.windowCount=t,this.runningApps.add(e),this.render())}setAppStopped(e){const t=this.items.get(e);t&&(t.isRunning=!1,t.windowCount=0,this.runningApps.delete(e),this.render())}updateWindowCount(e,t){const r=this.items.get(e);r&&(r.windowCount=t,this.render())}launchApp(e){const t=this.items.get(e);t&&(this.emit("app-launch",{appId:e,manifest:t.manifest}),this.setAppRunning(e,1))}focusApp(e){this.emit("app-focus",{appId:e})}render(){const e=document.getElementById("dock");if(!e)return;const t=this.getSortedItems(),r=`
      <div class="dock-container ${this.options.position} ${this.options.size}">
        ${t.map(s=>this.renderItem(s)).join("")}
      </div>
    `;e.innerHTML=r,this.addEventListeners()}getSortedItems(){return Array.from(this.items.values()).sort((t,r)=>t.isPinned&&!r.isPinned?-1:!t.isPinned&&r.isPinned?1:t.isRunning&&!r.isRunning?-1:!t.isRunning&&r.isRunning?1:t.manifest.manifest.name.localeCompare(r.manifest.manifest.name))}renderItem(e){return`
      <div class="${["dock-item",e.isRunning?"running":"",e.isPinned?"pinned":"",e.windowCount>1?"multiple-windows":""].filter(Boolean).join(" ")}" data-app-id="${e.id}">
        <div class="dock-icon">
          <img src="${e.icon}" alt="${e.manifest.manifest.name}" />
          ${this.options.showRunningIndicator&&e.isRunning?`
            <div class="running-indicator"></div>
          `:""}
          ${e.windowCount>1?`
            <div class="window-count">${e.windowCount}</div>
          `:""}
        </div>
        ${this.options.showLabels?`
          <div class="dock-label">${e.manifest.manifest.name}</div>
        `:""}
        <div class="dock-tooltip">
          <div class="tooltip-title">${e.manifest.manifest.name}</div>
          <div class="tooltip-description">${e.manifest.manifest.description}</div>
          ${e.isRunning?`
            <div class="tooltip-status">Running (${e.windowCount} window${e.windowCount>1?"s":""})</div>
          `:""}
        </div>
      </div>
    `}addEventListeners(){const e=document.getElementById("dock");e&&(e.addEventListener("click",t=>{const r=t.target.closest(".dock-item");if(!r)return;const s=r.getAttribute("data-app-id");if(!s)return;const i=this.items.get(s);i&&(i.isRunning?this.focusApp(s):this.launchApp(s))}),e.addEventListener("contextmenu",t=>{const r=t.target.closest(".dock-item");if(!r)return;t.preventDefault();const s=r.getAttribute("data-app-id");s&&this.showContextMenu(t,s)}),e.addEventListener("mouseover",t=>{const r=t.target.closest(".dock-item");r&&r.classList.add("hover")}),e.addEventListener("mouseout",t=>{const r=t.target.closest(".dock-item");r&&r.classList.remove("hover")}))}showContextMenu(e,t){const r=this.items.get(t);if(!r)return;const s=document.createElement("div");s.className="dock-context-menu",s.style.left=`${e.clientX}px`,s.style.top=`${e.clientY}px`;const i=[{label:r.isRunning?"Focus":"Launch",action:()=>{r.isRunning?this.focusApp(t):this.launchApp(t)}},{label:r.isPinned?"Unpin":"Pin",action:()=>this.togglePin(t)},{label:"Remove from Dock",action:()=>this.removeApp(t)}];s.innerHTML=i.map(c=>`
      <div class="context-menu-item" data-action="${c.label}">
        ${c.label}
      </div>
    `).join(""),document.body.appendChild(s),s.addEventListener("click",c=>{const l=c.target.closest(".context-menu-item");if(!l)return;const p=l.getAttribute("data-action"),m=i.find(h=>h.label===p);m&&m.action(),document.body.removeChild(s)});const a=()=>{document.body.contains(s)&&document.body.removeChild(s),document.removeEventListener("click",a)};setTimeout(()=>{document.addEventListener("click",a)},0)}updateOptions(e){this.options={...this.options,...e},this.render()}getItems(){return Array.from(this.items.values())}getRunningApps(){return Array.from(this.runningApps)}getPinnedApps(){return Array.from(this.pinnedApps)}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}emit(e,t){const r=this.listeners.get(e)||[];for(const s of r)s(t)}}class TrustComputation{constructor(){this.damping=.85,this.iterations=20}computeTrustScores(e){var i;const t=new Map,r=new Map;for(const[a]of e.nodes)t.set(a,e.userTrusted.has(a)?1:0);for(let a=0;a<this.iterations;a++){for(const[c]of e.nodes){let l=0;const p=1-this.damping;e.userTrusted.has(c)&&(l+=p);const m=this.getIncomingEdges(e,c);for(const h of m){const f=t.get(h)||0,y=((i=e.edges.get(h))==null?void 0:i.size)||1;l+=this.damping*(f/y)}r.set(c,l)}t.clear();for(const[c,l]of r)t.set(c,l);r.clear()}const s=Math.max(...t.values());if(s>0)for(const[a,c]of t)t.set(a,c/s);return t}getIncomingEdges(e,t){const r=new Set;for(const[s,i]of e.edges)i.has(t)&&r.add(s);return r}}class ReputationComputation{computeReputation(e){const t=[],r=this.wilsonScore(e.installCount,e.appCount*100);t.push(r),e.avgAppRating>0&&t.push(e.avgAppRating/5);const s=Math.min(e.age/365,1);t.push(s*.5);const i=Math.min(e.updateFrequency/4,1);t.push(i);const a=Math.max(0,1-e.reportCount/10);return t.reduce((l,p)=>l+p,0)/t.length*a}wilsonScore(e,t){if(t===0)return 0;const r=1.96,s=e/t,i=s+r*r/(2*t)-r*Math.sqrt((s*(1-s)+r*r/(4*t))/t),a=1+r*r/t;return Math.max(0,i/a)}}class TrustScoreCalculator{constructor(){this.weights={direct:1,transitive:.6,reputation:.3}}computeFinalScore(e,t){const r=t.userTrusted.has(e)?1:0,a=new TrustComputation().computeTrustScores(t).get(e)||0,c=t.nodes.get(e),p=new ReputationComputation().computeReputation(c),m=this.computeHops(t,e),h=a*Math.pow(.8,m-1),f=this.weights.direct+this.weights.transitive+this.weights.reputation,y=(r*this.weights.direct+h*this.weights.transitive+p*this.weights.reputation)/f;return{direct:r,transitive:h,reputation:p,final:y,computedAt:Date.now(),hops:m}}computeHops(e,t){if(e.userTrusted.has(t))return 0;const r=[],s=new Set;for(const i of e.userTrusted)r.push([i,0]),s.add(i);for(;r.length>0;){const[i,a]=r.shift(),c=e.edges.get(i)||new Set;for(const l of c){if(l===t)return a+1;s.has(l)||(s.add(l),r.push([l,a+1]))}}return 1/0}}class TrustScoreCache{constructor(){this.cache=new Map,this.cacheTTL=1e3*60*60}get(e,t){const r=this.cache.get(e);if(r&&Date.now()-r.computedAt<this.cacheTTL)return r.score;const i=new TrustScoreCalculator().computeFinalScore(e,t);return this.cache.set(e,{score:i,computedAt:Date.now()}),i}invalidate(e){e?this.cache.delete(e):this.cache.clear()}}let kernel=null,storage=null,runtime=null,windowManager=null,commandPalette=null,dock=null,trustCache=null,searchEngine=null;async function initializeGlyphOS(){console.log(" Starting GlyphOS...");try{storage=new KernelStorageManager,await storage.initialize(),console.log(" Storage initialized"),kernel=await initializeKernel(),console.log(" Kernel initialized"),runtime=new RuntimeManager(kernel.processes,kernel.capabilities,kernel.ipc,kernel.events),console.log(" Runtime manager initialized"),windowManager=new WindowManager,commandPalette=new CommandPalette,dock=new Dock,commandPalette.registerCommand({id:"toggle-command-palette",name:"Toggle Command Palette",description:"Open or close the command palette",keyboardShortcut:"Cmd+K",handler:()=>commandPalette.toggle()}),commandPalette.registerCommand({id:"new-window",name:"New Window",description:"Create a new window",keyboardShortcut:"Cmd+N",handler:()=>{windowManager.createWindow({title:"New Window",width:800,height:600})}}),commandPalette.registerCommand({id:"tile-windows",name:"Tile Windows",description:"Arrange windows in a tiled layout",handler:()=>{windowManager.applyTilingLayout("adaptive")}}),dock.addApp({id:"text-editor",manifest:{name:"Text Editor",shortName:"Editor",description:"Simple text editor",longDescription:"A simple text editor for editing files",categories:["productivity"],tags:["editor","text"],icons:[],display:"standalone",orientation:"any",themeColor:"#007acc",backgroundColor:"#1a1a1a",lang:"en",dir:"ltr"},version:"1.0.0",author:{name:"GlyphOS Team",email:"team@glyphd.com",url:"https://glyphd.com",pubkey:"ed25519:abc123...",registry:"https://registry.glyphd.com"},entry:{html:"/apps/text-editor/index.html",integrity:"sha384-abc123..."},capabilities:{storage:{opfs:!0,indexeddb:!0,quota:"100MB"}},signature:{algorithm:"ed25519",publicKey:"ed25519:abc123...",signature:"abc123...",timestamp:new Date().toISOString()}},"/icons/text-editor.png",!0),dock.addApp({id:"file-manager",manifest:{name:"File Manager",shortName:"Files",description:"Browse and manage files",longDescription:"A file manager for browsing and managing files",categories:["tools"],tags:["files","browser"],icons:[],display:"standalone",orientation:"any",themeColor:"#28ca42",backgroundColor:"#1a1a1a",lang:"en",dir:"ltr"},version:"1.0.0",author:{name:"GlyphOS Team",email:"team@glyphd.com",url:"https://glyphd.com",pubkey:"ed25519:def456...",registry:"https://registry.glyphd.com"},entry:{html:"/apps/file-manager/index.html",integrity:"sha384-def456..."},capabilities:{storage:{opfs:!0,indexeddb:!0,quota:"500MB"}},signature:{algorithm:"ed25519",publicKey:"ed25519:def456...",signature:"def456...",timestamp:new Date().toISOString()}},"/icons/file-manager.png",!0),console.log(" Desktop environment initialized"),trustCache=new TrustScoreCache,searchEngine=new SearchEngine({appUsage:new Map,lastUsed:new Map,categoryPreferences:new Map}),console.log(" Algorithms initialized"),console.log(" GlyphOS ready!")}catch(n){throw console.error(" Failed to initialize GlyphOS:",n),n}}function getKernel(){if(!kernel)throw new Error("GlyphOS not initialized");return kernel}function getStorage(){if(!storage)throw new Error("Storage not initialized");return storage}function getRuntime(){if(!runtime)throw new Error("Runtime manager not initialized");return runtime}function getWindowManager(){if(!windowManager)throw new Error("Window manager not initialized");return windowManager}function getCommandPalette(){if(!commandPalette)throw new Error("Command palette not initialized");return commandPalette}function getDock(){if(!dock)throw new Error("Dock not initialized");return dock}function getTrustCache(){if(!trustCache)throw new Error("Trust cache not initialized");return trustCache}function getSearchEngine(){if(!searchEngine)throw new Error("Search engine not initialized");return searchEngine}function isInitialized(){return kernel!==null&&storage!==null&&windowManager!==null}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initializeGlyphOS):initializeGlyphOS();window.GlyphOS={getKernel,getStorage,getRuntime,getWindowManager,getCommandPalette,getDock,getTrustCache,getSearchEngine,isInitialized};window.addEventListener("load",()=>{setTimeout(()=>{document.getElementById("loading").style.display="none",document.getElementById("desktop").classList.add("loaded")},2e3)});function closeWindow(n){var e;try{console.log("Closing window:",n);const r=window.GlyphOS.getWindowManager().closeWindow(n);if(console.log("Close result:",r),r){const s=(e=document.querySelector(`[data-window-id="${n}"]`))==null?void 0:e.closest(".window");s&&s.remove(),renderWindows()}}catch(t){console.error("Error closing window:",t)}}function minimizeWindow(n){console.log("Minimizing window:",n),window.GlyphOS.getWindowManager().minimizeWindow(n),renderWindows()}function toggleMaximize(n){console.log("Maximizing window:",n),window.GlyphOS.getWindowManager().maximizeWindow(n),renderWindows()}function renderWindows(){const n=document.getElementById("windows-container"),e=window.GlyphOS.getWindowManager(),t=e.getWindows();console.log("Rendering windows:",t.length,"windows"),console.log("Window IDs:",t.map(r=>r.id)),n.innerHTML="",t.forEach(r=>{console.log("Rendering window:",r.id,r.title);const s=document.createElement("div");s.className=`window ${r.focused?"focused":""}`,s.id=r.id,s.style.left=`${r.bounds.x}px`,s.style.top=`${r.bounds.y}px`,s.style.width=`${r.bounds.width}px`,s.style.height=`${r.bounds.height}px`,s.style.zIndex=r.zIndex,s.innerHTML=`
          <div class="window-header" data-window-id="${r.id}">
            <div class="window-title">${r.title}</div>
            <div class="window-controls">
              <button class="window-btn minimize" data-action="minimize"></button>
              <button class="window-btn maximize" data-action="maximize"></button>
              <button class="window-btn close" data-action="close"></button>
            </div>
          </div>
          <div class="window-body">
            <iframe class="window-content" src="${r.url}" sandbox="allow-scripts allow-forms allow-modals allow-popups" data-window-id="${r.id}"></iframe>
          </div>
        `,n.appendChild(s);const i=s.querySelector(".window-btn.close"),a=s.querySelector(".window-btn.minimize"),c=s.querySelector(".window-btn.maximize");i&&i.addEventListener("click",l=>{l.stopPropagation(),l.preventDefault(),closeWindow(r.id)}),a&&a.addEventListener("click",l=>{l.stopPropagation(),l.preventDefault(),minimizeWindow(r.id)}),c&&c.addEventListener("click",l=>{l.stopPropagation(),l.preventDefault(),toggleMaximize(r.id)}),s.addEventListener("mousedown",()=>{e.focusWindow(r.id),renderWindows()})})}const panels={apps:document.getElementById("appsPanel"),files:document.getElementById("filesPanel"),market:document.getElementById("marketPanel")};function openPanel(n){var e,t;Object.values(panels).forEach(r=>r==null?void 0:r.classList.remove("active")),(e=panels[n])==null||e.classList.add("active"),document.querySelectorAll(".dock-btn").forEach(r=>r.classList.remove("active")),(t=document.getElementById(`${n}Btn`))==null||t.classList.add("active")}function closeAllPanels(){Object.values(panels).forEach(n=>n==null?void 0:n.classList.remove("active")),document.querySelectorAll(".dock-btn").forEach(n=>n.classList.remove("active"))}document.getElementById("appsBtn").addEventListener("click",()=>openPanel("apps"));document.getElementById("filesBtn").addEventListener("click",()=>openPanel("files"));document.getElementById("marketBtn").addEventListener("click",()=>openPanel("market"));document.addEventListener("keydown",n=>{n.key==="Escape"&&closeAllPanels()});document.addEventListener("click",n=>{!n.target.closest(".panel")&&!n.target.closest(".dock-btn")&&closeAllPanels()});function populateAppsPanel(){const n=document.getElementById("appGrid"),e=[{id:"com.glyphd.notes",name:"Notes",icon:"",url:"/apps/notes/index.html",description:"Note-taking app",category:"productivity"},{id:"com.glyphd.canvas",name:"Glyph Canvas",icon:"",url:"/apps/canvas/index.html",description:"Creative drawing app",category:"creative"},{id:"com.glyphd.collab",name:"Live Collab",icon:"",url:"/apps/collab/index.html",description:"Real-time collaboration",category:"productivity"},{id:"com.glyphd.aichat",name:"AI Chat",icon:"",url:"/apps/aichat/index.html",description:"Chat with AI",category:"ai"},{id:"com.glyphd.monitor",name:"System Monitor",icon:"",url:"/apps/monitor/index.html",description:"System performance monitor",category:"tools"},{id:"com.glyphd.command",name:"Command Center",icon:"",url:"/apps/command/index.html",description:"App launcher and workflows",category:"tools"},{id:"com.glyphd.memory",name:"Memory Graph",icon:"",url:"/apps/memory/index.html",description:"Knowledge graph visualization",category:"ai"},{id:"com.glyphd.studio",name:"Studio Player",icon:"",url:"/apps/studio/index.html",description:"Media player and visualizer",category:"creative"},{id:"com.glyphd.focus",name:"Focus",icon:"",url:"/apps/focus/index.html",description:"Pomodoro timer and focus tool",category:"productivity"},{id:"com.glyphd.market",name:"Market",icon:"",url:"/apps/market/index.html",description:"App store and discovery",category:"tools"}];n.innerHTML="",e.forEach(t=>{const r=document.createElement("div");r.className="app-item",r.dataset.category=t.category,r.title=t.description,r.innerHTML=`
          <div class="app-item-icon">${t.icon}</div>
          <div class="app-item-name">${t.name}</div>
        `,r.addEventListener("click",()=>{launchApp(t),closeAllPanels()}),n.appendChild(r)})}document.querySelectorAll(".category-chip").forEach(n=>{n.addEventListener("click",()=>{document.querySelectorAll(".category-chip").forEach(r=>r.classList.remove("active")),n.classList.add("active");const e=n.dataset.category;document.querySelectorAll(".app-item").forEach(r=>{e==="all"||r.dataset.category===e?r.style.display="flex":r.style.display="none"})})});document.getElementById("appSearch").addEventListener("input",n=>{const e=n.target.value.toLowerCase();document.querySelectorAll(".app-item").forEach(r=>{r.querySelector(".app-item-name").textContent.toLowerCase().includes(e)?r.style.display="flex":r.style.display="none"})});function populateMarketPanel(){const n=document.getElementById("featuredApps"),e=document.getElementById("marketGrid"),t=[{name:"AI Assistant",icon:"",desc:"Advanced AI helper"},{name:"Code Editor",icon:"",desc:"Full-featured code editor"},{name:"Design Tool",icon:"",desc:"Professional design suite"}];n.innerHTML=t.map(s=>`
        <div class="market-app">
          <div class="market-app-icon">${s.icon}</div>
          <div class="market-app-name">${s.name}</div>
          <div class="market-app-desc">${s.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join("");const r=[{name:"Calculator",icon:"",desc:"Scientific calculator"},{name:"Calendar",icon:"",desc:"Event management"},{name:"Weather",icon:"",desc:"Weather forecast"},{name:"Music Player",icon:"",desc:"Audio player"},{name:"Photo Editor",icon:"",desc:"Image editing"},{name:"Task Manager",icon:"",desc:"Task organization"}];e.innerHTML=r.map(s=>`
        <div class="market-app">
          <div class="market-app-icon">${s.icon}</div>
          <div class="market-app-name">${s.name}</div>
          <div class="market-app-desc">${s.desc}</div>
          <button class="market-app-install">Install</button>
        </div>
      `).join("")}function launchApp(n){try{const t=window.GlyphOS.getWindowManager().createWindow({appId:n.id,title:n.name,url:n.url,width:800,height:600,x:Math.random()*200+100,y:Math.random()*200+100});console.log(`${n.name} launched with window ID:`,t),renderWindows()}catch(e){console.error(`Failed to launch ${n.name}:`,e)}}window.addEventListener("load",()=>{setTimeout(()=>{document.getElementById("loading").style.display="none",document.getElementById("desktop").classList.add("loaded"),populateAppsPanel(),populateMarketPanel()},2e3)});document.addEventListener("keydown",n=>{(n.metaKey||n.ctrlKey)&&n.key===" "&&(n.preventDefault(),openPanel("apps"))});
